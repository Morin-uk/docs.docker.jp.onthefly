<!-- Page generated 2019-06-28 11:26:24 +0900 -->
<!-- relative link basehrefs -->

	
	
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
			


<!-- Logic for 'edit this button' -->


	

	

	

	

	

	

	

	

	


<!-- End of logic for 'edit this button' -->


<!DOCTYPE html>
<html lang="ja">

<head>
	<base href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/install/" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<style type="text/css">
		@charset "UTF-8";
		[ng\:cloak],
		[ng-cloak],
		[data-ng-cloak],
		[x-ng-cloak],
		.ng-cloak,
		.x-ng-cloak,
		.ng-hide:not(.ng-hide-animate) {
			display: none !important;
		}

		ng\:form {
			display: block;
		}
	</style>
	<script type="text/javascript">
	  !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="4.0.0";
	  analytics.load("IWj9D0UpZHZdZUZX9jl98PcpBFWBnBMy");
	  analytics.page();
	  }}();
	</script>
	
	<!-- favicon -->
	<link rel="icon" type="image/x-icon" href="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
	<meta name="msapplication-TileImage" content="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico">
	<link rel="apple-touch-icon" type="image/x-icon" href="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
	<meta property="og:image" content="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
	<!-- metadata -->
	<meta property="og:type" content="website"/>
	<meta property="og:updated_time" itemprop="dateUpdated" content="2019-06-28T11:26:24+09:00"/>
	<meta property="og:image" itemprop="image primaryImageOfPage" content="https://matsuand.github.io/docs.docker.jp.onthefly/images/docs@2x.png"/>
	<meta name="twitter:card" content="summary"/>
	<meta name="twitter:domain" content="docs.docker.jp"/>
	<meta name="twitter:site" content="@docker_docs"/>
	<meta name="twitter:url" content="https://twitter.com/docker_docs"/>
	<meta name="twitter:title" itemprop="title name" content="Install UCP on Azure"/>
	<meta name="twitter:description" property="og:description" itemprop="description" content="Docker Universal Control Plane (UCP) closely integrates with Microsoft Azure for its Kubernetes Networking and Persistent Storage feature set. UCP deploys the Calico CNI provider. In Azure, the Calico CNI..." />
	<meta name="twitter:image:src" content="https://matsuand.github.io/docs.docker.jp.onthefly/images/docs@2x.png"/>
	<meta name="twitter:image:alt" content="Docker Documentation"/>
	<meta property="article:published_time" itemprop="datePublished" content="2019-06-28T11:26:24+09:00"/>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="keywords" content="Universal Control Plane, UCP, install, Docker EE, Azure, Kubernetes">
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/bootstrap.min.css">
	<link id="pygments" rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/pygments/perldoc.css">
	<link id="pagestyle" rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/style.css">

	<!-- Go get "Open Sans" font from Google -->
	<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
	<!-- SEO stuff -->
	<title>Install UCP on Azure | Docker Documentation</title>
<meta property="og:title" content="Install UCP on Azure" />
<meta property="og:locale" content="ja_JP" />
<meta name="description" content="Learn how to install Docker Universal Control Plane in a Microsoft Azure environment." />
<meta property="og:description" content="Learn how to install Docker Universal Control Plane in a Microsoft Azure environment." />
<link rel="canonical" href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/install/install-on-azure/" />
<meta property="og:url" content="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/install/install-on-azure/" />
<meta property="og:site_name" content="Docker Documentation" />
<script type="application/ld+json">
{"@context":"http://schema.org","@type":"WebPage","headline":"Install UCP on Azure","description":"Learn how to install Docker Universal Control Plane in a Microsoft Azure environment.","url":"https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/install/install-on-azure/"}</script>
	<!-- END SEO STUFF -->
	
	<script language="javascript">
	// Default to assuming this is an archive and hiding some stuff
	// See js/archive.js and js/docs.js for logic relating to this
	var isArchive = true;
	var dockerVersion = 'v18.09';
	</script>
</head>
<body ng-app="Docker" ng-controller="DockerController" class="colums">
	<header>
		 <nav class="nav-secondary navbar navbar-fixed-top">
    <!-- <div class="fan"></div> -->
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="https://matsuand.github.io/docs.docker.jp.onthefly/"><img class="logo" src="https://matsuand.github.io/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs"></a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="search-form" id="search-div" style="visibility: hidden">
    <form class="search-form form-inline ng-pristine ng-valid" /id="searchForm" action="/docs.docker.jp.onthefly/search/">
        <input class="search-field form-control ds-input" id="st-search-input" value="" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteContainer">
            <div id="autocompleteResults"></div>
        </div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container">
    <div id="tabs">
        <ul class="tabs" id="jsTOCHorizontal">

        </ul>
    </div>
    <div class="ctrl-right hidden-xs hidden-sm">
        <a href="javascript:void(0)" id="menu-toggle"><i class="fa fa-indent" aria-hidden="true"></i></a>
        <div class="btn-group" style="visibility: hidden">
  <button type="button" class="btn btn-default dropdown-btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Docker v18.09 (current)        <span class="caret"></span>
  </button>
  <ul class="dropdown-menu">
    <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/edge/">Docker edge</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v18.03/">Docker v18.03</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.12/">Docker v17.12</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.09/">Docker v17.09</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.06/">Docker v17.06</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.03/">Docker v17.03</a></li>
  </ul>
</div>

    </div>
</div>

        </div>
    </div>
</nav>

	</header>

	<div class="wrapper right-open">
		<div class="container-fluid">
			<div class="row">
				<div class="col-body">
					<main class="col-content content">
						<section class="section">
							
								
							<h1>Install UCP on Azure</h1>  <span class="reading-time" title="Estimated reading time">
  <span class="reading-time-label">読む時間の目安: </span>
  
  
    11 分
  
</span>

							
							
							<p>Docker Universal Control Plane (UCP) closely integrates with Microsoft Azure for its Kubernetes Networking
and Persistent Storage feature set. UCP deploys the Calico CNI provider. In Azure,
the Calico CNI leverages the Azure networking infrastructure for data path
networking and the Azure IPAM for IP address management. There are
infrastructure prerequisites required prior to UCP installation for the
Calico / Azure integration.</p>

<h2 id="docker-ucp-networking">Docker UCP Networking</h2>

<p>Docker UCP configures the Azure IPAM module for Kubernetes to allocate IP
addresses for Kubernetes pods. The Azure IPAM module requires each Azure virtual
machine which is part of the Kubernetes cluster to be configured with a pool of IP
addresses.</p>

<p>There are two options for provisoning IPs for the Kubernetes cluster on Azure:</p>

<ul>
  <li><em>An automated mechanism provided by UCP which allows for IP pool configuration and maintenance
for standalone Azure virtual machines.</em> This service runs within the
<code class="highlighter-rouge">calico-node</code> daemonset and provisions 128 IP addresses for each
node by default. For information on customizing this value, see <a href="https://matsuand.github.io/docs.docker.jp.onthefly/#adjusting-the-ip-count-value">Adjusting the IP count value</a>.</li>
  <li><em>Manual provision of additional IP address for each Azure virtual machine.</em> This
could be done through the Azure Portal, the Azure CLI <code class="highlighter-rouge">$ az network nic ip-config create</code>,
or an ARM template. You can find an example of an ARM template
<a href="https://matsuand.github.io/docs.docker.jp.onthefly/#manually-provision-ip-address-as-part-of-an-azure-virtual-machine-scale-set">here</a>.</li>
</ul>

<h2 id="azure-prerequisites">Azure Prerequisites</h2>

<p>You must meet the following infrastructure prerequisites in order
to successfully deploy Docker UCP on Azure:</p>

<ul>
  <li>All UCP Nodes (Managers and Workers) need to be deployed into the same Azure
Resource Group. The Azure Networking components (Virtual Network, Subnets,
Security Groups) could be deployed in a second Azure Resource Group.</li>
  <li>The Azure Virtual Network and Subnet must be appropriately sized for your
environment, as addresses from this pool will be consumed by Kubernetes Pods.
For more information, see <a href="https://matsuand.github.io/docs.docker.jp.onthefly/#considerations-for-ipam-configuration">Considerations for IPAM
Configuration</a>.</li>
  <li>All UCP worker and manager nodes need to be attached to the same Azure
Subnet.</li>
  <li>Internal IP addresses for all nodes should be <a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-static-private-ip-arm-pportal">set to
Static</a>,
rather than the default of Dynamic.</li>
  <li>The Azure Virtual Machine Object Name needs to match the Azure Virtual Machine
Computer Name and the Node Operating System’s Hostname which is the FQDN of
the host, including domain names. Note that this requires all characters to be in lowercase.</li>
  <li>An Azure Service Principal with <code class="highlighter-rouge">Contributor</code> access to the Azure Resource
Group hosting the UCP Nodes. This Service principal will be used by Kubernetes
to communicate with the Azure API. The Service Principal ID and Secret Key are
needed as part of the UCP prerequisites. If you are using a separate Resource
Group for the networking components, the same Service Principal will need
<code class="highlighter-rouge">Network Contributor</code> access to this Resource Group.</li>
</ul>

<p>UCP requires the following information for the installation:</p>

<ul>
  <li><code class="highlighter-rouge">subscriptionId</code> - The Azure Subscription ID in which the UCP
objects are being deployed.</li>
  <li><code class="highlighter-rouge">tenantId</code> - The Azure Active Directory Tenant ID in which the UCP
objects are being deployed.</li>
  <li><code class="highlighter-rouge">aadClientId</code> - The Azure Service Principal ID.</li>
  <li><code class="highlighter-rouge">aadClientSecret</code> - The Azure Service Principal Secret Key.</li>
</ul>

<h3 id="azure-configuration-file">Azure Configuration File</h3>

<p>For Docker UCP to integrate with Microsoft Azure,each UCP node in your cluster
needs an Azure configuration file, <code class="highlighter-rouge">azure.json</code>. Place the file within
<code class="highlighter-rouge">/etc/kubernetes</code>. Since the config file is owned by <code class="highlighter-rouge">root</code>, set its permissions
to <code class="highlighter-rouge">0644</code> to ensure the container user has read access.</p>

<p>The following is an example template for <code class="highlighter-rouge">azure.json</code>. Replace <code class="highlighter-rouge">***</code> with real values, and leave the other
parameters as is.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"cloud"</span><span class="p">:</span><span class="s2">"AzurePublicCloud"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"tenantId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"***"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"subscriptionId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"***"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"aadClientId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"***"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"aadClientSecret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"***"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"resourceGroup"</span><span class="p">:</span><span class="w"> </span><span class="s2">"***"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"****"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"subnetName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/****"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"securityGroupName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"****"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"vnetName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"****"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"cloudProviderBackoff"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="s2">"cloudProviderBackoffRetries"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="s2">"cloudProviderBackoffExponent"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="s2">"cloudProviderBackoffDuration"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="s2">"cloudProviderBackoffJitter"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="s2">"cloudProviderRatelimit"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="s2">"cloudProviderRateLimitQPS"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="s2">"cloudProviderRateLimitBucket"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="s2">"useManagedIdentityExtension"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="s2">"useInstanceMetadata"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>There are some optional parameters for Azure deployments:</p>

<ul>
  <li><code class="highlighter-rouge">primaryAvailabilitySetName</code> - The Worker Nodes availability set.</li>
  <li><code class="highlighter-rouge">vnetResourceGroup</code> - The Virtual Network Resource group, if your Azure Network objects live in a
seperate resource group.</li>
  <li><code class="highlighter-rouge">routeTableName</code> - If you have defined multiple Route tables within
an Azure subnet.</li>
</ul>

<p>See the <a href="https://github.com/kubernetes/cloud-provider-azure/blob/master/docs/cloud-provider-config.md">Kubernetes Azure Cloud Provider Config</a> for more details on this configuration file.</p>

<h2 id="considerations-for-ipam-configuration">Considerations for IPAM Configuration</h2>

<p>The subnet and the virtual network associated with the primary interface of the
Azure virtual machines need to be configured with a large enough address
prefix/range. The number of required IP addresses depends on the workload and
the number of nodes in the cluster.</p>

<p>For example, in a cluster of 256 nodes, make sure that the address space of the subnet and the
virtual network can allocate at least 128 * 256 IP addresses, in order to run a maximum of 128 pods
concurrently on a node. This would be <strong><em>in addition to</em></strong> initial IP allocations to virtual machine
NICs (network interfaces) during Azure resource creation.</p>

<p>Accounting for IP addresses that are allocated to NICs during virtual machine bring-up, set
the address space of the subnet and virtual network to <code class="highlighter-rouge">10.0.0.0/16</code>. This
ensures that the network can dynamically allocate at least 32768 addresses,
plus a buffer for initial allocations for primary IP addresses.</p>

<blockquote class="important">
  <p>Azure IPAM, UCP, and Kubernetes</p>

  <p>The Azure IPAM module queries an Azure virtual machine’s metadata to obtain
a list of IP addresses which are assigned to the virtual machine’s NICs. The
IPAM module allocates these IP addresses to Kubernetes pods. You configure the
IP addresses as <code class="highlighter-rouge">ipConfigurations</code> in the NICs associated with a virtual machine
or scale set member, so that Azure IPAM can provide them to Kubernetes when
requested.</p>
</blockquote>

<h2 id="manually-provision-ip-address-pools-as-part-of-an-azure-virtual-machine-scale-set">Manually provision IP address pools as part of an Azure virtual machine scale set</h2>

<p>Configure IP Pools for each member of the virtual machine scale set during provisioning by
associating multiple <code class="highlighter-rouge">ipConfigurations</code> with the scale set’s
<code class="highlighter-rouge">networkInterfaceConfigurations</code>. Here’s an example <code class="highlighter-rouge">networkProfile</code>
configuration for an ARM template that configures pools of 32 IP addresses
for each virtual machine in the virtual machine scale set.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"networkProfile"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="s2">"networkInterfaceConfigurations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[variables('nicName')]"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"ipConfigurations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[variables('ipConfigName1')]"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="s2">"primary"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="p">,</span><span class="w">
              </span><span class="s2">"subnet"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'), '/subnets/', variables('subnetName'))]"</span><span class="w">
              </span><span class="p">},</span><span class="w">
              </span><span class="s2">"loadBalancerBackendAddressPools"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="p">{</span><span class="w">
                  </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/loadBalancers/', variables('loadBalancerName'), '/backendAddressPools/', variables('bePoolName'))]"</span><span class="w">
                </span><span class="p">}</span><span class="w">
              </span><span class="p">],</span><span class="w">
              </span><span class="s2">"loadBalancerInboundNatPools"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="p">{</span><span class="w">
                  </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/loadBalancers/', variables('loadBalancerName'), '/inboundNatPools/', variables('natPoolName'))]"</span><span class="w">
                </span><span class="p">}</span><span class="w">
              </span><span class="p">]</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[variables('ipConfigName2')]"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="s2">"subnet"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'), '/subnets/', variables('subnetName'))]"</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
          </span><span class="err">.</span><span class="w">
          </span><span class="err">.</span><span class="w">
          </span><span class="err">.</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[variables('ipConfigName32')]"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="s2">"subnet"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'), '/subnets/', variables('subnetName'))]"</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"primary"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="ucp-installation">UCP Installation</h2>

<h3 id="adjust-the-ip-count-value">Adjust the IP Count Value</h3>

<p>If you have manually attached additional IP addresses to the Virtual Machines
(via an ARM Template, Azure CLI or Azure Portal) or you want to reduce the
number of IP Addresses automatically provisioned by UCP from the default of 128
addresses, you can alter the <code class="highlighter-rouge">azure_ip_count</code> variable in the UCP
Configuration file before installation. If you are happy with 128 addresses per
Virtual Machine, proceed to <a href="https://matsuand.github.io/docs.docker.jp.onthefly/#install-ucp">installing UCP</a>.</p>

<p>Once UCP has been installed, the UCP <a href="../configure/ucp-configuration-file/">configuration
file</a> is managed by UCP and populated with
all of the cluster configuration data, such as AD/LDAP information or networking
configuration. As there is no Universal Control Plane deployed yet, we are able
to stage a <a href="../configure/ucp-configuration-file/">configuration file</a> just
containing the Azure IP Count value. UCP will populate the rest of the cluster
variables during and after the installation.</p>

<p>Below are some example configuration files with just the <code class="highlighter-rouge">azure_ip_count</code>
variable defined. These 3-line files can be preloaded into a Docker Swarm prior
to installing UCP in order to override the default <code class="highlighter-rouge">azure_ip_count</code> value of 128 IP
addresses per node. See <a href="../configure/ucp-configuration-file/">UCP configuration file</a>
to learn more about the configuration file, and other variables that can be staged pre-install.</p>

<blockquote>
  <p>Note: Do not set the <code class="highlighter-rouge">azure_ip_count</code> to a value of less than 6 if you have not
manually provisioned additional IP addresses for each Virtual Machine. The UCP
installation will need at least 6 IP addresses to allocate to the core UCP components
that run as Kubernetes pods. That is in addition to the Virtual
Machine’s private IP address.</p>
</blockquote>

<p>If you have manually provisioned additional IP addresses for each Virtual
Machine, and want to disallow UCP from dynamically provisioning IP
addresses for you, then your UCP configuration file would be:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vi example-config-1
<span class="o">[</span>cluster_config]
  azure_ip_count <span class="o">=</span> <span class="s2">"0"</span>
</code></pre></div></div>

<p>If you want to reduce the IP addresses dynamically allocated from 128 to a
custom value, then your UCP configuration file would be:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vi example-config-2
<span class="o">[</span>cluster_config]
  azure_ip_count <span class="o">=</span> <span class="s2">"20"</span> <span class="c"># This value may be different for your environment</span>
</code></pre></div></div>

<p>See <a href="https://matsuand.github.io/docs.docker.jp.onthefly/#considerations-for-ipam-configuration">Considerations for IPAM
Configuration</a> to calculate an
appropriate value.</p>

<p>To preload this configuration file prior to installing UCP:</p>

<ol>
  <li>
    <p>Copy the configuration file to a Virtual Machine that you wish to become a UCP Manager Node.</p>
  </li>
  <li>
    <p>Initiate a Swarm on that Virtual Machine.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker swarm init
</code></pre></div>    </div>
  </li>
  <li>
    <p>Upload the configuration file to the Swarm, by using a <a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/swarm/configs/">Docker Swarm Config</a>.
This Swarm Config will need to be named <code class="highlighter-rouge">com.docker.ucp.config</code>.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker config create com.docker.ucp.config &lt;local-configuration-file&gt;
</code></pre></div>    </div>
  </li>
  <li>
    <p>Check that the configuration has been loaded succesfully.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker config list
 ID                          NAME                                                      CREATED             UPDATED
 igca3q30jz9u3e6ecq1ckyofz   com.docker.ucp.config                                     1 days ago          1 days ago
</code></pre></div>    </div>
  </li>
  <li>
    <p>You are now ready to <a href="https://matsuand.github.io/docs.docker.jp.onthefly/#install-ucp">install UCP</a>. As you have already staged
a UCP configuration file, you will need to add <code class="highlighter-rouge">--existing-config</code> to the
install command below.</p>
  </li>
</ol>

<p>If you need to adjust this value post-installation, see <a href="../configure/ucp-configuration-file/">instructions</a>
on how to download the UCP configuration file, change the value, and update the configuration via the API.
If you reduce the value post-installation, existing virtual machines will not be
reconciled, and you will have to manually edit the IP count in Azure.</p>

<h3 id="install-ucp">Install UCP</h3>

<p>Run the following command to install UCP on a manager node. The <code class="highlighter-rouge">--pod-cidr</code>
option maps to the IP address range that you have configured for the Azure
subnet, and the <code class="highlighter-rouge">--host-address</code> maps to the private IP address of the master
node. Finally if you have set the <a href="https://matsuand.github.io/docs.docker.jp.onthefly/#adjusting-the-ip-count-value">Ip Count
Value</a> you will need to add <code class="highlighter-rouge">--existing-config</code>
to the install command below.</p>

<blockquote>
  <p>Note: The <code class="highlighter-rouge">pod-cidr</code> range must match the Azure Virtual Network’s Subnet
attached the hosts. For example, if the Azure Virtual Network had the range
<code class="highlighter-rouge">172.0.0.0/16</code> with Virtual Machines provisioned on an Azure Subnet of
<code class="highlighter-rouge">172.0.1.0/24</code>, then the Pod CIDR should also be <code class="highlighter-rouge">172.0.1.0/24</code>.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker container run <span class="nt">--rm</span> <span class="nt">-it</span> <span class="se">\</span>
  <span class="nt">--name</span> ucp <span class="se">\</span>
  <span class="nt">--volume</span> /var/run/docker.sock:/var/run/docker.sock <span class="se">\</span>
  docker/ucp:3.1.8 install <span class="se">\</span>
  <span class="nt">--host-address</span> &lt;ucp-ip&gt; <span class="se">\</span>
  <span class="nt">--pod-cidr</span> &lt;ip-address-range&gt; <span class="se">\</span>
  <span class="nt">--cloud-provider</span> Azure <span class="se">\</span>
  <span class="nt">--interactive</span>
</code></pre></div></div>

							<!-- tags -->
							
							
							
							<span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span style="vertical-align: 2px"><a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=Universal Control Plane">Universal Control Plane</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=UCP">UCP</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=install">install</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=Docker EE">Docker EE</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=Azure">Azure</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=Kubernetes">Kubernetes</a></span>
							
							<!-- link corrections -->
              <script language="JavaScript">
							var x = document.links.length;
							var baseHref = document.getElementsByTagName('base')[0].href
							for (i = 0; i < x; i++) {
							  var munged = false;
							  var thisHREF = document.links[i].href;
							  var originalURL = "/ee/ucp/admin/install/install-on-azure/";
							  if (thisHREF.indexOf(baseHref + "#") > -1) {
							    // hash fix
							    //console.log('BEFORE: base:',baseHref,'thisHREF:',thisHREF,'originalURL:',originalURL);
							    thisHREF = originalURL + thisHREF.replace(baseHref, "");
							    //console.log('AFTER: base:',baseHref,'thisHREF:',thisHREF,'originalURL:',originalURL);
							  }
							  if ((thisHREF.indexOf(window.location.hostname) > -1 || thisHREF.indexOf('http') == -1) && document.links[i].className.indexOf("nomunge") < 0) {
							    munged = true;
							    thisHREF = thisHREF.replace(".md", "/").replace("/index/", "/");
							    document.links[i].setAttribute('href', thisHREF);
							  }
							}
							</script>
							
						  <div id="ratings-div" style="color:#b9c2cc; text-align: center; margin-top: 150px; visibility: hidden">
								<div id="pd_rating_holder_8453675"></div>
								<script type="text/javascript">
									PDRTJS_settings_8453675 = {
										"id": "8453675",
										"unique_id": "ee/ucp/admin/install/install-on-azure.md",
										"title": "Install UCP on Azure",
										"permalink": "https://github.com/docker/docker.github.io/blob/master/ee/ucp/admin/install/install-on-azure.md"
									};
									(function(d, c, j) {
										if (!document.getElementById(j)) {
											var pd = d.createElement(c),
												s;
											pd.id = j;
											pd.src = ('https:' == document.location.protocol) ? 'https://polldaddy.com/js/rating/rating.js' : 'http://i0.poll.fm/js/rating/rating.js';
											s = document.getElementsByTagName(c)[0];
											s.parentNode.insertBefore(pd, s);
										}
									}(document, 'script', 'pd-rating-js'));
								</script>
							</div>
							
						</section>
					</main>
					<nav class="col-nav">
						<div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
						<div id="navbar" class="nav-sidebar">
    <ul class="nav" id="jsTOCLeftNav">
    </ul>
</div>

						</div>
					</nav>
					<div class="col-toc">
							<div class="sidebar hidden-xs hidden-sm">
							<div class="toc-nav">
								<div class="feedback-links">
									<ul>
										
										<li style="visibility: hidden"><a href="https://github.com/matsuand/docs.docker.jp/edit/v18.09.local/ee/ucp/admin/install/install-on-azure.md"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> このページの編集</a></li>
										<li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/issues/new?body=File: [ee/ucp/admin/install/install-on-azure.md](https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/install/install-on-azure/)"
															class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 文書変更のリクエスト</a></li>
										<li><a href="https://success.docker.com/support"><i class="fa fa-question" aria-hidden="true"></i> サポート依頼</a></li>
										<!-- toggle mode -->
										<li>
											<div class="toggle-mode">
												<div class="icon">
													<i class="fa fa-sun-o" aria-hidden="true"></i>
												</div>
												<div class="toggle-switch">
													<label class="switch">
														<input type="checkbox" id="switch-style">
														<div class="slider round"></div>
												</label>
												</div>
												<div class="icon">
													<i class="fa fa-moon-o" aria-hidden="true"></i>
												</div>
											</div>
										</li>
									</ul>
								</div>
								   
									<div id="side-toc-title">本ページ内</div>
									
<ul id="my_toc" class="inline_toc">
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#docker-ucp-networking" class="nomunge">Docker UCP Networking</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#azure-prerequisites" class="nomunge">Azure Prerequisites</a>
    <ul>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#azure-configuration-file" class="nomunge">Azure Configuration File</a></li>
    </ul>
  </li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#considerations-for-ipam-configuration" class="nomunge">Considerations for IPAM Configuration</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#manually-provision-ip-address-pools-as-part-of-an-azure-virtual-machine-scale-set" class="nomunge">Manually provision IP address pools as part of an Azure virtual machine scale set</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#ucp-installation" class="nomunge">UCP Installation</a>
    <ul>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#adjust-the-ip-count-value" class="nomunge">Adjust the IP Count Value</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#install-ucp" class="nomunge">Install UCP</a></li>
    </ul>
  </li>
</ul>


								</div>
								
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	
	<footer class="footer">
		  
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/what-docker">What is Docker</a></li>
                        <li><a href="https://www.docker.com/what-container">What is a Container</a></li>
                        <li><a href="https://www.docker.com/use-cases">Use Cases</a></li>
                        <li><a href="https://www.docker.com/customers">Customers</a></li>
                        <li><a href="https://www.docker.com/partners/partner-program">Partners</a></li>
                        <li class="break"><a href="https://www.docker.com/industry-government">For Government</a></li>
                        <li><a href="https://www.docker.com/company">About Docker</a></li>
                        <li><a href="https://www.docker.com/company/management">Management</a></li>
                        <li><a href="https://www.docker.com/company/news-and-press">Press &amp; News</a></li>
                        <li><a href="https://www.docker.com/careers">Careers</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/products/overview">Product</a></li>
                        <li><a href="https://www.docker.com/pricing">Pricing</a></li>
                        <li><a href="https://www.docker.com/docker-community">Community Edition</a></li>
                        <li class="break"><a href="https://www.docker.com/enterprise">Enterprise Edition </a></li>
                        <li><a href="https://www.docker.com/products/docker-datacenter">Docker Datacenter</a></li>
                        <li><a href="https://hub.docker.com/">Docker Hub</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/">Documentation</a></li>
                        <li><a href="https://www.docker.com/docker">Learn</a></li>
                        <li><a href="https://blog.docker.com" target="_blank">Blog</a></li>
                        <li><a href="https://engineering.docker.com" target="_blank">Engineering Blog</a></li>
                        <li><a href="https://training.docker.com/" target="_blank">Training</a></li>
                        <li><a href="https://success.docker.com/support">Support</a></li>
                        <li><a href="https://success.docker.com/kbase">Knowledge Base</a></li>
                        <li><a href="https://www.docker.com/products/resources">Resources</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/docker-community">Community</a></li>
                        <li><a href="https://www.docker.com/technologies/overview">Open Source</a></li>
                        <li><a href="https://www.docker.com/community/events">Events</a></li>
                        <li><a href="https://forums.docker.com/" target="_blank">Forums</a></li>
                        <li><a href="https://www.docker.com/community/docker-captains">Docker Captains</a></li>
                        <li><a href="https://www.docker.com/docker-community/scholarships">Scholarships</a></li>
                        <li><a href="https://blog.docker.com/curated/">Community News</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="http://status.docker.com/">Status</a></li>
                        <li><a href="https://www.docker.com/docker-security">Security</a></li>
                        <li><a href="https://www.docker.com/legal">Legal</a></li>
                        <li><a href="https://www.docker.com/company/contact">Contact</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2019 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="http://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="http://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-reddit"><a href="http://www.reddit.com/r/docker">Reddit</a></li>
                    <li class="fa fa-slideshare"><a href="http://www.slideshare.net/docker">Slideshare</a></li>
                </ul>
            </div>
        </div>
    </div>

	</footer>
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/github.css">
	
	<!-- <script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/anchorlinks.js"></script> -->
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/menu.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/jquery.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
	<!-- Always include the archive.js, but it doesn't do much unless we are an archive -->
	<script language="javascript">
	// Default to assuming this is an archive and hiding some stuff
	// See js/archive.js and js/docs.js for logic relating to this
	var isArchive = true;
	var dockerVersion = 'v18.09';
	// In archives, we need to know the page root and we get it from JEKYLL_ENV in the jekyll build command
	var jekyllEnv = 'development';
	// If unset (in non-archive branches), defaults to "development". In that case, reset it to empty
	if (jekyllEnv == 'development') {
		jekyllEnv = '';
	}
	var pageURL = jekyllEnv + '/ee/ucp/admin/install/install-on-azure/';
	</script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/archive.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/stickyfill.min.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/metadata.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/glossary.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/collections_tocs.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/docs.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/toc.js"></script>
	<script language="javascript">
	jQuery(document).ready(function(){
				hookupTOCEvents();
			});
	</script>
</body>

</html>
