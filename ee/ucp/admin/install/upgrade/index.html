<!-- Page generated 2020-02-15 16:32:32 +0900 -->
<!-- relative link basehrefs -->

	
	
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
			


<!-- Logic for 'edit this button' -->


	

	

	

	

	

	

	

	

	


<!-- End of logic for 'edit this button' -->


<!DOCTYPE html>
<html lang="ja">

<head>
	<base href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/install/" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<style type="text/css">
		@charset "UTF-8";
		[ng\:cloak],
		[ng-cloak],
		[data-ng-cloak],
		[x-ng-cloak],
		.ng-cloak,
		.x-ng-cloak,
		.ng-hide:not(.ng-hide-animate) {
			display: none !important;
		}

		ng\:form {
			display: block;
		}
	</style>
	<!-- Google Tag Manager -->
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-WL2QLG5');</script>
	<!-- End Google Tag Manager -->
	
	<!-- favicon -->
	<link rel="icon" type="image/x-icon" href="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
	<meta name="msapplication-TileImage" content="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico">
	<link rel="apple-touch-icon" type="image/x-icon" href="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
	<meta property="og:image" content="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
	<!-- metadata -->
	<meta property="og:type" content="website"/>
	<meta property="og:updated_time" itemprop="dateUpdated" content="2020-02-15T16:32:32+09:00"/>
	<meta property="og:image" itemprop="image primaryImageOfPage" content="https://matsuand.github.io/docs.docker.jp.onthefly/images/docs@2x.png"/>
	<meta name="twitter:card" content="summary"/>
	<meta name="twitter:domain" content="docs.docker.jp"/>
	<meta name="twitter:site" content="@docker_docs"/>
	<meta name="twitter:url" content="https://twitter.com/docker_docs"/>
	<meta name="twitter:title" itemprop="title name" content="Upgrade to UCP 3.2"/>
	<meta name="twitter:description" property="og:description" itemprop="description" content="This topic applies to Docker Enterprise. The Docker Enterprise platform business, including products, customers, and employees, has been acquired by Mirantis, inc., effective 13-November-2019. For more information on the acquisition..." />
	<meta name="twitter:image:src" content="https://matsuand.github.io/docs.docker.jp.onthefly/images/docs@2x.png"/>
	<meta name="twitter:image:alt" content="Docker ドキュメント"/>
	<meta property="article:published_time" itemprop="datePublished" content="2020-02-15T16:32:32+09:00"/>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="keywords" content="UCP, upgrade, update">
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/bootstrap.min.css">
	<link id="pygments" rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/pygments/perldoc.css">
	<link id="pagestyle" rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/style.css">

	<!-- Go get "Open Sans" font from Google -->
	<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
	<!-- SEO stuff -->
	<title>Upgrade to UCP 3.2 | Docker ドキュメント</title>
<meta property="og:title" content="Upgrade to UCP 3.2" />
<meta property="og:locale" content="ja_JP" />
<meta name="description" content="Learn how to upgrade Docker Universal Control Plane with minimal impact to your users." />
<meta property="og:description" content="Learn how to upgrade Docker Universal Control Plane with minimal impact to your users." />
<link rel="canonical" href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/install/upgrade/" />
<meta property="og:url" content="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/install/upgrade/" />
<meta property="og:site_name" content="Docker ドキュメント" />
<script type="application/ld+json">
{"@context":"http://schema.org","@type":"WebPage","headline":"Upgrade to UCP 3.2","description":"Learn how to upgrade Docker Universal Control Plane with minimal impact to your users.","url":"https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/install/upgrade/"}</script>
	<!-- END SEO STUFF -->
	
	<script language="javascript">
	// Default to assuming this is an archive and hiding some stuff
	// See js/archive.js and js/docs.js for logic relating to this
	var isArchive = true;
	var dockerVersion = 'v19.03';
	</script>
</head>
<body ng-app="Docker" ng-controller="DockerController" class="colums">
	<header>
		 <nav class="nav-secondary navbar navbar-fixed-top">
    <!-- <div class="fan"></div> -->
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="https://matsuand.github.io/docs.docker.jp.onthefly/"><img class="logo" src="https://matsuand.github.io/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs"></a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="search-form" id="search-div" style="visibility: hidden">
    <form class="search-form form-inline ng-pristine ng-valid" id="searchForm" action="https://matsuand.github.io/docs.docker.jp.onthefly/search/">
        <input class="search-field form-control ds-input" id="st-search-input" value="" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteContainer">
            <div id="autocompleteResults"></div>
        </div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container">
    <div id="tabs">
        <ul class="tabs" id="jsTOCHorizontal">

        </ul>
    </div>
    <div class="ctrl-right hidden-xs hidden-sm">
        <a href="javascript:void(0)" id="menu-toggle"><i class="fa fa-indent" aria-hidden="true"></i></a>
        <div class="btn-group" style="visibility: hidden">
  <button type="button" class="btn btn-default dropdown-btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Docker v19.03 (current)        <span class="caret"></span>
  </button>
  <ul class="dropdown-menu">
    <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v18.09/">Docker v18.09</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v18.03/">Docker v18.03</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.12/">Docker v17.12</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.09/">Docker v17.09</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.06/">Docker v17.06</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.03/">Docker v17.03</a></li>
  </ul>
</div>

    </div>
</div>

        </div>
    </div>
</nav>

	</header>

	<div class="wrapper right-open">
		<div class="container-fluid">
			<div class="row">
				<div class="col-body">
					<main class="col-content content">
						<section class="section">
							
								
							<h1>Upgrade to UCP 3.2</h1>  <span class="reading-time" title="Estimated reading time">
  <span class="reading-time-label">読む時間の目安: </span>
  
  
    14 分
  
</span>

							
							
							<blockquote>
  <!-- This text will be included on all Docker pages that document Enterprise products, features, and technologies that are transitioning to Mirantis. -->
  <p>This topic applies to Docker Enterprise.</p>

  <p>The Docker Enterprise platform business, including products, customers, and employees, has been acquired by Mirantis, inc., effective 13-November-2019. For more information on the acquisition and how it may affect you and your business, refer to the <a href="https://www.docker.com/faq-for-docker-enterprise-customers-and-partners">Docker Enterprise Customer FAQ</a>.</p>
</blockquote>

<p>This page helps you upgrade Docker Universal Control Plane (UCP) to version 3.2.5.</p>

<h2 id="plan-the-upgrade">Plan the upgrade</h2>

<p>Before upgrading to a new version of UCP, check the
<a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/release-notes/">release notes</a>.
There you’ll find information about new features, breaking changes, and
other relevant information for upgrading to a particular version.</p>

<p>As part of the upgrade process, you’ll upgrade the Docker Engine - Enterprise
installed on each node of the cluster to version 19.03 or higher.
You should plan for the upgrade to take place outside of business hours,
to ensure there’s minimal impact to your users.</p>

<p>Also, don’t make changes to UCP configurations while you’re upgrading it.
This can lead to misconfigurations that are difficult to troubleshoot.</p>

<h3 id="environment-checklist">Environment checklist</h3>
<p>Complete the following checks:</p>

<h4 id="systems">Systems</h4>
<ul>
  <li>Confirm time sync across all nodes (and check time daemon logs for any large time drifting)</li>
  <li>Check system requirements <code class="highlighter-rouge">PROD=4</code> <code class="highlighter-rouge">vCPU/16GB</code> for UCP managers and DTR replicas</li>
  <li>Review the full UCP/DTR/Engine port requirements</li>
  <li>Ensure that your cluster nodes meet the minimum requirements</li>
  <li>Before performing any upgrade, ensure that you meet all minimum requirements listed in <a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/install/system-requirements/">UCP System requirements</a>, including port openings (UCP 3.x added more required ports for Kubernetes), memory, and disk space. For example, manager nodes must have at least 8GB of memory.</li>
</ul>

<blockquote>
  <p>Note</p>

  <p>If you are upgrading a cluster to UCP 3.0.2 or higher on Microsoft
Azure, please ensure that all of the Azure <a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/install/install-on-azure/#azure-prerequisites">prerequisites</a>
are met.</p>
</blockquote>

<h4 id="storage">Storage</h4>
<ul>
  <li>Check <code class="highlighter-rouge">/var/</code> storage allocation and increase if it is over 70% usage.</li>
  <li>In addition, check all nodes’ local file systems for any disk storage issues (and DTR back-end storage, for example, NFS).</li>
  <li>If not using Overlay2 storage drivers please take this opportunity to do so, you will find stability there. Note that the transition from Device mapper to Overlay2 is a destructive rebuild.</li>
</ul>

<h4 id="operating-system">Operating system</h4>
<ul>
  <li>If cluster nodes OS branch is older (Ubuntu 14.x, RHEL 7.3, etc), consider patching all relevant packages to the most recent (including kernel).</li>
  <li>Rolling restart of each node before upgrade (to confirm in-memory settings are the same as startup-scripts).</li>
  <li>Run <code class="highlighter-rouge">check-config.sh</code> on each cluster node (after rolling restart) for any kernel compatibility issues. Latest version of the script can be found here: https://github.com/moby/moby/blob/master/contrib/check-config.sh</li>
</ul>

<h4 id="procedural">Procedural</h4>
<ul>
  <li>Perform Swarm, UCP and DTR backups before upgrading</li>
  <li>Gather Compose file/service/stack files</li>
  <li>Generate a UCP Support dump (for point in time) before upgrading</li>
  <li>Preinstall Engine/UCP/DTR images. If your cluster is offline (with no connection to the internet), then Docker provides tarballs containing all of the required container images <a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/install/upgrade-offline/">here</a>. If your cluster is
online, you can pull the required container images onto your nodes with the following command:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">--rm</span> docker/ucp:3.2.5 images <span class="nt">--list</span> | xargs <span class="nt">-L</span> 1 docker pull
</code></pre></div></div>
<ul>
  <li>Load troubleshooting packages (netshoot, etc)</li>
  <li>Best order for upgrades: Engine, UCP, and then DTR. Note that the scope of this topic is limited to upgrade instructions for UCP.</li>
</ul>

<h4 id="upgrade-strategy">Upgrade strategy</h4>

<p>For each worker node that requires an upgrade, you can upgrade that node in place or you can replace the node
with a new worker node. The type of upgrade you perform depends on what is needed for each node:</p>

<ul>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#automated-in-place-cluster-upgrade">Automated, in-place cluster upgrade</a>: Performed on any manager node. Automatically upgrades the entire cluster.</li>
  <li>Manual cluster upgrade: Performed using the CLI. Automatically upgrades manager nodes and allows you to control the upgrade order of worker nodes. This type of upgrade is more advanced than the automated, in-place cluster upgrade.
    <ul>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#phased-in-place-cluster-upgrade">Upgrade existing nodes in place</a>: Performed using the CLI. Automatically upgrades manager nodes and allows you to control the order of worker node upgrades.</li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#replace-existing-worker-nodes-using-blue-green-deployment">Replace all worker nodes using blue-green deployment</a>: Performed using the CLI. This type of upgrade allows you to stand up a new cluster in parallel to the current code and cut over when complete. This type of upgrade allows you to join new worker nodes, schedule workloads to run on new nodes, pause, drain, and remove old worker nodes in batches of multiple nodes rather than one at a time, and shut down servers to remove worker nodes. This type of upgrade is the most advanced.</li>
    </ul>
  </li>
</ul>

<h2 id="back-up-your-cluster">Back up your cluster</h2>

<p>Before starting an upgrade, make sure that your cluster is healthy. If a problem
occurs, this makes it easier to find and troubleshoot it.</p>

<p><a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/admin/backup/back-up-ucp/">Create a backup</a> of your cluster.
This allows you to recover if something goes wrong during the upgrade process.</p>

<blockquote>
  <p>Note</p>

  <p>The backup archive is version-specific, so you can’t use it during the
upgrade process. For example, if you create a backup archive for a UCP 2.2
cluster, you can’t use the archive file after you upgrade to UCP 3.0.</p>
</blockquote>

<h2 id="upgrade-docker-engine">Upgrade Docker Engine</h2>

<p>For each node that is part of your cluster, upgrade the Docker Engine
installed on that node to Docker Engine version 19.03 or higher. Be sure
to install the Docker Enterprise Edition.</p>

<p>Starting with the manager nodes, and then worker nodes:</p>

<ol>
  <li>Log into the node using ssh.</li>
  <li>Upgrade the Docker Engine to version 18.09.0 or higher. See <a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/upgrade/">Upgrade Docker EE</a>.</li>
  <li>Make sure the node is healthy.</li>
</ol>

<blockquote>
  <p>Note</p>

  <p>In your browser, navigate to <strong>Nodes</strong> in the UCP web interface, and check that the node is healthy and is part of the cluster.</p>
</blockquote>

<h2 id="upgrade-ucp">Upgrade UCP</h2>
<p>When upgrading UCP to version 3.2.5, you can choose from
different upgrade workflows:</p>

<blockquote class="important">
  <p>Note</p>

  <p>In all upgrade workflows, manager nodes are automatically upgraded in place. You cannot control the order
of manager node upgrades.</p>
</blockquote>

<ul>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#automated-in-place-cluster-upgrade">Automated, in-place cluster upgrade</a>: Performed on any
manager node. Automatically upgrades the entire cluster.</li>
  <li>Manual cluster upgrade: Performed using the CLI. Automatically upgrades manager
nodes and allows you to control the upgrade order of worker nodes. This type of upgrade is more
advanced than the automated, in-place cluster upgrade.
    <ul>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#phased-in-place-cluster-upgrade">Upgrade existing nodes in place</a>: Performed using the CLI. Automatically upgrades manager nodes and allows you to control the order of worker node upgrades.</li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#replace-existing-worker-nodes-using-blue-green-deployment">Replace all worker nodes using blue-green deployment</a>: Performed using the CLI. This type of upgrade allows you to stand up a new cluster in parallel to the current code and cut over when complete. This type of upgrade allows you to join new worker nodes, schedule workloads to run on new nodes, pause, drain, and remove old worker nodes in batches of multiple nodes rather than one at a time, and shut down servers to remove worker nodes. This type of upgrade is the most advanced.</li>
    </ul>
  </li>
</ul>

<h3 id="use-the-cli-to-perform-an-upgrade">Use the CLI to perform an upgrade</h3>

<p>There are two different ways to upgrade a UCP Cluster via the CLI. The first is
an automated process; this approach will update all UCP components on all nodes
within the UCP Cluster. The upgrade process is done node by node, but once the
user has initiated an upgrade it will work its way through the entire cluster.</p>

<p>The second UCP upgrade method is a phased approach, once an upgrade has been
initiated this method will upgrade all UCP components on a single UCP worker
nodes, giving the user more control to migrate workloads and control traffic
when upgrading the cluster.</p>

<h3 id="automated-in-place-cluster-upgrade">Automated in-place cluster upgrade</h3>

<p>This is the traditional approach to upgrading UCP and is often used when the
order in which UCP worker nodes is upgraded is NOT important.</p>

<p>To upgrade UCP, ensure all Docker engines have been upgraded to the
corresponding new version. Then a user should SSH to one UCP manager node and run
the following command. The upgrade command should not be run on a workstation
with a client bundle.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker container run --rm -it \
  --name ucp \
  --volume /var/run/docker.sock:/var/run/docker.sock \
  docker/ucp:3.2.5 \
  upgrade \
  --interactive
</code></pre></div></div>

<p>The upgrade command will print messages regarding the progress of the upgrade as
it automatically upgrades UCP on all nodes in the cluster.</p>

<h3 id="phased-in-place-cluster-upgrade">Phased in-place cluster upgrade</h3>

<p>The phased approach of upgrading UCP, introduced in UCP 3.2, allows granular
control of the UCP upgrade process. A user can temporarily run UCP worker nodes
with different versions of the Docker Engine and UCP. This workflow is useful
when a user wants to manually control how workloads and traffic are migrated
around a cluster during an upgrade. This process can also be used if a user
wants to add additional worker node capacity during an upgrade to handle
failover. Worker nodes can be added to a partially upgraded UCP Cluster,
workloads migrated across, and previous worker nodes then taken offline and
upgraded.</p>

<p>To start a phased upgrade of UCP, first all manager nodes will need to be
upgraded to the new UCP version. To tell UCP to upgrade the manager nodes but
not upgrade any worker nodes, pass <code class="highlighter-rouge">--manual-worker-upgrade</code> into the upgrade
command.</p>

<p>To upgrade UCP, ensure the Docker engine on all UCP manager nodes have been
upgraded to the corresponding new version. SSH to a UCP manager node and run
the following command. The upgrade command should not be run on a workstation
with a client bundle.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker container run --rm -it \
  --name ucp \
  --volume /var/run/docker.sock:/var/run/docker.sock \
  docker/ucp:3.2.5 \
  upgrade \
  --manual-worker-upgrade \
  --interactive
</code></pre></div></div>

<p>The <code class="highlighter-rouge">--manual-worker-upgrade</code> flag will add an upgrade-hold label to all worker
nodes. UCP will be constantly monitor this label, and if that label is removed
UCP will then upgrade the node.</p>

<p>To trigger the upgrade on a worker node, you will have to remove the
label.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker node update --label-rm com.docker.ucp.upgrade-hold &lt;node name or id&gt;
</code></pre></div></div>

<blockquote>
  <p>Optional</p>

  <p>Joining new worker nodes to the cluster. Once the manager nodes have
been upgraded to a new UCP version, new worker nodes can be added to the
cluster, assuming they are running the corresponding new docker engine
version.</p>
</blockquote>

<p>The swarm join token can be found in the UCP UI, or while ssh’d on a UCP
manager node. More information on finding the swarm token can be found
<a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/configure/join-nodes/join-linux-nodes-to-cluster/">here</a>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker swarm join --token SWMTKN-&lt;YOUR TOKEN&gt; &lt;manager ip&gt;:2377
</code></pre></div></div>

<h3 id="replace-existing-worker-nodes-using-blue-green-deployment">Replace existing worker nodes using blue-green deployment</h3>

<p>This workflow is used to create a parallel environment for a new deployment, which can greatly reduce downtime, upgrades
worker node engines without disrupting workloads, and allows traffic to be migrated to the new environment with
worker node rollback capability. This type of upgrade creates a parallel environment for reduced downtime and workload disruption.</p>

<blockquote>
  <p>Note</p>

  <p>Steps 2 through 6 can be repeated for groups of nodes - you do not have to replace all worker
nodes in the cluster at one time.</p>
</blockquote>

<ol>
  <li>
    <p>Upgrade manager nodes</p>

    <ul>
      <li>The <code class="highlighter-rouge">--manual-worker-upgrade</code> command automatically upgrades manager nodes first, and then allows you to control
 the upgrade of the UCP components on the worker nodes using node labels.</li>
    </ul>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker container run --rm -it \
   --name ucp \
   --volume /var/run/docker.sock:/var/run/docker.sock \
   docker/ucp:3.2.5 \
   upgrade \
   --manual-worker-upgrade \
   --interactive
</code></pre></div>    </div>
  </li>
  <li>
    <p>Join new worker nodes</p>

    <ul>
      <li>New worker nodes have newer engines already installed and have the new UCP version running when they join the cluster.
 On the manager node, run commands similar to the following examples to get the Swarm Join token and add new worker nodes:
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> docker swarm join-token worker
</code></pre></div>        </div>
      </li>
      <li>On the node to be joined:
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> docker swarm join --token SWMTKN-&lt;YOUR TOKEN&gt; &lt;manager ip&gt;:2377
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Join Enterprise Engine to the cluster
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> docker swarm join --token SWMTKN-&lt;YOUR TOKEN&gt; &lt;manager ip&gt;:2377
</code></pre></div>    </div>
  </li>
  <li>
    <p>Pause all existing worker nodes</p>

    <ul>
      <li>This ensures that new workloads are not deployed on existing nodes.
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker node update --availability pause &lt;node name&gt;
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>Drain paused nodes for workload migration</p>

    <ul>
      <li>Redeploy workloads on all existing nodes to new nodes. Because all existing nodes are “paused”, workloads are
 automatically rescheduled onto new nodes.
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> docker node update --availability drain &lt;node name&gt;
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>Remove drained nodes</p>

    <ul>
      <li>After each node is fully drained, it can be shut down and removed from the cluster. On each worker node that is
 getting removed from the cluster, run a command similar to the following example :
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> docker swarm leave &lt;node name&gt;
</code></pre></div>        </div>
      </li>
      <li>Run a command similar to the following example on the manager node when the old worker comes unresponsive:
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> docker node rm &lt;node name&gt;
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>Remove old UCP agents</p>

    <ul>
      <li>After upgrade completion, remove old UCP agents, which includes 390x and Windows agents, that were carried over
 from the previous install by running the following command on the manager node:
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> docker service rm ucp-agent
 docker service rm ucp-agent-win
 docker service rm ucp-agent-s390x
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ol>

<h3 id="troubleshooting">Troubleshooting</h3>

<ul>
  <li>Upgrade compatibility
    <ul>
      <li>The upgrade command automatically checks for multiple <code class="highlighter-rouge">ucp-worker-agents</code> before
  proceeding with the upgrade. The existence of multiple <code class="highlighter-rouge">ucp-worker-agents</code> might indicate
  that the cluster still in the middle of a prior manual upgrade and you must resolve the
  conflicting node labels issues before proceeding with the upgrade.</li>
    </ul>
  </li>
  <li>Upgrade failures
    <ul>
      <li>For worker nodes, an upgrade failure can be rolled back by changing the node label back
  to the previous target version. Rollback of manager nodes is not supported.</li>
    </ul>
  </li>
  <li><a href="https://success.docker.com/article/how-to-resolve-kubernetes-errors-after-upgrading-ucp">Kubernetes errors in node state messages after upgrading UCP</a></li>
  <li>The following information applies if you have upgraded to UCP 3.0.0 or newer:
    <ul>
      <li>After performing a UCP upgrade from 2.2.x to 3.x.x, you might see unhealthy nodes in your UCP
  dashboard with any of the following errors listed:
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Awaiting healthy status in Kubernetes node inventory
  Kubelet is unhealthy: Kubelet stopped posting node status
</code></pre></div>        </div>
      </li>
      <li>Alternatively, you may see other port errors such as the one below in the ucp-controller
  container logs:
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  http: proxy error: dial tcp 10.14.101.141:12388: connect: no route to host
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>UCP 3.x.x requires additional opened ports for Kubernetes use. For ports that are used by the
latest UCP versions and the scope of port use, refer to
<a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/install/system-requirements/#ports-used">this page</a>.
    <ul>
      <li>If you have upgraded from UCP 2.2.x to 3.0.x, verify that the ports 179, 6443, 6444, and 10250 are
open for Kubernetes traffic.</li>
      <li>If you have upgraded to UCP 3.1.x, in addition to the ports listed above, also open
ports 9099 and 12388.</li>
    </ul>
  </li>
</ul>

<h3 id="recommended-upgrade-paths">Recommended upgrade paths</h3>

<ul>
  <li>From UCP 3.0: UCP 3.0 &gt; UCP 3.1 &gt; UCP 3.2</li>
  <li>From UCP 2.2: UCP 2.2 &gt; UCP 3.0 &gt; UCP 3.1 &gt; UCP 3.2</li>
</ul>

<p>If you’re running a UCP version earlier than 2.1, first upgrade to the latest
2.1 version, then upgrade to 2.2. Use the following rules for your upgrade path
to UCP 2.2:</p>

<ul>
  <li>From UCP 1.1: UCP 1.1 &gt; UCP 2.1 &gt; UCP 2.2</li>
  <li>From UCP 2.0: UCP 2.0 &gt; UCP 2.1 &gt; UCP 2.2</li>
</ul>

<h2 id="where-to-go-next">Where to go next</h2>

<ul>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/dtr/admin/upgrade/">Upgrade DTR</a></li>
</ul>

							<!-- tags -->
							
							
							
							<span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span style="vertical-align: 2px"><a href="https://matsuand.github.io/docs.docker.jp.onthefly/search/?q=UCP">UCP</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/search/?q=upgrade">upgrade</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/search/?q=update">update</a></span>
							
							<!-- link corrections -->
              <script language="JavaScript">
							var x = document.links.length;
							var baseHref = document.getElementsByTagName('base')[0].href
							for (i = 0; i < x; i++) {
							  var munged = false;
							  var thisHREF = document.links[i].href;
							  var originalURL = "/ee/ucp/admin/install/upgrade/";
							  if (thisHREF.indexOf(baseHref + "#") > -1) {
							    // hash fix
							    //console.log('BEFORE: base:',baseHref,'thisHREF:',thisHREF,'originalURL:',originalURL);
							    thisHREF = originalURL + thisHREF.replace(baseHref, "");
							    //console.log('AFTER: base:',baseHref,'thisHREF:',thisHREF,'originalURL:',originalURL);
							  }
							  if ((thisHREF.indexOf(window.location.hostname) > -1 || thisHREF.indexOf('http') == -1) && document.links[i].className.indexOf("nomunge") < 0) {
							    munged = true;
							    thisHREF = thisHREF.replace(".md", "/").replace("/index/", "/");
							    document.links[i].setAttribute('href', thisHREF);
							  }
							}
							</script>
							
						  <div id="ratings-div" style="color:#b9c2cc; text-align: center; margin-top: 150px; visibility: hidden">
								<div id="pd_rating_holder_8453675"></div>
								<script type="text/javascript">
									PDRTJS_settings_8453675 = {
										"id": "8453675",
										"unique_id": "ee/ucp/admin/install/upgrade.md",
										"title": "Upgrade to UCP 3.2",
										"permalink": "https://github.com/docker/docker.github.io/blob/master/ee/ucp/admin/install/upgrade.md"
									};
									(function(d, c, j) {
										if (!document.getElementById(j)) {
											var pd = d.createElement(c),
												s;
											pd.id = j;
											pd.src = ('https:' == document.location.protocol) ? 'https://polldaddy.com/js/rating/rating.js' : 'http://i0.poll.fm/js/rating/rating.js';
											s = document.getElementsByTagName(c)[0];
											s.parentNode.insertBefore(pd, s);
										}
									}(document, 'script', 'pd-rating-js'));
								</script>
							</div>
							
						</section>
					</main>
					<nav class="col-nav">
						<div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
						<div id="navbar" class="nav-sidebar">
    <ul class="nav" id="jsTOCLeftNav">
    </ul>
</div>

						</div>
					</nav>
					<div class="col-toc">
							<div class="sidebar hidden-xs hidden-sm">
							<div class="toc-nav">
								<div class="feedback-links">
									<ul>
										
										<li style="visibility: hidden"><a href="https://github.com/matsuand/docs.docker.jp/edit/v19.03.local/ee/ucp/admin/install/upgrade.md"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> このページの編集</a></li>
										<li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/issues/new?body=File: [ee/ucp/admin/install/upgrade.md](https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/install/upgrade/)"
															class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 文書変更のリクエスト</a></li>
										<li><a href="https://success.docker.com/support"><i class="fa fa-question" aria-hidden="true"></i> サポート依頼</a></li>
										<!-- toggle mode -->
										<li>
											<div class="toggle-mode">
												<div class="icon">
													<i class="fa fa-sun-o" aria-hidden="true"></i>
												</div>
												<div class="toggle-switch">
													<label class="switch">
														<input type="checkbox" id="switch-style">
														<div class="slider round"></div>
												</label>
												</div>
												<div class="icon">
													<i class="fa fa-moon-o" aria-hidden="true"></i>
												</div>
											</div>
										</li>
									</ul>
								</div>
								   
									<div id="side-toc-title">本ページ内</div>
									
<ul id="my_toc" class="inline_toc">
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#plan-the-upgrade" class="nomunge">Plan the upgrade</a>
    <ul>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#environment-checklist" class="nomunge">Environment checklist</a></li>
    </ul>
  </li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#back-up-your-cluster" class="nomunge">Back up your cluster</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#upgrade-docker-engine" class="nomunge">Upgrade Docker Engine</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#upgrade-ucp" class="nomunge">Upgrade UCP</a>
    <ul>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#use-the-cli-to-perform-an-upgrade" class="nomunge">Use the CLI to perform an upgrade</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#automated-in-place-cluster-upgrade" class="nomunge">Automated in-place cluster upgrade</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#phased-in-place-cluster-upgrade" class="nomunge">Phased in-place cluster upgrade</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#replace-existing-worker-nodes-using-blue-green-deployment" class="nomunge">Replace existing worker nodes using blue-green deployment</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#troubleshooting" class="nomunge">Troubleshooting</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#recommended-upgrade-paths" class="nomunge">Recommended upgrade paths</a></li>
    </ul>
  </li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/upgrade.md#where-to-go-next" class="nomunge">Where to go next</a></li>
</ul>


								</div>
								
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	
	<footer class="footer">
		  
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/what-docker">What is Docker</a></li>
                        <li><a href="https://www.docker.com/what-container">What is a Container</a></li>
                        <li><a href="https://www.docker.com/use-cases">Use Cases</a></li>
                        <li><a href="https://www.docker.com/customers">Customers</a></li>
                        <li><a href="https://www.docker.com/partners/partner-program">Partners</a></li>
                        <li class="break"><a href="https://www.docker.com/industry-government">For Government</a></li>
                        <li><a href="https://www.docker.com/company">About Docker</a></li>
                        <li><a href="https://www.docker.com/company/management">Management</a></li>
                        <li><a href="https://www.docker.com/company/news-and-press">Press &amp; News</a></li>
                        <li><a href="https://www.docker.com/careers">Careers</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/products/overview">Product</a></li>
                        <li><a href="https://www.docker.com/pricing">Pricing</a></li>
                        <li><a href="https://www.docker.com/docker-community">Community Edition</a></li>
                        <li class="break"><a href="https://www.docker.com/enterprise">Enterprise Edition </a></li>
                        <li><a href="https://www.docker.com/products/docker-datacenter">Docker Datacenter</a></li>
                        <li><a href="https://hub.docker.com/">Docker Hub</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/">Documentation</a></li>
                        <li><a href="https://www.docker.com/docker">Learn</a></li>
                        <li><a href="https://blog.docker.com" target="_blank">Blog</a></li>
                        <li><a href="https://engineering.docker.com" target="_blank">Engineering Blog</a></li>
                        <li><a href="https://training.docker.com/" target="_blank">Training</a></li>
                        <li><a href="https://success.docker.com/support">Support</a></li>
                        <li><a href="https://success.docker.com/kbase">Knowledge Base</a></li>
                        <li><a href="https://www.docker.com/products/resources">Resources</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/docker-community">Community</a></li>
                        <li><a href="https://www.docker.com/technologies/overview">Open Source</a></li>
                        <li><a href="https://www.docker.com/community/events">Events</a></li>
                        <li><a href="https://forums.docker.com/" target="_blank">Forums</a></li>
                        <li><a href="https://www.docker.com/community/docker-captains">Docker Captains</a></li>
                        <li><a href="https://www.docker.com/docker-community/scholarships">Scholarships</a></li>
                        <li><a href="https://blog.docker.com/curated/">Community News</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="http://status.docker.com/">Status</a></li>
                        <li><a href="https://www.docker.com/docker-security">Security</a></li>
                        <li><a href="https://www.docker.com/legal">Legal</a></li>
                        <li><a href="https://www.docker.com/company/contact">Contact</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2019 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="http://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="http://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-reddit"><a href="http://www.reddit.com/r/docker">Reddit</a></li>
                    <li class="fa fa-slideshare"><a href="http://www.slideshare.net/docker">Slideshare</a></li>
                </ul>
            </div>
        </div>
    </div>

	</footer>
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/github.css">
	
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/anchorlinks.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/menu.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/jquery.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
	<!-- Always include the archive.js, but it doesn't do much unless we are an archive -->
	<script language="javascript">
	// Default to assuming this is an archive and hiding some stuff
	// See js/archive.js and js/docs.js for logic relating to this
	var isArchive = true;
	var dockerVersion = 'v19.03';
	// In archives, we need to know the page root and we get it from JEKYLL_ENV in the jekyll build command
	var jekyllEnv = 'development';
	// If unset (in non-archive branches), defaults to "development". In that case, reset it to empty
	if (jekyllEnv == 'development') {
		jekyllEnv = '';
	}
	var pageURL = jekyllEnv + '/ee/ucp/admin/install/upgrade/';
	</script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/archive.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/stickyfill.min.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/metadata.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/glossary.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/docs.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/toc.js"></script>
	<script language="javascript">
	jQuery(document).ready(function(){
				hookupTOCEvents();
			});
	</script>
</body>

</html>
