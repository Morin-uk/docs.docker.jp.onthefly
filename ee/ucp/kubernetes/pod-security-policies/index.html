<!-- Page generated 2020-05-31 22:34:01 +0900 -->
<!-- Logic for 'edit this button'


    

    

    

    

    

    

    

    

-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <style type="text/css">
      @charset "UTF-8";
      [ng\:cloak],
      [ng-cloak],
      [data-ng-cloak],
      [x-ng-cloak],
      .ng-cloak,
      .x-ng-cloak,
      .ng-hide:not(.ng-hide-animate) {
          display: none !important;
      }

      ng\:form {
          display: block;
      }
  </style>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WL2QLG5');</script>

  
  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta name="msapplication-TileImage" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico">
  <link rel="apple-touch-icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta property="og:image" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
  <!-- metadata -->
  <meta property="og:type" content="website"/>
  <meta property="og:updated_time" itemprop="dateUpdated" content="2020-05-31T22:34:01+09:00"/>
  <meta property="og:image" itemprop="image primaryImageOfPage" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:domain" content="docs.docker.com"/>
  <meta name="twitter:site" content="@docker_docs"/>
  <meta name="twitter:url" content="https://twitter.com/docker_docs"/>
  <meta name="twitter:title" itemprop="title name" content="Use Pod Security Policies in UCP"/>
  <meta name="twitter:description" property="og:description" itemprop="description" content="This topic applies to Docker Enterprise. The Docker Enterprise platform business, including products, customers, and employees, has been acquired by Mirantis, inc., effective 13-November-2019. For more information on the acquisition..." />
  <meta name="twitter:image:src" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:image:alt" content="Docker Documentation"/>
  <meta property="article:published_time" itemprop="datePublished" content="2020-05-31T22:34:01+09:00"/>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="UCP, Kubernetes, psps, pod security policies">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/font-awesome.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/bootstrap.min.css">
  <link id="pygments" rel="stylesheet" href="/docs.docker.jp.onthefly/css/pygments/perldoc.css">
  <link id="pagestyle" rel="stylesheet" href="/docs.docker.jp.onthefly/css/style.css">

  <!-- Go get "Open Sans" font from Google -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <!-- SEO stuff -->
  <title>Use Pod Security Policies in UCP | Docker Documentation</title>
  <meta property="og:title" content="Use Pod Security Policies in UCP" />
  <meta property="og:locale" content="ja_JP" />
  <meta name="description" content="Learn how to use Pod Security Policies to lock down Kubernetes as part of Universal Control Plane." />
  <meta property="og:description" content="Learn how to use Pod Security Policies to lock down Kubernetes as part of Universal Control Plane." />
  <link rel="canonical" href="/ee/ucp/kubernetes/pod-security-policies/" />
  <meta property="og:url" content="https://docs.docker.com/ee/ucp/kubernetes/pod-security-policies/" />
  <meta property="og:site_name" content="Docker ドキュメント" />
  <script type="application/ld+json">{"@context":"http://schema.org","@type":"WebPage","headline":"Use Pod Security Policies in UCP","description":"Learn how to use Pod Security Policies to lock down Kubernetes as part of Universal Control Plane.","url":"https://docs.docker.com/ee/ucp/kubernetes/pod-security-policies/"}</script>
  <!-- END SEO STUFF -->
  
  <script>
  // Default to assuming this is an archive and hiding some stuff
  // See js/archive.js and js/docs.js for logic relating to this
  var isArchive = true;
  var dockerVersion = 'v19.03';
  </script>
</head>


    <body ng-app="Docker" ng-controller="DockerController" class="colums">
    <header>
        <nav class="nav-secondary navbar navbar-fixed-top">
    <!-- <div class="fan"></div> -->
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="/docs.docker.jp.onthefly/">
                <img class="logo" src="/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs">
            </a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="logo-mobile">
    <a href="/docs.docker.jp.onthefly/">
        <img src="/docs.docker.jp.onthefly/images/docker-icon.svg" alt="Docker Docs" title="Docker Docs">
    </a>
</div>
<div class="search-form" id="search-div" style="visibility: hidden">
    <form class="search-form form-inline ng-pristine ng-valid" id="searchForm" action="https://matsuand.github.io/docs.docker.jp.onthefly/search/">
        <input class="search-field form-control ds-input" id="st-search-input" value="" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteContainer">
            <div id="autocompleteResults"></div>
        </div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container hidden-sm hidden-xs">
    <div id="tabs">
        <ul class="tabs jsTOCHorizontal">

        </ul>
    </div>
    <div class="ctrl-right">
        <a href="javascript:void(0)" id="menu-toggle"><i class="fa fa-indent" aria-hidden="true"></i></a>
        <div class="btn-group" style="visibility: hidden">
  <button type="button" class="btn btn-default dropdown-btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Docker v19.03 (最新)     <span class="caret"></span>
  </button>
  <ul class="dropdown-menu">
    <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v18.09/">Docker v18.09</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v18.03/">Docker v18.03</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.06/">Docker v17.06</a></li>
  </ul>
</div>

    </div>
</div>

        </div>
    </div>
</nav>

    </header>
    <div class="wrapper right-open">
        <div class="container-fluid">
            <div class="row">
                <div class="col-body">
                    <main class="col-content content">
                        <section class="section">
                            
                            
                            <h1>Use Pod Security Policies in UCP</h1> 
                            <span class="reading-time" title="Estimated reading time">
  <span class="reading-time-label">読む時間の目安: </span>
  
  
    15 分
  
</span>

                            
                            
                            <blockquote>
  <!-- This text will be included on all Docker pages that document Enterprise products, features, and technologies that are transitioning to Mirantis. -->
  <p>This topic applies to Docker Enterprise.</p>

  <p>The Docker Enterprise platform business, including products, customers, and employees, has been acquired by Mirantis, inc., effective 13-November-2019. For more information on the acquisition and how it may affect you and your business, refer to the <a href="https://www.docker.com/faq-for-docker-enterprise-customers-and-partners">Docker Enterprise Customer FAQ</a>.</p>
</blockquote>

<p>Pod Security Policies (PSPs) are cluster-level resources which are enabled by
default in Docker Universal Control Plane (UCP) 3.2. See <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">Pod Security
Policy</a> for an
explanation of this Kubernetes concept.</p>

<p>There are two default PSPs in UCP: a <code class="highlighter-rouge">privileged</code> policy and an <code class="highlighter-rouge">unprivileged</code>
policy. Administrators of the cluster can enforce additional policies and apply
them to users and teams for further control of what runs in the Kubernetes
cluster. This guide describes the two default policies, and provides two
example use cases for custom policies.</p>

<h2 id="kubernetes-role-based-access-control-rbac">Kubernetes Role Based Access Control (RBAC)</h2>

<p>To interact with PSPs, a user will need to be granted access to the
<code class="highlighter-rouge">PodSecurityPolicy</code> object in Kubernetes RBAC. If the user is a <code class="highlighter-rouge">UCP Admin</code>,
then the user can  already manipulate PSPs. A normal user can interact with
policies if a UCP admin creates the following <code class="highlighter-rouge">ClusterRole</code> and
<code class="highlighter-rouge">ClusterRoleBinding</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat &lt;&lt;EOF | kubectl create -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: psp-admin
rules:
- apiGroups:
  - extensions
  resources:
  - podsecuritypolicies
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
EOF

$ USER=jeff

$ cat &lt;&lt;EOF | kubectl create -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: psp-admin:$USER
roleRef:
  kind: ClusterRole
  name: psp-admin
  apiGroup: rbac.authorization.k8s.io
subjects:
- kind: User
  name: $USER
EOF
</code></pre></div></div>

<h2 id="default-pod-security-policies-in-ucp">Default pod security policies in UCP</h2>

<p>By default, there are two policies defined within UCP, <code class="highlighter-rouge">privileged</code> and
<code class="highlighter-rouge">unprivileged</code>. Additionally, there is a <code class="highlighter-rouge">ClusterRoleBinding</code> that gives every
single user access to the privileged policy. This is for backward compatibility
after an upgrade. By default, any user can create any pod.</p>

<blockquote>
  <p>Note: PSPs do not override security defaults built into the
UCP RBAC engine for Kubernetes pods. These <a href="/ee/ucp/authorization/">Security
defaults</a> prevent non-admin
users from mounting host paths into pods or starting privileged pods.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get podsecuritypolicies
NAME           PRIV    CAPS   SELINUX    RUNASUSER   FSGROUP    SUPGROUP   READONLYROOTFS   VOLUMES
privileged     <span class="nb">true</span>    <span class="k">*</span>      RunAsAny   RunAsAny    RunAsAny   RunAsAny   <span class="nb">false</span>            <span class="k">*</span>
unprivileged   <span class="nb">false          </span>RunAsAny   RunAsAny    RunAsAny   RunAsAny   <span class="nb">false</span>            <span class="k">*</span>
</code></pre></div></div>

<p>The specification for the <code class="highlighter-rouge">privileged</code> policy is as follows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  allowPrivilegeEscalation: true
  allowedCapabilities:
  - '*'
  fsGroup:
    rule: RunAsAny
  hostIPC: true
  hostNetwork: true
  hostPID: true
  hostPorts:
  - max: 65535
    min: 0
  privileged: true
  runAsUser:
    rule: RunAsAny
  seLinux:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  volumes:
  - '*'
</code></pre></div></div>

<p>The specification for the <code class="highlighter-rouge">unprivileged</code> policy is as follows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  allowPrivilegeEscalation: false
  allowedHostPaths:
  - pathPrefix: /dev/null
    readOnly: true
  fsGroup:
    rule: RunAsAny
  hostPorts:
  - max: 65535
    min: 0
  runAsUser:
    rule: RunAsAny
  seLinux:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  volumes:
  - '*'
</code></pre></div></div>

<h2 id="use-the-unprivileged-policy">Use the unprivileged policy</h2>

<blockquote>
  <p>Note: When following this guide, if the prompt <code class="highlighter-rouge">$</code> follows <code class="highlighter-rouge">admin</code>, the action
needs to be performed by a user with access to create pod security policies as
discussed in <a href="#kubernetes-role-based-access-control">the Kubernetes RBAC section</a>. If the prompt <code class="highlighter-rouge">$</code>
follows <code class="highlighter-rouge">user</code>, the UCP account does not need access to the PSP
object in Kubernetes. The user only needs the ability to create Kubernetes pods.</p>

</blockquote>

<p>To switch users from the <code class="highlighter-rouge">privileged</code> policy to the <code class="highlighter-rouge">unprivileged</code> policy (or
any custom policy), an admin must first remove the <code class="highlighter-rouge">ClusterRoleBinding</code> that
links all users and service accounts to the <code class="highlighter-rouge">privileged</code> policy.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin $ kubectl delete clusterrolebindings ucp:all:privileged-psp-role
</code></pre></div></div>

<p>When the <code class="highlighter-rouge">ClusterRoleBinding</code> is removed, cluster admins can still deploy pods,
and these pods are deployed with the <code class="highlighter-rouge">privileged</code> policy. But users or service
accounts are unable to deploy pods, because Kubernetes does not know what pod
security policy to apply. Note cluster admins would not be able to deploy
deployments, see <a href="#using-the-unprivileged-policy-in-a-deployment">using the unprivileged policy in a
deployment</a> for more details.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user <span class="nv">$ </span>kubectl apply <span class="nt">-f</span> pod.yaml
Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: error when creating <span class="s2">"pod.yaml"</span>: pods <span class="s2">"demopod"</span> is forbidden: unable to validate against any pod security policy: <span class="o">[]</span>
</code></pre></div></div>

<p>Therefore, to allow a user or a service account to use the <code class="highlighter-rouge">unprivileged</code> policy
(or any custom policy), you must create a <code class="highlighter-rouge">RoleBinding</code> to link that user or
team with the alternative policy. For the <code class="highlighter-rouge">unprivileged</code> policy, a <code class="highlighter-rouge">ClusterRole</code>
has already been defined, but has not been attached to a user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># List Existing Cluster Roles</span>
admin <span class="nv">$ </span>kubectl get clusterrole | <span class="nb">grep </span>psp
privileged-psp-role                                                    3h47m
unprivileged-psp-role                                                  3h47m

<span class="c"># Define which user to apply the ClusterRole too</span>
admin <span class="nv">$ USER</span><span class="o">=</span>jeff

<span class="c"># Create a RoleBinding linking the ClusterRole to the User</span>
admin <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: unprivileged-psp-role:</span><span class="nv">$USER</span><span class="sh">
  namespace: default
roleRef:
  kind: ClusterRole
  name: unprivileged-psp-role
  apiGroup: rbac.authorization.k8s.io
subjects:
- kind: User
  name: </span><span class="nv">$USER</span><span class="sh">
  namespace: default
</span><span class="no">EOF
</span></code></pre></div></div>

<p>In the following example, when user “jeff” deploys a basic <code class="highlighter-rouge">nginx</code> pod, the <code class="highlighter-rouge">unprivileged</code> policy
then gets applied.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: Pod
metadata:
  name: demopod
spec:
  containers:
    - name:  demopod
      image: nginx
</span><span class="no">EOF

</span>user <span class="nv">$ </span>kubectl get pods
NAME      READY   STATUS    RESTARTS   AGE
demopod   1/1     Running   0          10m
</code></pre></div></div>

<p>To check which PSP is applied to a pod, you can get a detailed
view of the pod spec using the <code class="highlighter-rouge">-o yaml</code> or <code class="highlighter-rouge">-o json</code> syntax with <code class="highlighter-rouge">kubectl</code>. You
can parse JSON output with <a href="https://stedolan.github.io/jq/">jq</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user <span class="nv">$ </span>kubectl get pods demopod <span class="nt">-o</span> json | jq <span class="nt">-r</span> <span class="s1">'.metadata.annotations."kubernetes.io/psp"'</span>
unprivileged
</code></pre></div></div>

<h3 id="using-the-unprivileged-policy-in-a-deployment">Using the unprivileged policy in a deployment</h3>

<blockquote>
  <p>Note: In a most use cases a Pod is not actually scheduled by a user. When
creating Kubernetes objects such as Deployments or Daemonsets the pods are
being scheduled by a service account or a controller.</p>
</blockquote>

<p>If you have disabled the <code class="highlighter-rouge">privileged</code> PSP policy, and created a <code class="highlighter-rouge">RoleBinding</code>
to map a user to a new PSP policy, Kubernetes objects like Deployments and
Daemonsets will not be able to deploy pods. This is because Kubernetes objects,
like Deployments, use a <code class="highlighter-rouge">Service Account</code> to schedule pods, instead of the user
that created the Deployment.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user <span class="nv">$ </span>kubectl get deployments
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
nginx   0/1     0            0           88s

user <span class="nv">$ </span>kubectl get replicasets
NAME              DESIRED   CURRENT   READY   AGE
nginx-cdcdd9f5c   1         0         0       92s

user <span class="nv">$ </span>kubectl describe replicasets nginx-cdcdd9f5c
...
  Warning  FailedCreate  48s <span class="o">(</span>x15 over 2m10s<span class="o">)</span>  replicaset-controller  Error creating: pods <span class="s2">"nginx-cdcdd9f5c-"</span> is forbidden: unable to validate against any pod security policy: <span class="o">[]</span>
</code></pre></div></div>

<p>For this deployment to be able to schedule pods, the service account defined
wthin the deployment specification needs to be associated with a PSP policy.
If a service account is not defined within a deployment spec, the default
service account in a namespace is used.</p>

<p>This is the case in the deployment output above, there is no service account
defined, therefore a <code class="highlighter-rouge">Rolebinding</code> to grant the default service account in the
default namespace to use PSP policy is needed.</p>

<p>An example <code class="highlighter-rouge">RoleBinding</code> to associate the <code class="highlighter-rouge">unprivileged</code> PSP policy in UCP with
the defaut service account in the default namespace is:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: unprivileged-psp-role:defaultsa
  namespace: default
roleRef:
  kind: ClusterRole
  name: unprivileged-psp-role
  apiGroup: rbac.authorization.k8s.io
subjects:
- kind: ServiceAccount
  name: default
  namespace: default
</span><span class="no">EOF
</span></code></pre></div></div>

<p>This should allow the replica set to schedule pods within the cluster:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user <span class="nv">$ </span>kubectl get deployments
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
nginx   1/1     1            1           6m11s

user <span class="nv">$ </span>kubectl get replicasets
NAME              DESIRED   CURRENT   READY   AGE
nginx-cdcdd9f5c   1         1         1       6m16s

user <span class="nv">$ </span>kubectl get pods
NAME                    READY   STATUS    RESTARTS   AGE
nginx-cdcdd9f5c-9kknc   1/1     Running   0          6m17s

user <span class="nv">$ </span>kubectl get pod nginx-cdcdd9f5c-9kknc  <span class="nt">-o</span> json | jq <span class="nt">-r</span> <span class="s1">'.metadata.annotations."kubernetes.io/psp"'</span>
unprivileged
</code></pre></div></div>

<h3 id="applying-the-unprivileged-psp-policy-to-a-namespace">Applying the unprivileged PSP policy to a namespace</h3>

<p>A common use case when using PSPs is to apply a particular policy to one
namespace, but not configure the rest. An example could be where an admin
might be want to configure keep the <code class="highlighter-rouge">privileged</code> policy for all of the
infrastructure namespaces but configure the <code class="highlighter-rouge">unprivileged</code> policy for the
end user namespaces. This can be done with the following example:</p>

<p>In this demonstration cluster, infrastructure workloads are deployed in the
<code class="highlighter-rouge">kube-system</code> and the <code class="highlighter-rouge">monitoring</code> namespaces. End User workloads are deployed
in the <code class="highlighter-rouge">default</code> namespace.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin <span class="nv">$ </span>kubectl get namespaces
NAME              STATUS   AGE
default           Active   3d
kube-node-lease   Active   3d
kube-public       Active   3d
kube-system       Active   3d
monitoring        Active   3d
</code></pre></div></div>

<p>First, delete the <code class="highlighter-rouge">ClusterRoleBinding</code> that is applied by default in UCP.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin <span class="nv">$ </span>kubectl delete clusterrolebindings ucp:all:privileged-psp-role
</code></pre></div></div>

<p>Next, create a new <code class="highlighter-rouge">ClusterRoleBinding</code> that will enforce the <code class="highlighter-rouge">privileged</code> PSP
policy for all users and service accounts in the <code class="highlighter-rouge">kube-system</code> and <code class="highlighter-rouge">monitoring</code>
namespaces, where in this example cluster the infrastructure workloads are
deployed.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ucp:infrastructure:privileged-psp-role
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: privileged-psp-role
subjects:
- kind: Group
  name: system:authenticated:kube-system
  apiGroup: rbac.authorization.k8s.io
- kind: Group
  name: system:authenticated:monitoring
  apiGroup: rbac.authorization.k8s.io
- kind: Group
  name: system:serviceaccounts:kube-system
  apiGroup: rbac.authorization.k8s.io
- kind: Group
  name: system:serviceaccounts:monitoring
  apiGroup: rbac.authorization.k8s.io
</span><span class="no">EOF
</span></code></pre></div></div>

<p>Finally, create a <code class="highlighter-rouge">ClusterRoleBinding</code> to allow all users who deploy pods and
deployments in the <code class="highlighter-rouge">default</code> namespace to use the <code class="highlighter-rouge">unprivileged</code> policy.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ucp:default:unprivileged-psp-role
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: unprivileged-psp-role
subjects:
- kind: Group
  name: system:authenticated:default
  apiGroup: rbac.authorization.k8s.io
- kind: Group
  name: system:serviceaccounts:default
  apiGroup: rbac.authorization.k8s.io
</span><span class="no">EOF
</span></code></pre></div></div>

<p>Now when the user deploys in the <code class="highlighter-rouge">default</code> namespace they will get the
<code class="highlighter-rouge">unprivileged</code> policy but when they deploy in the monitoring namespace they
will get the <code class="highlighter-rouge">privileged</code> policy.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: Pod
metadata:
  name: demopod
  namespace: monitoring
spec:
  containers:
    - name:  demopod
      image: nginx
---
apiVersion: v1
kind: Pod
metadata:
  name: demopod
  namespace: default
spec:
  containers:
    - name:  demopod
      image: nginx
</span><span class="no">EOF
</span></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user <span class="nv">$ </span>kubectl get pods demopod <span class="nt">-n</span> monitoring <span class="nt">-o</span> json | jq <span class="nt">-r</span> <span class="s1">'.metadata.annotations."kubernetes.io/psp"'</span>
privileged

user <span class="nv">$ </span>kubectl get pods demopod <span class="nt">-n</span> default <span class="nt">-o</span> json | jq <span class="nt">-r</span> <span class="s1">'.metadata.annotations."kubernetes.io/psp"'</span>
unprivileged
</code></pre></div></div>

<h2 id="reenable-the-privileged-psp-for-all-users">Reenable the privileged PSP for all users</h2>

<p>To revert to the default UCP configuration, in which all UCP users and service
accounts use the <code class="highlighter-rouge">privileged</code> PSP, recreate the default
<code class="highlighter-rouge">ClusterRoleBinding</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ucp:all:privileged-psp-role
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: privileged-psp-role
subjects:
- kind: Group
  name: system:authenticated
  apiGroup: rbac.authorization.k8s.io
- kind: Group
  name: system:serviceaccounts
  apiGroup: rbac.authorization.k8s.io
</span><span class="no">EOF
</span></code></pre></div></div>

<h2 id="psp-examples">PSP examples</h2>

<p>UCP admins or users with the <a href="#kubernetes-role-based-access-control">correct
permissions</a> can create their own custom
policies and attach them to UCP users or teams. This section highlights two
potential use cases for custom PSPs. These two uses cases can be combined into
the same policy. Note there are many more use cases with PSPs not covered in
this document.</p>

<ul>
  <li>
    <p>Preventing containers that start as the Root User</p>
  </li>
  <li>
    <p>Applying default seccomp policies to all Kubernetes Pods.</p>
  </li>
</ul>

<p>For the full list of parameters that can be configured in a PSP,
see the <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">Kubernetes
documentation</a>.</p>

<h3 id="example-1-use-a-psp-to-enforce-no-root-users">Example 1: Use a PSP to enforce “no root users”</h3>

<p>A common use case for PSPs is to prevent a user from deploying
containers that run with the root user. A PSP can be created to
enforce this with the parameter <code class="highlighter-rouge">MustRunAsNonRoot</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: extensions/v1beta1
kind: PodSecurityPolicy
metadata:
  name: norootcontainers
spec:
  allowPrivilegeEscalation: false
  allowedHostPaths:
  - pathPrefix: /dev/null
    readOnly: true
  fsGroup:
    rule: RunAsAny
  hostPorts:
  - max: 65535
    min: 0
  runAsUser:
    rule: MustRunAsNonRoot
  seLinux:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  volumes:
  - '*'
</span><span class="no">EOF
</span></code></pre></div></div>

<p>If not done previously, the admin user must remove the <code class="highlighter-rouge">ClusterRoleBinding</code>
for the <code class="highlighter-rouge">privileged</code> policy, and then add a new <code class="highlighter-rouge">ClusterRole</code> and <code class="highlighter-rouge">RoleBinding</code>
to link a user to the new <code class="highlighter-rouge">norootcontainers</code> policy.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Delete the default privileged ClusterRoleBinding</span>
admin <span class="nv">$ </span>kubectl delete clusterrolebindings ucp:all:privileged-psp-role

<span class="c"># Create a ClusterRole Granting Access to the Policy</span>
admin <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: norootcontainers-psp-role
rules:
- apiGroups:
  - policy
  resourceNames:
  - norootcontainers
  resources:
  - podsecuritypolicies
  verbs:
  - use
</span><span class="no">EOF

</span><span class="c"># Define a User to attach to the No Root Policy</span>
admin <span class="nv">$ USER</span><span class="o">=</span>jeff

<span class="c"># Create a RoleBinding attaching the User to the ClusterRole</span>
admin <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: norootcontainers-psp-role:</span><span class="nv">$USER</span><span class="sh">
  namespace: default
roleRef:
  kind: ClusterRole
  name: norootcontainers-psp-role
  apiGroup: rbac.authorization.k8s.io
subjects:
- kind: User
  name: </span><span class="nv">$USER</span><span class="sh">
  namespace: default
</span><span class="no">EOF
</span></code></pre></div></div>

<p>If a user tries to deploy a pod that runs as a root user, such as the upstream
<code class="highlighter-rouge">nginx</code> image, this should fail with a <code class="highlighter-rouge">ConfigError</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: Pod
metadata:
  name: demopod
spec:
  containers:
    - name:  demopod
      image: nginx
</span><span class="no">EOF

</span>user <span class="nv">$ </span>kubectl get pods
NAME      READY   STATUS                       RESTARTS   AGE
demopod   0/1     CreateContainerConfigError   0          37s

user <span class="nv">$ </span>kubectl describe pods demopod
&lt;..&gt;
 Error: container has runAsNonRoot and image will run as root
</code></pre></div></div>

<h3 id="example-2-use-a-psp-to-apply-seccomp-policies">Example 2: Use a PSP to apply seccomp policies</h3>

<p>A second use case for PSPs is to prevent a user from deploying
containers without a <a href="https://docs.docker.com/engine/security/seccomp/">seccomp
policy</a>. By default,
Kubernetes does not apply a seccomp policy to pods, so a default seccomp policy
could be applied for all pods by a PSP.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: extensions/v1beta1
kind: PodSecurityPolicy
metadata:
  name: seccomppolicy
  annotations:
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: 'docker/default'
    seccomp.security.alpha.kubernetes.io/defaultProfileName:  'docker/default'
spec:
  allowPrivilegeEscalation: false
  allowedHostPaths:
  - pathPrefix: /dev/null
    readOnly: true
  fsGroup:
    rule: RunAsAny
  hostPorts:
  - max: 65535
    min: 0
  runAsUser:
    rule: RunAsAny
  seLinux:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  volumes:
  - '*'
</span><span class="no">EOF
</span></code></pre></div></div>

<p>If not done previously, the admin user must remove the <code class="highlighter-rouge">ClusterRoleBinding</code>
for the <code class="highlighter-rouge">privileged</code> policy, and then add a new <code class="highlighter-rouge">ClusterRole</code> and <code class="highlighter-rouge">RoleBinding</code>
to link a user to the new <code class="highlighter-rouge">applyseccompprofile</code> policy.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Delete the default privileged ClusterRoleBinding</span>
admin <span class="nv">$ </span>kubectl delete clusterrolebindings ucp:all:privileged-psp-role

<span class="c"># Create a ClusterRole Granting Access to the Policy</span>
admin <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: applyseccompprofile-psp-role
rules:
- apiGroups:
  - policy
  resourceNames:
  - seccomppolicy
  resources:
  - podsecuritypolicies
  verbs:
  - use
</span><span class="no">EOF

</span><span class="c"># Define a User to attach to the No Root Policy</span>
admin <span class="nv">$ USER</span><span class="o">=</span>jeff

<span class="c"># Create a RoleBinding attaching the User to the ClusterRole</span>
admin <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: applyseccompprofile-psp-role:</span><span class="nv">$USER</span><span class="sh">
  namespace: default
roleRef:
  kind: ClusterRole
  name: applyseccompprofile-psp-role
  apiGroup: rbac.authorization.k8s.io
subjects:
- kind: User
  name: </span><span class="nv">$USER</span><span class="sh">
  namespace: default
</span><span class="no">EOF
</span></code></pre></div></div>

<p>As shown in the following example, if a user tries to deploy an <code class="highlighter-rouge">nginx</code> pod without applying
a seccomp policy as the pod metadata, Kubernetes automatically applies a policy for the user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user <span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
apiVersion: v1
kind: Pod
metadata:
  name: demopod
spec:
  containers:
    - name:  demopod
      image: nginx
</span><span class="no">EOF

</span>user <span class="nv">$ </span>kubectl get pods
NAME      READY   STATUS    RESTARTS   AGE
demopod   1/1     Running   0          16s

user <span class="nv">$ </span>kubectl get pods demopod <span class="nt">-o</span> json | jq <span class="s1">'.metadata.annotations."seccomp.security.alpha.kubernetes.io/pod"'</span>
<span class="s2">"docker/default"</span>
</code></pre></div></div>

                            <!-- tags -->
                            
                            <span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span
                                style="vertical-align: 2px"><a
                                    href="https://docs.docker.com/search/?q=UCP">UCP</a>, <a
                                    href="https://docs.docker.com/search/?q=Kubernetes">Kubernetes</a>, <a
                                    href="https://docs.docker.com/search/?q=psps">psps</a>, <a
                                    href="https://docs.docker.com/search/?q=pod security policies">pod security policies</a></span>
                            
                            
                            <div id="ratings-div"
                                style="color:#b9c2cc; text-align: center; margin-top: 150px; visibility: hidden">
                                <div id="pd_rating_holder_8453675"></div>
                                <script type="text/javascript">
                                    PDRTJS_settings_8453675 = {
                                        "id": "8453675",
                                        "unique_id": "ee/ucp/kubernetes/pod-security-policies.md",
                                        "title": "Use Pod Security Policies in UCP",
                                        "permalink": "https://github.com/docker/docker.github.io/blob/master/ee/ucp/kubernetes/pod-security-policies.md"
                                    };
                                    (function (d, c, j) {
                                        if (!document.getElementById(j)) {
                                            var pd = d.createElement(c),
                                                s;
                                            pd.id = j;
                                            pd.src = ('https:' == document.location.protocol) ? 'https://polldaddy.com/js/rating/rating.js' : 'http://i0.poll.fm/js/rating/rating.js';
                                            s = document.getElementsByTagName(c)[0];
                                            s.parentNode.insertBefore(pd, s);
                                        }
                                    }(document, 'script', 'pd-rating-js'));
                                </script>
                            </div>
                            
                        </section>
                    </main>
                    <nav class="col-nav">
                        <div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
                            <div id="navbar" class="nav-sidebar">
    <ul class="nav jsTOCHorizontal hidden-md hidden-lg">
    </ul>
    <div class="divider hidden-md hidden-lg"></div>
    <ul class="nav" id="jsTOCLeftNav">
    </ul>
</div>

                        </div>
                    </nav>
                    <div class="col-toc">
                        <div class="sidebar hidden-xs hidden-sm">
                            <div class="toc-nav">
                                <div class="feedback-links">
                                    <ul>
                                        
                                        <li style="visibility: hidden"><a href="https://github.com/matsuand/docs.docker.jp/edit/v19.03.local/ee/ucp/kubernetes/pod-security-policies.md"><i
                                                    class="fa fa-pencil-square-o" aria-hidden="true"></i> このページの編集</a></li>
                                        <li><a href="https://github.com/matsuand/docs.docker.jp/issues/new?body=ファイル: [ee/ucp/kubernetes/pod-security-policies.md](https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/kubernetes/pod-security-policies/)"
                                                class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 文書変更のリクエスト</a></li>
                                        <!-- toggle mode -->
                                        <li>
                                            <div class="toggle-mode">
                                                <div class="icon">
                                                    <i class="fa fa-sun-o" aria-hidden="true"></i>
                                                </div>
                                                <div class="toggle-switch">
                                                    <label class="switch">
                                                        <input type="checkbox" id="switch-style">
                                                        <div class="slider round"></div>
                                                    </label>
                                                </div>
                                                <div class="icon">
                                                    <i class="fa fa-moon-o" aria-hidden="true"></i>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                
                                
                                
                                
                                <div id="side-toc-title">本ページ内:</div>
                                
<ul id="my_toc" class="inline_toc">
  <li><a href="#kubernetes-role-based-access-control-rbac" class="nomunge">Kubernetes Role Based Access Control (RBAC)</a></li>
  <li><a href="#default-pod-security-policies-in-ucp" class="nomunge">Default pod security policies in UCP</a></li>
  <li><a href="#use-the-unprivileged-policy" class="nomunge">Use the unprivileged policy</a>
    <ul>
      <li><a href="#using-the-unprivileged-policy-in-a-deployment" class="nomunge">Using the unprivileged policy in a deployment</a></li>
      <li><a href="#applying-the-unprivileged-psp-policy-to-a-namespace" class="nomunge">Applying the unprivileged PSP policy to a namespace</a></li>
    </ul>
  </li>
  <li><a href="#reenable-the-privileged-psp-for-all-users" class="nomunge">Reenable the privileged PSP for all users</a></li>
  <li><a href="#psp-examples" class="nomunge">PSP examples</a>
    <ul>
      <li><a href="#example-1-use-a-psp-to-enforce-no-root-users" class="nomunge">Example 1: Use a PSP to enforce “no root users”</a></li>
      <li><a href="#example-2-use-a-psp-to-apply-seccomp-policies" class="nomunge">Example 2: Use a PSP to apply seccomp policies</a></li>
    </ul>
  </li>
</ul>


                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <footer class="footer">
          
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/why-docker">Why Docker</a></b></li>
                        <li><a href="https://www.docker.com/what-container">What is a Container</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/overview">Products</a></b></li>
                        <li><a href="https://www.docker.com/products/docker-desktop">Docker Desktop</a></li>
                        <li><a href="https://www.docker.com/products/docker-hub">Docker Hub</a></li>
                        <li><b><a href="https://www.docker.com/products/docker-desktop">Features</a></b></li>
                        <li><a href="https://www.docker.com/products/container-runtime">Container Runtime</a></li>
                        <li><a href="https://www.docker.com/products/developer-tools">Developer Tools</a></li>
                        <li><a href="https://www.docker.com/products/kubernetes">Kubernetes</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop">Developers</a></b></li>
                        <li><a href="https://www.docker.com/use-cases">Use Cases</a></li>
                        <li><a href="https://www.docker.com/play-with-docker">Play with Docker</a></li>
                        <li><a href="https://www.docker.com/docker-community">Community</a></li>
                        <li><a href="https://www.docker.com/open-source">Open Source</a></li>
                        <li><a href="https://www.docker.com/community/docker-captains">Docker Captains</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/company" target="_blank">Company</a></b></li>
                        <li><a href="https://www.docker.com/company">About Us</a></li>
                        <li><a href="https://www.docker.com/blog/" target="_blank">Blog</a></li>
                        <li><a href="https://www.docker.com/customers">Customers</a></li>
                        <li><a href="https://www.docker.com/partners">Partners</a></li>
                        <li><a href="https://www.docker.com/company/newsroom">Newsroom</a></li>
                        <li><a href="https://www.docker.com/careers">Careers</a></li>
                        <li><a href="https://www.docker.com/company/contact">Contact Us</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="http://status.docker.com/">Status</a></li>
                        <li><a href="https://www.docker.com/docker-security">Security</a></li>
                        <li><a href="https://www.docker.com/legal">Legal</a></li>
                        <li><a href="https://www.docker.com/company/contact">Contact</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2013-2020 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="http://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="http://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-slideshare"><a href="https://www.slideshare.net/docker">Slideshare</a></li>
                    <li class="fa fa-reddit"><a href="https://www.reddit.com/r/docker">Reddit</a></li>
                </ul>
            </div>
        </div>
    </div>

    </footer>
    <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/github.css">
    
    <script defer src="/docs.docker.jp.onthefly/js/anchorlinks.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/menu.js"></script>
    <script src="/docs.docker.jp.onthefly/js/jquery.js"></script>
    <script src="/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
    <!-- Always include the archive.js, but it doesn't do much unless we are an archive -->
    <script>
        // Default to assuming this is an archive and hiding some stuff
        // See js/archive.js and js/docs.js for logic relating to this
        var isArchive = true;
        var dockerVersion = 'v19.03';
        // In archives, we need to know the page root and we get it from JEKYLL_ENV in the jekyll build command
        var jekyllEnv = 'development';
        // If unset (in non-archive branches), defaults to "development". In that case, reset it to empty
        if (jekyllEnv === 'development') {
            jekyllEnv = '';
        }
        var pageURL = jekyllEnv + '/ee/ucp/kubernetes/pod-security-policies/';
    </script>
    <script src="/docs.docker.jp.onthefly/js/archive.js"></script>
    <script src="/docs.docker.jp.onthefly/js/stickyfill.min.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/metadata.js"></script>
    <script src="/docs.docker.jp.onthefly/js/glossary.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/docs.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/toc.js"></script>
    <script defer src="/js/search.js"></script>
</body>


</html>
