<!-- Page generated 2020-03-11 14:21:27 +0900 -->
<!-- relative link basehrefs -->

	
	
	
		
			
		
	
		
			
		
	
		
			
			


<!-- Logic for 'edit this button' -->


	

	

	

	

	

	

	

	

	


<!-- End of logic for 'edit this button' -->


<!DOCTYPE html>
<html lang="ja">

<head>
	<base href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/admin/" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<style type="text/css">
		@charset "UTF-8";
		[ng\:cloak],
		[ng-cloak],
		[data-ng-cloak],
		[x-ng-cloak],
		.ng-cloak,
		.x-ng-cloak,
		.ng-hide:not(.ng-hide-animate) {
			display: none !important;
		}

		ng\:form {
			display: block;
		}
	</style>
	<!-- Google Tag Manager -->
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-WL2QLG5');</script>
	<!-- End Google Tag Manager -->
	
	<!-- favicon -->
	<link rel="icon" type="image/x-icon" href="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
	<meta name="msapplication-TileImage" content="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico">
	<link rel="apple-touch-icon" type="image/x-icon" href="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
	<meta property="og:image" content="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
	<!-- metadata -->
	<meta property="og:type" content="website"/>
	<meta property="og:updated_time" itemprop="dateUpdated" content="2020-03-11T14:21:27+09:00"/>
	<meta property="og:image" itemprop="image primaryImageOfPage" content="https://matsuand.github.io/docs.docker.jp.onthefly/images/docs@2x.png"/>
	<meta name="twitter:card" content="summary"/>
	<meta name="twitter:domain" content="docs.docker.jp"/>
	<meta name="twitter:site" content="@docker_docs"/>
	<meta name="twitter:url" content="https://twitter.com/docker_docs"/>
	<meta name="twitter:title" itemprop="title name" content="Disaster recovery"/>
	<meta name="twitter:description" property="og:description" itemprop="description" content="Disaster recovery procedures should be performed in the following order: Docker Swarm. Universal Control Plane (UCP). Docker Trusted Registry (DTR). Swarm disaster recovery Recover from losing the quorum Swarm is..." />
	<meta name="twitter:image:src" content="https://matsuand.github.io/docs.docker.jp.onthefly/images/docs@2x.png"/>
	<meta name="twitter:image:alt" content="Docker ドキュメント"/>
	<meta property="article:published_time" itemprop="datePublished" content="2020-03-11T14:21:27+09:00"/>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="keywords" content="enterprise, recovery, disaster recovery, dtr, ucp, swarm">
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/bootstrap.min.css">
	<link id="pygments" rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/pygments/perldoc.css">
	<link id="pagestyle" rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/style.css">

	<!-- Go get "Open Sans" font from Google -->
	<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
	<!-- SEO stuff -->
	<title>Disaster recovery | Docker ドキュメント</title>
<meta property="og:title" content="Disaster recovery" />
<meta property="og:locale" content="ja_JP" />
<meta name="description" content="Learn disaster recovery procedures for Docker Enterprise" />
<meta property="og:description" content="Learn disaster recovery procedures for Docker Enterprise" />
<link rel="canonical" href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/admin/disaster-recovery/" />
<meta property="og:url" content="https://matsuand.github.io/docs.docker.jp.onthefly/ee/admin/disaster-recovery/" />
<meta property="og:site_name" content="Docker ドキュメント" />
<script type="application/ld+json">
{"@context":"http://schema.org","@type":"WebPage","headline":"Disaster recovery","description":"Learn disaster recovery procedures for Docker Enterprise","url":"https://matsuand.github.io/docs.docker.jp.onthefly/ee/admin/disaster-recovery/"}</script>
	<!-- END SEO STUFF -->
	
	<script language="javascript">
	// Default to assuming this is an archive and hiding some stuff
	// See js/archive.js and js/docs.js for logic relating to this
	var isArchive = true;
	var dockerVersion = 'v19.03';
	</script>
</head>
<body ng-app="Docker" ng-controller="DockerController" class="colums">
	<header>
		 <nav class="nav-secondary navbar navbar-fixed-top">
    <!-- <div class="fan"></div> -->
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="https://matsuand.github.io/docs.docker.jp.onthefly/"><img class="logo" src="https://matsuand.github.io/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs"></a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="search-form" id="search-div" style="visibility: hidden">
    <form class="search-form form-inline ng-pristine ng-valid" id="searchForm" action="https://matsuand.github.io/docs.docker.jp.onthefly/search/">
        <input class="search-field form-control ds-input" id="st-search-input" value="" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteContainer">
            <div id="autocompleteResults"></div>
        </div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container">
    <div id="tabs">
        <ul class="tabs" id="jsTOCHorizontal">

        </ul>
    </div>
    <div class="ctrl-right hidden-xs hidden-sm">
        <a href="javascript:void(0)" id="menu-toggle"><i class="fa fa-indent" aria-hidden="true"></i></a>
        <div class="btn-group" style="visibility: hidden">
  <button type="button" class="btn btn-default dropdown-btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Docker v19.03 (current)     <span class="caret"></span>
  </button>
  <ul class="dropdown-menu">
    <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v18.09/">Docker v18.09</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v18.03/">Docker v18.03</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.06/">Docker v17.06</a></li>
  </ul>
</div>

    </div>
</div>

        </div>
    </div>
</nav>

	</header>

	<div class="wrapper right-open">
		<div class="container-fluid">
			<div class="row">
				<div class="col-body">
					<main class="col-content content">
						<section class="section">
							
								
							<h1>Disaster recovery</h1>  <span class="reading-time" title="Estimated reading time">
  <span class="reading-time-label">読む時間の目安: </span>
  
  
    15 分
  
</span>

							
							
							<p>Disaster recovery procedures should be performed in the following order:</p>

<ol>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/disaster-recovery.md#swarm-disaster-recovery">Docker Swarm</a>.</li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/disaster-recovery.md#ucp-disaster-recovery">Universal Control Plane (UCP)</a>.</li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/disaster-recovery.md#dtr-disaster-recovery">Docker Trusted Registry (DTR)</a>.</li>
</ol>

<h2 id="swarm-disaster-recovery">Swarm disaster recovery</h2>

<h3 id="recover-from-losing-the-quorum">Recover from losing the quorum</h3>

<p>Swarm is resilient to failures and the swarm can recover from any number
of temporary node failures (machine reboots or crash with restart) or other
transient errors. However, a swarm cannot automatically recover if it loses a
quorum. Tasks on existing worker nodes continue to run, but administrative
tasks are not possible, including scaling or updating services and joining or
removing nodes from the swarm. The best way to recover is to bring the missing
manager nodes back online. If that is not possible, continue reading for some
options for recovering your swarm.</p>

<p>In a swarm of <code class="highlighter-rouge">N</code> managers, a quorum (a majority) of manager nodes must always
be available. For example, in a swarm with 5 managers, a minimum of 3 must be
operational and in communication with each other. In other words, the swarm can
tolerate up to <code class="highlighter-rouge">(N-1)/2</code> permanent failures beyond which requests involving
swarm management cannot be processed. These types of failures include data
corruption or hardware failures.</p>

<p>If you lose the quorum of managers, you cannot administer the swarm. If you have
lost the quorum and you attempt to perform any management operation on the swarm,
an error occurs:</p>

<pre><code class="language-none">Error response from daemon: rpc error: code = 4 desc = context deadline exceeded
</code></pre>

<p>The best way to recover from losing the quorum is to bring the failed nodes back
online. If you can’t do that, the only way to recover from this state is to use
the <code class="highlighter-rouge">--force-new-cluster</code> action from a manager node. This removes all managers
except the manager the command was run from. The quorum is achieved because
there is now only one manager. Promote nodes to be managers until you have the
desired number of managers.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># From the node to recover</span>
<span class="nv">$ </span>docker swarm init <span class="nt">--force-new-cluster</span> <span class="nt">--advertise-addr</span> node01:2377
</code></pre></div></div>

<p>When you run the <code class="highlighter-rouge">docker swarm init</code> command with the <code class="highlighter-rouge">--force-new-cluster</code>
flag, the Docker Engine where you run the command becomes the manager node of a
single-node swarm which is capable of managing and running services. The manager
has all the previous information about services and tasks, worker nodes are
still part of the swarm, and services are still running. You need to add or
re-add  manager nodes to achieve your previous task distribution and ensure that
you have enough managers to maintain high availability and prevent losing the
quorum.</p>

<h3 id="force-the-swarm-to-rebalance">Force the swarm to rebalance</h3>

<p>Generally, you do not need to force the swarm to rebalance its tasks. When you
add a new node to a swarm, or a node reconnects to the swarm after a
period of unavailability, the swarm does not automatically give a workload to
the idle node. This is a design decision. If the swarm periodically shifted tasks
to different nodes for the sake of balance, the clients using those tasks would
be disrupted. The goal is to avoid disrupting running services for the sake of
balance across the swarm. When new tasks start, or when a node with running
tasks becomes unavailable, those tasks are given to less busy nodes. The goal
is eventual balance, with minimal disruption to the end user.</p>

<p>In Docker 1.13 and higher, you can use the <code class="highlighter-rouge">--force</code> or <code class="highlighter-rouge">-f</code> flag with the
<code class="highlighter-rouge">docker service update</code> command to force the service to redistribute its tasks
across the available worker nodes. This causes the service tasks to restart.
Client applications may be disrupted. If you have configured it, your service
uses a <a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/swarm/swarm-tutorial/rolling-update/">rolling update</a>.</p>

<p>If you use an earlier version and you want to achieve an even balance of load
across workers and don’t mind disrupting running tasks, you can force your swarm
to re-balance by temporarily scaling the service upward. Use
<code class="highlighter-rouge">docker service inspect --pretty &lt;servicename&gt;</code> to see the configured scale
of a service. When you use <code class="highlighter-rouge">docker service scale</code>, the nodes with the lowest
number of tasks are targeted to receive the new workloads. There may be multiple
under-loaded nodes in your swarm. You may need to scale the service up by modest
increments a few times to achieve the balance you want across all the nodes.</p>

<p>When the load is balanced to your satisfaction, you can scale the service back
down to the original scale. You can use <code class="highlighter-rouge">docker service ps</code> to assess the current
balance of your service across nodes.</p>

<p>See also
<a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/reference/commandline/service_scale/"><code class="highlighter-rouge">docker service scale</code></a> and
<a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/reference/commandline/service_ps/"><code class="highlighter-rouge">docker service ps</code></a>.</p>

<h2 id="ucp-disaster-recovery">UCP disaster recovery</h2>

<p>In the event half or more manager nodes are lost and cannot be recovered
to a healthy state, the system is considered to have lost quorum and can only be
restored through the following disaster recovery procedure.</p>

<h3 id="recover-a-ucp-cluster-from-an-existing-backup">Recover a UCP cluster from an existing backup</h3>

<ol>
  <li>If UCP is still installed on the swarm, uninstall UCP using the <code class="highlighter-rouge">uninstall-ucp</code> command.
    <blockquote>
      <p><strong>Note</strong>: If the restore is happening on new machines, skip this step.</p>
    </blockquote>
  </li>
  <li>Perform a <a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/admin/restore/">restore from an existing backup</a> on any node. If there is an
existing swarm, the restore operation must be performed on a manager node. If no swarm exists,
the restore operation will create one.</li>
</ol>

<h3 id="recover-a-ucp-cluster-without-an-existing-backup-not-recommended">Recover a UCP cluster without an existing backup (not recommended)</h3>
<p>If your cluster has lost quorum, you can still perform a backup of one of the remaining nodes.</p>

<blockquote>
  <p><strong>Important</strong>: Performing a backup after losing quorum is not guaranteed to succeed with
no loss of running services or configuration data. To properly protect against
manager failures, the system should be configured for
<a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/configure/join-nodes/">high availability</a>, and backups should be performed regularly
in order to have complete backup data.</p>
</blockquote>

<ol>
  <li>On one of the remaining manager nodes, perform <code class="highlighter-rouge">docker swarm init --force-new-cluster</code>. You might also need to specify an
<code class="highlighter-rouge">--advertise-addr</code> parameter, which is equivalent to the <code class="highlighter-rouge">--host-address</code>
parameter of the <code class="highlighter-rouge">docker/ucp install</code> operation. This instantiates a new
single-manager swarm by recovering as much state as possible from the
existing manager. This is a disruptive operation and existing tasks might be
either terminated or suspended.</li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/admin/backup/">Create a backup</a> of the remaining manager node.</li>
  <li>If UCP is still installed on the swarm, uninstall UCP using the
<code class="highlighter-rouge">uninstall-ucp</code> command.</li>
  <li>Perform a <a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/admin/restore/">restore</a> on the recovered swarm manager node.</li>
  <li>Log in to UCP and browse to the nodes page, or use the CLI <code class="highlighter-rouge">docker node ls</code>
command.</li>
  <li>If any nodes are listed as <code class="highlighter-rouge">down</code>, you’ll have to manually <a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/configure/scale-your-cluster/">remove these
nodes</a> from the swarm and then re-join
them using a <code class="highlighter-rouge">docker swarm join</code> operation with the swarm’s new join-token.</li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/admin/backup/">Create a backup</a> of the restored cluster.</li>
</ol>

<h3 id="recreate-objects-within-orchestrators-that-docker-enterprise-supports">Recreate objects within Orchestrators that Docker Enterprise supports</h3>

<p>Kubernetes currently backs up the declarative state of Kube objects in etcd. However, for Swarm, there is no way to take the state and export it to a declarative format, since the objects that are embedded within the Swarm raft logs are not easily transferable to other nodes or clusters.</p>

<p>For disaster recovery, to recreate swarm related workloads requires having the original scripts used for deployment. Alternatively, you can recreate workloads by manually recreating output from <code class="highlighter-rouge">docker inspect</code> commands.</p>

<h2 id="dtr-disaster-recovery">DTR disaster recovery</h2>

<p>Docker Trusted Registry is a clustered application. You can join multiple
replicas for high availability. For a DTR cluster to be healthy, a majority of its replicas (n/2 + 1) need to
be healthy and be able to communicate with the other replicas. This is also
known as maintaining quorum.</p>

<p>This means that there are three failure scenarios possible.</p>

<h3 id="replica-is-unhealthy-but-cluster-maintains-quorum">Replica is unhealthy but cluster maintains quorum</h3>

<p>One or more replicas are unhealthy, but the overall majority (n/2 + 1) is still
healthy and able to communicate with one another.</p>

<p><img src="https://matsuand.github.io/docs.docker.jp.onthefly/ee/dtr/images/dr-overview-1.svg" alt="Failure scenario 1" /></p>

<p>In this example the DTR cluster has five replicas but one of the nodes stopped
working, and the other has problems with the DTR overlay network.</p>

<p>Even though these two replicas are unhealthy the DTR cluster has a majority
of replicas still working, which means that the cluster is healthy.</p>

<p>In this case you should repair the unhealthy replicas, or remove them from
the cluster and join new ones.</p>

<h4 id="repair-a-single-replica">Repair a single replica</h4>

<p>When one or more DTR replicas are unhealthy but the overall majority
(n/2 + 1) is healthy and able to communicate with one another, your DTR
cluster is still functional and healthy.</p>

<p><img src="https://matsuand.github.io/docs.docker.jp.onthefly/ee/dtr/images/repair-replica-1.svg" alt="Cluster with two nodes unhealthy" /></p>

<p>Given that the DTR cluster is healthy, there’s no need to execute any disaster
recovery procedures like restoring from a backup.</p>

<p>Instead, you should:</p>

<ol>
  <li>Remove the unhealthy replicas from the DTR cluster.</li>
  <li>Join new replicas to make DTR highly available.</li>
</ol>

<p>Since a DTR cluster requires a majority of replicas to be healthy at all times,
the order of these operations is important. If you join more replicas before
removing the ones that are unhealthy, your DTR cluster might become unhealthy.</p>

<h5 id="split-brain-scenario">Split-brain scenario</h5>

<p>To understand why you should remove unhealthy replicas before joining new ones,
imagine you have a five-replica DTR deployment, and something goes wrong with
the overlay network connection the replicas, causing them to be separated in
two groups.</p>

<p><img src="https://matsuand.github.io/docs.docker.jp.onthefly/ee/dtr/images/repair-replica-2.svg" alt="Cluster with network problem" /></p>

<p>Because the cluster originally had five replicas, it can work as long as
three replicas are still healthy and able to communicate (5 / 2 + 1 = 3).
Even though the network separated the replicas in two groups, DTR is still
healthy.</p>

<p>If at this point you join a new replica instead of fixing the network problem
or removing the two replicas that got isolated from the rest, it’s possible
that the new replica ends up in the side of the network partition that has
less replicas.</p>

<p><img src="https://matsuand.github.io/docs.docker.jp.onthefly/ee/dtr/images/repair-replica-3.svg" alt="cluster with split brain" /></p>

<p>When this happens, both groups now have the minimum amount of replicas needed
to establish a cluster. This is also known as a split-brain scenario, because
both groups can now accept writes and their histories start diverging, making
the two groups effectively two different clusters.</p>

<h5 id="remove-replicas">Remove replicas</h5>

<p>To remove unhealthy replicas, you’ll first have to find the replica ID
of one of the replicas you want to keep, and the replica IDs of the unhealthy
replicas you want to remove.</p>

<p>You can find the list of replicas by navigating to <strong>Shared Resources &gt; Stacks</strong> or <strong>Swarm &gt; Volumes</strong> (when using <a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/swarm/">swarm mode</a>) on the UCP web interface, or by using the UCP
client bundle to run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker ps <span class="nt">--format</span> <span class="s2">"{{.Names}}"</span> | <span class="nb">grep </span>dtr

<span class="c"># The list of DTR containers with &lt;node&gt;/&lt;component&gt;-&lt;replicaID&gt;, e.g.</span>
<span class="c"># node-1/dtr-api-a1640e1c15b6</span>
</code></pre></div></div>

<p>Another way to determine the replica ID is to SSH into a DTR node and run the following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ REPLICA_ID</span><span class="o">=</span><span class="k">$(</span>docker inspect <span class="nt">-f</span> <span class="s1">'{{.Name}}'</span> <span class="k">$(</span>docker ps <span class="nt">-q</span> <span class="nt">-f</span> <span class="nv">name</span><span class="o">=</span>dtr-rethink<span class="k">)</span> | cut <span class="nt">-f</span> 3 <span class="nt">-d</span> <span class="s1">'-'</span><span class="k">)</span>
<span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nv">$REPLICA_ID</span>
</code></pre></div></div>

<p>Then use the UCP client bundle to remove the unhealthy replicas:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker container run <span class="se">\</span>
  <span class="nt">--rm</span> <span class="se">\</span>
  <span class="nt">--interactive</span> <span class="se">\</span>
  docker/dtr:2.7.6 remove <span class="se">\</span>
  <span class="nt">--existing-replica-id</span> &lt;healthy-replica-id&gt; <span class="se">\</span>
  <span class="nt">--replica-ids</span> &lt;unhealthy-replica-id&gt; <span class="se">\</span>
  <span class="nt">--ucp-insecure-tls</span> <span class="se">\</span>
  <span class="nt">--ucp-url</span> &lt;ucp-url&gt; <span class="se">\</span>
  <span class="nt">--ucp-username</span> &lt;user&gt; <span class="se">\</span>
  <span class="nt">--ucp-password</span> &lt;password&gt;
</code></pre></div></div>

<p>You can remove more than one replica at the same time, by specifying multiple
IDs with a comma.</p>

<p><img src="https://matsuand.github.io/docs.docker.jp.onthefly/ee/dtr/images/repair-replica-4.svg" alt="Healthy cluster" /></p>

<h5 id="join-replicas">Join replicas</h5>

<p>Once you’ve removed the unhealthy nodes from the cluster, you should join new
ones to make sure your cluster is highly available.</p>

<p>Use your UCP client bundle to run the following command which prompts you for
the necessary parameters:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker container run <span class="se">\</span>
  <span class="nt">--rm</span> <span class="se">\</span>
  <span class="nt">--interactive</span> <span class="se">\</span>
  docker/dtr:2.7.6 join <span class="se">\</span>
  <span class="nt">--ucp-node</span> &lt;ucp-node-name&gt; <span class="se">\</span>
  <span class="nt">--ucp-insecure-tls</span>
</code></pre></div></div>

<p><a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/dtr/admin/configure/set-up-high-availability/">Learn more about high availability</a>.</p>

<h3 id="the-majority-of-replicas-are-unhealthy">The majority of replicas are unhealthy</h3>

<p>If a majority of replicas are unhealthy, making the cluster lose quorum, but at
least one replica is still healthy, or at least the data volumes for DTR are
accessible from that replica, you can repair the cluster without having to restore from
a backup. This minimizes the amount of data loss. The following image provides an example of this scenario.</p>

<p><img src="https://matsuand.github.io/docs.docker.jp.onthefly/ee/dtr/images/dr-overview-2.svg" alt="Failure scenario 2" /></p>

<h4 id="repair-a-cluster">Repair a cluster</h4>

<p>For a DTR cluster to be healthy, a majority of its replicas (n/2 + 1) need to
be healthy and be able to communicate with the other replicas. This is known
as maintaining quorum.</p>

<p>In a scenario where quorum is lost, but at least one replica is still
accessible, you can use that replica to repair the cluster. That replica doesn’t
need to be completely healthy. The cluster can still be repaired as the DTR
data volumes are persisted and accessible.</p>

<p><img src="https://matsuand.github.io/docs.docker.jp.onthefly/ee/dtr/images/repair-cluster-1.svg" alt="Unhealthy cluster" /></p>

<p>Repairing the cluster from an existing replica minimizes the amount of data lost.
If this procedure doesn’t work, you’ll have to
<a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/admin/restore/">restore from an existing backup</a>.</p>

<h5 id="diagnose-an-unhealthy-cluster">Diagnose an unhealthy cluster</h5>

<p>When a majority of replicas are unhealthy, causing the overall DTR cluster to
become unhealthy, operations like <code class="highlighter-rouge">docker login</code>, <code class="highlighter-rouge">docker pull</code>, and <code class="highlighter-rouge">docker push</code>
present <code class="highlighter-rouge">internal server error</code>.</p>

<p>Accessing the <code class="highlighter-rouge">/_ping</code> endpoint of any replica also returns the same error.
It’s also possible that the DTR web UI is partially or fully unresponsive.</p>

<h5 id="perform-an-emergency-repair">Perform an emergency repair</h5>

<p>Use the <code class="highlighter-rouge">docker/dtr emergency-repair</code> command to try to repair an unhealthy
DTR cluster, from an existing replica.</p>

<p>This command checks the data volumes for the DTR</p>

<p>This command checks the data volumes for the DTR replica are uncorrupted,
redeploys all internal DTR components and reconfigured them to use the existing
volumes.</p>

<p>It also reconfigures DTR removing all other nodes from the cluster, leaving DTR
as a single-replica cluster with the replica you chose.</p>

<p>Start by finding the ID of the DTR replica that you want to repair from.
You can find the list of replicas by navigating to <strong>Shared Resources &gt; Stacks</strong> or <strong>Swarm &gt; Volumes</strong> (when using <a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/swarm/">swarm mode</a>) on the UCP web interface, or by using
a UCP client bundle to run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker ps <span class="nt">--format</span> <span class="s2">"{{.Names}}"</span> | <span class="nb">grep </span>dtr

<span class="c"># The list of DTR containers with &lt;node&gt;/&lt;component&gt;-&lt;replicaID&gt;, e.g.</span>
<span class="c"># node-1/dtr-api-a1640e1c15b6</span>
</code></pre></div></div>

<p>Another way to determine the replica ID is to SSH into a DTR node and run the following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ REPLICA_ID</span><span class="o">=</span><span class="k">$(</span>docker inspect <span class="nt">-f</span> <span class="s1">'{{.Name}}'</span> <span class="k">$(</span>docker ps <span class="nt">-q</span> <span class="nt">-f</span> <span class="nv">name</span><span class="o">=</span>dtr-rethink<span class="k">)</span> | cut <span class="nt">-f</span> 3 <span class="nt">-d</span> <span class="s1">'-'</span><span class="k">)</span>
<span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nv">$REPLICA_ID</span>
</code></pre></div></div>

<p>Then, use your UCP client bundle to run the emergency repair command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker container run <span class="se">\</span>
  <span class="nt">--rm</span> <span class="se">\</span>
  <span class="nt">--interactive</span> <span class="se">\</span>
  docker/dtr:2.7.6 emergency-repair <span class="se">\</span>
  <span class="nt">--ucp-insecure-tls</span> <span class="se">\</span>
  <span class="nt">--existing-replica-id</span> &lt;replica-id&gt;
</code></pre></div></div>

<p>If the emergency repair procedure is successful, your DTR cluster now has a
single replica. You should now
<a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/dtr/admin/configure/set-up-high-availability/">join more replicas for high availability</a>.</p>

<p><img src="https://matsuand.github.io/docs.docker.jp.onthefly/ee/dtr/images/repair-cluster-2.svg" alt="Healthy cluster" /></p>

<p>If the emergency repair command fails, try running it again using a different
replica ID. As a last resort, you can restore your cluster from an existing
backup.</p>

<h3 id="all-replicas-are-unhealthy">All replicas are unhealthy</h3>

<p>This is a total disaster scenario where all DTR replicas are lost, causing
the data volumes for all DTR replicas to get corrupted or be lost.</p>

<p><img src="https://matsuand.github.io/docs.docker.jp.onthefly/ee/dtr/images/dr-overview-3.svg" alt="Failure scenario 3" /></p>

<p>In a disaster scenario like this, you’ll have to restore DTR from an existing
backup. Restoring from a backup should be only used as a last resort, since
doing an emergency repair might prevent some data loss.</p>

<p><a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/admin/backup/">Create a backup</a>.</p>

<h2 id="where-to-go-next">Where to go next</h2>

<ul>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/admin/backup/">Create a backup</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/configure/join-nodes/">Set up high availability</a></li>
</ul>

							<!-- tags -->
							
							
							
							<span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span style="vertical-align: 2px"><a href="https://matsuand.github.io/docs.docker.jp.onthefly/search/?q=enterprise">enterprise</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/search/?q=recovery">recovery</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/search/?q=disaster recovery">disaster recovery</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/search/?q=dtr">dtr</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/search/?q=ucp">ucp</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/search/?q=swarm">swarm</a></span>
							
							<!-- link corrections -->
              <script language="JavaScript">
							var x = document.links.length;
							var baseHref = document.getElementsByTagName('base')[0].href
							for (i = 0; i < x; i++) {
							  var munged = false;
							  var thisHREF = document.links[i].href;
							  var originalURL = "/ee/admin/disaster-recovery/";
							  if (thisHREF.indexOf(baseHref + "#") > -1) {
							    // hash fix
							    //console.log('BEFORE: base:',baseHref,'thisHREF:',thisHREF,'originalURL:',originalURL);
							    thisHREF = originalURL + thisHREF.replace(baseHref, "");
							    //console.log('AFTER: base:',baseHref,'thisHREF:',thisHREF,'originalURL:',originalURL);
							  }
							  if ((thisHREF.indexOf(window.location.hostname) > -1 || thisHREF.indexOf('http') == -1) && document.links[i].className.indexOf("nomunge") < 0) {
							    munged = true;
							    thisHREF = thisHREF.replace(".md", "/").replace("/index/", "/");
							    document.links[i].setAttribute('href', thisHREF);
							  }
							}
							</script>
							
						  <div id="ratings-div" style="color:#b9c2cc; text-align: center; margin-top: 150px; visibility: hidden">
								<div id="pd_rating_holder_8453675"></div>
								<script type="text/javascript">
									PDRTJS_settings_8453675 = {
										"id": "8453675",
										"unique_id": "ee/admin/disaster-recovery.md",
										"title": "Disaster recovery",
										"permalink": "https://github.com/docker/docker.github.io/blob/master/ee/admin/disaster-recovery.md"
									};
									(function(d, c, j) {
										if (!document.getElementById(j)) {
											var pd = d.createElement(c),
												s;
											pd.id = j;
											pd.src = ('https:' == document.location.protocol) ? 'https://polldaddy.com/js/rating/rating.js' : 'http://i0.poll.fm/js/rating/rating.js';
											s = document.getElementsByTagName(c)[0];
											s.parentNode.insertBefore(pd, s);
										}
									}(document, 'script', 'pd-rating-js'));
								</script>
							</div>
							
						</section>
					</main>
					<nav class="col-nav">
						<div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
						<div id="navbar" class="nav-sidebar">
    <ul class="nav" id="jsTOCLeftNav">
    </ul>
</div>

						</div>
					</nav>
					<div class="col-toc">
							<div class="sidebar hidden-xs hidden-sm">
							<div class="toc-nav">
								<div class="feedback-links">
									<ul>
										
										<li style="visibility: hidden"><a href="https://github.com/matsuand/docs.docker.jp/edit/v19.03.local/ee/admin/disaster-recovery.md"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> このページの編集</a></li>
										<li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/issues/new?body=File: [ee/admin/disaster-recovery.md](https://matsuand.github.io/docs.docker.jp.onthefly/ee/admin/disaster-recovery/)"
															class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 文書変更のリクエスト</a></li>
										<li><a href="https://success.docker.com/support"><i class="fa fa-question" aria-hidden="true"></i> サポート依頼</a></li>
										<!-- toggle mode -->
										<li>
											<div class="toggle-mode">
												<div class="icon">
													<i class="fa fa-sun-o" aria-hidden="true"></i>
												</div>
												<div class="toggle-switch">
													<label class="switch">
														<input type="checkbox" id="switch-style">
														<div class="slider round"></div>
												</label>
												</div>
												<div class="icon">
													<i class="fa fa-moon-o" aria-hidden="true"></i>
												</div>
											</div>
										</li>
									</ul>
								</div>
								   
									<div id="side-toc-title">本ページ内</div>
									
<ul id="my_toc" class="inline_toc">
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/disaster-recovery.md#swarm-disaster-recovery" class="nomunge">Swarm disaster recovery</a>
    <ul>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/disaster-recovery.md#recover-from-losing-the-quorum" class="nomunge">Recover from losing the quorum</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/disaster-recovery.md#force-the-swarm-to-rebalance" class="nomunge">Force the swarm to rebalance</a></li>
    </ul>
  </li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/disaster-recovery.md#ucp-disaster-recovery" class="nomunge">UCP disaster recovery</a>
    <ul>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/disaster-recovery.md#recover-a-ucp-cluster-from-an-existing-backup" class="nomunge">Recover a UCP cluster from an existing backup</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/disaster-recovery.md#recover-a-ucp-cluster-without-an-existing-backup-not-recommended" class="nomunge">Recover a UCP cluster without an existing backup (not recommended)</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/disaster-recovery.md#recreate-objects-within-orchestrators-that-docker-enterprise-supports" class="nomunge">Recreate objects within Orchestrators that Docker Enterprise supports</a></li>
    </ul>
  </li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/disaster-recovery.md#dtr-disaster-recovery" class="nomunge">DTR disaster recovery</a>
    <ul>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/disaster-recovery.md#replica-is-unhealthy-but-cluster-maintains-quorum" class="nomunge">Replica is unhealthy but cluster maintains quorum</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/disaster-recovery.md#the-majority-of-replicas-are-unhealthy" class="nomunge">The majority of replicas are unhealthy</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/disaster-recovery.md#all-replicas-are-unhealthy" class="nomunge">All replicas are unhealthy</a></li>
    </ul>
  </li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/disaster-recovery.md#where-to-go-next" class="nomunge">Where to go next</a></li>
</ul>


								</div>
								
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	
	<footer class="footer">
		  
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/what-docker">What is Docker</a></li>
                        <li><a href="https://www.docker.com/what-container">What is a Container</a></li>
                        <li><a href="https://www.docker.com/use-cases">Use Cases</a></li>
                        <li><a href="https://www.docker.com/customers">Customers</a></li>
                        <li><a href="https://www.docker.com/partners/partner-program">Partners</a></li>
                        <li class="break"><a href="https://www.docker.com/industry-government">For Government</a></li>
                        <li><a href="https://www.docker.com/company">About Docker</a></li>
                        <li><a href="https://www.docker.com/company/management">Management</a></li>
                        <li><a href="https://www.docker.com/company/news-and-press">Press &amp; News</a></li>
                        <li><a href="https://www.docker.com/careers">Careers</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/products/overview">Product</a></li>
                        <li><a href="https://www.docker.com/pricing">Pricing</a></li>
                        <li><a href="https://www.docker.com/docker-community">Community Edition</a></li>
                        <li class="break"><a href="https://www.docker.com/enterprise">Enterprise Edition </a></li>
                        <li><a href="https://www.docker.com/products/docker-datacenter">Docker Datacenter</a></li>
                        <li><a href="https://hub.docker.com/">Docker Hub</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/">Documentation</a></li>
                        <li><a href="https://www.docker.com/docker">Learn</a></li>
                        <li><a href="https://blog.docker.com" target="_blank">Blog</a></li>
                        <li><a href="https://engineering.docker.com" target="_blank">Engineering Blog</a></li>
                        <li><a href="https://training.docker.com/" target="_blank">Training</a></li>
                        <li><a href="https://success.docker.com/support">Support</a></li>
                        <li><a href="https://success.docker.com/kbase">Knowledge Base</a></li>
                        <li><a href="https://www.docker.com/products/resources">Resources</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/docker-community">Community</a></li>
                        <li><a href="https://www.docker.com/technologies/overview">Open Source</a></li>
                        <li><a href="https://www.docker.com/community/events">Events</a></li>
                        <li><a href="https://forums.docker.com/" target="_blank">Forums</a></li>
                        <li><a href="https://www.docker.com/community/docker-captains">Docker Captains</a></li>
                        <li><a href="https://www.docker.com/docker-community/scholarships">Scholarships</a></li>
                        <li><a href="https://blog.docker.com/curated/">Community News</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="http://status.docker.com/">Status</a></li>
                        <li><a href="https://www.docker.com/docker-security">Security</a></li>
                        <li><a href="https://www.docker.com/legal">Legal</a></li>
                        <li><a href="https://www.docker.com/company/contact">Contact</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2019 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="http://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="http://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-reddit"><a href="http://www.reddit.com/r/docker">Reddit</a></li>
                    <li class="fa fa-slideshare"><a href="http://www.slideshare.net/docker">Slideshare</a></li>
                </ul>
            </div>
        </div>
    </div>

	</footer>
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/github.css">
	
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/anchorlinks.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/menu.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/jquery.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
	<!-- Always include the archive.js, but it doesn't do much unless we are an archive -->
	<script language="javascript">
	// Default to assuming this is an archive and hiding some stuff
	// See js/archive.js and js/docs.js for logic relating to this
	var isArchive = true;
	var dockerVersion = 'v19.03';
	// In archives, we need to know the page root and we get it from JEKYLL_ENV in the jekyll build command
	var jekyllEnv = 'development';
	// If unset (in non-archive branches), defaults to "development". In that case, reset it to empty
	if (jekyllEnv == 'development') {
		jekyllEnv = '';
	}
	var pageURL = jekyllEnv + '/ee/admin/disaster-recovery/';
	</script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/archive.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/stickyfill.min.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/metadata.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/glossary.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/docs.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/toc.js"></script>
	<script language="javascript">
	jQuery(document).ready(function(){
				hookupTOCEvents();
			});
	</script>
</body>

</html>
