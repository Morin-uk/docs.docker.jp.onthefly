<!-- Page generated 2019-09-11 17:40:27 +0900 -->
<!-- relative link basehrefs -->

	
	
	
		
			
		
	
		
			
			


<!-- Logic for 'edit this button' -->


	

	

	

	

	

	

	

	

	


<!-- End of logic for 'edit this button' -->


<!DOCTYPE html>
<html lang="ja">

<head>
	<base href="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<style type="text/css">
		@charset "UTF-8";
		[ng\:cloak],
		[ng-cloak],
		[data-ng-cloak],
		[x-ng-cloak],
		.ng-cloak,
		.x-ng-cloak,
		.ng-hide:not(.ng-hide-animate) {
			display: none !important;
		}

		ng\:form {
			display: block;
		}
	</style>
	<!-- Google Tag Manager -->
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-WL2QLG5');</script>
	<!-- End Google Tag Manager -->
	
	<!-- favicon -->
	<link rel="icon" type="image/x-icon" href="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
	<meta name="msapplication-TileImage" content="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico">
	<link rel="apple-touch-icon" type="image/x-icon" href="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
	<meta property="og:image" content="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
	<!-- metadata -->
	<meta property="og:type" content="website"/>
	<meta property="og:updated_time" itemprop="dateUpdated" content="2019-09-11T17:40:27+09:00"/>
	<meta property="og:image" itemprop="image primaryImageOfPage" content="https://matsuand.github.io/docs.docker.jp.onthefly/images/docs@2x.png"/>
	<meta name="twitter:card" content="summary"/>
	<meta name="twitter:domain" content="docs.docker.jp"/>
	<meta name="twitter:site" content="@docker_docs"/>
	<meta name="twitter:url" content="https://twitter.com/docker_docs"/>
	<meta name="twitter:title" itemprop="title name" content="Build a Swarm cluster for production"/>
	<meta name="twitter:description" property="og:description" itemprop="description" content="This page teaches you to deploy a high-availability swarm cluster. Although the example installation uses the Amazon Web Services (AWS) platform, you can deploy an equivalent swarm on many other..." />
	<meta name="twitter:image:src" content="https://matsuand.github.io/docs.docker.jp.onthefly/images/docs@2x.png"/>
	<meta name="twitter:image:alt" content="Docker ドキュメント"/>
	<meta property="article:published_time" itemprop="datePublished" content="2019-09-11T17:40:27+09:00"/>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="keywords" content="docker, swarm, clustering, examples, Amazon, AWS EC2">
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/bootstrap.min.css">
	<link id="pygments" rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/pygments/perldoc.css">
	<link id="pagestyle" rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/style.css">

	<!-- Go get "Open Sans" font from Google -->
	<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
	<!-- SEO stuff -->
	<title>Build a Swarm cluster for production | Docker ドキュメント</title>
<meta property="og:title" content="Build a Swarm cluster for production" />
<meta property="og:locale" content="ja_JP" />
<meta name="description" content="Deploying Swarm on AWS EC2 AMI's in a VPC" />
<meta property="og:description" content="Deploying Swarm on AWS EC2 AMI's in a VPC" />
<link rel="canonical" href="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/install-manual/" />
<meta property="og:url" content="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/install-manual/" />
<meta property="og:site_name" content="Docker ドキュメント" />
<script type="application/ld+json">
{"@context":"http://schema.org","@type":"WebPage","headline":"Build a Swarm cluster for production","description":"Deploying Swarm on AWS EC2 AMI's in a VPC","url":"https://matsuand.github.io/docs.docker.jp.onthefly/swarm/install-manual/"}</script>
	<!-- END SEO STUFF -->
	<meta name="robots" content="noindex" />
	<script language="javascript">
	// Default to assuming this is an archive and hiding some stuff
	// See js/archive.js and js/docs.js for logic relating to this
	var isArchive = true;
	var dockerVersion = 'v19.03';
	</script>
</head>
<body ng-app="Docker" ng-controller="DockerController" class="colums">
	<header>
		 <nav class="nav-secondary navbar navbar-fixed-top">
    <!-- <div class="fan"></div> -->
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="https://matsuand.github.io/docs.docker.jp.onthefly/"><img class="logo" src="https://matsuand.github.io/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs"></a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="search-form" id="search-div" style="visibility: hidden">
    <form class="search-form form-inline ng-pristine ng-valid" id="searchForm" action="https://matsuand.github.io/docs.docker.jp.onthefly/search/">
        <input class="search-field form-control ds-input" id="st-search-input" value="" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteContainer">
            <div id="autocompleteResults"></div>
        </div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container">
    <div id="tabs">
        <ul class="tabs" id="jsTOCHorizontal">

        </ul>
    </div>
    <div class="ctrl-right hidden-xs hidden-sm">
        <a href="javascript:void(0)" id="menu-toggle"><i class="fa fa-indent" aria-hidden="true"></i></a>
        <div class="btn-group" style="visibility: hidden">
  <button type="button" class="btn btn-default dropdown-btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Docker v19.03 (current)         <span class="caret"></span>
  </button>
  <ul class="dropdown-menu">
    <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/edge/">Docker edge</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v18.09/">Docker v18.09</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v18.03/">Docker v18.03</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.12/">Docker v17.12</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.09/">Docker v17.09</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.06/">Docker v17.06</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.03/">Docker v17.03</a></li>
  </ul>
</div>

    </div>
</div>

        </div>
    </div>
</nav>

	</header>

	<div class="wrapper right-open">
		<div class="container-fluid">
			<div class="row">
				<div class="col-body">
					<main class="col-content content">
						<section class="section">
							
								
							<h1>Build a Swarm cluster for production</h1> 
							<blockquote><p><strong>この文書は古いスタンドアロン版の Swarm に関するものです。</strong> ここではスタンドアロン版 Docker Swarm について説明しています。Docker 1.12 およびそれ以降においては、Docker Engine に対して<a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/swarm/">スウォームモード</a>が組み入れられました。たいていのユーザーは、統合されたスウォームモードを利用してください。これに関して読み進めるべきドキュメントは、<a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/swarm/swarm-tutorial/">スウォームモードをはじめよう</a>、<a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/swarm/index.md#swarm-mode-cli-commands">スウォームモード CLI コマンド</a>、<a href="https://matsuand.github.io/docs.docker.jp.onthefly/get-started/">Docker ウォークスルー</a> です。スタンドアロン版の Docker Swarm は Docker Engine API や CLI コマンドには統合されていません。</p>
</blockquote> <span class="reading-time" title="Estimated reading time">
  <span class="reading-time-label">読む時間の目安: </span>
  
  
    10 分
  
</span>

							
							
							<p>This page teaches you to deploy a high-availability swarm cluster.
Although the example installation uses the Amazon Web Services (AWS) platform,
you can deploy an equivalent swarm on many other platforms. In this example, you do the following:</p>

<ul>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/install-manual/#prerequisites">Verify you have the prerequisites</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/install-manual/#step-1-add-network-security-rules">Establish basic network security</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/install-manual/#step-2-create-your-instances">Create your nodes</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/install-manual/#step-3-install-engine-on-each-node">Install Engine on each node</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/install-manual/#step-4-set-up-a-discovery-backend">Configure a discovery backend</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/install-manual/#step-5-create-swarm-cluster">Create a swarm cluster</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/install-manual/#step-6-communicate-with-the-swarm">Communicate with the swarm</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/install-manual/#step-7-test-swarm-failover">Test the high-availability swarm managers</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/install-manual/#additional-resources">Additional Resources</a></li>
</ul>

<p>For a quickstart for Docker Swarm, try the <a href="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/install-w-machine/">Evaluate Swarm in a sandbox</a> page.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li>An Amazon Web Services (AWS) account</li>
  <li>Familiarity with AWS features and tools, such as:
    <ul>
      <li>Elastic Cloud (EC2) Dashboard</li>
      <li>Virtual Private Cloud (VPC) Dashboard</li>
      <li>VPC Security groups</li>
      <li>Connecting to an EC2 instance using SSH</li>
    </ul>
  </li>
</ul>

<h2 id="step-1-add-network-security-rules">Step 1. Add network security rules</h2>

<p>AWS uses a “security group” to allow specific types of network traffic on your
VPC network. The <strong>default</strong> security group’s initial set of rules deny all
inbound traffic, allow all outbound traffic, and allow all traffic between
instances.</p>

<p>You’re going to add a couple of rules to allow inbound SSH connections and
inbound container images. This set of rules somewhat protects the Engine, Swarm,
and Consul ports. For a production environment, you would apply more restrictive
security measures. Do not leave Docker Engine ports unprotected.</p>

<p>From your AWS home console, do the following:</p>

<ol>
  <li>
    <p>Click <strong>VPC - Isolated Cloud Resources</strong>.</p>

    <p>The VPC Dashboard opens.</p>
  </li>
  <li>
    <p>Navigate to <strong>Security Groups</strong>.</p>
  </li>
  <li>
    <p>Select the <strong>default</strong> security group that’s associated with your default VPC.</p>
  </li>
  <li>
    <p>Add the following two rules.</p>

    <table>
 <tr>
   <th>Type</th>
   <th>Protocol</th>
   <th>Port Range</th>
   <th>Source</th>
 </tr>
 <tr>
   <td>SSH</td>
   <td>TCP</td>
   <td>22</td>
   <td>0.0.0.0/0</td>
 </tr>
 <tr>
   <td>HTTP</td>
   <td>TCP</td>
   <td>80</td>
   <td>0.0.0.0/0</td>
 </tr>
 </table>
  </li>
</ol>

<p>The SSH connection allows you to connect to the host while the HTTP is for container images.</p>

<h2 id="step-2-create-your-instances">Step 2. Create your instances</h2>

<p>In this step, you create five Linux hosts that are part of your default security
group. When complete, the example deployment contains three types of nodes:</p>

<table>
  <thead>
    <tr>
      <th>Node Description</th>
      <th>Name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Swarm primary and secondary managers</td>
      <td><code class="highlighter-rouge">manager0</code>, <code class="highlighter-rouge">manager1</code></td>
    </tr>
    <tr>
      <td>Swarm node</td>
      <td><code class="highlighter-rouge">node0</code>, <code class="highlighter-rouge">node1</code></td>
    </tr>
    <tr>
      <td>Discovery backend</td>
      <td><code class="highlighter-rouge">consul0</code></td>
    </tr>
  </tbody>
</table>

<p>To create the instances do the following:</p>

<ol>
  <li>
    <p>Open the EC2 Dashboard and launch five EC2 instances, one at a time.</p>

    <ul>
      <li>
        <p>During <strong>Step 1: Choose an Amazon Machine Image (AMI)</strong>, pick the <em>Amazon Linux AMI</em>.</p>
      </li>
      <li>
        <p>During <strong>Step 5: Tag Instance</strong>, under <strong>Value</strong>, give each instance one of these names:</p>

        <ul>
          <li><code class="highlighter-rouge">manager0</code></li>
          <li><code class="highlighter-rouge">manager1</code></li>
          <li><code class="highlighter-rouge">consul0</code></li>
          <li><code class="highlighter-rouge">node0</code></li>
          <li><code class="highlighter-rouge">node1</code></li>
        </ul>
      </li>
      <li>
        <p>During <strong>Step 6: Configure Security Group</strong>, choose <strong>Select an existing security group</strong> and pick the “default” security group.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Review and launch your instances.</p>
  </li>
</ol>

<h2 id="step-3-install-engine-on-each-node">Step 3. Install Engine on each node</h2>

<ol>
  <li>
    <p><a href="https://matsuand.github.io/docs.docker.jp.onthefly/install/" target="_blank" class="_">Install Docker</a> on each
host, using the appropriate instructions for your operating system and
distribution.</p>
  </li>
  <li>
    <p>Edit <code class="highlighter-rouge">/etc/docker/daemon.json</code>. Create it if it does not exist. Assuming the
file was empty, its contents should be:</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"tcp://0.0.0.0:2375"</span><span class="p">,</span><span class="w"> </span><span class="s2">"unix:///var/run/docker.sock"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>

    <p>Start or restart Docker for the changes to take effect.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>systemctl start docker
</code></pre></div>    </div>
  </li>
  <li>
    <p>Give the <code class="highlighter-rouge">ec2-user</code> root privileges:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker ec2-user
</code></pre></div>    </div>
  </li>
  <li>
    <p>Log out of the host.</p>
  </li>
</ol>

<h4 id="troubleshooting">Troubleshooting</h4>

<ul>
  <li>
    <p>If entering a <code class="highlighter-rouge">docker</code> command produces a message asking whether docker is
available on this host, it may be because the user doesn’t have root privileges.
If so, use <code class="highlighter-rouge">sudo</code> or give the user root privileges.</p>
  </li>
  <li>
    <p>For this example, don’t create an AMI image from one of your instances running
Docker Engine and then re-use it to create the other instances. Doing so
produces errors.</p>
  </li>
  <li>
    <p>If your host cannot reach Docker Hub, <code class="highlighter-rouge">docker run</code> commands that pull
images fail. In that case, check that your VPC is associated with
a security group with a rule that allows inbound traffic. Also check the <a href="http://status.docker.com/">Docker Hub status
page</a> for service availability.</p>
  </li>
</ul>

<h2 id="step-4-set-up-a-discovery-backend">Step 4. Set up a discovery backend</h2>

<p>Here, you’re going to create a minimalist discovery backend. The swarm managers
and nodes use this backend to authenticate themselves as members of the cluster.
The swarm managers also use this information to identify which nodes are
available to run containers.</p>

<p>To keep things simple, you are going to run a single consul daemon on the same
host as one of the swarm managers.</p>

<ol>
  <li>
    <p>Use SSH to connect to the <code class="highlighter-rouge">consul0</code> instance.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ ifconfig
</code></pre></div>    </div>
  </li>
  <li>
    <p>From the output, copy the <code class="highlighter-rouge">eth0</code> IP address from <code class="highlighter-rouge">inet addr</code>.</p>
  </li>
  <li>
    <p>To set up a discovery backend, use the following command, replacing <code class="highlighter-rouge">&lt;consul0_ip&gt;</code> with the IP address from the previous command:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker run -d -p 8500:8500 --name=consul progrium/consul -server -bootstrap -advertise=&lt;consul0_ip&gt;
</code></pre></div>    </div>
  </li>
  <li>
    <p>Enter <code class="highlighter-rouge">docker ps</code>.</p>

    <p>From the output, verify that a consul container is running.
 Then, disconnect from the <code class="highlighter-rouge">consul0</code> instance.</p>
  </li>
</ol>

<p>Your Consul node is up and running, providing your cluster with a discovery
backend. To increase its reliability, you can create a high-availability cluster
using a trio of consul nodes using the link mentioned at the end of this page.
(Before creating a cluster of consul nodes, update the VPC security group with
rules to allow inbound traffic on the required port numbers.)</p>

<h2 id="step-5-create-swarm-cluster">Step 5. Create swarm cluster</h2>

<p>After creating the discovery backend, you can create the swarm managers. In this step, you are going to create two swarm managers in a high-availability configuration. The first manager you run becomes the swarm’s <em>primary manager</em>. Some documentation still refers to a primary manager as a “master”, but that term has been superseded. The second manager you run serves as a <em>replica</em>. If the primary manager becomes unavailable, the cluster elects the replica as the primary manager.</p>

<ol>
  <li>
    <p>Use SSH to connect to the <code class="highlighter-rouge">manager0</code> instance and use <code class="highlighter-rouge">ifconfig</code> to get its IP address.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ ifconfig
</code></pre></div>    </div>
  </li>
  <li>
    <p>To create the primary manager in a high-availability swarm cluster, use the following syntax:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker run -d -p 4000:4000 swarm manage -H :4000 --replication --advertise &lt;manager0_ip&gt;:4000 consul://&lt;consul0_ip&gt;:8500
</code></pre></div>    </div>

    <p>Replacing <code class="highlighter-rouge">&lt;manager0_ip&gt;</code> and <code class="highlighter-rouge">&lt;consul0_ip&gt;</code> with the IP address from the previous command, for example:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker run -d -p 4000:4000 swarm manage -H :4000 --replication --advertise 172.30.0.125:4000 consul://172.30.0.161:8500
</code></pre></div>    </div>
  </li>
  <li>
    <p>Enter <code class="highlighter-rouge">docker ps</code>.</p>

    <p>From the output, verify that a swarm cluster container is running.
 Then, disconnect from the <code class="highlighter-rouge">manager0</code> instance.</p>
  </li>
  <li>
    <p>Connect to the <code class="highlighter-rouge">manager1</code> node and use <code class="highlighter-rouge">ifconfig</code> to get its IP address.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ ifconfig
</code></pre></div>    </div>
  </li>
  <li>
    <p>Start the secondary swarm manager using following command.</p>

    <p>Replacing <code class="highlighter-rouge">&lt;manager1_ip&gt;</code> with the IP address from the previous command, for example:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker run -d -p 4000:4000 swarm manage -H :4000 --replication --advertise &lt;manager1_ip&gt;:4000 consul://172.30.0.161:8500
</code></pre></div>    </div>
  </li>
  <li>
    <p>Enter <code class="highlighter-rouge">docker ps</code> to verify that a swarm container is running. Then disconnect from the <code class="highlighter-rouge">manager1</code> instance.</p>
  </li>
  <li>
    <p>Connect to <code class="highlighter-rouge">node0</code> and <code class="highlighter-rouge">node1</code> in turn and join them to the cluster.</p>

    <p>a. Get the node IP addresses with the <code class="highlighter-rouge">ifconfig</code> command.</p>

    <p>b. Start a swarm container each using the following syntax:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> docker run -d swarm join --advertise=&lt;node_ip&gt;:2375 consul://&lt;consul0_ip&gt;:8500
</code></pre></div>    </div>

    <p>For example:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker run -d swarm join --advertise=172.30.0.69:2375 consul://172.30.0.161:8500
</code></pre></div>    </div>

    <p>c. Enter <code class="highlighter-rouge">docker ps</code> to verify that the swarm cluster container started from the previous command is running.</p>
  </li>
</ol>

<p>Your small swarm cluster is up and running on multiple hosts, providing you with a high-availability virtual Docker Engine. To increase its reliability and capacity, you can add more swarm managers, nodes, and a high-availability discovery backend.</p>

<h2 id="step-6-communicate-with-the-swarm">Step 6. Communicate with the swarm</h2>

<p>You can communicate with the swarm to get information about the managers and
nodes using the Swarm API, which is nearly the same as the standard Docker API.
In this example, you use SSL to connect to <code class="highlighter-rouge">manager0</code> and <code class="highlighter-rouge">consul0</code> host again.
Then, you address commands to the swarm manager.</p>

<ol>
  <li>
    <p>Get information about the manager and nodes in the cluster:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker -H :4000 info
</code></pre></div>    </div>

    <p>The output gives the manager’s role as primary (<code class="highlighter-rouge">Role: primary</code>) and
 information about each of the nodes.</p>
  </li>
  <li>
    <p>Run an application on the swarm:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker -H :4000 run hello-world
</code></pre></div>    </div>
  </li>
  <li>
    <p>Check which swarm node ran the application:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker -H :4000 ps
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="step-7-test-swarm-failover">Step 7. Test Swarm failover</h2>

<p>To see the replica instance take over, you’re going to shut down the primary
manager. Doing so kicks off an election, and the replica becomes the primary
manager. When you start the manager you shut down earlier, it becomes the
replica.</p>

<ol>
  <li>
    <p>SSH connection to the <code class="highlighter-rouge">manager0</code> instance.</p>
  </li>
  <li>
    <p>Get the container ID or name of the <code class="highlighter-rouge">swarm</code> container:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker ps
</code></pre></div>    </div>
  </li>
  <li>
    <p>Shut down the primary manager, replacing <code class="highlighter-rouge">&lt;id_name&gt;</code> with the container’s ID or name (for example, “8862717fe6d3” or “trusting_lamarr”).</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> docker container rm -f &lt;id_name&gt;
</code></pre></div>    </div>
  </li>
  <li>
    <p>Start the swarm manager. For example:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker run -d -p 4000:4000 swarm manage -H :4000 --replication --advertise 172.30.0.161:4000 consul://172.30.0.161:8500
</code></pre></div>    </div>
  </li>
  <li>
    <p>Review the Engine’s daemon logs, replacing <code class="highlighter-rouge">&lt;id_name&gt;</code> with the new container’s ID or name:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ sudo docker logs &lt;id_name&gt;
</code></pre></div>    </div>

    <p>The output shows two entries like these ones:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> time="2016-02-02T02:12:32Z" level=info msg="Leader Election: Cluster leadership lost"
 time="2016-02-02T02:12:32Z" level=info msg="New leader elected: 172.30.0.160:4000"
</code></pre></div>    </div>
  </li>
  <li>
    <p>To get information about the manager and nodes in the cluster, enter:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker -H :4000 info
</code></pre></div>    </div>
  </li>
</ol>

<p>You can connect to the <code class="highlighter-rouge">manager1</code> node and run the <code class="highlighter-rouge">info</code> and <code class="highlighter-rouge">logs</code> commands.
They display corresponding entries for the change in leadership.</p>

<h2 id="additional-resources">Additional resources</h2>

<ul>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/docker-for-aws/">Installing Docker Engine on a cloud provider</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/multi-manager-setup/">High availability in Docker Swarm</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/discovery/">Discovery</a></li>
  <li><a href="https://hub.docker.com/r/progrium/consul/">High-availability cluster using a trio of consul nodes</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/swarm/networking/">Networking</a></li>
</ul>

							<!-- tags -->
							
							
							
							<span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span style="vertical-align: 2px"><a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=docker">docker</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=swarm">swarm</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=clustering">clustering</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=examples">examples</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=Amazon">Amazon</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=AWS EC2">AWS EC2</a></span>
							
							<!-- link corrections -->
              <script language="JavaScript">
							var x = document.links.length;
							var baseHref = document.getElementsByTagName('base')[0].href
							for (i = 0; i < x; i++) {
							  var munged = false;
							  var thisHREF = document.links[i].href;
							  var originalURL = "/swarm/install-manual/";
							  if (thisHREF.indexOf(baseHref + "#") > -1) {
							    // hash fix
							    //console.log('BEFORE: base:',baseHref,'thisHREF:',thisHREF,'originalURL:',originalURL);
							    thisHREF = originalURL + thisHREF.replace(baseHref, "");
							    //console.log('AFTER: base:',baseHref,'thisHREF:',thisHREF,'originalURL:',originalURL);
							  }
							  if ((thisHREF.indexOf(window.location.hostname) > -1 || thisHREF.indexOf('http') == -1) && document.links[i].className.indexOf("nomunge") < 0) {
							    munged = true;
							    thisHREF = thisHREF.replace(".md", "/").replace("/index/", "/");
							    document.links[i].setAttribute('href', thisHREF);
							  }
							}
							</script>
							
						  <div id="ratings-div" style="color:#b9c2cc; text-align: center; margin-top: 150px; visibility: hidden">
								<div id="pd_rating_holder_8453675"></div>
								<script type="text/javascript">
									PDRTJS_settings_8453675 = {
										"id": "8453675",
										"unique_id": "swarm/install-manual.md",
										"title": "Build a Swarm cluster for production",
										"permalink": "https://github.com/docker/docker.github.io/blob/master/swarm/install-manual.md"
									};
									(function(d, c, j) {
										if (!document.getElementById(j)) {
											var pd = d.createElement(c),
												s;
											pd.id = j;
											pd.src = ('https:' == document.location.protocol) ? 'https://polldaddy.com/js/rating/rating.js' : 'http://i0.poll.fm/js/rating/rating.js';
											s = document.getElementsByTagName(c)[0];
											s.parentNode.insertBefore(pd, s);
										}
									}(document, 'script', 'pd-rating-js'));
								</script>
							</div>
							
						</section>
					</main>
					<nav class="col-nav">
						<div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
						<div id="navbar" class="nav-sidebar">
    <ul class="nav" id="jsTOCLeftNav">
    </ul>
</div>

						</div>
					</nav>
					<div class="col-toc">
							<div class="sidebar hidden-xs hidden-sm">
							<div class="toc-nav">
								<div class="feedback-links">
									<ul>
										
										<li style="visibility: hidden"><a href="https://github.com/matsuand/docs.docker.jp/edit/v19.03.local/swarm/install-manual.md"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> このページの編集</a></li>
										<li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/issues/new?body=File: [swarm/install-manual.md](https://matsuand.github.io/docs.docker.jp.onthefly/swarm/install-manual/)"
															class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 文書変更のリクエスト</a></li>
										<li><a href="https://success.docker.com/support"><i class="fa fa-question" aria-hidden="true"></i> サポート依頼</a></li>
										<!-- toggle mode -->
										<li>
											<div class="toggle-mode">
												<div class="icon">
													<i class="fa fa-sun-o" aria-hidden="true"></i>
												</div>
												<div class="toggle-switch">
													<label class="switch">
														<input type="checkbox" id="switch-style">
														<div class="slider round"></div>
												</label>
												</div>
												<div class="icon">
													<i class="fa fa-moon-o" aria-hidden="true"></i>
												</div>
											</div>
										</li>
									</ul>
								</div>
								   
									<div id="side-toc-title">本ページ内</div>
									
<ul id="my_toc" class="inline_toc">
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/install-manual.md#prerequisites" class="nomunge">Prerequisites</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/install-manual.md#step-1-add-network-security-rules" class="nomunge">Step 1. Add network security rules</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/install-manual.md#step-2-create-your-instances" class="nomunge">Step 2. Create your instances</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/install-manual.md#step-3-install-engine-on-each-node" class="nomunge">Step 3. Install Engine on each node</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/install-manual.md#step-4-set-up-a-discovery-backend" class="nomunge">Step 4. Set up a discovery backend</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/install-manual.md#step-5-create-swarm-cluster" class="nomunge">Step 5. Create swarm cluster</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/install-manual.md#step-6-communicate-with-the-swarm" class="nomunge">Step 6. Communicate with the swarm</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/install-manual.md#step-7-test-swarm-failover" class="nomunge">Step 7. Test Swarm failover</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/install-manual.md#additional-resources" class="nomunge">Additional resources</a></li>
</ul>


								</div>
								
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	
	<footer class="footer">
		  
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/what-docker">What is Docker</a></li>
                        <li><a href="https://www.docker.com/what-container">What is a Container</a></li>
                        <li><a href="https://www.docker.com/use-cases">Use Cases</a></li>
                        <li><a href="https://www.docker.com/customers">Customers</a></li>
                        <li><a href="https://www.docker.com/partners/partner-program">Partners</a></li>
                        <li class="break"><a href="https://www.docker.com/industry-government">For Government</a></li>
                        <li><a href="https://www.docker.com/company">About Docker</a></li>
                        <li><a href="https://www.docker.com/company/management">Management</a></li>
                        <li><a href="https://www.docker.com/company/news-and-press">Press &amp; News</a></li>
                        <li><a href="https://www.docker.com/careers">Careers</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/products/overview">Product</a></li>
                        <li><a href="https://www.docker.com/pricing">Pricing</a></li>
                        <li><a href="https://www.docker.com/docker-community">Community Edition</a></li>
                        <li class="break"><a href="https://www.docker.com/enterprise">Enterprise Edition </a></li>
                        <li><a href="https://www.docker.com/products/docker-datacenter">Docker Datacenter</a></li>
                        <li><a href="https://hub.docker.com/">Docker Hub</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/">Documentation</a></li>
                        <li><a href="https://www.docker.com/docker">Learn</a></li>
                        <li><a href="https://blog.docker.com" target="_blank">Blog</a></li>
                        <li><a href="https://engineering.docker.com" target="_blank">Engineering Blog</a></li>
                        <li><a href="https://training.docker.com/" target="_blank">Training</a></li>
                        <li><a href="https://success.docker.com/support">Support</a></li>
                        <li><a href="https://success.docker.com/kbase">Knowledge Base</a></li>
                        <li><a href="https://www.docker.com/products/resources">Resources</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/docker-community">Community</a></li>
                        <li><a href="https://www.docker.com/technologies/overview">Open Source</a></li>
                        <li><a href="https://www.docker.com/community/events">Events</a></li>
                        <li><a href="https://forums.docker.com/" target="_blank">Forums</a></li>
                        <li><a href="https://www.docker.com/community/docker-captains">Docker Captains</a></li>
                        <li><a href="https://www.docker.com/docker-community/scholarships">Scholarships</a></li>
                        <li><a href="https://blog.docker.com/curated/">Community News</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="http://status.docker.com/">Status</a></li>
                        <li><a href="https://www.docker.com/docker-security">Security</a></li>
                        <li><a href="https://www.docker.com/legal">Legal</a></li>
                        <li><a href="https://www.docker.com/company/contact">Contact</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2019 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="http://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="http://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-reddit"><a href="http://www.reddit.com/r/docker">Reddit</a></li>
                    <li class="fa fa-slideshare"><a href="http://www.slideshare.net/docker">Slideshare</a></li>
                </ul>
            </div>
        </div>
    </div>

	</footer>
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/github.css">
	
	<!-- <script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/anchorlinks.js"></script> -->
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/menu.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/jquery.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
	<!-- Always include the archive.js, but it doesn't do much unless we are an archive -->
	<script language="javascript">
	// Default to assuming this is an archive and hiding some stuff
	// See js/archive.js and js/docs.js for logic relating to this
	var isArchive = true;
	var dockerVersion = 'v19.03';
	// In archives, we need to know the page root and we get it from JEKYLL_ENV in the jekyll build command
	var jekyllEnv = 'development';
	// If unset (in non-archive branches), defaults to "development". In that case, reset it to empty
	if (jekyllEnv == 'development') {
		jekyllEnv = '';
	}
	var pageURL = jekyllEnv + '/swarm/install-manual/';
	</script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/archive.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/stickyfill.min.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/metadata.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/glossary.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/collections_tocs.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/docs.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/toc.js"></script>
	<script language="javascript">
	jQuery(document).ready(function(){
				hookupTOCEvents();
			});
	</script>
</body>

</html>
