<!-- Page generated 2019-08-12 20:21:01 +0900 -->
<!-- relative link basehrefs -->

	
	
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
			


<!-- Logic for 'edit this button' -->


	

	

	

	

	

	

	

	

	


<!-- End of logic for 'edit this button' -->


<!DOCTYPE html>
<html lang="ja">

<head>
	<base href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<style type="text/css">
		@charset "UTF-8";
		[ng\:cloak],
		[ng-cloak],
		[data-ng-cloak],
		[x-ng-cloak],
		.ng-cloak,
		.x-ng-cloak,
		.ng-hide:not(.ng-hide-animate) {
			display: none !important;
		}

		ng\:form {
			display: block;
		}
	</style>
	<script type="text/javascript">
	  !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="4.0.0";
	  analytics.load("IWj9D0UpZHZdZUZX9jl98PcpBFWBnBMy");
	  analytics.page();
	  }}();
	</script>
	
	<!-- favicon -->
	<link rel="icon" type="image/x-icon" href="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
	<meta name="msapplication-TileImage" content="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico">
	<link rel="apple-touch-icon" type="image/x-icon" href="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
	<meta property="og:image" content="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
	<!-- metadata -->
	<meta property="og:type" content="website"/>
	<meta property="og:updated_time" itemprop="dateUpdated" content="2019-08-12T20:21:01+09:00"/>
	<meta property="og:image" itemprop="image primaryImageOfPage" content="https://matsuand.github.io/docs.docker.jp.onthefly/images/docs@2x.png"/>
	<meta name="twitter:card" content="summary"/>
	<meta name="twitter:domain" content="docs.docker.jp"/>
	<meta name="twitter:site" content="@docker_docs"/>
	<meta name="twitter:url" content="https://twitter.com/docker_docs"/>
	<meta name="twitter:title" itemprop="title name" content="Docker Content Trust"/>
	<meta name="twitter:description" property="og:description" itemprop="description" content="ネットワークシステム内においてデータの受け渡しを行う際には、信頼（trust）というものが最も大切になります。 特にインターネットのような信頼性に欠ける媒体との間でやり取りを行うとき、システムが取り扱うことになるデータはすべて完全性を保ち、発信者が誰であるかを常に確実にすることが重要です。 Docker Engine を利用する際には、イメージ（データ）を公開レジストリあるいはプライベートレジストリとの間でプッシュしたりプルしたりします。 Content Trust とは、あやゆるチャネルにわたってレジストリから取得するデータの完全性と公開者情報を検証する機能を提供するものです。 Docker Content Trust について Docker Content Trust (DCT) は、リモートにある Docker レジストリとの間で送受信するデータに対して、デジタル署名を利用する機能を提供します。 この署名によって、特定のタグづけされたイメージに対する完全性と公開者情報を、クライアント側においてあるいは実行時に検証することが可能となります。 DCT を利用することで、イメージ公開者はイメージに署名をつけることができ、一方その利用者は、そのイメージが署名されていることを確認することができます。 公開者とは、個人や組織である場合もあります。 また公開イメージに手動で署名を行っているかもしれませんし、ソフトウェアサプライチェーンのリリース過程において署名を自動化して行っているかもしれません。 イメージタグと DCT 各イメージのレコードには、以下の識別子があります。 [REGISTRY_HOST[:REGISTRY_PORT]/]REPOSITORY[:TAG] イメージ REPOSITORYにはタグを複数つけることができます。..." />
	<meta name="twitter:image:src" content="https://matsuand.github.io/docs.docker.jp.onthefly/images/docs@2x.png"/>
	<meta name="twitter:image:alt" content="Docker Documentation"/>
	<meta property="article:published_time" itemprop="datePublished" content="2019-08-12T20:21:01+09:00"/>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="keywords" content="content, trust, security, docker, documentation">
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/bootstrap.min.css">
	<link id="pygments" rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/pygments/perldoc.css">
	<link id="pagestyle" rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/style.css">

	<!-- Go get "Open Sans" font from Google -->
	<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
	<!-- SEO stuff -->
	<title>Docker Content Trust | Docker Documentation</title>
<meta property="og:title" content="Docker Content Trust" />
<meta property="og:locale" content="ja_JP" />
<meta name="description" content="Enabling content trust in Docker" />
<meta property="og:description" content="Enabling content trust in Docker" />
<link rel="canonical" href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/content_trust/" />
<meta property="og:url" content="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/content_trust/" />
<meta property="og:site_name" content="Docker Documentation" />
<script type="application/ld+json">
{"@context":"http://schema.org","@type":"WebPage","headline":"Docker Content Trust","description":"Enabling content trust in Docker","url":"https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/content_trust/"}</script>
	<!-- END SEO STUFF -->
	
	<script language="javascript">
	// Default to assuming this is an archive and hiding some stuff
	// See js/archive.js and js/docs.js for logic relating to this
	var isArchive = true;
	var dockerVersion = 'v19.03';
	</script>
</head>
<body ng-app="Docker" ng-controller="DockerController" class="colums">
	<header>
		 <nav class="nav-secondary navbar navbar-fixed-top">
    <!-- <div class="fan"></div> -->
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="https://matsuand.github.io/docs.docker.jp.onthefly/"><img class="logo" src="https://matsuand.github.io/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs"></a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="search-form" id="search-div" style="visibility: hidden">
    <form class="search-form form-inline ng-pristine ng-valid" id="searchForm" action="https://matsuand.github.io/docs.docker.jp.onthefly/search/">
        <input class="search-field form-control ds-input" id="st-search-input" value="" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteContainer">
            <div id="autocompleteResults"></div>
        </div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container">
    <div id="tabs">
        <ul class="tabs" id="jsTOCHorizontal">

        </ul>
    </div>
    <div class="ctrl-right hidden-xs hidden-sm">
        <a href="javascript:void(0)" id="menu-toggle"><i class="fa fa-indent" aria-hidden="true"></i></a>
        <div class="btn-group" style="visibility: hidden">
  <button type="button" class="btn btn-default dropdown-btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Docker v19.03 (current)         <span class="caret"></span>
  </button>
  <ul class="dropdown-menu">
    <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/edge/">Docker edge</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v18.09/">Docker v18.09</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v18.03/">Docker v18.03</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.12/">Docker v17.12</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.09/">Docker v17.09</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.06/">Docker v17.06</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.03/">Docker v17.03</a></li>
  </ul>
</div>

    </div>
</div>

        </div>
    </div>
</nav>

	</header>

	<div class="wrapper right-open">
		<div class="container-fluid">
			<div class="row">
				<div class="col-body">
					<main class="col-content content">
						<section class="section">
							
								
							<h1>Docker Content Trust</h1>  <span class="reading-time" title="Estimated reading time">
  <span class="reading-time-label">読む時間の目安: </span>
  
  
    11 分
  
</span>

							
							
							
<p>ネットワークシステム内においてデータの受け渡しを行う際には、信頼（<strong>trust</strong>）というものが最も大切になります。
特にインターネットのような信頼性に欠ける媒体との間でやり取りを行うとき、システムが取り扱うことになるデータはすべて完全性を保ち、発信者が誰であるかを常に確実にすることが重要です。
Docker Engine を利用する際には、イメージ（データ）を公開レジストリあるいはプライベートレジストリとの間でプッシュしたりプルしたりします。
Content Trust とは、あやゆるチャネルにわたってレジストリから取得するデータの完全性と公開者情報を検証する機能を提供するものです。</p>

<h2 id="about-docker-content-trust-dct">Docker Content Trust について</h2>

<p>Docker Content Trust (DCT) は、リモートにある Docker レジストリとの間で送受信するデータに対して、デジタル署名を利用する機能を提供します。
この署名によって、特定のタグづけされたイメージに対する完全性と公開者情報を、クライアント側においてあるいは実行時に検証することが可能となります。</p>

<p>DCT を利用することで、イメージ公開者はイメージに署名をつけることができ、一方その利用者は、そのイメージが署名されていることを確認することができます。
公開者とは、個人や組織である場合もあります。
また公開イメージに手動で署名を行っているかもしれませんし、ソフトウェアサプライチェーンのリリース過程において署名を自動化して行っているかもしれません。</p>

<h3 id="image-tags-and-dct">イメージタグと DCT</h3>

<p>各イメージのレコードには、以下の識別子があります。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[REGISTRY_HOST[:REGISTRY_PORT]/]REPOSITORY[:TAG]
</code></pre></div></div>

<p>イメージ <code class="highlighter-rouge">REPOSITORY</code>にはタグを複数つけることができます。
たとえば <code class="highlighter-rouge">mongo</code> イメージにおいて <code class="highlighter-rouge">latest</code> と <code class="highlighter-rouge">3.1.2</code> という 2 つのタグづけが可能です。
イメージ公開者としては、イメージビルドとタグづけの組み合わせを何回も行って、イメージを作り変えていくことができます。</p>

<p>DCT はイメージの <code class="highlighter-rouge">TAG</code> 部分に関連づけられます。
イメージリポジトリでは一連のキーが管理されていて、そこにイメージ公開者がイメージタグに署名した情報が保持されます。
どのイメージに署名するのかは、イメージ公開者の判断に任されています。</p>

<p>イメージリポジトリには、署名を行ったタグを持つイメージと、署名を行っていないものを同時に含めることができます。
たとえば <a href="https://hub.docker.com/r/library/mongo/tags/">Mongo イメージリポジトリ</a> を確認してみてください。
<code class="highlighter-rouge">latest</code> タグには署名をつけず、<code class="highlighter-rouge">3.1.6</code> タグには署名するといったことが可能です。
イメージタグに署名するかどうかは、そのイメージ公開者の責任のもとで行うことになります。
以下の図においては、署名されているタグと署名されていないタグが示されています。</p>

<p><img src="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/images/tag_signing.png" alt="署名されたタグ" /></p>

<p>イメージ公開者としては、特定のタグに対して署名するかしないかを選択します。
結果として同一のイメージ名であっても、署名されていないタグと署名されたタグとでは内容が異なることになります。
たとえばイメージ公開者が、タグづけしたイメージ <code class="highlighter-rouge">someimage:latest</code> をプッシュして、これに署名をしたとします。
この後にその人が、署名を行っていない <code class="highlighter-rouge">someimage:latest</code> イメージをプッシュしたとします。
2 つめにプッシュした内容は、署名を行っていない <code class="highlighter-rouge">latest</code> タグによって置き換えられることになりますが、ただし署名を行っていた <code class="highlighter-rouge">latest</code> バージョンには何ら影響を与えません。
署名する対象のタグは自由に選択できることから、公開者にとっては署名を行わないイメージ作りを何度も繰り返し行って、最後に公式イメージに署名を行うということもできます。</p>

<p>イメージの利用者は DCT を使って、イメージが署名されているかどうかを確認することができます。
DCT を有効にしている場合、イメージの利用者は信頼できる署名済イメージのみをプル、実行、ビルドを行うことができます。
DCT を有効にするというのは、レジストリに対していわば「フィルタリング」を設定するようなものです。
利用者には署名されたイメージタグのみが「見える」のであって、これに比べて署名されていないイメージタグは好ましくないものとして「見えなくなる」というものです。</p>

<p><img src="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/images/trust_view.png" alt="信頼性を確認する画面" /></p>

<p>DCT を有効にしていない利用者にとって、Docker イメージに関する作業は何も変わりません。
イメージはすべて「見える」ものであって、署名されている、されていないは関係がありません。</p>

<h3 id="docker-content-trust-keys">Docker Content Trust 署名鍵</h3>

<p>イメージタグへの信頼性は、署名鍵を利用して行われます。
DCT を用いて初めて操作をする際に、鍵情報が生成されます。
鍵情報は、以下に示すような鍵のクラスから構成されます。</p>

<ul>
  <li>an offline key that is the root of DCT for an image tag</li>
  <li>repository or tagging keys that sign tags</li>
  <li>server-managed keys such as the timestamp key, which provides freshness
  security guarantees for your repository</li>
</ul>

<p>以下の図は、さまざまな署名鍵とその関係性を示すものです。</p>

<p><img src="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/images/trust_components.png" alt="Content Trust のコンポーネント" /></p>

<blockquote class="warning">
  <p><strong>警告</strong>:
ルート鍵を紛失してしまうと、回復は <strong>非常に困難</strong> になります。
これを復旧するには <a href="https://support.docker.com">Docker サポート</a> に連絡し、リポジトリの状態をリセットすることが必要です。
This loss
also requires <strong>manual intervention</strong> from every consumer that used a signed
tag from this repository prior to the loss.</p>
</blockquote>

<p>You should back up the root key somewhere safe. Given that it is only required
to create new repositories, it is a good idea to store it offline in hardware.
For details on securing, and backing up your keys, make sure you
read how to <a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/trust_key_mng/">manage keys for DCT</a>.</p>

<h2 id="signing-images-with-docker-content-trust">Docker Content Trust によるイメージへの署名</h2>

<blockquote>
  <p>ここに示す内容は Docker Community Engine 17.12 およびそれ以降、Docker Enterprise Engine 18.03 およびそれ以降に適用されます。</p>
</blockquote>

<p>Within the Docker CLI we can sign and push a container image with the
<code class="highlighter-rouge">$ docker trust</code> command syntax. This is built on top of the Notary feature
set, more information on Notary can be found <a href="https://matsuand.github.io/docs.docker.jp.onthefly/notary/getting_started/">here</a>.</p>

<p>A prerequisite for signing an image is a Docker Registry with a Notary server
attached (Such as the Docker Hub or Docker Trusted Registry). Instructions for
standing up a self-hosted environment can be found <a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/deploying_notary/">here</a>.</p>

<p>To sign a Docker Image you will need a delegation key pair. These keys
can be generated locally using <code class="highlighter-rouge">$ docker trust key generate</code>, generated
by a certificate authority, or if you are using Docker Enterprise’s
Universal Control Plane (UCP), a user’s Client Bundle provides adequate keys for a
delegation. Find more information on Delegation Keys
<a href="trust_delegation/#creating-delegation-keys">here</a>.</p>

<p>First we will add the delegation private key to the local Docker trust
repository. (By default this is stored in <code class="highlighter-rouge">~/.docker/trust/</code>). If you are
generating delegation keys with <code class="highlighter-rouge">$ docker trust key generate</code>, the private key
is automatically added to the local trust store. If you are importing a separate
key, such as one from a UCP Client Bundle you will need to use the
<code class="highlighter-rouge">$ docker trust key load</code> command.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust key generate jeff
Generating key for jeff...
Enter passphrase for new jeff key with ID 9deed25:
Repeat passphrase for new jeff key with ID 9deed25:
Successfully generated and loaded private key. Corresponding public key available: /home/ubuntu/Documents/mytrustdir/jeff.pub
</code></pre></div></div>

<p>Or if you have an existing key:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust key load key.pem --name jeff
Loading key from "key.pem"...
Enter passphrase for new jeff key with ID 8ae710e:
Repeat passphrase for new jeff key with ID 8ae710e:
Successfully imported key from key.pem
</code></pre></div></div>

<p>Next we will need to add the delegation public key to the Notary server;
this is specific to a particular image repository in Notary known as a Global
Unique Name (GUN). If this is the first time you are adding a delegation to that
repository, this command will also initiate the repository, using a local Notary
canonical root key. To understand more about initiating a repository, and the
role of delegations, head to
<a href="trust_delegation/#managing-delegations-in-a-notary-server">delegations for content trust</a>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust signer add --key cert.pem jeff dtr.example.com/admin/demo
Adding signer "jeff" to dtr.example.com/admin/demo...
Enter passphrase for new repository key with ID 10b5e94:
</code></pre></div></div>

<p>Finally, we will use the delegation private key to sign a particular tag and
push it up to the registry.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust sign dtr.example.com/admin/demo:1
Signing and pushing trust data for local image dtr.example.com/admin/demo:1, may overwrite remote trust data
The push refers to repository [dtr.example.com/admin/demo]
7bff100f35cb: Pushed
1: digest: sha256:3d2e482b82608d153a374df3357c0291589a61cc194ec4a9ca2381073a17f58e size: 528
Signing and pushing trust metadata
Enter passphrase for signer key with ID 8ae710e:
Successfully signed dtr.example.com/admin/demo:1
</code></pre></div></div>

<p>Alternatively, once the keys have been imported an image can be pushed with the
<code class="highlighter-rouge">$ docker push</code> command, by exporting the DCT environmental variable.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ export DOCKER_CONTENT_TRUST=1

$ docker push dtr.example.com/admin/demo:1
The push refers to repository [dtr.example.com/admin/demo:1]
7bff100f35cb: Pushed
1: digest: sha256:3d2e482b82608d153a374df3357c0291589a61cc194ec4a9ca2381073a17f58e size: 528
Signing and pushing trust metadata
Enter passphrase for signer key with ID 8ae710e:
Successfully signed dtr.example.com/admin/demo:1
</code></pre></div></div>

<p>Remote trust data for a tag or a repository can be viewed by the
<code class="highlighter-rouge">$ docker trust inspect</code> command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust inspect --pretty dtr.example.com/admin/demo:1


Signatures for dtr.example.com/admin/demo:1

SIGNED TAG          DIGEST                                                             SIGNERS
1                   3d2e482b82608d153a374df3357c0291589a61cc194ec4a9ca2381073a17f58e   jeff


List of signers and their keys for dtr.example.com/admin/demo:1

SIGNER              KEYS
jeff                8ae710e3ba82


Administrative keys for dtr.example.com/admin/demo:1

  Repository Key:	10b5e94c916a0977471cc08fa56c1a5679819b2005ba6a257aa78ce76d3a1e27
  Root Key:	84ca6e4416416d78c4597e754f38517bea95ab427e5f95871f90d460573071fc
</code></pre></div></div>

<p>Remote Trust data for a tag can be removed by the <code class="highlighter-rouge">$ docker trust revoke</code> command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust revoke dtr.example.com/admin/demo:1
Enter passphrase for signer key with ID 8ae710e:
Successfully deleted signature for dtr.example.com/admin/demo:1
</code></pre></div></div>

<h2 id="runtime-enforcement-with-docker-content-trust">Runtime Enforcement with Docker Content Trust</h2>

<blockquote>
  <p>Note this only applies to Docker Enterprise Engine 18.09 or newer. This
implementation is also separate from the <code class="highlighter-rouge">only run signed images</code> feature of
<a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/ucp/admin/configure/run-only-the-images-you-trust/">Universal Control Plane</a></p>
</blockquote>

<p>Docker Content Trust within the Docker Enterprise Engine prevents a user from
using a container image from an unknown source, it will also prevent a user from
building a container image from a base layer from an unknown source. Trusted
sources could include Official Docker Images, found on the <a href="https://hub.docker.com/search?image_filter=official&amp;type=image">Docker
Hub</a>, or User
trusted sources, with repositories and tags signed with the commands <a href="https://matsuand.github.io/docs.docker.jp.onthefly/content_trust.md#signing-images-with-docker-content-trust">above</a>.</p>

<p>Engine Signature Verification prevents the following:</p>
<ul>
  <li><code class="highlighter-rouge">$ docker container run</code> of an unsigned or altered image.</li>
  <li><code class="highlighter-rouge">$ docker pull</code> of an unsigned or altered image.</li>
  <li><code class="highlighter-rouge">$ docker build</code> where the <code class="highlighter-rouge">FROM</code> image is not signed or is not scratch.</li>
</ul>

<blockquote>
  <p><strong>Note</strong>: The implicit pulls and runs performed by worker
nodes for a <a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/swarm/services.md">Swarm service</a> on <code class="highlighter-rouge">$ docker service create</code> and
<code class="highlighter-rouge">$ docker service update</code> are also verified. Tag resolution of services
requires that all nodes in the Swarm including managers have content trust
enabled and similarly configured.</p>
</blockquote>

<p>DCT does not verify that a running container’s filesystem has not been altered
from what was in the image. For example, it does not prevent a container from
writing to the filesystem, once the container is running, nor does it prevent
the container’s filesystem from being altered on disk. DCT will also not prevent
unsigned images from being imported, loaded, or created.</p>

<h3 id="enabling-dct-within-the-docker-enterprise-engine">Enabling DCT within the Docker Enterprise Engine</h3>

<p>DCT is controlled by the Docker Engine’s configuration file. By default this is
found at <code class="highlighter-rouge">/etc/docker/daemon.json</code>. More details on this file can be found
<a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/reference/commandline/dockerd/#daemon-configuration-file">here</a>.</p>

<p>The <code class="highlighter-rouge">content-trust</code> flag is based around a <code class="highlighter-rouge">mode</code> variable instructing
the engine whether to enforce signed images, and a <code class="highlighter-rouge">trust-pinning</code> variable
instructing the engine which sources to trust.</p>

<p><code class="highlighter-rouge">Mode</code> can take three variables:</p>

<ul>
  <li><code class="highlighter-rouge">Disabled</code> - Verification is not active and the remainder of the content-trust
related metadata will be ignored. This is the default value if <code class="highlighter-rouge">mode</code> is not
specified.</li>
  <li><code class="highlighter-rouge">Permissive</code> - Verification will be performed, but only failures will be
logged and remain unenforced. This configuration is intended for testing of
changes related to content-trust. The results of the signature verification
is displayed in the Docker Engine’s daemon logs.</li>
  <li><code class="highlighter-rouge">Enforced</code> - Content trust will be enforced and an image that cannot be
verified successfully will not be pulled or run.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "content-trust": {
        "mode": "enforced"
    }
}
</code></pre></div></div>

<h3 id="official-docker-images">Official Docker images</h3>

<p>All official Docker library images found on the Docker Hub (docker.io/library/*)
are signed by the same Notary root key. This root key’s ID has been embedded
inside of the Docker Enterprise Engine. Therefore, to enforce that, only official
Docker images can be used. Specify:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "content-trust": {
    "trust-pinning": {
      "official-library-images": true
    },
    "mode": "enforced"
  }
}
</code></pre></div></div>

<h3 id="user-signed-images">User-Signed images</h3>

<p>There are two options for trust pinning user-signed images:</p>

<ul>
  <li>Notary Canonical Root Key ID (DCT Root Key) is an ID that describes <em>just</em> the
root key used to sign a repository (or rather its respective keys). This is the
root key on the host that originally signed the repository (i.e. your workstation).
This can be retrieved from the workstation that signed the repository through
<code class="highlighter-rouge">$ grep -r "root" ~/.docker/trust/private/</code> (Assuming your trust data is
at <code class="highlighter-rouge">~/.docker/trust/*</code>). It is expected that this canonical ID has initiated
multiple image repositories (<code class="highlighter-rouge">mydtr/user1/image1</code> and <code class="highlighter-rouge">mydtr/user1/image2</code>).</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Retrieving Root ID
$ grep -r "root" ~/.docker/trust/private
/home/ubuntu/.docker/trust/private/0b6101527b2ac766702e4b40aa2391805b70e5031c04714c748f914e89014403.key:role: root

# Using a Canonical ID that has signed 2 repos (mydtr/user1/repo1 and mydtr/user1/repo2). Note you can use a Wildcard.

{
  "content-trust": {
    "trust-pinning": {
      "root-keys": {
         "mydtr/user1/*": [
           "0b6101527b2ac766702e4b40aa2391805b70e5031c04714c748f914e89014403"
         ]
      }
    },
    "mode": "enforced"
  }
}
</code></pre></div></div>

<ul>
  <li>Notary Root key ID (DCT Certificate ID) is an ID that describes the same, but
the ID is unique per repository. For example, <code class="highlighter-rouge">mydtr/user1/image1</code> and <code class="highlighter-rouge">mydtr/usr1/image2</code>
will have unique certificate IDs. A certificate ID can be retrieved through a
<code class="highlighter-rouge">$ docker trust inspect</code> command and is labelled as a root-key (referring back
to the Notary key name). This is designed for when different users are signing
their own repositories, for example, when there is no central signing server. As a cert-id
is more granular, it would take priority if a conflict occurs over a root ID.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Retrieving Cert ID
$ docker trust inspect mydtr/user1/repo1 | jq -r '.[].AdministrativeKeys[] | select(.Name=="Root") | .Keys[].ID'
9430d6e31e3b3e240957a1b62bbc2d436aafa33726d0fcb50addbf7e2dfa2168

# Using Cert Ids, by specifying 2 repositories by their DCT root ID. Example for using this may be different DTRs or maybe because the repository was initiated on different hosts, therefore having different canonical IDs.

{
  "content-trust": {
    "trust-pinning": {
      "cert-ids": {
         "mydtr/user1/repo1": [
           "9430d6e31e3b3e240957a1b62bbc2d436aafa33726d0fcb50addbf7e2dfa2168"
         ],
         "mydtr/user2/repo1": [
           "544cf09f294860f9d5bc953ad80b386063357fd206b37b541bb2c54166f38d08"
         ]
      }
    },
    "mode": "enforced"
  }
}
</code></pre></div></div>

<h3 id="using-dct-in-an-offline-environment">Using DCT in an offline environment</h3>

<p>If your engine is unable to communicate to the registry, we can enable DCT to
trust cached signature data. This is done through the
<code class="highlighter-rouge">allow-expired-cached-trust-data</code> variable.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "content-trust": {
    "trust-pinning": {
      "official-library-images": true,
      "root-keys": {
         "mydtr/user1/*": [
           "0b6101527b2ac766702e4b40aa2391805b70e5031c04714c748f914e89014403"
         ]
      },
      "cert-ids": {
         "mydtr/user2/repo1": [
           "9430d6e31e3b3e240957a1b62bbc2d436aafa33726d0fcb50addbf7e2dfa2168"
         ],
      }
    },
    "mode": "enforced",
    "allow-expired-cached-trust-data": true
  }
}
</code></pre></div></div>

<h2 id="client-enforcement-with-docker-content-trust">Client Enforcement with Docker Content Trust</h2>

<blockquote>
  <p>Note this is supported on Docker Community and Enterprise Engines newer than
17.03.</p>
</blockquote>

<p>Currently, content trust is disabled by default in the Docker Client. To enable
it, set the <code class="highlighter-rouge">DOCKER_CONTENT_TRUST</code> environment variable to <code class="highlighter-rouge">1</code>. This prevents
users from working with tagged images unless they contain a signature.</p>

<p>When DCT is enabled in the Docker client, <code class="highlighter-rouge">docker</code> CLI commands that operate on
tagged images must either have content signatures or explicit content hashes.
The commands that operate with DCT are:</p>

<ul>
  <li><code class="highlighter-rouge">push</code></li>
  <li><code class="highlighter-rouge">build</code></li>
  <li><code class="highlighter-rouge">create</code></li>
  <li><code class="highlighter-rouge">pull</code></li>
  <li><code class="highlighter-rouge">run</code></li>
</ul>

<p>For example, with DCT enabled a <code class="highlighter-rouge">docker pull someimage:latest</code> only
succeeds if <code class="highlighter-rouge">someimage:latest</code> is signed. However, an operation with an explicit
content hash always succeeds as long as the hash exists:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker pull dtr.example.com/user/image:1
Error: remote trust data does not exist for dtr.example.com/user/image: dtr.example.com does not have trust data for dtr.example.com/user/image

$ docker pull dtr.example.com/user/image@sha256:d149ab53f8718e987c3a3024bb8aa0e2caadf6c0328f1d9d850b2a2a67f2819a
sha256:ee7491c9c31db1ffb7673d91e9fac5d6354a89d0e97408567e09df069a1687c1: Pulling from user/image
ff3a5c916c92: Pull complete
a59a168caba3: Pull complete
Digest: sha256:ee7491c9c31db1ffb7673d91e9fac5d6354a89d0e97408567e09df069a1687c1
Status: Downloaded newer image for dtr.example.com/user/image@sha256:ee7491c9c31db1ffb7673d91e9fac5d6354a89d0e97408567e09df069a1687c1
</code></pre></div></div>

<h2 id="related-information">関連情報</h2>

<ul>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/trust_delegation/">Delegations for content trust</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/trust_automation/">Automation with content trust</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/trust_key_mng/">Manage keys for content trust</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/trust_sandbox/">Play in a content trust sandbox</a></li>
</ul>

							<!-- tags -->
							
							
							
							<span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span style="vertical-align: 2px"><a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=content">content</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=trust">trust</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=security">security</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=docker">docker</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=documentation">documentation</a></span>
							
							<!-- link corrections -->
              <script language="JavaScript">
							var x = document.links.length;
							var baseHref = document.getElementsByTagName('base')[0].href
							for (i = 0; i < x; i++) {
							  var munged = false;
							  var thisHREF = document.links[i].href;
							  var originalURL = "/engine/security/trust/content_trust/";
							  if (thisHREF.indexOf(baseHref + "#") > -1) {
							    // hash fix
							    //console.log('BEFORE: base:',baseHref,'thisHREF:',thisHREF,'originalURL:',originalURL);
							    thisHREF = originalURL + thisHREF.replace(baseHref, "");
							    //console.log('AFTER: base:',baseHref,'thisHREF:',thisHREF,'originalURL:',originalURL);
							  }
							  if ((thisHREF.indexOf(window.location.hostname) > -1 || thisHREF.indexOf('http') == -1) && document.links[i].className.indexOf("nomunge") < 0) {
							    munged = true;
							    thisHREF = thisHREF.replace(".md", "/").replace("/index/", "/");
							    document.links[i].setAttribute('href', thisHREF);
							  }
							}
							</script>
							
						  <div id="ratings-div" style="color:#b9c2cc; text-align: center; margin-top: 150px; visibility: hidden">
								<div id="pd_rating_holder_8453675"></div>
								<script type="text/javascript">
									PDRTJS_settings_8453675 = {
										"id": "8453675",
										"unique_id": "engine/security/trust/content_trust.md",
										"title": "Docker Content Trust",
										"permalink": "https://github.com/docker/docker.github.io/blob/master/engine/security/trust/content_trust.md"
									};
									(function(d, c, j) {
										if (!document.getElementById(j)) {
											var pd = d.createElement(c),
												s;
											pd.id = j;
											pd.src = ('https:' == document.location.protocol) ? 'https://polldaddy.com/js/rating/rating.js' : 'http://i0.poll.fm/js/rating/rating.js';
											s = document.getElementsByTagName(c)[0];
											s.parentNode.insertBefore(pd, s);
										}
									}(document, 'script', 'pd-rating-js'));
								</script>
							</div>
							
						</section>
					</main>
					<nav class="col-nav">
						<div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
						<div id="navbar" class="nav-sidebar">
    <ul class="nav" id="jsTOCLeftNav">
    </ul>
</div>

						</div>
					</nav>
					<div class="col-toc">
							<div class="sidebar hidden-xs hidden-sm">
							<div class="toc-nav">
								<div class="feedback-links">
									<ul>
										
										<li style="visibility: hidden"><a href="https://github.com/matsuand/docs.docker.jp/edit/v19.03.local/engine/security/trust/content_trust.md"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> このページの編集</a></li>
										<li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/issues/new?body=File: [engine/security/trust/content_trust.md](https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/content_trust/)"
															class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 文書変更のリクエスト</a></li>
										<li><a href="https://success.docker.com/support"><i class="fa fa-question" aria-hidden="true"></i> サポート依頼</a></li>
										<!-- toggle mode -->
										<li>
											<div class="toggle-mode">
												<div class="icon">
													<i class="fa fa-sun-o" aria-hidden="true"></i>
												</div>
												<div class="toggle-switch">
													<label class="switch">
														<input type="checkbox" id="switch-style">
														<div class="slider round"></div>
												</label>
												</div>
												<div class="icon">
													<i class="fa fa-moon-o" aria-hidden="true"></i>
												</div>
											</div>
										</li>
									</ul>
								</div>
								   
									<div id="side-toc-title">本ページ内</div>
									
<ul id="my_toc" class="inline_toc">
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/content_trust.md#about-docker-content-trust-dct" class="nomunge">Docker Content Trust について</a>
    <ul>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/content_trust.md#image-tags-and-dct" class="nomunge">イメージタグと DCT</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/content_trust.md#docker-content-trust-keys" class="nomunge">Docker Content Trust 署名鍵</a></li>
    </ul>
  </li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/content_trust.md#signing-images-with-docker-content-trust" class="nomunge">Docker Content Trust によるイメージへの署名</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/content_trust.md#runtime-enforcement-with-docker-content-trust" class="nomunge">Runtime Enforcement with Docker Content Trust</a>
    <ul>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/content_trust.md#enabling-dct-within-the-docker-enterprise-engine" class="nomunge">Enabling DCT within the Docker Enterprise Engine</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/content_trust.md#official-docker-images" class="nomunge">Official Docker images</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/content_trust.md#user-signed-images" class="nomunge">User-Signed images</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/content_trust.md#using-dct-in-an-offline-environment" class="nomunge">Using DCT in an offline environment</a></li>
    </ul>
  </li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/content_trust.md#client-enforcement-with-docker-content-trust" class="nomunge">Client Enforcement with Docker Content Trust</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/content_trust.md#related-information" class="nomunge">関連情報</a></li>
</ul>


								</div>
								
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	
	<footer class="footer">
		  
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/what-docker">What is Docker</a></li>
                        <li><a href="https://www.docker.com/what-container">What is a Container</a></li>
                        <li><a href="https://www.docker.com/use-cases">Use Cases</a></li>
                        <li><a href="https://www.docker.com/customers">Customers</a></li>
                        <li><a href="https://www.docker.com/partners/partner-program">Partners</a></li>
                        <li class="break"><a href="https://www.docker.com/industry-government">For Government</a></li>
                        <li><a href="https://www.docker.com/company">About Docker</a></li>
                        <li><a href="https://www.docker.com/company/management">Management</a></li>
                        <li><a href="https://www.docker.com/company/news-and-press">Press &amp; News</a></li>
                        <li><a href="https://www.docker.com/careers">Careers</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/products/overview">Product</a></li>
                        <li><a href="https://www.docker.com/pricing">Pricing</a></li>
                        <li><a href="https://www.docker.com/docker-community">Community Edition</a></li>
                        <li class="break"><a href="https://www.docker.com/enterprise">Enterprise Edition </a></li>
                        <li><a href="https://www.docker.com/products/docker-datacenter">Docker Datacenter</a></li>
                        <li><a href="https://hub.docker.com/">Docker Hub</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/">Documentation</a></li>
                        <li><a href="https://www.docker.com/docker">Learn</a></li>
                        <li><a href="https://blog.docker.com" target="_blank">Blog</a></li>
                        <li><a href="https://engineering.docker.com" target="_blank">Engineering Blog</a></li>
                        <li><a href="https://training.docker.com/" target="_blank">Training</a></li>
                        <li><a href="https://success.docker.com/support">Support</a></li>
                        <li><a href="https://success.docker.com/kbase">Knowledge Base</a></li>
                        <li><a href="https://www.docker.com/products/resources">Resources</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/docker-community">Community</a></li>
                        <li><a href="https://www.docker.com/technologies/overview">Open Source</a></li>
                        <li><a href="https://www.docker.com/community/events">Events</a></li>
                        <li><a href="https://forums.docker.com/" target="_blank">Forums</a></li>
                        <li><a href="https://www.docker.com/community/docker-captains">Docker Captains</a></li>
                        <li><a href="https://www.docker.com/docker-community/scholarships">Scholarships</a></li>
                        <li><a href="https://blog.docker.com/curated/">Community News</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="http://status.docker.com/">Status</a></li>
                        <li><a href="https://www.docker.com/docker-security">Security</a></li>
                        <li><a href="https://www.docker.com/legal">Legal</a></li>
                        <li><a href="https://www.docker.com/company/contact">Contact</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2019 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="http://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="http://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-reddit"><a href="http://www.reddit.com/r/docker">Reddit</a></li>
                    <li class="fa fa-slideshare"><a href="http://www.slideshare.net/docker">Slideshare</a></li>
                </ul>
            </div>
        </div>
    </div>

	</footer>
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/github.css">
	
	<!-- <script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/anchorlinks.js"></script> -->
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/menu.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/jquery.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
	<!-- Always include the archive.js, but it doesn't do much unless we are an archive -->
	<script language="javascript">
	// Default to assuming this is an archive and hiding some stuff
	// See js/archive.js and js/docs.js for logic relating to this
	var isArchive = true;
	var dockerVersion = 'v19.03';
	// In archives, we need to know the page root and we get it from JEKYLL_ENV in the jekyll build command
	var jekyllEnv = 'development';
	// If unset (in non-archive branches), defaults to "development". In that case, reset it to empty
	if (jekyllEnv == 'development') {
		jekyllEnv = '';
	}
	var pageURL = jekyllEnv + '/engine/security/trust/content_trust/';
	</script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/archive.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/stickyfill.min.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/metadata.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/glossary.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/collections_tocs.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/docs.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/toc.js"></script>
	<script language="javascript">
	jQuery(document).ready(function(){
				hookupTOCEvents();
			});
	</script>
</body>

</html>
