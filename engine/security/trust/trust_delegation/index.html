<!-- Page generated 2019-07-03 11:12:02 +0900 -->
<!-- relative link basehrefs -->

	
	
	
		
			
		
	
		
			
		
	
		
			
		
	
		
			
			


<!-- Logic for 'edit this button' -->


	

	

	

	

	

	

	

	

	


<!-- End of logic for 'edit this button' -->


<!DOCTYPE html>
<html lang="ja">

<head>
	<base href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<style type="text/css">
		@charset "UTF-8";
		[ng\:cloak],
		[ng-cloak],
		[data-ng-cloak],
		[x-ng-cloak],
		.ng-cloak,
		.x-ng-cloak,
		.ng-hide:not(.ng-hide-animate) {
			display: none !important;
		}

		ng\:form {
			display: block;
		}
	</style>
	<script type="text/javascript">
	  !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="4.0.0";
	  analytics.load("IWj9D0UpZHZdZUZX9jl98PcpBFWBnBMy");
	  analytics.page();
	  }}();
	</script>
	
	<!-- favicon -->
	<link rel="icon" type="image/x-icon" href="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
	<meta name="msapplication-TileImage" content="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico">
	<link rel="apple-touch-icon" type="image/x-icon" href="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
	<meta property="og:image" content="https://matsuand.github.io/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
	<!-- metadata -->
	<meta property="og:type" content="website"/>
	<meta property="og:updated_time" itemprop="dateUpdated" content="2019-07-03T11:12:02+09:00"/>
	<meta property="og:image" itemprop="image primaryImageOfPage" content="https://matsuand.github.io/docs.docker.jp.onthefly/images/docs@2x.png"/>
	<meta name="twitter:card" content="summary"/>
	<meta name="twitter:domain" content="docs.docker.jp"/>
	<meta name="twitter:site" content="@docker_docs"/>
	<meta name="twitter:url" content="https://twitter.com/docker_docs"/>
	<meta name="twitter:title" itemprop="title name" content="Delegations for content trust"/>
	<meta name="twitter:description" property="og:description" itemprop="description" content="Delegations in Docker Content Trust (DCT) allow you to control who can and cannot sign an image tag. A delegation will have a pair of private and public delegation keys...." />
	<meta name="twitter:image:src" content="https://matsuand.github.io/docs.docker.jp.onthefly/images/docs@2x.png"/>
	<meta name="twitter:image:alt" content="Docker Documentation"/>
	<meta property="article:published_time" itemprop="datePublished" content="2019-07-03T11:12:02+09:00"/>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="keywords" content="trust, security, delegations, keys, repository">
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/bootstrap.min.css">
	<link id="pygments" rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/pygments/perldoc.css">
	<link id="pagestyle" rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/style.css">

	<!-- Go get "Open Sans" font from Google -->
	<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
	<!-- SEO stuff -->
	<title>Delegations for content trust | Docker Documentation</title>
<meta property="og:title" content="Delegations for content trust" />
<meta property="og:locale" content="ja_JP" />
<meta name="description" content="Delegations for content trust" />
<meta property="og:description" content="Delegations for content trust" />
<link rel="canonical" href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/trust_delegation/" />
<meta property="og:url" content="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/trust_delegation/" />
<meta property="og:site_name" content="Docker Documentation" />
<script type="application/ld+json">
{"@context":"http://schema.org","@type":"WebPage","headline":"Delegations for content trust","description":"Delegations for content trust","url":"https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/trust_delegation/"}</script>
	<!-- END SEO STUFF -->
	
	<script language="javascript">
	// Default to assuming this is an archive and hiding some stuff
	// See js/archive.js and js/docs.js for logic relating to this
	var isArchive = true;
	var dockerVersion = 'v18.09';
	</script>
</head>
<body ng-app="Docker" ng-controller="DockerController" class="colums">
	<header>
		 <nav class="nav-secondary navbar navbar-fixed-top">
    <!-- <div class="fan"></div> -->
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="https://matsuand.github.io/docs.docker.jp.onthefly/"><img class="logo" src="https://matsuand.github.io/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs"></a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="search-form" id="search-div" style="visibility: hidden">
    <form class="search-form form-inline ng-pristine ng-valid" /id="searchForm" action="/docs.docker.jp.onthefly/search/">
        <input class="search-field form-control ds-input" id="st-search-input" value="" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteContainer">
            <div id="autocompleteResults"></div>
        </div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container">
    <div id="tabs">
        <ul class="tabs" id="jsTOCHorizontal">

        </ul>
    </div>
    <div class="ctrl-right hidden-xs hidden-sm">
        <a href="javascript:void(0)" id="menu-toggle"><i class="fa fa-indent" aria-hidden="true"></i></a>
        <div class="btn-group" style="visibility: hidden">
  <button type="button" class="btn btn-default dropdown-btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Docker v18.09 (current)        <span class="caret"></span>
  </button>
  <ul class="dropdown-menu">
    <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/edge/">Docker edge</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v18.03/">Docker v18.03</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.12/">Docker v17.12</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.09/">Docker v17.09</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.06/">Docker v17.06</a></li><li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/v17.03/">Docker v17.03</a></li>
  </ul>
</div>

    </div>
</div>

        </div>
    </div>
</nav>

	</header>

	<div class="wrapper right-open">
		<div class="container-fluid">
			<div class="row">
				<div class="col-body">
					<main class="col-content content">
						<section class="section">
							
								
							<h1>Delegations for content trust</h1>  <span class="reading-time" title="Estimated reading time">
  <span class="reading-time-label">読む時間の目安: </span>
  
  
    14 分
  
</span>

							
							
							<p>Delegations in Docker Content Trust (DCT) allow you to control who can and cannot sign
an image tag. A delegation will have a pair of private and public delegation keys. A delegation
could contain multiple pairs of keys and contributors in order to a) allow multiple users
to be part of a delegation, and b) to support key rotation.</p>

<p>The most important delegation within Docker Content Trust is <code class="highlighter-rouge">targets/releases</code>.
This is seen as the canonical source of a trusted image tag, and without a
contributor’s key being under this delegation, they will be unable to sign a tag.</p>

<p>Fortunately when using the <code class="highlighter-rouge">$ docker trust</code> commands, we will automatically
initialize a repository, manage the repository keys, and add a collaborator’s key to the
<code class="highlighter-rouge">targets/releases</code> delegation via <code class="highlighter-rouge">docker trust signer add</code>.</p>

<h2 id="configuring-the-docker-client">Configuring the Docker Client</h2>

<p>By default, the <code class="highlighter-rouge">$ docker trust</code> commands expect the notary server URL to be the
same as the registry URL specified in the image tag (following a similar logic to
<code class="highlighter-rouge">$ docker push</code>). When using Docker Hub or DTR, the notary
server URL is the same as the registry URL. However, for self-hosted
environments or 3rd party registries, you will need to specify an alternative
URL for the notary server. This is done with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export DOCKER_CONTENT_TRUST_SERVER=https://&lt;URL&gt;:&lt;PORT&gt;
</code></pre></div></div>

<p>If you do not export this variable in self-hosted environments, you may see
errors such as:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust signer add --key cert.pem jeff dtr.example.com/admin/demo
Adding signer "jeff" to dtr.example.com/admin/demo...
[...]
Error: trust data missing for remote repository dtr.example.com/admin/demo or remote repository not found: timestamp key trust data unavailable.  Has a notary repository been initialized?

$ docker trust inspect dtr.example.com/admin/demo --pretty
WARN[0000] Error while downloading remote metadata, using cached timestamp - this might not be the latest version available remotely
[...]
</code></pre></div></div>

<p>If you have enabled authentication for your notary server, or are using DTR, you will need to log in
before you can push data to the notary server.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker login dtr.example.com/user/repo
Username: admin
Password:

Login Succeeded

$ docker trust signer add --key cert.pem jeff dtr.example.com/user/repo
Adding signer "jeff" to dtr.example.com/user/repo...
Initializing signed repository for dtr.example.com/user/repo...
Successfully initialized "dtr.example.com/user/repo"
Successfully added signer: jeff to dtr.example.com/user/repo
</code></pre></div></div>

<p>If you do not log in, you will see:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker trust signer add <span class="nt">--key</span> cert.pem jeff dtr.example.com/user/repo
Adding signer <span class="s2">"jeff"</span> to dtr.example.com/user/repo...
Initializing signed repository <span class="k">for </span>dtr.example.com/user/repo...
you are not authorized to perform this operation: server returned 401.

Failed to add signer to: dtr.example.com/user/repo
</code></pre></div></div>

<p>If you are using DTR and would like to work with a remote UCP’s signing policy,
you must <a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/dtr/user/manage-images/sign-images/trust-with-remote-ucp/#registering-dtr-with-a-remote-universal-control-plane">register your DTR instance with that remote UCP</a>.
See <a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/dtr/user/manage-images/sign-images/trust-with-remote-ucp/">Using Docker Content Trust with a Remote UCP Cluster</a> for more details.</p>

<h2 id="configuring-the-notary-client">Configuring the Notary Client</h2>

<p>Some of the more advanced features of DCT require the Notary CLI. To install and
configure the Notary CLI:</p>

<p>1) Download the <a href="https://github.com/theupdateframework/notary/releases">client</a>
and ensure that it is available on your path.</p>

<p>2) Create a configuration file at <code class="highlighter-rouge">~/.notary/config.json</code> with the following content:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "trust_dir" : "~/.docker/trust",
  "remote_server": {
    "url": "https://dtr.example.com",
    "root_ca": "../.docker/ca.pem"
  }
}
</code></pre></div></div>

<p>The newly created configuration file contains information about the location of your local Docker trust data and the notary server URL.</p>

<p>For more detailed information about how to use notary outside of the
Docker Content Trust use cases, refer to the Notary CLI documentation
<a href="https://github.com/theupdateframework/notary/blob/master/docs/command_reference.md">here</a></p>

<h2 id="creating-delegation-keys">Creating Delegation Keys</h2>

<p>A prerequisite to adding your first contributor is a pair of delegation keys.
These keys can either be generated locally using <code class="highlighter-rouge">$ docker trust</code>, generated by
a certificate authority, or can be taken from a Universal Control Plane’s
<a href="ee/ucp/user-access/cli/#download-client-certificates">Client Bundle</a>.</p>

<h3 id="using-docker-trust-to-generate-keys">Using Docker Trust to Generate Keys</h3>

<p>Docker trust has a built-in generator for a delegation key pair,
<code class="highlighter-rouge">$ docker trust generate &lt;name&gt;</code>. Running this command will automatically load
the delegation private key in to the local Docker trust store.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust key generate jeff
Generating key for jeff...
Enter passphrase for new jeff key with ID 9deed25:
Repeat passphrase for new jeff key with ID 9deed25:
Successfully generated and loaded private key. Corresponding public key available: /home/ubuntu/Documents/mytrustdir/jeff.pub
</code></pre></div></div>

<h3 id="manually-generating-keys">Manually Generating Keys</h3>

<p>If you need to manually generate a private key (either RSA or ECDSA) and a x509
certificate containing the public key, you can use local tools like openssl or
cfssl along with a local or company-wide Certificate Authority.</p>

<p>Here is an example of how to generate a 2048-bit RSA portion key (all RSA keys
must be at least 2048 bits):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openssl genrsa -out delegation.key 2048
Generating RSA private key, 2048 bit long modulus
....................................................+++
............+++
e is 65537 (0x10001)

</code></pre></div></div>

<p>They should keep <code class="highlighter-rouge">delegation.key</code> private because it is used to sign tags.</p>

<p>Then they need to generate an x509 certificate containing the public key, which is
what you need from them. Here is the command to generate a CSR (certificate
signing request):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openssl req -new -sha256 -key delegation.key -out delegation.csr
</code></pre></div></div>

<p>Then they can send it to whichever CA you trust to sign certificates, or they
can self-sign the certificate (in this example, creating a certificate that is
valid for 1 year):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openssl x509 -req -sha256 -days 365 -in delegation.csr -signkey delegation.key -out delegation.crt
</code></pre></div></div>

<p>Then they need to give you <code class="highlighter-rouge">delegation.crt</code>, whether it is self-signed or signed
by a CA.</p>

<p>Finally you will need to add the private key into your local Docker trust store.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust key load delegation.key --name jeff
Loading key from "delegation.key"...
Enter passphrase for new jeff key with ID 8ae710e:
Repeat passphrase for new jeff key with ID 8ae710e:
Successfully imported key from delegation.key
</code></pre></div></div>

<h3 id="using-universal-control-planes-client-bundles">Using Universal Control Plane’s Client Bundles</h3>

<p>Universal Control Plane (UCP) manages CLI and API access to its clusters through
certificates generated in a Client Bundle. These certificates and keys can be
used as a delegation key pair. Within each client bundle there is a unique
private key (<code class="highlighter-rouge">key.pem</code>) and x509 certificate containing a public key
(<code class="highlighter-rouge">cert.pem</code>).</p>

<p>1) Download a user’s client bundle from the
<a href="ee/ucp/user-access/cli/#download-client-certificates">Universal Control Plane</a>.</p>

<p>2) Extract the client bundle into your current directory</p>

<p>3) Load the private key into your local Docker trust store</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust key load key.pem --name jeff
Loading key from "key.pem"...
Enter passphrase for new jeff key with ID 9deed25:
Repeat passphrase for new jeff key with ID 9deed25:
Successfully imported key from key.pem
</code></pre></div></div>

<h3 id="viewing-local-delegation-keys">Viewing local Delegation keys</h3>

<p>To list the keys that have been imported in to the local Docker trust store we
can use the Notary CLI.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ notary key list

ROLE       GUN                          KEY ID                                                              LOCATION
----       ---                          ------                                                              --------
root                                    f6c6a4b00fefd8751f86194c7d87a3bede444540eb3378c4a11ce10852ab1f96    /home/ubuntu/.docker/trust/private
jeff                                    9deed251daa1aa6f9d5f9b752847647cf8d705da0763aa5467650d0987ed5306    /home/ubuntu/.docker/trust/private
</code></pre></div></div>

<h2 id="managing-delegations-in-a-notary-server">Managing Delegations in a Notary Server</h2>

<p>When the first Delegation is added to the Notary Server using <code class="highlighter-rouge">$ docker trust</code>,
we automatically initiate trust data for the repository. This includes creating
the notary target and snapshots keys, and rotating the snapshot key to be
managed by the notary server. More information on these keys can be found
<a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/trust_key_mng/">here</a></p>

<p>When initiating a repository, you will need the key and the passphrase of a local
Notary Canonical Root Key. If you have not initiated a repository before, and
therefore don’t have a Notary root key, <code class="highlighter-rouge">$ docker trust</code> will create one for you.</p>

<blockquote>
  <p>Be sure to protect and back up your <a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/trust_key_mng/">Notary Canonical Root Key</a></p>
</blockquote>

<h3 id="initiating-the-repository">Initiating the Repository</h3>

<p>To upload the first key to a delegation, at the same time initiating a
repository, you can use the <code class="highlighter-rouge">$ docker trust signer add</code> command. This will add
the contributor’s public key to the <code class="highlighter-rouge">targets/releases</code> delegation, and create a
second <code class="highlighter-rouge">targets/&lt;name&gt;</code> delegation.</p>

<p>For DCT the name of the second delegation, in the below example
<code class="highlighter-rouge">jeff</code>, is there to help you keep track of the owner of the keys. In more
advanced use cases of Notary additional delegations are used for hierarchy.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust signer add --key cert.pem jeff dtr.example.com/admin/demo
Adding signer "jeff" to dtr.example.com/admin/demo...
Initializing signed repository for dtr.example.com/admin/demo...
Enter passphrase for root key with ID f6c6a4b:
Enter passphrase for new repository key with ID b0014f8:
Repeat passphrase for new repository key with ID b0014f8:
Successfully initialized "dtr.example.com/admin/demo"
Successfully added signer: jeff to dtr.example.com/admin/demo
</code></pre></div></div>

<p>You can see which keys have been pushed to the Notary server for each repository
with the <code class="highlighter-rouge">$ docker trust inspect</code> command.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust inspect --pretty dtr.example.com/admin/demo

No signatures for dtr.example.com/admin/demo


List of signers and their keys for dtr.example.com/admin/demo

SIGNER              KEYS
jeff                1091060d7bfd

Administrative keys for dtr.example.com/admin/demo

  Repository Key:	b0014f8e4863df2d028095b74efcb05d872c3591de0af06652944e310d96598d
  Root Key:	64d147e59e44870311dd2d80b9f7840039115ef3dfa5008127d769a5f657a5d7
</code></pre></div></div>

<p>You could also use the Notary CLI to list delegations and keys. Here you can
clearly see the keys were attached to <code class="highlighter-rouge">targets/releases</code> and <code class="highlighter-rouge">targets/jeff</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ notary delegation list dtr.example.com/admin/demo

ROLE                PATHS             KEY IDS                                                             THRESHOLD
----                -----             -------                                                             ---------
targets/jeff        "" &lt;all paths&gt;    1091060d7bfd938dfa5be703fa057974f9322a4faef6f580334f3d6df44c02d1    1

targets/releases    "" &lt;all paths&gt;    1091060d7bfd938dfa5be703fa057974f9322a4faef6f580334f3d6df44c02d1    1
</code></pre></div></div>

<h3 id="adding-additional-signers">Adding Additional Signers</h3>

<p>Docker Trust allows you to configure multiple delegations per repository,
allowing you to manage the lifecycle of delegations. When adding additional
delegations with <code class="highlighter-rouge">$ docker trust</code> the collaborators key is once again added to
the <code class="highlighter-rouge">targets/release</code> role.</p>

<blockquote>
  <p>Note you will need the passphrase for the repository key; this would have been
configured when you first initiated the repository.</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust signer add --key ben.pub ben dtr.example.com/admin/demo
Adding signer "ben" to dtr.example.com/admin/demo...
Enter passphrase for repository key with ID b0014f8:
Successfully added signer: ben to dtr.example.com/admin/demo
</code></pre></div></div>

<p>Check to prove that there are now 2 delegations (Signer).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust inspect --pretty dtr.example.com/admin/demo

No signatures for dtr.example.com/admin/demo

List of signers and their keys for dtr.example.com/admin/demo

SIGNER              KEYS
ben                 afa404703b25
jeff                1091060d7bfd

Administrative keys for dtr.example.com/admin/demo

  Repository Key:	b0014f8e4863df2d028095b74efcb05d872c3591de0af06652944e310d96598d
  Root Key:	64d147e59e44870311dd2d80b9f7840039115ef3dfa5008127d769a5f657a5d7
</code></pre></div></div>

<h3 id="adding-keys-to-an-existing-delegation">Adding Keys to an Existing Delegation</h3>

<p>To support things like key rotation and expiring / retiring keys you can publish
multiple contributor keys per delegation. The only prerequisite here is to make
sure you use the same the delegation name, in this case <code class="highlighter-rouge">jeff</code>. Docker trust
will automatically handle adding this new key to <code class="highlighter-rouge">targets/releases</code>.</p>

<blockquote>
  <p>Note you will need the passphrase for the repository key; this would have been
configured when you first initiated the repository.</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust signer add --key cert2.pem jeff dtr.example.com/admin/demo
Adding signer "jeff" to dtr.example.com/admin/demo...
Enter passphrase for repository key with ID b0014f8:
Successfully added signer: jeff to dtr.example.com/admin/demo
</code></pre></div></div>

<p>Check to prove that the delegation (Signer) now contains multiple Key IDs.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust inspect --pretty dtr.example.com/admin/demo

No signatures for dtr.example.com/admin/demo


List of signers and their keys for dtr.example.com/admin/demo

SIGNER              KEYS
jeff                1091060d7bfd, 5570b88df073

Administrative keys for dtr.example.com/admin/demo

  Repository Key:	b0014f8e4863df2d028095b74efcb05d872c3591de0af06652944e310d96598d
  Root Key:	64d147e59e44870311dd2d80b9f7840039115ef3dfa5008127d769a5f657a5d7
</code></pre></div></div>

<h3 id="removing-a-delegation">Removing a Delegation</h3>

<p>If you need to remove a delegation, including the contributor keys that are
attached to the <code class="highlighter-rouge">targets/releases</code> role, you can use the
<code class="highlighter-rouge">$ docker trust signer remove</code> command.</p>

<blockquote>
  <p>Note tags that were signed by the removed delegation will need to be resigned
by an active delegation</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker trust signer remove dtr.example.com/admin/demo
Removing signer "ben" from dtr.example.com/admin/demo...
Enter passphrase for repository key with ID b0014f8:
Successfully removed ben from dtr.example.com/admin/demo
</code></pre></div></div>

<h4 id="troubleshooting">Troubleshooting</h4>

<p>1) If you see an error that there are no usable keys in <code class="highlighter-rouge">targets/releases</code>, you
will need to add additional delegations using <code class="highlighter-rouge">docker trust signer add</code> before
resigning images.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WARN[0000] role targets/releases has fewer keys than its threshold of 1; it will not be usable until keys are added to it
</code></pre></div></div>

<p>2) If you have added additional delegations already and are seeing an error
message that there are no valid signatures in <code class="highlighter-rouge">targest/releases</code>, you will need
to resign the <code class="highlighter-rouge">targets/releases</code> delegation file with the Notary CLI.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WARN[0000] Error getting targets/releases: valid signatures did not meet threshold for targets/releases
</code></pre></div></div>

<p>Resigning the delegation file is done with the <code class="highlighter-rouge">$ notary witness</code> command</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ notary witness dtr.example.com/admin/demo targets/releases --publish
</code></pre></div></div>

<p>More information on the <code class="highlighter-rouge">$ notary witness</code> command can be found
<a href="https://github.com/theupdateframework/notary/blob/master/docs/advanced_usage.md#recovering-a-delegation">here</a></p>

<h3 id="removing-a-contributors-key-from-a-delegation">Removing a Contributor’s Key from a Delegation</h3>

<p>As part of rotating keys for a delegation, you may want to remove an individual
key but retain the delegation. This can be done with the Notary CLI.</p>

<p>Remember you will have to remove the key from both the <code class="highlighter-rouge">targets/releases</code> role
and the role specific to that signer <code class="highlighter-rouge">targets/&lt;name&gt;</code>.</p>

<p>1) We will need to grab the Key ID from the Notary Server</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ notary delegation list dtr.example.com/admin/demo

ROLE                PATHS             KEY IDS                                                             THRESHOLD
----                -----             -------                                                             ---------
targets/jeff        "" &lt;all paths&gt;    8fb597cbaf196f0781628b2f52bff6b3912e4e8075720378fda60d17232bbcf9    1
                                      1091060d7bfd938dfa5be703fa057974f9322a4faef6f580334f3d6df44c02d1
targets/releases    "" &lt;all paths&gt;    8fb597cbaf196f0781628b2f52bff6b3912e4e8075720378fda60d17232bbcf9    1
                                      1091060d7bfd938dfa5be703fa057974f9322a4faef6f580334f3d6df44c02d1
</code></pre></div></div>

<p>2) Remove from the <code class="highlighter-rouge">targets/releases</code> delegation</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ notary delegation remove dtr.example.com/admin/demo targets/targets 1091060d7bfd938dfa5be703fa057974f9322a4faef6f580334f3d6df44c02d1 --publish
Auto-publishing changes to dtr.example.com/admin/demo
Enter username: admin
Enter password:
Enter passphrase for targets key with ID b0014f8:
Successfully published changes for repository dtr.example.com/admin/demo
</code></pre></div></div>

<p>3) Remove from the <code class="highlighter-rouge">targets/&lt;name&gt;</code> delegation</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ notary delegation remove dtr.example.com/admin/demo targets/jeff 1091060d7bfd938dfa5be703fa057974f9322a4faef6f580334f3d6df44c02d1 --publish

Removal of delegation role targets/jeff with keys [5570b88df0736c468493247a07e235e35cf3641270c944d0e9e8899922fc6f99], to repository "dtr.example.com/admin/demo" staged for next publish.

Auto-publishing changes to dtr.example.com/admin/demo
Enter username: admin
Enter password:
Enter passphrase for targets key with ID b0014f8:
Successfully published changes for repository dtr.example.com/admin/demo
</code></pre></div></div>

<p>4) Check the remaining delegation list</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ notary delegation list dtr.example.com/admin/demo

ROLE                PATHS             KEY IDS                                                             THRESHOLD
----                -----             -------                                                             ---------
targets/jeff        "" &lt;all paths&gt;    8fb597cbaf196f0781628b2f52bff6b3912e4e8075720378fda60d17232bbcf9    1
targets/releases    "" &lt;all paths&gt;    8fb597cbaf196f0781628b2f52bff6b3912e4e8075720378fda60d17232bbcf9    1
</code></pre></div></div>

<h3 id="removing-a-local-delegation-private-key">Removing a local Delegation Private Key</h3>

<p>As part of rotating delegation keys, you may need to remove a local delegation
key from the local Docker trust store. This is done with the Notary CLI, using
the <code class="highlighter-rouge">$ notary key remove</code> command.</p>

<p>1) We will need to get the Key ID from the local Docker Trust store</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ notary key list

ROLE       GUN                          KEY ID                                                              LOCATION
----       ---                          ------                                                              --------
root                                    f6c6a4b00fefd8751f86194c7d87a3bede444540eb3378c4a11ce10852ab1f96    /home/ubuntu/.docker/trust/private
admin                                   8fb597cbaf196f0781628b2f52bff6b3912e4e8075720378fda60d17232bbcf9    /home/ubuntu/.docker/trust/private
jeff                                    1091060d7bfd938dfa5be703fa057974f9322a4faef6f580334f3d6df44c02d1    /home/ubuntu/.docker/trust/private
targets    ...example.com/admin/demo    c819f2eda8fba2810ec6a7f95f051c90276c87fddfc3039058856fad061c009d    /home/ubuntu/.docker/trust/private
</code></pre></div></div>

<p>2) Remove the key from the local Docker Trust store</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ notary key remove 1091060d7bfd938dfa5be703fa057974f9322a4faef6f580334f3d6df44c02d1

Are you sure you want to remove 1091060d7bfd938dfa5be703fa057974f9322a4faef6f580334f3d6df44c02d1 (role jeff) from /home/ubuntu/.docker/trust/private?  (yes/no)  y

Deleted 1091060d7bfd938dfa5be703fa057974f9322a4faef6f580334f3d6df44c02d1 (role jeff) from /home/ubuntu/.docker/trust/private.
</code></pre></div></div>

<h2 id="removing-all-trust-data-from-a-repository">Removing all trust data from a Repository</h2>

<p>You can remove all trust data from a repository, including repository, target,
snapshot and all delegations keys using the Notary CLI.</p>

<p>This is often required by a container registry before a particular repository
can be deleted.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ notary delete dtr.example.com/admin/demo --remote
Deleting trust data for repository dtr.example.com/admin/demo
Enter username: admin
Enter password:
Successfully deleted local and remote trust data for repository dtr.example.com/admin/demo

$ docker trust inspect --pretty dtr.example.com/admin/demo
No signatures or cannot access dtr.example.com/admin/demo
</code></pre></div></div>

<h2 id="related-information">Related information</h2>

<ul>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/content_trust/">Content trust in Docker</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/trust_key_mng/">Manage keys for content trust</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/trust_automation/">Automation with content trust</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/trust_sandbox/">Play in a content trust sandbox</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/ee/dtr/user/manage-images/sign-images/trust-with-remote-ucp.md">Using Docker Content Trust with a Remote UCP Cluster</a></li>
</ul>

							<!-- tags -->
							
							
							
							<span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span style="vertical-align: 2px"><a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=trust">trust</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=security">security</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=delegations">delegations</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=keys">keys</a>, <a href="https://matsuand.github.io/docs.docker.jp.onthefly/glossary/?term=repository">repository</a></span>
							
							<!-- link corrections -->
              <script language="JavaScript">
							var x = document.links.length;
							var baseHref = document.getElementsByTagName('base')[0].href
							for (i = 0; i < x; i++) {
							  var munged = false;
							  var thisHREF = document.links[i].href;
							  var originalURL = "/engine/security/trust/trust_delegation/";
							  if (thisHREF.indexOf(baseHref + "#") > -1) {
							    // hash fix
							    //console.log('BEFORE: base:',baseHref,'thisHREF:',thisHREF,'originalURL:',originalURL);
							    thisHREF = originalURL + thisHREF.replace(baseHref, "");
							    //console.log('AFTER: base:',baseHref,'thisHREF:',thisHREF,'originalURL:',originalURL);
							  }
							  if ((thisHREF.indexOf(window.location.hostname) > -1 || thisHREF.indexOf('http') == -1) && document.links[i].className.indexOf("nomunge") < 0) {
							    munged = true;
							    thisHREF = thisHREF.replace(".md", "/").replace("/index/", "/");
							    document.links[i].setAttribute('href', thisHREF);
							  }
							}
							</script>
							
						  <div id="ratings-div" style="color:#b9c2cc; text-align: center; margin-top: 150px; visibility: hidden">
								<div id="pd_rating_holder_8453675"></div>
								<script type="text/javascript">
									PDRTJS_settings_8453675 = {
										"id": "8453675",
										"unique_id": "engine/security/trust/trust_delegation.md",
										"title": "Delegations for content trust",
										"permalink": "https://github.com/docker/docker.github.io/blob/master/engine/security/trust/trust_delegation.md"
									};
									(function(d, c, j) {
										if (!document.getElementById(j)) {
											var pd = d.createElement(c),
												s;
											pd.id = j;
											pd.src = ('https:' == document.location.protocol) ? 'https://polldaddy.com/js/rating/rating.js' : 'http://i0.poll.fm/js/rating/rating.js';
											s = document.getElementsByTagName(c)[0];
											s.parentNode.insertBefore(pd, s);
										}
									}(document, 'script', 'pd-rating-js'));
								</script>
							</div>
							
						</section>
					</main>
					<nav class="col-nav">
						<div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
						<div id="navbar" class="nav-sidebar">
    <ul class="nav" id="jsTOCLeftNav">
    </ul>
</div>

						</div>
					</nav>
					<div class="col-toc">
							<div class="sidebar hidden-xs hidden-sm">
							<div class="toc-nav">
								<div class="feedback-links">
									<ul>
										
										<li style="visibility: hidden"><a href="https://github.com/matsuand/docs.docker.jp/edit/v18.09.local/engine/security/trust/trust_delegation.md"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> このページの編集</a></li>
										<li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/issues/new?body=File: [engine/security/trust/trust_delegation.md](https://matsuand.github.io/docs.docker.jp.onthefly/engine/security/trust/trust_delegation/)"
															class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 文書変更のリクエスト</a></li>
										<li><a href="https://success.docker.com/support"><i class="fa fa-question" aria-hidden="true"></i> サポート依頼</a></li>
										<!-- toggle mode -->
										<li>
											<div class="toggle-mode">
												<div class="icon">
													<i class="fa fa-sun-o" aria-hidden="true"></i>
												</div>
												<div class="toggle-switch">
													<label class="switch">
														<input type="checkbox" id="switch-style">
														<div class="slider round"></div>
												</label>
												</div>
												<div class="icon">
													<i class="fa fa-moon-o" aria-hidden="true"></i>
												</div>
											</div>
										</li>
									</ul>
								</div>
								   
									<div id="side-toc-title">本ページ内</div>
									
<ul id="my_toc" class="inline_toc">
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#configuring-the-docker-client" class="nomunge">Configuring the Docker Client</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#configuring-the-notary-client" class="nomunge">Configuring the Notary Client</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#creating-delegation-keys" class="nomunge">Creating Delegation Keys</a>
    <ul>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#using-docker-trust-to-generate-keys" class="nomunge">Using Docker Trust to Generate Keys</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#manually-generating-keys" class="nomunge">Manually Generating Keys</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#using-universal-control-planes-client-bundles" class="nomunge">Using Universal Control Plane’s Client Bundles</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#viewing-local-delegation-keys" class="nomunge">Viewing local Delegation keys</a></li>
    </ul>
  </li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#managing-delegations-in-a-notary-server" class="nomunge">Managing Delegations in a Notary Server</a>
    <ul>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#initiating-the-repository" class="nomunge">Initiating the Repository</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#adding-additional-signers" class="nomunge">Adding Additional Signers</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#adding-keys-to-an-existing-delegation" class="nomunge">Adding Keys to an Existing Delegation</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#removing-a-delegation" class="nomunge">Removing a Delegation</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#removing-a-contributors-key-from-a-delegation" class="nomunge">Removing a Contributor’s Key from a Delegation</a></li>
      <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#removing-a-local-delegation-private-key" class="nomunge">Removing a local Delegation Private Key</a></li>
    </ul>
  </li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#removing-all-trust-data-from-a-repository" class="nomunge">Removing all trust data from a Repository</a></li>
  <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/#related-information" class="nomunge">Related information</a></li>
</ul>


								</div>
								
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	
	<footer class="footer">
		  
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/what-docker">What is Docker</a></li>
                        <li><a href="https://www.docker.com/what-container">What is a Container</a></li>
                        <li><a href="https://www.docker.com/use-cases">Use Cases</a></li>
                        <li><a href="https://www.docker.com/customers">Customers</a></li>
                        <li><a href="https://www.docker.com/partners/partner-program">Partners</a></li>
                        <li class="break"><a href="https://www.docker.com/industry-government">For Government</a></li>
                        <li><a href="https://www.docker.com/company">About Docker</a></li>
                        <li><a href="https://www.docker.com/company/management">Management</a></li>
                        <li><a href="https://www.docker.com/company/news-and-press">Press &amp; News</a></li>
                        <li><a href="https://www.docker.com/careers">Careers</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/products/overview">Product</a></li>
                        <li><a href="https://www.docker.com/pricing">Pricing</a></li>
                        <li><a href="https://www.docker.com/docker-community">Community Edition</a></li>
                        <li class="break"><a href="https://www.docker.com/enterprise">Enterprise Edition </a></li>
                        <li><a href="https://www.docker.com/products/docker-datacenter">Docker Datacenter</a></li>
                        <li><a href="https://hub.docker.com/">Docker Hub</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/">Documentation</a></li>
                        <li><a href="https://www.docker.com/docker">Learn</a></li>
                        <li><a href="https://blog.docker.com" target="_blank">Blog</a></li>
                        <li><a href="https://engineering.docker.com" target="_blank">Engineering Blog</a></li>
                        <li><a href="https://training.docker.com/" target="_blank">Training</a></li>
                        <li><a href="https://success.docker.com/support">Support</a></li>
                        <li><a href="https://success.docker.com/kbase">Knowledge Base</a></li>
                        <li><a href="https://www.docker.com/products/resources">Resources</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><a href="https://www.docker.com/docker-community">Community</a></li>
                        <li><a href="https://www.docker.com/technologies/overview">Open Source</a></li>
                        <li><a href="https://www.docker.com/community/events">Events</a></li>
                        <li><a href="https://forums.docker.com/" target="_blank">Forums</a></li>
                        <li><a href="https://www.docker.com/community/docker-captains">Docker Captains</a></li>
                        <li><a href="https://www.docker.com/docker-community/scholarships">Scholarships</a></li>
                        <li><a href="https://blog.docker.com/curated/">Community News</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="http://status.docker.com/">Status</a></li>
                        <li><a href="https://www.docker.com/docker-security">Security</a></li>
                        <li><a href="https://www.docker.com/legal">Legal</a></li>
                        <li><a href="https://www.docker.com/company/contact">Contact</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2019 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="http://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="http://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-reddit"><a href="http://www.reddit.com/r/docker">Reddit</a></li>
                    <li class="fa fa-slideshare"><a href="http://www.slideshare.net/docker">Slideshare</a></li>
                </ul>
            </div>
        </div>
    </div>

	</footer>
	<link rel="stylesheet" href="https://matsuand.github.io/docs.docker.jp.onthefly/css/github.css">
	
	<!-- <script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/anchorlinks.js"></script> -->
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/menu.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/jquery.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
	<!-- Always include the archive.js, but it doesn't do much unless we are an archive -->
	<script language="javascript">
	// Default to assuming this is an archive and hiding some stuff
	// See js/archive.js and js/docs.js for logic relating to this
	var isArchive = true;
	var dockerVersion = 'v18.09';
	// In archives, we need to know the page root and we get it from JEKYLL_ENV in the jekyll build command
	var jekyllEnv = 'development';
	// If unset (in non-archive branches), defaults to "development". In that case, reset it to empty
	if (jekyllEnv == 'development') {
		jekyllEnv = '';
	}
	var pageURL = jekyllEnv + '/engine/security/trust/trust_delegation/';
	</script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/archive.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/stickyfill.min.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/metadata.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/glossary.js"></script>
	<script src="https://matsuand.github.io/docs.docker.jp.onthefly/js/collections_tocs.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/docs.js"></script>
	<script defer src="https://matsuand.github.io/docs.docker.jp.onthefly/js/toc.js"></script>
	<script language="javascript">
	jQuery(document).ready(function(){
				hookupTOCEvents();
			});
	</script>
</body>

</html>
