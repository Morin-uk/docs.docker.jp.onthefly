
<p>このクィックスタートガイドでは Docker Compose を使って、簡単な Rails/PostgreSQL アプリを設定し実行する手順を示します。
はじめるには <a href="/docs.docker.jp.onthefly/compose/install/">Compose のインストール</a> が必要です。</p>

<h3 id="define-the-project">プロジェクトの定義</h3>

<p>アプリのビルドに必要となるファイルを作るところから始めます。
アプリの依存パッケージも含め、アプリは Docker コンテナー内で実行するものとします。
依存パッケージは <code class="language-plaintext highlighter-rouge">Dockerfile</code> というファイル内に定義します。
まずは Dockerfile を以下のようにします。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM ruby:2.5
RUN apt-get update -qq &amp;&amp; apt-get install -y nodejs postgresql-client
RUN mkdir /myapp
WORKDIR /myapp
COPY Gemfile /myapp/Gemfile
COPY Gemfile.lock /myapp/Gemfile.lock
RUN bundle install
COPY . /myapp

# コンテナー起動時に毎回実行されるスクリプトを追加
COPY entrypoint.sh /usr/bin/
RUN chmod +x /usr/bin/entrypoint.sh
ENTRYPOINT ["entrypoint.sh"]
EXPOSE 3000

# メインプロセスの起動
CMD ["rails", "server", "-b", "0.0.0.0"]
</code></pre></div></div>

<p>上の設定はイメージ内部にアプリケーションコードを置きます。
このイメージは Ruby、Bundler などの依存パッケージすべてをコンテナー内部に含めてビルドされます。
Dockerfile の記述方法の詳細は <a href="/docs.docker.jp.onthefly/get-started/">Docker ユーザーガイド</a> や <a href="/engine/reference/builder/">Dockerfile リファレンス</a> を参照してください。</p>

<p>次にブートストラップを行うファイル <code class="language-plaintext highlighter-rouge">Gemfile</code> を生成して、Rails をロードできるようにします。
このファイルは <code class="language-plaintext highlighter-rouge">rails new</code> を行ったタイミングで書き換わります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>source 'https://rubygems.org'
gem 'rails', '~&gt;5'
</code></pre></div></div>

<p>空のファイル <code class="language-plaintext highlighter-rouge">Gemfile.lock</code> を生成して <code class="language-plaintext highlighter-rouge">Dockerfile</code> のビルドができるようにします。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>touch Gemfile.lock
</code></pre></div></div>

<p>次にエントリーポイントの実行スクリプトを生成して、Rails 特有の問題へ対処します。
これはサーバー内に <code class="language-plaintext highlighter-rouge">server.pid</code> というファイルが先に存在していたときに、サーバーが再起動できなくなる問題を回避するものです。
このスクリプトは、コンテナーが起動されるたびに実行されることになります。
<code class="language-plaintext highlighter-rouge">entrypoint.sh</code> というこのスクリプトを、以下のように生成します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">set</span> <span class="nt">-e</span>

<span class="c"># Rails に対応したファイル server.pid が存在しているかもしれないので削除する。</span>
<span class="nb">rm</span> <span class="nt">-f</span> /myapp/tmp/pids/server.pid

<span class="c"># コンテナーのプロセスを実行する。（Dockerfile 内の CMD に設定されているもの。）</span>
<span class="nb">exec</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
</code></pre></div></div>

<p>最後に <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> が取りまとめてくれます。
このファイルには、データベースとウェブという 2 つのアプリを含んだサービスが定義されています。
そしてそれぞれの Docker イメージをどう作るかが示されています。
（データベースは既存の PostgreSQL イメージにより動作します。ウェブアプリはカレントディレクトリ内に生成されます。）
また、リンクによってそれを結び合わせることが設定されていて、ウェブアプリのポートは外部に公開されています。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: '3'
services:
  db:
    image: postgres
    volumes:
      - ./tmp/db:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: password
  web:
    build: .
    command: bash -c "rm -f tmp/pids/server.pid &amp;&amp; bundle exec rails s -p 3000 -b '0.0.0.0'"
    volumes:
      - .:/myapp
    ports:
      - "3000:3000"
    depends_on:
      - db
</code></pre></div></div>

<blockquote>
  <p><strong>ヒント</strong>: このファイルの拡張子は<code class="language-plaintext highlighter-rouge">.yml</code>と<code class="language-plaintext highlighter-rouge">.yaml</code>のどちらでも構いません。</p>
</blockquote>

<h3 id="build-the-project">プロジェクトのビルド</h3>

<p>ここまでのファイルを使って <a href="/docs.docker.jp.onthefly/compose/reference/run/">docker-compose run</a> を実行し、Rails アプリのひながたを生成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose run --no-deps web rails new . --force --database=postgresql
</code></pre></div></div>

<p>最初に Compose は <code class="language-plaintext highlighter-rouge">Dockerfile</code> を用いて <code class="language-plaintext highlighter-rouge">web</code> サービスに対するイメージをビルドします。
<code class="language-plaintext highlighter-rouge">--no-deps</code>フラグは Compose に対してリンクサービスは起動しないように指示します。
そしてこのイメージを利用して、新たに生成されたコンテナー内にて <code class="language-plaintext highlighter-rouge">rails new</code> を実行します。
処理が完了すれば、できたてのアプリが生成されているはずです。</p>

<p>ファイル一覧を見てみます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 64
<span class="nt">-rw-r--r--</span>   1 vmb  staff   222 Jun  7 12:05 Dockerfile
<span class="nt">-rw-r--r--</span>   1 vmb  staff  1738 Jun  7 12:09 Gemfile
<span class="nt">-rw-r--r--</span>   1 vmb  staff  4297 Jun  7 12:09 Gemfile.lock
<span class="nt">-rw-r--r--</span>   1 vmb  staff   374 Jun  7 12:09 README.md
<span class="nt">-rw-r--r--</span>   1 vmb  staff   227 Jun  7 12:09 Rakefile
drwxr-xr-x  10 vmb  staff   340 Jun  7 12:09 app
drwxr-xr-x   8 vmb  staff   272 Jun  7 12:09 bin
drwxr-xr-x  14 vmb  staff   476 Jun  7 12:09 config
<span class="nt">-rw-r--r--</span>   1 vmb  staff   130 Jun  7 12:09 config.ru
drwxr-xr-x   3 vmb  staff   102 Jun  7 12:09 db
<span class="nt">-rw-r--r--</span>   1 vmb  staff   211 Jun  7 12:06 docker-compose.yml
<span class="nt">-rw-r--r--</span>   1 vmb  staff   184 Jun  7 12:08 entrypoint.sh
drwxr-xr-x   4 vmb  staff   136 Jun  7 12:09 lib
drwxr-xr-x   3 vmb  staff   102 Jun  7 12:09 log
<span class="nt">-rw-r--r--</span>   1 vmb  staff    63 Jun  7 12:09 package.json
drwxr-xr-x   9 vmb  staff   306 Jun  7 12:09 public
drwxr-xr-x   9 vmb  staff   306 Jun  7 12:09 <span class="nb">test
</span>drwxr-xr-x   4 vmb  staff   136 Jun  7 12:09 tmp
drwxr-xr-x   3 vmb  staff   102 Jun  7 12:09 vendor
</code></pre></div></div>

<p>Linux 上で Docker を利用している場合、<code class="language-plaintext highlighter-rouge">rails new</code> により生成されたファイルの所有者は root になります。
これはコンテナーが root ユーザーにより実行されているためです。
この場合は、生成されたファイルの所有者を以下のように変更してください。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo chown</span> <span class="nt">-R</span> <span class="nv">$USER</span>:<span class="nv">$USER</span> <span class="nb">.</span>
</code></pre></div></div>

<p>Docker on Mac あるいは Docker on Windows を利用している場合、<code class="language-plaintext highlighter-rouge">rails new</code> により生成されたファイルも含め、すべてのファイルに対しての所有権は、正しく設定されているはずです。</p>

<p>ここに新たな Gemfile が作成されたので、イメージを再ビルドすることが必要です。
（再ビルドが必要になるのは、今の時点、あるいは <code class="language-plaintext highlighter-rouge">Gemfile</code> や Dockerfile を修正したときだけです。）</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose build
</code></pre></div></div>

<h3 id="connect-the-database">データベースの接続設定</h3>

<p>アプリは実行可能ですが、実行するのはまだです。
デフォルトで Rails は <code class="language-plaintext highlighter-rouge">localhost</code> において実行されているデータベースを用います。
したがってここでは <code class="language-plaintext highlighter-rouge">db</code> コンテナーを用いるように書き換える必要があります。
また <code class="language-plaintext highlighter-rouge">postgres</code> イメージにおいて設定されているデフォルトのデータベース名、ユーザー名を変更することも必要です。</p>

<p><code class="language-plaintext highlighter-rouge">config/database.yml</code> の記述内容を以下のように書き換えます。</p>

<pre><code class="language-none">default: &amp;default
  adapter: postgresql
  encoding: unicode
  host: db
  username: postgres
  password: password
  pool: 5

development:
  &lt;&lt;: *default
  database: myapp_development


test:
  &lt;&lt;: *default
  database: myapp_test
</code></pre>

<p><a href="/docs.docker.jp.onthefly/compose/reference/up/">docker-compose up</a> によりアプリを起動します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up
</code></pre></div></div>

<p>正常に動作すれば、PostgreSQL による出力が確認できるはずです。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails_db_1 is up-to-date
Creating rails_web_1 ... <span class="k">done
</span>Attaching to rails_db_1, rails_web_1
db_1   | PostgreSQL init process <span class="nb">complete</span><span class="p">;</span> ready <span class="k">for </span>start up.
db_1   |
db_1   | 2018-03-21 20:18:37.437 UTC <span class="o">[</span>1] LOG:  listening on IPv4 address <span class="s2">"0.0.0.0"</span>, port 5432
db_1   | 2018-03-21 20:18:37.437 UTC <span class="o">[</span>1] LOG:  listening on IPv6 address <span class="s2">"::"</span>, port 5432
db_1   | 2018-03-21 20:18:37.443 UTC <span class="o">[</span>1] LOG:  listening on Unix socket <span class="s2">"/var/run/postgresql/.s.PGSQL.5432"</span>
db_1   | 2018-03-21 20:18:37.726 UTC <span class="o">[</span>55] LOG:  database system was shut down at 2018-03-21 20:18:37 UTC
db_1   | 2018-03-21 20:18:37.772 UTC <span class="o">[</span>1] LOG:  database system is ready to accept connections
</code></pre></div></div>

<p>最後にデータベースを生成することが必要です。
別の端末から以下を実行します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose run web rake db:create
</code></pre></div></div>

<p>コマンドから出力される結果は、たとえば以下のようになります。</p>

<pre><code class="language-none">vmb at snapair in ~/sandbox/rails
$ docker-compose run web rake db:create
Starting rails_db_1 ... done
Created database 'myapp_development'
Created database 'myapp_test'
</code></pre>

<h3 id="rails-のようこそページの確認">Rails の「ようこそ」ページの確認</h3>

<p>以上です。
Docker デーモンを通じて、アプリがポート 3000 番を使って実行されています。</p>

<p>Docker Desktop for Mac や Docker Desktop for Windows の場合は、ウェブブラウザーから <code class="language-plaintext highlighter-rouge">http://localhost:3000</code> にアクセスすれば Rails のようこそページを確認できます。</p>

<p><img src="/docs.docker.jp.onthefly/compose/images/rails-welcome.png" alt="Rails の例" /></p>

<h3 id="stop-the-application">アプリケーションの停止</h3>

<p>アプリケーションを停止するには、プロジェクトディレクトリにおいて <a href="/docs.docker.jp.onthefly/compose/reference/down/">docker-compose down</a> を実行します。
この場合に用いる端末画面は、データベースを起動したときと同じものを用いるか、あるいはコマンドプロンプトにアクセスできる別画面であっても構いません。
これがアプリケーションを適切に停止する方法です。</p>

<pre><code class="language-none">vmb at snapair in ~/sandbox/rails
$ docker-compose down
Stopping rails_web_1 ... done
Stopping rails_db_1 ... done
Removing rails_web_run_1 ... done
Removing rails_web_1 ... done
Removing rails_db_1 ... done
Removing network rails_default

</code></pre>

<h3 id="restart-the-application">アプリケーションの再起動</h3>

<p>アプリケーションを再起動する場合は、プロジェクトディレクトリにて <code class="language-plaintext highlighter-rouge">docker-compose up</code> を実行します。</p>

<h3 id="rebuild-the-application">アプリケーションの再ビルド</h3>

<p>Gemfile や Compose ファイルを編集して、いろいろと別の設定とした場合には、再ビルドが必要になります。
変更内容によっては <code class="language-plaintext highlighter-rouge">docker-compose up --build</code> だけで済む場合もあります。
しかし完全に再ビルドを行うには、<code class="language-plaintext highlighter-rouge">docker-compose run web bundle install</code> を再度実行して、ホストにおける <code class="language-plaintext highlighter-rouge">Gemfile.lock</code> の変更と同期を取ることが必要になります。
その後に <code class="language-plaintext highlighter-rouge">docker-compose up --build</code> を実行します。</p>

<p>以下に示すのは前者、つまり完全な再ビルドは必要としない例です。
ローカルホスト側の公開ポートを <code class="language-plaintext highlighter-rouge">3000</code> から <code class="language-plaintext highlighter-rouge">3001</code> に変更する場合を取り上げます。
Compose ファイルにおいて、コンテナー側にて <code class="language-plaintext highlighter-rouge">3000</code> としているポートを新たなポート <code class="language-plaintext highlighter-rouge">3001</code> に変更します。
そしてこの変更を保存します。</p>

<pre><code class="language-none">ports: - "3001:3000"
</code></pre>

<p>再ビルドとアプリの再起動は  <code class="language-plaintext highlighter-rouge">docker-compose up --build</code> により行います。</p>

<p>コンテナー内部において、アプリはそれまでと変わらないポート <code class="language-plaintext highlighter-rouge">3000</code> で稼動していますが、ローカルホスト上から Rails ようこそページにアクセスするのは <code class="language-plaintext highlighter-rouge">http://localhost:3001</code> となります。</p>

<h2 id="more-compose-documentation">Compose ドキュメント</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/compose/">ユーザーガイド</a></li>
  <li><a href="/docs.docker.jp.onthefly/compose/install/">Compose のインストール</a></li>
  <li><a href="/docs.docker.jp.onthefly/compose/gettingstarted/">はじめよう</a></li>
  <li><a href="/docs.docker.jp.onthefly/compose/reference/">コマンドラインリファレンス</a></li>
  <li><a href="/docs.docker.jp.onthefly/compose/compose-file/">Compose ファイルリファレンス</a></li>
  <li><a href="/docs.docker.jp.onthefly/compose/samples-for-compose/">Compose を使ったサンプルアプリ</a></li>
</ul>
