
<p>Compose を用いたアプリの定義を開発環境で行っていたら、その定義を別の環境に、たとえば継続インテグレーション（CI）、ステージング環境、本番環境に適用することができます。</p>

<p>アプリケーションをデプロイする一番簡単な方法は、一つのサーバー上で動作させることです。
ちょうど開発環境で動作させている方法に近いものです。
アプリケーションをスケールアップしたいなら、Compose アプリをスウォームクラスター上で実行する方法もあります。</p>

<h3 id="modify-your-compose-file-for-production">本番環境向け Compose ファイルの修正</h3>

<p>アプリケーションの設定を本番環境向けにするには、変更を要するかもしれません。
その変更とは以下のようなものです。</p>

<ul>
  <li>アプリケーションコードからボリュームバインディングは削除します。
コードは内部のみで実現するようにし、外部から変更されないようにします。</li>
  <li>ホスト上のポートは別のものを割り当てます。</li>
  <li>環境変数は区別して割り当てます。
たとえば冗長なログ出力が不要な場合にログレベルを下げるとか、メールサーバーのような外部サーバーの設定を行うなど。</li>
  <li>再起動ポリシーを設定します。
例えば <code class="language-plaintext highlighter-rouge">restart: always</code> とすることで、システムダウンの時間を減らします。</li>
  <li>ログ収集といったような追加サービスを設定します。</li>
</ul>

<p>このようなことがあるので、追加の Compose ファイルとしてたとえば <code class="language-plaintext highlighter-rouge">production.yml</code> といったものを用意して、そこに本番環境固有の設定を行うことを考えておきましょう。
この設定ファイルには、元の Compose ファイルに対して変更したい内容のみを含めておけばよいことになります。
つまりこの追加ファイルは、元々の <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> にさらに設定を追加して、新たな設定を作り出すものとなるわけです。</p>

<p>このような 2 つめの設定ファイルを用意したら Compose に対してこれを利用するために <code class="language-plaintext highlighter-rouge">-f</code> オプションを用います。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose -f docker-compose.yml -f production.yml up -d
</code></pre></div></div>

<p>より詳細な例は、<a href="/docs.docker.jp.onthefly/compose/extends/#different-environments">複数 compose ファイルの利用</a>を参照してください。</p>

<h3 id="deploying-changes">アプリ変更後のデプロイ</h3>

<p>アプリコードに変更を加えたら、イメージを再ビルドし、アプリのコンテナーを再生成することを忘れないでください。
<code class="language-plaintext highlighter-rouge">web</code> というサービスを再デプロイするには以下のようにします。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker-compose build web
$ docker-compose up --no-deps -d web
</code></pre></div></div>

<p>はじめに <code class="language-plaintext highlighter-rouge">web</code> のイメージを再ビルドし、次に <code class="language-plaintext highlighter-rouge">web</code> サービス<strong>のみ</strong>を停止、破棄、再生成します。
<code class="language-plaintext highlighter-rouge">--no-deps</code> フラグは <code class="language-plaintext highlighter-rouge">web</code> サービスが依存している他のサービスを再生成しないことを指示しています。</p>

<h3 id="running-compose-on-a-single-server">単一サーバー上での Compose の実行</h3>

<p>Compose を使って、リモートの Docker ホストへアプリをデプロイすることができます。
これを行うには <code class="language-plaintext highlighter-rouge">DOCKER_HOST</code>、<code class="language-plaintext highlighter-rouge">DOCKER_TLS_VERIFY</code>、<code class="language-plaintext highlighter-rouge">DOCKER_CERT_PATH</code> という各環境変数を適切に設定します。</p>

<p>環境変数を設定していれば、他になにかを設定する必要はなく、通常の <code class="language-plaintext highlighter-rouge">docker-compose</code> コマンドを使っていくことができます。</p>

<h3 id="running-compose-on-a-swarm-cluster">スウォームクラスター上での Compose の実行</h3>

<p><a href="../swarm/overview.md">Docker Swarm</a> は Docker のネイティブなクラスターシステムです。
単一 Docker ホストと同様の API を提供します。
つまりスウォームインタンスに対しても Compose を利用することができ、また複数ホストにわたってアプリを実行することができるということです。</p>

<p>Compose と Swarm の統合に関しては、<a href="/docs.docker.jp.onthefly/compose/swarm/">統合に関する説明</a>を確認してください。</p>

<h2 id="compose-documentation">Compose ドキュメント</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/compose/">ユーザーガイド</a></li>
  <li><a href="/docs.docker.jp.onthefly/compose/install/">Compose のインストール</a></li>
  <li><a href="/docs.docker.jp.onthefly/compose/gettingstarted/">はじめよう</a></li>
  <li><a href="/docs.docker.jp.onthefly/compose/reference/">コマンドラインリファレンス</a></li>
  <li><a href="/docs.docker.jp.onthefly/compose/compose-file/">Compose ファイルリファレンス</a></li>
  <li><a href="/docs.docker.jp.onthefly/compose/samples-for-compose/">Compose を使ったサンプルアプリ</a></li>
</ul>
