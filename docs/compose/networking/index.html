
<blockquote>
  <p>このページに示す内容は Compose ファイルフォーマットの <a href="/docs.docker.jp.onthefly/compose/compose-file/compose-file-v2/">バージョン 2</a> と <a href="/docs.docker.jp.onthefly/compose/compose-file/">それ以降</a> に適用されます。
ネットワーク機能は<a href="/docs.docker.jp.onthefly/compose/compose-file/compose-file-v1/">（古い）バージョン 1</a> ではサポートされません。</p>
</blockquote>

<p>デフォルトで Compose は、アプリ向けに単一の <a href="/docs.docker.jp.onthefly/engine/reference/commandline/network_create/">ネットワーク</a> を設定します。
1 つのサービスを構成する各コンテナーは、そのデフォルトのネットワークに参加するので、ネットワーク上の他のコンテナーからのアクセスが可能です。
さらにコンテナー名と同等のホスト名を用いてコンテナーの識別が可能となります。</p>

<blockquote>
  <p><strong>メモ</strong>: アプリのネットワークには「プロジェクト名」に基づいた名前がつけられます。
そしてプロジェクト名はこれが稼動しているディレクトリ名に基づいて定まります。
プロジェクト名は <a href="/docs.docker.jp.onthefly/compose/reference/overview/"><code class="language-plaintext highlighter-rouge">--project-name</code> フラグ</a> あるいは <a href="/docs.docker.jp.onthefly/compose/reference/envvars/#compose_project_name"><code class="language-plaintext highlighter-rouge">COMPOSE_PROJECT_NAME</code> 環境変数</a> を使って上書きすることができます。</p>
</blockquote>

<p>たとえばアプリが <code class="language-plaintext highlighter-rouge">myapp</code> というディレクトリにあって、<code class="language-plaintext highlighter-rouge">docker-compose.yml</code> が以下のような内容であるとします。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: "3"
services:
  web:
    build: .
    ports:
      - "8000:8000"
  db:
    image: postgres
    ports:
      - "8001:5432"
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">docker-compose up</code> を実行すると以下の結果になります。</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">myapp_default</code> というネットワークが生成されます。</li>
  <li><code class="language-plaintext highlighter-rouge">web</code> に関する設定に従って 1 つのコンテナーが生成されます。
そしてそのコンテナーは <code class="language-plaintext highlighter-rouge">web</code> という名前でネットワーク <code class="language-plaintext highlighter-rouge">myapp_default</code> に参加します。</li>
  <li><code class="language-plaintext highlighter-rouge">db</code> に関する設定に従って 1 つのコンテナーが生成されます。
そしてそのコンテナーは <code class="language-plaintext highlighter-rouge">db</code> という名前でネットワーク <code class="language-plaintext highlighter-rouge">myapp_default</code> に参加します。</li>
</ol>

<blockquote>
  <p><strong>v2.1 以降、overlay ネットワークは常に <code class="language-plaintext highlighter-rouge">attachable</code> に</strong></p>

  <p>Compose ファイルフォーマット 2.1 から、overlay ネットワークは常に <code class="language-plaintext highlighter-rouge">attachable</code> として生成されるようになりましたが、これを変更することはできません。
<code class="language-plaintext highlighter-rouge">attachable</code> として生成されるため、スタンドアロンのコンテナーでも overlay ネットワークに接続することができます。
Compose ファイルフォーマット 3.x においては、必要に応じて <code class="language-plaintext highlighter-rouge">attachable</code> プロパティに <code class="language-plaintext highlighter-rouge">false</code> を設定できます。</p>
</blockquote>

<p>各コンテナーはこれ以降、ホスト名 <code class="language-plaintext highlighter-rouge">web</code> と <code class="language-plaintext highlighter-rouge">db</code> を認識できるようになり、コンテナーの IP アドレスも適切に取得できるようになります。
たとえば <code class="language-plaintext highlighter-rouge">web</code> のアプリケーションコードでは、URL <code class="language-plaintext highlighter-rouge">postgres://db:5432</code> を使ってのアクセスが可能となり、Postgres データベースの利用ができるようになります。</p>

<p><code class="language-plaintext highlighter-rouge">HOST_PORT</code> と <code class="language-plaintext highlighter-rouge">CONTAINER_PORT</code> の違いについては理解しておくことが重要です。
上の例の <code class="language-plaintext highlighter-rouge">db</code> では、<code class="language-plaintext highlighter-rouge">HOST_PORT</code> が <code class="language-plaintext highlighter-rouge">8001</code>、コンテナーポートが <code class="language-plaintext highlighter-rouge">5432</code>（postgres のデフォルト） になっています。
ネットワークにより接続されているサービス間の通信は <code class="language-plaintext highlighter-rouge">CONTAINER_PORT</code> を利用します。
<code class="language-plaintext highlighter-rouge">HOST_PORT</code> を定義すると、このサービスはスウォームの外からもアクセスが可能になります。</p>

<p><code class="language-plaintext highlighter-rouge">web</code> コンテナー内では、<code class="language-plaintext highlighter-rouge">db</code> への接続文字列は <code class="language-plaintext highlighter-rouge">postgres://db:5432</code> といったものになります。
そしてホストマシン上からは、その接続文字列は <code class="language-plaintext highlighter-rouge">postgres://{DOCKER_IP}:8001</code> となります。</p>

<h2 id="update-containers">コンテナーの更新</h2>

<p>サービスに対する設定を変更して <code class="language-plaintext highlighter-rouge">docker-compose up</code> により更新を行うと、それまでのコンテナーは削除されて新しいコンテナーがネットワークに接続されます。
このとき IP アドレスは異なることになりますが、ホスト名は変わりません。
コンテナーの実行によってホスト名による名前解決を行い、新たな IP アドレスへ接続します。
それまでの古い IP アドレスは利用できなくなります。</p>

<p>古いコンテナーに対して接続を行っていたコンテナーがあれば、その接続は切断されます。
この状況を検出するのは各コンテナーの責任であって、ホスト名を探して再接続が行われます。</p>

<h2 id="links">Links</h2>

<p>links は自サービスが他のサービスからアクセスできるように、追加でエイリアスを定義するものです。
これはサービス間の通信を行うために必要となるわけではありません。
デフォルトにおいてサービスは、サービス名を使って他サービスにアクセスできます。
以下の例においては、<code class="language-plaintext highlighter-rouge">db</code> は <code class="language-plaintext highlighter-rouge">web</code> からアクセス可能であり、ホスト名 <code class="language-plaintext highlighter-rouge">db</code> あるいは <code class="language-plaintext highlighter-rouge">database</code> を使ってアクセスできます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: "3"
services:

  web:
    build: .
    links:
      - "db:database"
  db:
    image: postgres
</code></pre></div></div>

<p>詳細は <a href="/docs.docker.jp.onthefly/compose/compose-file/compose-file-v2/#links">links リファレンス</a> を参照してください。</p>

<h2 id="Multi-host">複数ホストによるネットワーク</h2>

<blockquote>
  <p><strong>メモ</strong>: ここに示す手順は、<a href="/docs.docker.jp.onthefly/compose/swarm/">かつての Docker Swarm</a> の操作に基づいています。
したがってかつてのスウォームクラスターを対象とする場合にのみ動作します。
Compose によるプロジェクトを、最新の統合されたスウォームモードにデプロイするには、<a href="/docs.docker.jp.onthefly/engine/reference/commandline/stack_deploy/">Docker Stacks</a> に示すドキュメントを参照してください。</p>
</blockquote>

<p><a href="/docs.docker.jp.onthefly/compose/swarm/">Compose アプリケーションをスウォームクラスターにデプロイする</a> 際には、ビルトインの <code class="language-plaintext highlighter-rouge">overlay</code> ドライバーを利用して、コンテナー間で複数ホストによる通信を行うことが可能です。
Compose ファイルやアプリケーションコードへの変更は必要ありません。</p>

<p><a href="/docs.docker.jp.onthefly/network/network-tutorial-overlay/">複数ホストによるネットワークをはじめよう</a> を参考に、スウォームクラスターの構築方法を確認してください。
デフォルトでクラスターは <code class="language-plaintext highlighter-rouge">overlay</code> ドライバーを用います。
ただし明示的にこれを指定することもできます。
詳しくは後述します。</p>

<h2 id="specify-custom-networks">独自のネットワーク設定</h2>

<p>デフォルトのアプリ用ネットワークを利用するのではなく、独自のネットワークを指定することができます。
これは最上位の <code class="language-plaintext highlighter-rouge">networks</code> キーを使って行います。
これを使えば、より複雑なネットワークトポロジーを生成したり、<a href="/engine/extend/plugins_network/">独自のネットワークドライバー</a> とそのオプションを設定したりすることができます。
さらには、Compose が管理していない、外部に生成されたネットワークに対してサービスを接続することもできます。</p>

<p>サービスレベルの定義となる <code class="language-plaintext highlighter-rouge">networks</code> キーを利用すれば、サービスごとにどのネットワークに接続するかを指定できます。
指定する値はサービス名のリストであり、最上位の <code class="language-plaintext highlighter-rouge">networks</code> キーに指定されている値を参照するものです。</p>

<p>以下において Compose ファイルは、独自のネットワークを 2 つ定義しています。
<code class="language-plaintext highlighter-rouge">proxy</code> サービスは <code class="language-plaintext highlighter-rouge">db</code> サービスから切り離されています。
というのも両者はネットワークを共有しないためです。
そして <code class="language-plaintext highlighter-rouge">app</code> だけがその両者と通信を行います。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: "3"
services:

  proxy:
    build: ./proxy
    networks:
      - frontend
  app:
    build: ./app
    networks:
      - frontend
      - backend
  db:
    image: postgres
    networks:
      - backend

networks:
  frontend:
    # 独自ドライバーの利用
    driver: custom-driver-1
  backend:
    # 所定のオプションを用いる独自ドライバーの利用
    driver: custom-driver-2
    driver_opts:
      foo: "1"
      bar: "2"
</code></pre></div></div>

<p>接続するネットワークのそれぞれは、<a href="/docs.docker.jp.onthefly/compose/compose-file/compose-file-v2/#ipv4_address-ipv6_address">ipv4_address または ipv6_address</a> を使ってスタティック IP アドレスを設定することができます。</p>

<p>ネットワークには <a href="/docs.docker.jp.onthefly/compose/compose-file/#network-configuration-reference">独自の名前</a> も設定することができます。
（バージョン 3.5 から）</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: "3.5"
networks:
  frontend:
    name: custom_frontend
    driver: custom-driver-1
</code></pre></div></div>

<p>ネットワーク設定に関して利用可能なオプションについては、以下のリファレンスを参照してください。</p>

<ul>
  <li><a href="/docs.docker.jp.onthefly/compose/compose-file/compose-file-v2/#network-configuration-reference">最上位の <code class="language-plaintext highlighter-rouge">networks</code> キー</a></li>
  <li><a href="/docs.docker.jp.onthefly/compose/compose-file/compose-file-v2/#networks">service レベルの <code class="language-plaintext highlighter-rouge">networks</code> キー</a></li>
</ul>

<h2 id="configure-the-default-network">デフォルトネットワークの設定</h2>

<p>独自のネットワーク設定は行わずに、あるいはそれを行った上でさらに、アプリに対するデフォルトネットワークの設定を変更することができます。
これは <code class="language-plaintext highlighter-rouge">networks</code> のもとに <code class="language-plaintext highlighter-rouge">default</code> という項目を定義して行います。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: "3"
services:

  web:
    build: .
    ports:
      - "8000:8000"
  db:
    image: postgres

networks:
  default:
    # 独自のドライバーを利用
    driver: custom-driver-1
</code></pre></div></div>

<h2 id="use-a-pre-existing-network">既存ネットワークの利用</h2>

<p>コンテナーを既存のネットワークに接続したい場合は <a href="/docs.docker.jp.onthefly/compose/compose-file/compose-file-v2/#network-configuration-reference"><code class="language-plaintext highlighter-rouge">external</code> オプション</a> を利用します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>networks:
  default:
    external:
      name: my-pre-existing-network
</code></pre></div></div>

<p>Compose は <code class="language-plaintext highlighter-rouge">[projectname]_default</code> という名前のネットワークを生成しようとはせず、<code class="language-plaintext highlighter-rouge">my-pre-existing-network</code> というネットワークを探し出して、アプリのコンテナーをそこに接続します。</p>
