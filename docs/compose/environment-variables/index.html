
<p>Compose の複数の場面において環境変数がさまざまに用いられています。
このページでは環境変数について必要となる情報を示します。</p>

<h2 id="substitute-environment-variables-in-compose-files">Compose ファイル内での環境変数の利用</h2>

<p>シェル内にて環境変数を設定し、その値を Compose ファイルにおいて読み込ませることができます。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">web</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s2">"</span><span class="s">webapp:${TAG}"</span>
</code></pre></div></div>

<p>環境変数が複数ある場合、環境変数ファイルへのパスを指定して利用することができます。
<code class="language-plaintext highlighter-rouge">docker-compose</code> コマンドを実行すると、デフォルトでその実行ディレクトリ内の <code class="language-plaintext highlighter-rouge">.env</code> というファイルを探します。
ファイル名を引数に与えれば、どこの何というファイルでも指定できます。
たとえば <code class="language-plaintext highlighter-rouge">.env.ci</code>、<code class="language-plaintext highlighter-rouge">.env.dev</code>、<code class="language-plaintext highlighter-rouge">.env.prod</code> などとすることができます。
ファイルパスの指定は <code class="language-plaintext highlighter-rouge">--env-file</code> オプションを使って行います。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose <span class="nt">--env-file</span> ./config/.env.dev up
</code></pre></div></div>

<p>詳しくは Compose ファイルリファレンスの <a href="/docs.docker.jp.onthefly/compose/compose-file/#variable-substitution">変数の置換</a> の項を参照してください。</p>

<h2 id="set-environment-variables-in-containers">コンテナー内での環境変数の設定</h2>

<p>サービスコンテナーにおいて、たとえば<code class="language-plaintext highlighter-rouge">docker run -e VARIABLE=VALUE ...</code>のように <a href="/docs.docker.jp.onthefly/compose/compose-file/#environment"><code class="language-plaintext highlighter-rouge">environment</code>キー</a> を使って、環境変数を設定することができます。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">web</span><span class="pi">:</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">DEBUG=1</span>
</code></pre></div></div>

<h2 id="pass-environment-variables-to-containers">コンテナーへの環境変数の受け渡し</h2>

<p>シェル内の環境変数を <a href="/docs.docker.jp.onthefly/compose/compose-file/#environment"><code class="language-plaintext highlighter-rouge">environment</code>キー</a> を使って、直接サービスコンテナーに受け渡すことができます。この場合には値を渡すのではなく<code class="language-plaintext highlighter-rouge">docker run -e 変数名 ...</code>のようにできます。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">web</span><span class="pi">:</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">DEBUG</span>
</code></pre></div></div>

<p>コンテナー内の<code class="language-plaintext highlighter-rouge">DEBUG</code>変数は、シェル内の<code class="language-plaintext highlighter-rouge">DEBUG</code>変数の値が用いられます。
このシェルとは Compose が起動しているシェルのことです。</p>

<h2 id="the-env_file-configuration-option">設定オプション<code class="language-plaintext highlighter-rouge">env_file</code></h2>

<p>外部ファイルから複数の環境変数をサービスコンテナーに受け渡すには <a href="/docs.docker.jp.onthefly/compose/compose-file/#env_file"><code class="language-plaintext highlighter-rouge">env_file</code>オプション</a> を利用することができます。
<code class="language-plaintext highlighter-rouge">docker run --env-file=FILE ...</code>のようにすることもできます。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">web</span><span class="pi">:</span>
  <span class="na">env_file</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">web-variables.env</span>
</code></pre></div></div>

<h2 id="set-environment-variables-with-docker-compose-run"><code class="language-plaintext highlighter-rouge">docker-compose run</code>実行時の環境変数の設定</h2>

<p><code class="language-plaintext highlighter-rouge">docker run -e</code>と同じように、<code class="language-plaintext highlighter-rouge">docker-compose run -e</code>の実行によるコンテナーに対しても環境変数を実行することができます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose run <span class="nt">-e</span> <span class="nv">DEBUG</span><span class="o">=</span>1 web python console.py
</code></pre></div></div>

<p>シェル変数を受け渡す際には、値は直接受け渡さずに以下のようにできます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose run <span class="nt">-e</span> DEBUG web python console.py
</code></pre></div></div>

<p>コンテナー内の<code class="language-plaintext highlighter-rouge">DEBUG</code>変数は、シェル内の<code class="language-plaintext highlighter-rouge">DEBUG</code>変数の値が用いられます。
このシェルとは Compose が起動しているシェルのことです。</p>

<h2 id="the-env-file"><code class="language-plaintext highlighter-rouge">.env</code>ファイル</h2>

<p>Compose ファイルが参照する環境変数、あるいは Compose の設定に用いられる環境変数のデフォルト値を設定することができます。これは<code class="language-plaintext highlighter-rouge">.env</code>という<a href="/docs.docker.jp.onthefly/compose/env-file/">環境ファイル</a>にて行います。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> .env
<span class="nv">TAG</span><span class="o">=</span>v1.5

<span class="nv">$ </span><span class="nb">cat </span>docker-compose.yml
version: <span class="s1">'3'</span>
services:
  web:
    image: <span class="s2">"webapp:</span><span class="k">${</span><span class="nv">TAG</span><span class="k">}</span><span class="s2">"</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">docker-compose up</code>を実行すると、上で定義されている<code class="language-plaintext highlighter-rouge">web</code>サービスは<code class="language-plaintext highlighter-rouge">webapp:v1.5</code>というイメージを利用します。
このことは <a href="/docs.docker.jp.onthefly/compose/reference/config/">config コマンド</a>を使って確認できます。
このコマンドは変数を置換した後のアプリケーション設定を端末画面に出力します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose config

version: <span class="s1">'3'</span>
services:
  web:
    image: <span class="s1">'webapp:v1.5'</span>
</code></pre></div></div>

<p>シェル内にて設定される値は、<code class="language-plaintext highlighter-rouge">.env</code>ファイル内のものよりも優先されます。
たとえばシェル上において<code class="language-plaintext highlighter-rouge">TAG</code>を異なる値に設定していたら、それを使って変数置換された<code class="language-plaintext highlighter-rouge">image</code>が用いられることになります。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">TAG</span><span class="o">=</span>v2.0
<span class="nv">$ </span>docker-compose config

version: <span class="s1">'3'</span>
services:
  web:
    image: <span class="s1">'webapp:v2.0'</span>
</code></pre></div></div>

<p>環境変数を複数のファイルなどに設定していた場合に、Compose が値を採用する優先順位は以下のとおりです。</p>

<ol>
  <li>Compose ファイル</li>
  <li>シェル内の環境変数</li>
  <li>環境ファイル</li>
  <li>Dockerfile</li>
  <li>未定義の変数</li>
</ol>

<p>以下の例では同一の環境変数を、環境ファイルと Compose ファイルに設定しています。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> ./Docker/api/api.env
<span class="nv">NODE_ENV</span><span class="o">=</span><span class="nb">test</span>

<span class="nv">$ </span><span class="nb">cat </span>docker-compose.yml
version: <span class="s1">'3'</span>
services:
  api:
    image: <span class="s1">'node:6-alpine'</span>
    env_file:
     - ./Docker/api/api.env
    environment:
     - <span class="nv">NODE_ENV</span><span class="o">=</span>production
</code></pre></div></div>

<p>コンテナーを実行すると Compose ファイルに定義された環境変数が優先されます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose <span class="nb">exec </span>api node

<span class="o">&gt;</span> process.env.NODE_ENV
<span class="s1">'production'</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Dockerfile</code>ファイル内の<code class="language-plaintext highlighter-rouge">ARG</code>や<code class="language-plaintext highlighter-rouge">ENV</code>は、<code class="language-plaintext highlighter-rouge">environment</code>や<code class="language-plaintext highlighter-rouge">env_file</code>による Docker Composeの設定がある場合は評価されません。</p>

<blockquote>
  <p>NodeJS コンテナーの仕様</p>

  <p><code class="language-plaintext highlighter-rouge">script:start</code>に対して<code class="language-plaintext highlighter-rouge">package.json</code>のエントリーを含む場合、たとえば<code class="language-plaintext highlighter-rouge">NODE_ENV=test node server.js</code>のような場合には、<code class="language-plaintext highlighter-rouge">docker-compose.yml</code>ファイルでの設定よりもこちらの設定が優先されます。</p>
</blockquote>

<h2 id="configure-compose-using-environment-variables">環境変数を用いた Compose の設定</h2>

<p>Docker Compose のコマンドラインからの処理設定を行うことができる環境変数がいくつかあります。
そういった変数は先頭が<code class="language-plaintext highlighter-rouge">COMPOSE_</code>や<code class="language-plaintext highlighter-rouge">DOCKER_</code>で始まります。
詳しくは <a href="/docs.docker.jp.onthefly/compose/reference/envvars/">CLI 環境変数</a>を参照してください。</p>

<h2 id="environment-variables-created-by-links">リンクから生成される環境変数</h2>

<p><a href="/compose/compose-file/compose-file-v1.md#link-environment-variables">Compose ファイルバージョン 1</a> における <a href="/compose/compose-file/index.md#links"><code class="language-plaintext highlighter-rouge">links</code>オプション</a> を用いると、各リンクに対する環境変数が生成されます。
ただしこの変数は廃止予定となっています。
リンクはホスト名として利用するようにしてください。</p>
