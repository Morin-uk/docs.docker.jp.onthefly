
<p>このページでは Notary サービスを独自に起動するユーザー向けに、Notary クライアントの高度な利用方法を説明します。
読み進めるにあたっては <a href="/docs.docker.jp.onthefly/notary/running_a_service/">独自の Notary サービスの起動</a> を一読し理解しておいてください。</p>

<h2 id="an-important-note-about-the-examples">利用例に関する重要事項</h2>

<p>ここに示すコマンドの利用例においては<code class="language-plaintext highlighter-rouge">-s</code>と<code class="language-plaintext highlighter-rouge">-d</code>フラグは省略することにします。
このフラグがなにかわからない場合は、<a href="/docs.docker.jp.onthefly/notary/getting_started/">Notary をはじめよう</a> を読むか、<code class="language-plaintext highlighter-rouge">notary --help</code>を実行して確認してください。
このフラグについて理解できたら、本書内のコマンド例を実行する際には、自身が利用する値をそれぞれのフラグに設定してください。
このフラグの設定方法に関して、詳しくは <a href="/docs.docker.jp.onthefly/notary/reference/">高度な設定オプション</a> を参照してください。</p>

<h2 id="initialize-a-trusted-collection">トラストコレクションの初期化</h2>

<p>コレクションにコンテンツを追加し署名するには、その前にコレクションを初期化する必要があります。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#origin1">コマンド表記</a></li>
  <li><a data-toggle="tab" href="#japanese1">日本語訳</a></li>
</ul>
<div class="tab-content">
  <div id="origin1" class="tab-pane fade in active">
    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ notary init example.com/collection

No root keys found. Generating a new root key...
You are about to create a new root signing key passphrase. This passphrase
is used to protect the most sensitive key in your signing system.
Choose a long, complex passphrase and be careful to keep the password and the
key file itself secure and backed up. It is highly recommended that you use a
password manager to generate the passphrase and keep it safe. There is no
way to recover this key. You can find the key in your config directory.
Enter passphrase for new root key with ID 1f54328:
Repeat passphrase for new root key with ID 1f54328:
Enter passphrase for new targets key with ID 1df39fc (example.com/collection):
Repeat passphrase for new targets key with ID 1df39fc (example.com/collection):
</code></pre></div>        </div>
      </div>
    </div>
  </div>
  <div id="japanese1" class="tab-pane fade">

    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ notary init example.com/collection

ルート鍵が見つからなかったため、新たなルート鍵を生成します...
これから新たなルート署名鍵に対するパスフレーズを生成します。このパスフレーズは
利用する署名システムの中で、最も大切な鍵を保護するために利用します。
パスフレーズは長く複雑なものにして、パスワードと鍵ファイルそのものを安全に保存
し、バックアップするようにしてください。パスワードマネージャーを利用して、パス
フレーズの生成と安全な保存を行うことを強くお勧めします。この鍵を復旧する手段は
ありません。この鍵は設定ディレクトリ内にあります。
ID 1f54328 を使って新ルート鍵のパスフレーズを入力 :
ID 1f54328 を使って新ルート鍵のパスフレーズを再入力  :
ID 1df39fc を使って新ターゲット鍵のパスフレーズを入力 (example.com/collection):
ID 1df39fc を使って新ターゲット鍵のパスフレーズを再入力 (example.com/collection):
</code></pre></div>        </div>
      </div>
    </div>

  </div>
</div>

<p>トラストコレクションを初期化すると、以下のものが生成されます。
なおすべての鍵は非対称アルゴリズム（asymmetric algorithm）を利用していますが、すべてが <strong>同一の</strong> アルゴリズムを利用している必要はありません。</p>

<ul>
  <li>ルート鍵が見つからなかった場合、初期の<code class="language-plaintext highlighter-rouge">root</code>鍵が生成されます。
この鍵は、トラストコレクションを信頼するためのデフォルトルートとして用いられます。</li>
  <li><code class="language-plaintext highlighter-rouge">targets</code>（ターゲット）鍵と<code class="language-plaintext highlighter-rouge">snapshot</code>（スナップショット）鍵が生成されます。
これらの鍵に対して同一のパスワードにしておくと、そのセキュリティプロファイルが（トラストコレクションの作成者が両方を保持するのであれば）同一であるため、この 2 つの鍵を 1 つのパスワードによって暗号化できます。
このためスナップショット鍵に対してパスワード入力は求められません。</li>
  <li><code class="language-plaintext highlighter-rouge">timestamp</code>（タイムスタンプ）鍵が生成されます。
これはクライアントからの要求に従ってサーバーが生成します。
返されるのは単なる公開鍵です。
サーバーには、ユーザーのために秘密鍵と署名タイムスタンプが保持されます。</li>
  <li>Notary メタデータによって署名されたスタブ（stub）が生成されます。
これはコレクションのトラストメタデータにおけるベースバージョンを作り出します。
そしてサーバーに公開されるときに最終確定します。</li>
</ul>

<h2 id="add-and-remove-targets">ターゲット鍵の追加と削除</h2>

<p>トラストコレクションにターゲット鍵を追加するには、Notary CLI を使って以下のようにします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>notary add example.com/collection v1 my_file.txt
</code></pre></div></div>

<p>上のコマンドによって、ローカルにあるファイル<code class="language-plaintext highlighter-rouge">my_file.txt</code>が、ターゲット名を<code class="language-plaintext highlighter-rouge">v1</code>として、設定するコレクション<code class="language-plaintext highlighter-rouge">example.com/collection</code>に追加されます。
（<code class="language-plaintext highlighter-rouge">my_file.txt</code>は、カレントワーキングディレクトリからの相対的な場所に存在していなければなりません。）
ローカルファイル<code class="language-plaintext highlighter-rouge">my_file.txt</code>の内容がそのままコレクションに追加されます。
「ターゲット」は、ファイルパスとその内容に対するチェックサムによって構成されています。</p>

<p>このコマンドはオフラインコマンドであるため、追加を実際に行うには<code class="language-plaintext highlighter-rouge">notary publish example.com/collection</code>を実行する必要があります。</p>

<p>ターゲット鍵を削除するには<code class="language-plaintext highlighter-rouge">notary remove</code>コマンドを用います。
その際には GUN とターゲット名を指定します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>notary remove example.com/collection v1
</code></pre></div></div>

<p>ターゲット鍵の削除を行うこのコマンドもオフラインコマンドであるため、実際に削除するには<code class="language-plaintext highlighter-rouge">notary publish example.com/collection</code>を実行する必要があります。</p>

<h2 id="manage-keys">鍵の管理</h2>

<p>Notary クライアントは、デフォルトでルート鍵、ターゲット鍵、スナップショット鍵に対応した秘密鍵を管理しておく義務があります。
この鍵は、新たなトラストコレクションを初期化した際にデフォルトで生成されます。
そしてこの鍵は、Notary の<code class="language-plaintext highlighter-rouge">trust_dir</code>ディレクトリに配置されます。
さらに委任権限（delegation role）がある場合、その権限用の鍵も Notary クライアントが管理していなければなりません。</p>

<p>Notary サーバーには常にタイプスタンプ鍵を管理する責任があります。
そしてスナップショット鍵も Notary サーバーが管理するようにすることもできます。
これはスナップショット鍵を Notary クライアントからサーバーに向けてローテートした場合です。
詳しくは以下の節において説明しています。</p>

<h3 id="rotate-keys">鍵のローテート</h3>

<p>潜在的なリスクを考慮して、Notary では鍵のローテートを行う CLI コマンドを提供しています。
<code class="language-plaintext highlighter-rouge">notary key rotate</code>コマンドを使うことで、ターゲット鍵とスナップショット鍵のローテートを行います。</p>

<p>スナップショット鍵はデフォルトで Notary クライアントによって管理されているので、<code class="language-plaintext highlighter-rouge">notary key rotate snapshot -r</code>コマンドを使って、スナップショット鍵のローテートを行います。
これを使って Notary サーバーはスナップショットへの署名を行います。
これはトラストコレクションにおいて委任機能（delegation）を利用している場合に助かります。
委任機能はスナップショット鍵を必要としないので、コレクションへのアップデートを問題なく行うことができます。</p>

<p>新たに生成したコレクションが Docker 1.11 Engine クライアントを使っていた場合、デフォルトではスナップショット鍵の管理をサーバーが行うものになります。
このスナップショット鍵の管理をクライアント上で行うためには、<code class="language-plaintext highlighter-rouge">notary key rotate</code>コマンドにおいて<code class="language-plaintext highlighter-rouge">-r</code>フラグをつけずに実行します。</p>

<p>ターゲット鍵はローカルで管理しなければなりません。
そこでたとえば障害リスクに備えてターゲット鍵をローテートする場合には、<code class="language-plaintext highlighter-rouge">notary key rotate targets</code>コマンドにおいて<code class="language-plaintext highlighter-rouge">-r</code>フラグをつけずに実行します。</p>

<h3 id="use-a-yubikey">Yubikey の利用</h3>

<p>Notary では <a href="https://www.yubico.com/products/yubikey-hardware/yubikey4/" target="_blank" class="_">Yubikey 4</a> 鍵を利用することができます。
利用の際には Yubikey の CCID モードを有効にして PKCS11 インターフェースを通じて利用します。
YubiKey ではルート鍵を優先的に保存するため、その署名の際にはユーザーによるタッチ入力が必要です。
Yubikey サポートは、Docker コンテントトラストを利用する Docker Engine 1.11 に含まれます。</p>

<p>Yubikey サポートには <a href="https://www.yubico.com/support/knowledge-base/categories/downloads/" target="_blank" class="_">Yubico PIV ライブラリ</a>（PIV にバンドルされる）が必要であり、これは標準的なライブラリディレクトリに配置されます。</p>

<h2 id="work-with-delegation-roles">委任権限を使った作業</h2>

<p>委任権限（delegation role）は Notary トラストコレクションに対して、協力者（collaborator）のワークフローを単純化します。
そしてコレクションのコンテンツに対してきめ細かな権限の委任を可能にします。
委任権限はターゲット権限を制限したものであり、特定のファイルパス内にあるターゲット鍵への署名のみを可能にするものです。</p>

<p>委任権限には独自の鍵、つまり委任鍵が与えられます。
これがあることで各協力者がプライベート鍵を保持できます。
その際には、管理者がターゲット鍵を共有しなければならないとか、コレクションの個々のターゲットに対して書き込み権限を与えないといけない、といったことが不要になります。</p>

<p>委任鍵を追加するには、サーバーに向けてスナップショット鍵をローテートしておかなければなりません。
これは Docker Engine 1.11 クライアントを利用してコレクションを新規生成すれば、デフォルトで設定されます。
委任鍵は、コレクションのターゲット鍵を公開するためのスナップショット鍵を必要としません。
したがってサーバーは、委任ターゲット鍵を利用して、適正なスナップショット鍵を公開することができます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>notary key rotate example.com/collection snapshot <span class="nt">-r</span>
</code></pre></div></div>

<p>ここでも<code class="language-plaintext highlighter-rouge">-r</code>を指定することで、鍵をローテートしてリモートサーバーに配置します。</p>

<p>委任鍵を追加する際には、委任元ユーザーの公開鍵を使った x509 証明書が必要になります。
この委任権限を引き受けるユーザーは、Notary 上のコンテンツに署名できるプライベート鍵を持っておかなければなりません。</p>

<p>委任に必要な x509 証明書を取得したら、委任鍵をユーザーに追加することができます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>notary delegation add example.com/collection targets/releases cert.pem <span class="nt">--paths</span><span class="o">=</span><span class="s2">"delegation/path"</span>
</code></pre></div></div>

<p>上のコマンドは、委任鍵<code class="language-plaintext highlighter-rouge">targets/releases</code>を、GUN によって表記された<code class="language-plaintext highlighter-rouge">example.com/collection</code>に追加すものです。
委任名には頭に<code class="language-plaintext highlighter-rouge">targets/</code>をつける必要があります。
こうするのは、委任鍵がターゲット鍵の限定バージョンであるからです。
このコマンド実行によって x509 証明書<code class="language-plaintext highlighter-rouge">cert.pem</code>内に含まれる公開鍵が、委任鍵<code class="language-plaintext highlighter-rouge">targets/releases</code>に追加されます。</p>

<p>コンテンツに署名を行う委任鍵<code class="language-plaintext highlighter-rouge">targets/releases</code>に対して委任ユーザーは、この公開鍵に対応するプライベート鍵を所有していることが必要です。
上のコマンドは、この委任鍵を用いたコンテンツの公開を、<code class="language-plaintext highlighter-rouge">delegation/path</code>を頭につけたパスに限って許可するものです。
指定された「delegation/path」というパスを使って、委任鍵<code class="language-plaintext highlighter-rouge">targets/releases</code>からは「delegation/path/content.txt」、「”delegation/path_file.txt」、「delegation/path.txt」といったパスが署名可能になります。
<code class="language-plaintext highlighter-rouge">--paths</code>に対してカンマ区切りの文字列リストを加えていけば、そのパスを増やすことができます。
あるいは<code class="language-plaintext highlighter-rouge">--all-paths</code>フラグを用いれば、どのようなパス名であっても委任鍵がコンテンツを公開できるようになります。</p>

<p>公開した後は、以下の出力コマンドを使って委任権限を一覧確認できます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>notary delegation list example.com/collection

      ROLE               PATHS                                   KEY IDS                                THRESHOLD
<span class="nt">---------------------------------------------------------------------------------------------------------------</span>
  targets/releases   delegation/path   729c7094a8210fd1e780e7b17b7bb55c9a28a48b871b07f65d97baf93898523a   1
</code></pre></div></div>

<p>上では<code class="language-plaintext highlighter-rouge">targets/releases</code>に対するパスと鍵 ID が表示されています。
If you wish to modify these fields, you can do so with additional <code class="language-plaintext highlighter-rouge">notary delegation add</code> or <code class="language-plaintext highlighter-rouge">notary delegation remove</code> commands on this role.</p>

<p><code class="language-plaintext highlighter-rouge">THRESHOLD</code>（しきい値）欄に<code class="language-plaintext highlighter-rouge">1</code>と示されているのは、<code class="language-plaintext highlighter-rouge">KEY_IDS</code>欄に指定される鍵のただ 1 つだけが、委任鍵の公開に必要であることを表わしています。
このしきい値は<code class="language-plaintext highlighter-rouge">1</code>以外は、今のところサポートされていません。
委任権限全体を削除する、あるいは個々の鍵やパスだけを削除するには<code class="language-plaintext highlighter-rouge">notary delegation remove</code>コマンドを使います。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#origin2">コマンド表記</a></li>
  <li><a data-toggle="tab" href="#japanese2">日本語訳</a></li>
</ul>
<div class="tab-content">
  <div id="origin2" class="tab-pane fade in active">
    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ notary delegation remove example.com/user targets/releases

Are you sure you want to remove all data for this delegation? (yes/no)
yes

Forced removal (including all keys and paths) of delegation role targets/releases to repository "example.com/user" staged for next publish.
</code></pre></div>        </div>
      </div>
    </div>
  </div>
  <div id="japanese2" class="tab-pane fade">

    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ notary delegation remove example.com/user targets/releases

この委任鍵の関連データすべてを削除しますか？ (yes/no)
yes

リポジトリ"example.com/user"に対する委任権限 targets/releases を(すべての鍵と
パスの削除を含め)強制削除し、次回の公開時に向けてステージしました。
</code></pre></div>        </div>
      </div>
    </div>

  </div>
</div>

<p>個々の鍵やパスの削除を行うには、引数として鍵を指定するか<code class="language-plaintext highlighter-rouge">--paths</code>フラグにパスを指定して行います。
<code class="language-plaintext highlighter-rouge">--all-paths</code>を利用すれば、その権限におけるパス指定をすべて削除できます。
委任権限にある現時点のすべての鍵 ID を指定すると、この権限全体が削除されます。</p>

<p>ターゲット鍵を指定する委任権限に追加するには、<code class="language-plaintext highlighter-rouge">notary add</code>コマンドに<code class="language-plaintext highlighter-rouge">--roles</code>フラグをつけて実行します。</p>

<p>この権限に対しては、あらかじめ適切な委任鍵をインポートしておく必要があります。
これを行うには<code class="language-plaintext highlighter-rouge">notary key import &lt;KEY_FILE&gt; --role user</code>とコマンド実行します。
このときには秘密鍵の PEM ファイルを使います。
あるいは秘密鍵の PEM ファイルを<code class="language-plaintext highlighter-rouge">&lt;KEY_ID&gt;.key</code>の形で<code class="language-plaintext highlighter-rouge">private/tuf_keys</code>に配置し、<code class="language-plaintext highlighter-rouge">user</code>に設定された<code class="language-plaintext highlighter-rouge">role</code> PEM ヘッダーを利用します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>notary add example/collections delegation/path/target delegation_file.txt <span class="nt">--roles</span><span class="o">=</span>targets/releases
</code></pre></div></div>

<p>上の例においてはターゲット鍵<code class="language-plaintext highlighter-rouge">delegation/path/target</code>をコレクション<code class="language-plaintext highlighter-rouge">example/collections</code>に追加し、次回の公開に向けてステージしています。
ファイル<code class="language-plaintext highlighter-rouge">delegation_file.txt</code>が、委任権限<code class="language-plaintext highlighter-rouge">targets/releases</code>を利用するターゲット鍵<code class="language-plaintext highlighter-rouge">delegation/path/target</code>です。
このパスは、委任権限に対する適正なパスを先頭につけているので、ターゲット鍵として適正です。</p>

<p><code class="language-plaintext highlighter-rouge">notary list</code>コマンドや<code class="language-plaintext highlighter-rouge">notary remove</code>コマンドでも<code class="language-plaintext highlighter-rouge">--roles</code>フラグをつけることができます。
このフラグによって委任権限を指定して、ターゲット鍵の一覧取得や削除を行います。
この処理はデフォルトでは、ベースとなる<code class="language-plaintext highlighter-rouge">targets</code>権限に対して動作します。</p>

<p>委任鍵からターゲット鍵を削除するには、<code class="language-plaintext highlighter-rouge">notary remove</code>コマンドに同じフラグをつけて実行します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>notary remove example/collections delegation/path/target <span class="nt">--roles</span><span class="o">=</span>targets/releases
</code></pre></div></div>

<h2 id="use-delegations-with-content-trust">コンテントトラストにおける委任権限の利用</h2>

<p>Docker Engine 1.10 以降においては、信頼できるイメージタグが存在する場合、その正規ソースとして<code class="language-plaintext highlighter-rouge">targets/releases</code>委任権限を利用することがサポートされました。</p>

<p>Docker Engine 1.10 の Docker コンテントトラスを使って<code class="language-plaintext highlighter-rouge">docker pull</code>を実行すると、Docker は署名されたイメージタグに対応する<code class="language-plaintext highlighter-rouge">targets/releases</code>権限を検索します。
それが見つからなければ、デフォルトの<code class="language-plaintext highlighter-rouge">targets</code>権限を用います。
<code class="language-plaintext highlighter-rouge">targets</code>権限を探し出すにあたって Docker 1.10 では、<code class="language-plaintext highlighter-rouge">targets/releases</code>ではない別の委任権限を使ってタグに署名されたイメージを探してきてしまう場合があります。
Docker 1.11 においてこの動作は変更されました。
Docker コンテントトラストを利用する<code class="language-plaintext highlighter-rouge">docker pull</code>コマンドでは、<code class="language-plaintext highlighter-rouge">targets/releases</code>委任権限あるいは基本<code class="language-plaintext highlighter-rouge">targets</code>権限によって署名されたタグのみをプルするようになりました。</p>

<p>Docker コンテントトラストを使って<code class="language-plaintext highlighter-rouge">docker push</code>を実行すると、Docker Engine 1.10 は<code class="language-plaintext highlighter-rouge">targets/releases</code>委任権限があれば、これを使って署名やプッシュを行います。
それがないときは<code class="language-plaintext highlighter-rouge">targets</code>権限を用います。
Docker 1.11 において<code class="language-plaintext highlighter-rouge">docker push</code>は、ユーザーが対応署名鍵を持つターゲット鍵（たとえば<code class="language-plaintext highlighter-rouge">targets/role</code>であって<code class="language-plaintext highlighter-rouge">targets/nested/role</code>ではない）に基づく、委任権限を直接使って署名およびプッシュを行います。
委任権限があってもユーザーが署名鍵を持っていなければ、プッシュは失敗します。
委任権限がまったくない場合、プッシュ処理においては基本<code class="language-plaintext highlighter-rouge">targets</code>権限を使って署名を行います。</p>

<p>コンテントトラストを使ったイメージのプッシュやプルにおいて<code class="language-plaintext highlighter-rouge">targets/releases</code>権限を使うためには、上で示した手順に従って Notary に委任権限をプッシュして公開してください。
委任権限を追加する際には、全タグへの署名を可能にするために<code class="language-plaintext highlighter-rouge">--all-paths</code>フラグを指定することが必要です。</p>

<h2 id="files-and-state-on-disk">ディスク上のファイルと状態</h2>

<p>Notary はその状態を<code class="language-plaintext highlighter-rouge">trust_dir</code>ディレクトリ内に保持しています。
デフォルトでは<code class="language-plaintext highlighter-rouge">~/.notary</code>であり、Docker コンテントトラストの有効時には通常<code class="language-plaintext highlighter-rouge">~/.docker/trust</code>としています。
このディレクトリ内において、<code class="language-plaintext highlighter-rouge">trusted_certificates</code>にはコレクション内のブートストラップ用の証明書が保存され、<code class="language-plaintext highlighter-rouge">tuf</code>には TUF メタデータおよび GUN に適用される changelist が保存されています。
また<code class="language-plaintext highlighter-rouge">private</code>には秘密鍵が保存されています。</p>

<p><code class="language-plaintext highlighter-rouge">private</code>配下のサブディレクトリ<code class="language-plaintext highlighter-rouge">root_keys</code>にはルート秘密鍵が保存され、<code class="language-plaintext highlighter-rouge">tuf_keys</code>にはターゲット鍵、スナップショット鍵、委任秘密鍵が保存されます。</p>
