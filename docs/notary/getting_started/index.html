
<p>本書では、Docker コンテントトラストをサポートするツール、Notary CLI の基本的使い方について説明しています。
さらに高度な利用方法として <a href="/docs.docker.jp.onthefly/notary/running_a_service/">Notary サービスを独自に起動する</a> があります。
<a href="/docs.docker.jp.onthefly/notary/advanced_usage/">高度なユーザー向けの Notary クライアント利用</a> を参照してください。</p>

<h2 id="what-is-notary">Notary とは何か</h2>

<p>Notary は、信頼できるコンテンツのコレクションを公開し管理するためのツールです。
公開者はコレクションに対して電子署名を行い、利用者はコンテンツの整合性と配布元を確認します。
この仕組みは、ごく普通の鍵管理および署名インターフェースを使って構築されており、署名されたコレクションを生成し、信頼された公開者を設定することができます。</p>

<p>Notary を利用すれば、任意のデータコレクションに対して誰でも信用を付与することができます。
Notary では、ベースとなるセキュリティフレームワークとして <a href="https://www.theupdateframework.com/">The Update Framework (TUF)</a> を利用しており、コンテンツの整合性や最新性を示すメタデータの生成、管理、配布を行う操作を提供します。</p>

<h2 id="install-notary">Notary のインストール</h2>

<p>Notary リポジトリの <a href="https://github.com/docker/notary/releases">Releases page on Github</a> から、64 ビット Linux 用および macOS 用のプリコンパイル済み Notary バイナリがダウンロードできます。</p>

<h2 id="understand-notary-naming">Notary での名前の指定方法</h2>

<p>Notary では Globally Unique Names (GUN) を利用して、信頼できるコレクションを識別します。
マルチテナント方式により Notary を実行するには、Notary クライアントを通じて Docker Hub とのやりとりを行うにあたって、そのフォーマットを用いる必要があります。
Notary クライアント向けに Docker イメージ名を指定するには、GUN フォーマットとして以下のようにします。</p>

<ul>
  <li>Docker Hub 上に表示される公式イメージ（official image）の名前には、先頭に<code class="language-plaintext highlighter-rouge">docker.io/library/</code>がつきます。
たとえば普通なら<code class="language-plaintext highlighter-rouge">docker pull ubuntu</code>と入力するようなものに対しては、<code class="language-plaintext highlighter-rouge">notary {cmd} docker.io/library/ubuntu</code>と入力する必要があります。</li>
  <li>公式イメージ以外であれば、Docker Hub 上に表示されるイメージには、先頭に<code class="language-plaintext highlighter-rouge">docker.io</code>がつきます。</li>
</ul>

<p>Docker Engine クライアントでは、このような名前の拡張を取り扱うため、Engine クライアントや API を利用する際には、その名前を変更しないでください。
Notary クライアントを通じて、同一の Docker Hub リポジトリとのやりとりを行うときにだけ、このことを守ってください。</p>

<h2 id="inspect-a-docker-hub-repository">Docker Hub リポジトリの確認</h2>

<p>よく実行する基本的な操作として、リポジトリ内で利用可能な、署名済みタグの一覧の確認操作があります。
独立して動作している Notary クライアントにとって、信頼できるリポジトリがどこにあるのかはわかりません。
したがってクライアントに対しては<code class="language-plaintext highlighter-rouge">-s</code>オプション（長い形式では<code class="language-plaintext highlighter-rouge">--server</code>）を指定して、通信先とするリポジトリサーバーを指定することが必要になります。</p>

<p>公式の Docker Hub Notary サーバーは<code class="language-plaintext highlighter-rouge">https://notary.docker.io</code>にあります。
独自に Notary サーバーを利用したい場合には、クライアントの機能互換のため、<a href="https://github.com/docker/notary/releases">Notary サーバーのバージョン</a> は同一か、より最新のものを用いることが重要です。
（たとえばクライアントがバージョン 0.2 であれば、サーバーの署名バージョンは 0.2 以上とするなど。）
そして Notary は自己署名鍵や、ダウンロードしたトラストメタデータのキャッシュを<code class="language-plaintext highlighter-rouge">-d</code>フラグで指定されたディレクトリに保存します。
Docker Hub リポジトリとのやりとりを行う際には、クライアントに対して、利用するトラストディレクトリを指定することが必要になります。
このディレクトリはデフォルトでは、クライアントを実行するユーザーのホームディレクトリ配下にある<code class="language-plaintext highlighter-rouge">.docker/trust</code>です。
（このディレクトリでない場合、トラストデータの更新を公開する際にエラーとなる可能性があります。）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>notary <span class="nt">-s</span> https://notary.docker.io <span class="nt">-d</span> ~/.docker/trust list docker.io/library/alpine
   NAME                                 DIGEST                                SIZE <span class="o">(</span>BYTES<span class="o">)</span>    ROLE
<span class="nt">------------------------------------------------------------------------------------------------------</span>
  2.6      e9cec9aec697d8b9d450edd32860ecd363f2f3174c8338beb5f809422d182c63   1374           targets
  2.7      9f08005dff552038f0ad2f46b8e65ff3d25641747d3912e3ea8da6785046561a   1374           targets
  3.1      e876b57b2444813cd474523b9c74aacacc238230b288a22bccece9caf2862197   1374           targets
  3.2      4a8c62881c6237b4c1434125661cddf09434d37c6ef26bf26bfaef0b8c5e2f05   1374           targets
  3.3      2d4f890b7eddb390285e3afea9be98a078c2acd2fb311da8c9048e3d1e4864d3   1374           targets
  edge     878c1b1d668830f01c2b1622ebf1656e32ce830850775d26a387b2f11f541239   1374           targets
  latest   24a36bbc059b1345b7e8be0df20f1b23caa3602e85d42fff7ecd9d0bd255de56   1377           targets
</code></pre></div></div>

<p>一覧に示されるのは、利用可能なタグ名、そのタグに関連づいたイメージマニフェストの 16 進エンコード sha256 ダイジェスト値、マニフェストサイズ、リポジトリ内に向けてそのタグが署名された Notary ロールです。
「targets」というのは、単純なリポジトリではごく普通に用いられるロールです。
リポジトリに協力者（collaborator）がいる、または予定されている場合には、これとは違う「委任された」ロールが署名者として表示されるかもしれません。
これは協力者をどのように構成するのかという、管理者の意向によってさまざまです。</p>

<p><code class="language-plaintext highlighter-rouge">docker pull</code>コマンドの実行時に、Docker Engine は統合された Notary ライブラリを利用します。
（これは Notary CLI と同じものです。）
その利用の際には、興味のある特定のタグにおける sha256 ダイジェスト値に、タグをマッピングすることが求められます。
（あるいは<code class="language-plaintext highlighter-rouge">--all</code>フラグを指定すれば、クライアントから一覧操作を行って、効率よくマッピング情報を取得することができます。）
トラストデータの署名が検証済みであると、クライアントは Engine に対して「ダイジェスト値によるプル」を行うように指示します。
そのプル処理において Engine は、コンテントアドレスとして sha256 チェックサムを利用し、Docker レジストリに対してイメージマニフェストを要求し検証します。</p>

<h2 id="delete-a-tag">タグの削除</h2>

<p>Notary が実行されるホスト上には署名鍵（signing key）が生成され保存されます。
このことから、Docker Hub はトラストデータのタグを削除できません。
削除するには Notary クライアントを使わなければならないということです。
その際に実行するコマンドは<code class="language-plaintext highlighter-rouge">notary remove</code>です。
繰り返しになりますが、このコマンドの通信先は、適切な Notary サーバーでなければなりません。
以下の例は公式の<code class="language-plaintext highlighter-rouge">alpine</code>リポジトリからタグを削除するものですが、権限を有していない私もあなたも、普通こんなことはできません。
あくまで例として示しているだけです。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>notary <span class="nt">-s</span> https://notary.docker.io <span class="nt">-d</span> ~/.docker/trust remove docker.io/library/alpine 2.6
Removal of 2.6 from docker.io/library/alpine staged <span class="k">for </span>next publish.
</code></pre></div></div>

<p>上の例において出力結果からわかるように、削除されるのはステージされたものだけです。
何か書き込み処理を行っていたら、それは変更リストにステージされます。
この変更リストは、次にそのリポジトリに対して<code class="language-plaintext highlighter-rouge">notary publish</code>が実行されたとき、トラストリポジトリの最新バージョンに適用されます。</p>

<p>修正中のリポジトリに対しては<code class="language-plaintext highlighter-rouge">notary status</code>を実行することで、修正中のステータスであることがわかります。
サブコマンド<code class="language-plaintext highlighter-rouge">status</code>はオフラインで実行できます。
したがって<code class="language-plaintext highlighter-rouge">-s</code>フラグは必要としませんん。
仮にフラグが指定されても、何も表示されずただ無視されます。
<code class="language-plaintext highlighter-rouge">-d</code>フラグに適切な値を設定しなかったときには、間違った変更リスト（あるいは空のリスト）が表示される場合があります。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>notary <span class="nt">-d</span> ~/.docker/trust status docker.io/library/alpine
Unpublished changes <span class="k">for </span>docker.io/library/alpine:

action    scope     <span class="nb">type        </span>path
<span class="nt">----------------------------------------------------</span>
delete    targets   target      2.6
<span class="nv">$ </span>notary <span class="nt">-s</span> https://notary.docker.io publish docker.io/library/alpine
</code></pre></div></div>

<h2 id="configure-the-client">クライアントの設定</h2>

<p>コマンド実行の際に、いつも<code class="language-plaintext highlighter-rouge">-s</code>フラグや<code class="language-plaintext highlighter-rouge">-d</code>フラグをつけるのは入力も長くなって面倒です。
これに対処するには、Notary コマンドのエイリアスを作って設定を含めてしまうのが簡単です。
以下に示す記述を<code class="language-plaintext highlighter-rouge">.bashrc</code>あるいはそれに相当するファイルに書き加えてください。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">alias </span><span class="nv">dockernotary</span><span class="o">=</span><span class="s2">"notary -s https://notary.docker.io -d ~/.docker/trust"</span>
</code></pre></div></div>

<p>これ以外にも応用的な設定方法、数々のオプションについて、<a href="/docs.docker.jp.onthefly/notary/reference/">設定ドキュメント</a> に示しています。
また<code class="language-plaintext highlighter-rouge">notary --help</code>を実行することでも表示されます。</p>
