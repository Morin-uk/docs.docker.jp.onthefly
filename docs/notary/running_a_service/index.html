<p>This document is for anyone who wants to run their own Notary
service (such as those who want to use Notary with a
private Docker registry). Running a Notary service requires that you are already
familiar with using <a href="/engine/userguide/">Docker Engine</a>
and <a href="/compose/">Docker Compose</a>.</p>

<h2 id="run-a-service-for-testing-or-development">Run a service for testing or development</h2>

<p>The quickest way to spin up a full Notary service for testing and development
purposes is to use the Docker compose file in the
<a href="https://github.com/docker/notary">Notary project</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/theupdateframework/notary.git
<span class="nv">$ </span><span class="nb">cd </span>notary
<span class="nv">$ </span>docker-compose up
</code></pre></div></div>

<p>This builds the development Notary server and Notary signer images, and
start up containers for the Notary server, Notary signer, and the MySQL
database that both of them share. The MySQL data is stored in a volume.</p>

<p>Notary server and Notary signer communicate over mutually authenticated TLS
(using the self-signed testing certs in the repository), and Notary server
listens for HTTPS traffic on port 4443.</p>

<p>By default, this development Notary server container runs with the testing
self-signed TLS certificates. Before you can successfully connect to
it, you must use the root CA file in <code class="language-plaintext highlighter-rouge">fixtures/root-ca.crt</code>.</p>

<p>For example, to connect using OpenSSL:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>openssl s_client <span class="nt">-connect</span> &lt;docker host&gt;:4443 <span class="nt">-CAfile</span> fixtures/root-ca.crt <span class="nt">-no_ssl3</span> <span class="nt">-no_ssl2</span>
</code></pre></div></div>

<p>To connect using the Notary Client CLI, see <a href="/docs.docker.jp.onthefly/notary/getting_started/">Getting Started</a>.
The version of the Notary server and signer
needs to be greater than or equal to that of the Notary Client CLI to ensure feature compatibility.
For instance, if you use Notary Client CLI 0.2, the server and signer each need
to be at least version 0.2 as well.</p>

<p>The self-signed certificate’s subject name and subject alternative names are
<code class="language-plaintext highlighter-rouge">notary-server</code>, <code class="language-plaintext highlighter-rouge">notaryserver</code>, and <code class="language-plaintext highlighter-rouge">localhost</code>, so if your Docker host is not
on <code class="language-plaintext highlighter-rouge">localhost</code> (for example if you are using Docker Machine),
update your hosts file such that the name <code class="language-plaintext highlighter-rouge">notary-server</code> is associated with
the IP address of your Docker host.</p>

<h2 id="advanced-configuration-options">Advanced configuration options</h2>

<p>Both the Notary server and the Notary signer take
<a href="/docs.docker.jp.onthefly/notary/reference/">JSON configuration files</a>. Pre-built images, such as
the <a href="/docs.docker.jp.onthefly/notary/running_a_service/#run-a-service-for-testing-or-development">development images above</a>
provide these configuration files for you with some sane defaults.</p>

<p>However, for running in production, or if you just want to change those defaults
on your development service, you probably want to change those defaults.</p>

<h3 id="running-with-different-command-line-arguments">Running with different command line arguments</h3>

<p>You can override the <code class="language-plaintext highlighter-rouge">docker run</code> command for the image if you want to pass
different command line options. Both Notary server and Notary signer take
the following command line arguments:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">-config=&lt;config file&gt;</code> - specify the path to the JSON configuration file.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">-debug</code> - Passing this flag enables the debugging server on <code class="language-plaintext highlighter-rouge">localhost:8080</code>.
  The debugging server provides
  <a href="https://golang.org/pkg/net/http/pprof">pprof</a> and
  <a href="ttps://golang.org/pkg/expvar/">expvar</a> endpoints.
  (Remember, this is localhost with respect to the running container - this endpoint is not
  exposed from the container).</p>

    <p>This option can also be set in the configuration file.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">-logf=&lt;format&gt;</code> - This flag sets the output format for the logs. Possible
  formats are “json” and “logfmt”.</p>

    <p>This option cannot be set in the configuration file, since some log
  messages are produced on startup before the configuration file has been
  read.</p>
  </li>
</ul>

<h3 id="specifying-your-own-configuration-files">Specifying your own configuration files</h3>

<p>You can run the images with your own configuration files entirely.
You just need to mount your configuration directory, and then pass the
path to that configuration file as an argument to the <code class="language-plaintext highlighter-rouge">docker run</code> command.</p>

<h3 id="overriding-configuration-file-parameters-using-environment-variables">Overriding configuration file parameters using environment variables</h3>

<p>You can also override the parameters of the configuration by
setting environment variables of the form <code class="language-plaintext highlighter-rouge">NOTARY_SERVER_&lt;var&gt;</code> or
<code class="language-plaintext highlighter-rouge">NOTARY_SIGNER_&lt;var&gt;</code>.</p>

<p><code class="language-plaintext highlighter-rouge">var</code> is the ALL-CAPS, <code class="language-plaintext highlighter-rouge">"_"</code>-delimited path of keys from the top level of the
configuration JSON.</p>

<p>For instance, if you wanted to override the storage URL of the Notary server
configuration:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"storage"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"backend"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mysql"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"db_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dockercondemo:dockercondemo@tcp(notary-mysql)/dockercondemo"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>You would need to set the environment variable <code class="language-plaintext highlighter-rouge">NOTARY_SERVER_STORAGE_DB_URL</code>,
because the <code class="language-plaintext highlighter-rouge">db_url</code> is in the <code class="language-plaintext highlighter-rouge">storage</code> section of the Notary server
configuration JSON.</p>

<p>ou cannot override a key whose value is another map. For instance, setting
<code class="language-plaintext highlighter-rouge">NOTARY_SERVER_STORAGE='{"storage": {"backend": "memory"}}'</code> does not set
in-memory storage. It just fails to parse. You can only override keys whose
values are strings or numbers.</p>

<p>For example, let’s say that you wanted to run a single Notary server instance:</p>

<ul>
  <li>with your own TLS cert and keys</li>
  <li>with a local, in-memory signer service rather than using Notary signer</li>
  <li>using a local, in-memory TUF metadata store rather than using MySQL</li>
  <li>produce JSON-formatted logs</li>
</ul>

<p>One way to do this would be:</p>

<ol>
  <li>
    <p>Generate your own TLS certificate and key as <code class="language-plaintext highlighter-rouge">server.crt</code> and <code class="language-plaintext highlighter-rouge">server.key</code>,
 and put them in the directory <code class="language-plaintext highlighter-rouge">/tmp/server-configdir</code>.</p>
  </li>
  <li>
    <p>Write the following configuration file to <code class="language-plaintext highlighter-rouge">/tmp/server-configdir/config.json</code>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> {
   "server": {
     "http_addr": ":4443",
     "tls_key_file": "./server.key",
     "tls_cert_file": "./server.crt"
   },
   "trust_service": {
     "type": "remote",
     "hostname": "notarysigner",
     "port": "7899",
     "tls_ca_file": "./root-ca.crt",
     "key_algorithm": "ecdsa",
     "tls_client_cert": "./notary-server.crt",
     "tls_client_key": "./notary-server.key"
   },
   "storage": {
     "backend": "mysql",
     "db_url": "server@tcp(mysql:3306)/notaryserver?parseTime=True"
   }
 }
</code></pre></div>    </div>

    <p>NWe include a remote trust service and a database storage
 type to demonstrate how environment variables can override
 configuration parameters.</p>
  </li>
  <li>
    <p>Run the following command (assuming you’ve already built or pulled a Notary server docker image):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker run \
     -p "4443:4443" \
     -v /tmp/server-configdir:/etc/docker/notary-server/ \
     -e NOTARY_SERVER_TRUST_SERVICE_TYPE=local \
     -e NOTARY_SERVER_STORAGE_BACKEND=memory \
     -e NOTARY_SERVER_LOGGING_LEVEL=debug \
     notary_server \
         -config=/etc/docker/notary-server/config.json \
         -logf=json
 {"level":"info","msg":"Version: 0.2, Git commit: 619f8cf","time":"2016-02-25T00:53:59Z"}
 {"level":"info","msg":"Using local signing service, which requires ED25519. Ignoring all other trust_service parameters, including keyAlgorithm","time":"2016-02-25T00:53:59Z"}
 {"level":"info","msg":"Using memory backend","time":"2016-02-25T00:53:59Z"}
 {"level":"info","msg":"Starting Server","time":"2016-02-25T00:53:59Z"}
 {"level":"info","msg":"Enabling TLS","time":"2016-02-25T00:53:59Z"}
 {"level":"info","msg":"Starting on :4443","time":"2016-02-25T00:53:59Z"}
</code></pre></div>    </div>
  </li>
</ol>

<p>You can do the same using
<a href="/compose/">Docker Compose</a> by setting volumes,
environment variables, and overriding the default command for the Notary server
containers in the Compose file.</p>

<h2 id="recommendations-for-deploying-in-production">Recommendations for deploying in production</h2>

<p>When moving from development to production there are a number of considerations
that must be made to ensure security and scalability.</p>

<h3 id="certificates">Certificates</h3>

<p>The Notary repository includes sample certificates in the fixtures directory.
When you initialize a development service using the provided <code class="language-plaintext highlighter-rouge">docker-compose.yml</code>
file, these sample certificates are used to create a more production like
environment.</p>

<p><strong>You must acquire your own certificates to use in a production deployment.</strong></p>

<p>The sample private key files in the Notary repository are obviously public knowledge
and using them in a production deployment is highly insecure.</p>

<h3 id="certificate-directory">Certificate directory</h3>

<p>Notary is a user/client-based system, and it searches for certificates in the
user’s home directory, at <code class="language-plaintext highlighter-rouge">~/.docker/trust</code>. To streamline using Notary from
the command line, create an alias that maps the user’s <code class="language-plaintext highlighter-rouge">trust</code> directory to
the system’s <code class="language-plaintext highlighter-rouge">ca-certificates</code> directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">alias </span><span class="nv">notary</span><span class="o">=</span><span class="s2">"notary -s https://&lt;dtr-url&gt; -d ~/.docker/trust --tlscacert /usr/local/share/ca-certificates/&lt;dtr-url&gt;.crt"</span>
</code></pre></div></div>

<h3 id="databases">Databases</h3>

<p>The server and signer each require a database. These should be separate databases
with different users. The users should be limited in their permissions. We recommend
giving the following MySQL (or equivalent) permissions to the users restricted to
only their own databases:</p>

<ul>
  <li>Notary server database user: <code class="language-plaintext highlighter-rouge">SELECT, INSERT, UPDATE, DELETE</code></li>
  <li>Notary signer database user: <code class="language-plaintext highlighter-rouge">SELECT, INSERT, DELETE</code></li>
</ul>

<h3 id="high-availability">High Availability</h3>

<p>To increase availability, you can run multiple instances
of both the server and signer applications. These can scale arbitrarily and
independently. The database can also scale independently but this is left as
an exercise for experienced DBAs and Operations teams. A typical deployment
looks like this:</p>

<p><img src="https://cdn.rawgit.com/docker/notary/09f81717080f53276e6881ece57cbbbf91b8e2a7/docs/images/service-deployment.svg" alt="Notary server Deployment Diagram" /></p>

<p>In the diagram, a load balancer routes external traffic to a cluster of Notary server
instances. These may make requests to Notary signer instances if either a) signing
is required, or b) key generation is required. The requests from a Notary server
to a Notary signer cluster are router via an internal load balancer.</p>

<p>Notary can be used with a CDN or other caching system. All GET requests for JSON
files may be cached indefinitely <strong>except</strong> URLs matching:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">*/root.json</code></li>
  <li><code class="language-plaintext highlighter-rouge">*/timestamp.json</code></li>
</ul>

<p>All other requests for JSON files include sha256 checksums of the file being requested
and are therefore immutable. Requests for JSON files make up the vast majority of
all notary requests. Requests for anything other than a GET of a JSON file should
not be cached.</p>

<h2 id="related-information">Related information</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/notary/service_architecture/">Notary service architecture</a></li>
  <li><a href="/docs.docker.jp.onthefly/notary/reference/">Notary configuration files</a></li>
</ul>
