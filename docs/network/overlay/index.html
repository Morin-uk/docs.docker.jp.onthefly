
<p><code class="language-plaintext highlighter-rouge">overlay</code> ネットワークドライバーは、複数の Docker デーモンホスト間での分散ネットワークを生成します。
このネットワークは、ホストに固有のものとして構築されたネットワークの最上位に位置（overlay）するものです。
このネットワークに対しては、コンテナー（Swarm サービスコンテナーを含む）が接続可能です。
暗号化が有効になっていれば、安全な通信を行うことができます。
Docker は、各パケットの送受信経路を透過的に取り扱い、その送受信先となる Docker ホストデーモンやコンテナーを適切に認識します。</p>

<p>Swarm の初期化を行うとき、あるいは Docker ホストを既存の Swarm に参加させるときには、そのホスト上に 2 つのネットワークが生成されます。</p>

<ul>
  <li>1 つは <code class="language-plaintext highlighter-rouge">ingress</code> と呼ばれるオーバーレイネットワークです。
これは Swarm サービスに関する制御とデータトラフィックを取り扱います。
Swarm サービスを生成する際に、ユーザー定義のオーバーレイネットワークへの接続を指定しない限り、デフォルトでは <code class="language-plaintext highlighter-rouge">ingress</code> ネットワークに接続されます。</li>
  <li>もう 1 つは <code class="language-plaintext highlighter-rouge">docker_gwbridge</code> と呼ばれるブリッジネットワークです。
これは、個々の Docker デーモンを、Swarm 内に参加している別のデーモンに接続するものです。</li>
</ul>

<p>ユーザー定義の <code class="language-plaintext highlighter-rouge">overlay</code> ネットワークは <code class="language-plaintext highlighter-rouge">docker network create</code> を使って生成することができます。
ユーザー定義の <code class="language-plaintext highlighter-rouge">bridge</code> ネットワークを生成する方法と同じです。
サービスやコンテナーは、一度に複数のネットワークに接続できます。
サービスやコンテナーがネットワーク通信を行うことができるのは、互いに接続されている場合だけです。</p>

<p>Swarm サービスとスタンドアロンコンテナーは、どちらもオーバーレイネットワークに接続することができます。
ただしデフォルトの動作や設定が目指しているものは、まったく異なります。
そこで、これ以降のトピックでは操作説明を以下のように分けます。
オーバーレイネットワークに対する全般的な操作、Swarm サービスネットワークに対する操作、スタンドアロンコンテナーにおいて利用されるオーバーレイネットワークに対する操作です。</p>

<h2 id="operations-for-all-overlay-networks">オーバーレイネットワークに対する全般的な操作</h2>

<h3 id="create-an-overlay-network">オーバーレイネットワークの生成</h3>

<blockquote>
  <p><strong>前提条件</strong>:</p>

  <ul>
    <li>
      <p>オーバーレイネットワークを使った Docker デーモン用のファイアーウォールルール</p>

      <p>オーバーレイネットワーク上に参加する Docker ホスト間でのトラフィックのやりとりのため、以下のポートを公開する必要があります。</p>

      <ul>
        <li>TCP ポート 2377、クラスター管理に関する通信用。</li>
        <li>TCP と UDP のポート 7946、ノード間の通信用。</li>
        <li>UDP ポート 4789、オーバーレイネットワークトラフィック用。</li>
      </ul>
    </li>
    <li>
      <p>オーバーレイネットワークを生成する前には、<code class="language-plaintext highlighter-rouge">docker swarm init</code> を使って Docker デーモンを Swarm マネージャーとして初期化するか、あるいは <code class="language-plaintext highlighter-rouge">docker swarm join</code> を使って既存の Swarm にホストを追加しておく必要があります。
どちらの場合でも、デフォルトの <code class="language-plaintext highlighter-rouge">ingress</code> オーバーレイネットワークが生成されます。
このネットワークは、デフォルトで Swarm サービスが利用するものです。
Swarm サービスを利用するつもりがなくても、これを行っておくことが必要です。
この後には、ユーザー定義のオーバーレイネットワークを追加生成することができます。</p>
    </li>
  </ul>
</blockquote>

<p>Swarm サービスに対して利用するオーバーレイネットワークを生成するには、以下のようなコマンドを実行します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker network create <span class="nt">-d</span> overlay my-overlay
</code></pre></div></div>

<p>オーバーレイネットワークを生成する目的が、Swarm サービスにおいて利用するだけでなく、スタンドアロンコンテナー <strong>においても</strong> 利用することが必要な場合で、他の Docker デーモン上で動作する他のスタンドアロンコンテナーとも通信を行う必要がある場合は、<code class="language-plaintext highlighter-rouge">--attachable</code> フラグを加えます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker network create <span class="nt">-d</span> overlay <span class="nt">--attachable</span> my-attachable-overlay
</code></pre></div></div>

<p>IP アドレス範囲、サブネット、ゲートウェイ、その他のオプションを指定することができます。
詳しくは <code class="language-plaintext highlighter-rouge">docker network create --help</code> を確認してください。</p>

<h3 id="encrypt-traffic-on-an-overlay-network">オーバーレイネットワーク上のトラフィック暗号化</h3>

<p>Swarm サービスの管理トラフィックは、デフォルトにおいて、GCM モードの <a href="https://en.wikipedia.org/wiki/Galois/Counter_Mode">AES アルゴリズム</a> を使ってすべて暗号化されます。
Swarm 内のマネージャーノードは、ゴシップデータ（gossip data）の暗号化に利用する鍵を 12 時間ごとにローテートして利用します。</p>

<p>アプリケーションデータを暗号化するには、オーバーレイネットワークの生成時に <code class="language-plaintext highlighter-rouge">--opt encrypted</code> を指定します。
これにより vxlan レベルの IPSEC 暗号化が実現します。
この暗号化を利用すると、性能劣化が無視できない程度に発生します。
したがって本番環境での利用を行うには、あらかじめ十分にテストを行っておく必要があります。</p>

<p>オーバーレイにおいて暗号化を有効にすると、Docker はノード間のすべてに IPSEC トンネルを生成して、
オーバーレイネットワークにアタッチされたサービスに応じて、タスクをスケジューリングします。
このトンネルは GCM モードでの AES アルゴリズムを利用するので、マネージャーノードは 12 時間ごとに鍵のローテートを自動的に行います。</p>

<blockquote class="warning">
  <p><strong>Windows ノードは暗号化されたオーバーレイネットワークにアタッチしないでください。</strong></p>

  <p>オーバーレイネットワークの暗号化は Windows 上においてはサポートされていません。
暗号化されたオーバーレイネットワークに Windows ノードを接続しようとすると、エラーは発生しませんが、ただしそのノードは通信することができません。</p>
</blockquote>

<h4 id="swarm-mode-overlay-networks-and-standalone-containers">Swarm モードのオーバーレイネットワークとスタンドアロンコンテナー</h4>

<p>オーバーレイネットワーク機能を利用する際に <code class="language-plaintext highlighter-rouge">--opt encrypted --attachable</code> を同時に指定すれば、このネットワークに対して、管理外にあったコンテナーをアタッチさせることができます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker network create <span class="nt">--opt</span> encrypted <span class="nt">--driver</span> overlay <span class="nt">--attachable</span> my-attachable-multi-host-network
</code></pre></div></div>

<h3 id="customize-the-default-ingress-network">デフォルトの ingress ネットワークのカスタマイズ</h3>

<p>ほとんどのユーザーにとって <code class="language-plaintext highlighter-rouge">ingress</code> ネットワークをカスタマイズする必要はありません。
ただし Docker 17.05 またはそれ以降においては、設定変更が可能です。
たとえば自動的に設定されるサブネットが、ネットワーク上にすでにあるものとコンフリクトした場合には、設定が必要になります。
また MTU のような低レベルのネットワーク設定を行う場合にも必要です。</p>

<p><code class="language-plaintext highlighter-rouge">ingress</code> ネットワークをカスタマイズするには、いったん削除して再生成することが必要です。
通常は Swarm 上にサービスを生成する前に、これを行います。
ポートを公開しているサービスがある場合は、<code class="language-plaintext highlighter-rouge">ingress</code> ネットワークを削除する前に、そのサービスを削除しておく必要があります。</p>

<p><code class="language-plaintext highlighter-rouge">ingress</code> ネットワークが存在していない間、ポートを公開していないサービスであれば機能しますが、ただし負荷分散は行われません。
この状況は、WordPress サービスのようにポート 80 を公開しているサービスに影響を及ぼします。</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">docker network inspect ingress</code> を実行して <code class="language-plaintext highlighter-rouge">ingress</code> ネットワークを調べます。
そして、これに接続しているコンテナーのサービスをすべて削除します。
このサービスとは WordPress サービスにように、ポートを公開しているものです。
こういったサービスを停止し忘れていると、次の作業が失敗します。</p>
  </li>
  <li>
    <p>既存の <code class="language-plaintext highlighter-rouge">ingress</code> ネットワークを削除します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker network <span class="nb">rm </span>ingress

WARNING! Before removing the routing-mesh network, make sure all the nodes
<span class="k">in </span>your swarm run the same docker engine version. Otherwise, removal may not
be effective and functionality of newly created ingress networks will be
impaired.
Are you sure you want to <span class="k">continue</span>? <span class="o">[</span>y/N]
</code></pre></div>    </div>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--ingress</code> フラグを使って、新たなオーバーレイネットワークを生成します。
カスタマイズしたいオプションがあれば設定しておきます。
以下の例では MTU を 1200、サブネットを <code class="language-plaintext highlighter-rouge">10.11.0.0/16</code>、ゲートウェイを <code class="language-plaintext highlighter-rouge">10.11.0.2</code> にそれぞれ指定しています。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker network create <span class="se">\</span>
  <span class="nt">--driver</span> overlay <span class="se">\</span>
  <span class="nt">--ingress</span> <span class="se">\</span>
  <span class="nt">--subnet</span><span class="o">=</span>10.11.0.0/16 <span class="se">\</span>
  <span class="nt">--gateway</span><span class="o">=</span>10.11.0.2 <span class="se">\</span>
  <span class="nt">--opt</span> com.docker.network.driver.mtu<span class="o">=</span>1200 <span class="se">\</span>
  my-ingress
</code></pre></div>    </div>

    <blockquote>
      <p><strong>メモ</strong>: 生成する <code class="language-plaintext highlighter-rouge">ingress</code> ネットワークの名前は <code class="language-plaintext highlighter-rouge">ingress</code> 以外にすることも可能です。
ただし生成できるのは 1 つだけであり、2 つめを生成しようとしても失敗します。</p>
    </blockquote>
  </li>
  <li>
    <p>1 つめの手順で停止させていたサービスを再起動します。</p>
  </li>
</ol>

<h3 id="customize-the-docker_gwbridge-interface">docker_gwbridge インターフェースのカスタマイズ</h3>

<p><code class="language-plaintext highlighter-rouge">docker_gwbridge</code> は仮想ブリッジであり、（<code class="language-plaintext highlighter-rouge">ingress</code> ネットワークを含む）オーバーレイネットワークを、個々の Docker デーモンにおいて稼動する物理ネットワークに接続します。
Docker では、Swarm を初期化するとき、あるいは Docker ホストを Swarm に参加させるときに、この仮想ブリッジを自動生成します。
ただしこれは Docker のデバイスではありません。
Docker ホストのカーネル内に存在するものです。
これに対する設定が必要な場合は、Docker ホストを Swarm に参加させる前、あるいはホストを一時的に Swarm から削除してから設定を行う必要があります。</p>

<ol>
  <li>
    <p>Docker を停止します。</p>
  </li>
  <li>
    <p>既存の <code class="language-plaintext highlighter-rouge">docker_gwbridge</code> インターフェースを削除します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>ip <span class="nb">link set </span>docker_gwbridge down

<span class="nv">$ </span><span class="nb">sudo </span>ip <span class="nb">link </span>del dev docker_gwbridge
</code></pre></div>    </div>
  </li>
  <li>
    <p>Docker を起動します。
Swarm への参加、あるいは初期化は行いません。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">docker_gwbridge</code> ブリッジへのカスタマイズを行った上で、これを手動で再生成します。
これは <code class="language-plaintext highlighter-rouge">docker network create</code> コマンドを使って行います。
以下の例では、サブネットを <code class="language-plaintext highlighter-rouge">10.11.0.0/16</code> に指定しています。
カスタマイズ可能なオプションについては、<a href="/docs.docker.jp.onthefly/engine/reference/commandline/network_create/#bridge-driver-options">ブリッジドライバーのオプション</a> を参照してください。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker network create <span class="se">\</span>
<span class="nt">--subnet</span> 10.11.0.0/16 <span class="se">\</span>
<span class="nt">--opt</span> com.docker.network.bridge.name<span class="o">=</span>docker_gwbridge <span class="se">\</span>
<span class="nt">--opt</span> com.docker.network.bridge.enable_icc<span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
<span class="nt">--opt</span> com.docker.network.bridge.enable_ip_masquerade<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
docker_gwbridge
</code></pre></div>    </div>
  </li>
  <li>
    <p>Swarm の初期化、あるいは Swarm への参加を行います。
ブリッジが存在するので、Docker は自動設定にもとづくブリッジの生成は行いません。</p>
  </li>
</ol>

<h2 id="operations-for-swarm-services">Swarm サービスに対する操作</h2>

<h3 id="publish-ports-on-an-overlay-network">オーバーレイネットワーク上でのポート公開</h3>

<p>同一のオーバーレイネットワークに接続された Swarm サービスは、全ポートを互いに公開します。
外部のサービスからアクセス可能な 1 つのポートがあるなら、そのポートは <code class="language-plaintext highlighter-rouge">docker service create</code> や <code class="language-plaintext highlighter-rouge">docker service update</code> を実行するときの <code class="language-plaintext highlighter-rouge">-p</code> または <code class="language-plaintext highlighter-rouge">--publish</code> フラグを使って、<strong>公開に</strong> しておかなければなりません。
指定の際には、かつてのコロン区切りの文法と、最新のカンマ区切りによる文法がともにサポートされます。
わかりやすくするために、長い文法を用いることが好まれています。</p>

<table>
<thead>
<tr>
<th>フラグ値</th>
<th>内容説明</th>
</tr>
</thead>
<tr>
<td><tt>-p 8080:80</tt> または<br /><tt>-p published=8080,target=80</tt></td>
<td>サービス上の TCP ポート 80 をルーティングメッシュ上のポート 8080 にマッピングします。</td>
</tr>
<tr>
<td><tt>-p 8080:80/udp</tt> または<br /><tt>-p published=8080,target=80,protocol=udp</tt></td>
<td>サービス上の UDP ポート 80 をルーティングメッシュ上のポート 8080 にマッピングします。</td>
</tr>
<tr>
<td><tt>-p 8080:80/tcp -p 8080:80/udp</tt> または<br /><tt>-p published=8080,target=80,protocol=tcp -p published=8080,target=80,protocol=udp</tt></td>
<td>サービス上の TCP ポート 80 をルーティングメッシュ上のポート 8080 にマッピングします。
またサービス上の UDP ポート 80 をルーティングメッシュ上のポート 8080 にマッピングします。</td>
</tr>
</table>

<h3 id="bypass-the-routing-mesh-for-a-swarm-service">Swarm サービスにおけるルーティングメッシュの停止</h3>

<p>ポートを公開している Swarm サービスは、デフォルトでルーティングメッシュ（routing mesh）を利用します。
Swarm ノードのいずれかの公開ポートに接続すると（指定のサービスが動作しているかどうかには関係なく）、そのサービスが動作しているワーカーノードにリダイレクトされます。
Swarm サービスに対して、Docker が効率よくロードバランサーのように動作します。
ルーティングメッシュを利用するサービスは、<strong>仮想 IP モード</strong>（virtual IP mode）として稼動します。
各ノード上に稼動する別サービスであっても（<code class="language-plaintext highlighter-rouge">--mode global</code> フラグにより）ルーティングメッシュを利用します。
ルーティングメッシュを利用した場合、クライアントが要求するノードサービスがどれになるかは保証されません。</p>

<p>ルーティングメッシュを停止するには、サービスを <strong>DNS ラウンドロビン</strong>（DNS Round Robin; DNSRR）モードで起動します。
これは <code class="language-plaintext highlighter-rouge">--endpoint-mode</code> に <code class="language-plaintext highlighter-rouge">dnsrr</code> を設定することで実現します。
サービスに対しては独自にロードバランサーを稼動させる必要があります。
Docker ホスト上のサービス名に対する DNS 問い合わせは、サービスを実行しているノードの IP アドレス一覧を返します。
ロードバランサーがこの一覧を解釈し、ノード間のトラフィックを調整するように設定を行ってください。</p>

<h3 id="separate-control-and-data-traffic">制御情報とデータのトラフィック分離</h3>

<p>Swarm の管理に関連する制御情報のトラフィックと、アプリケーションの動作において発生するトラフィックは、同じネットワーク上でやりとりされます。
なお Swarm の制御情報トラフィックは暗号化されています。
Docker では、この異なる種類のトラフィックを、別々のネットワークインターフェースに分けて取り扱う設定が可能です。
Swarm の初期化時あるいは Swarm への参加時に <code class="language-plaintext highlighter-rouge">--advertise-addr</code>、<code class="language-plaintext highlighter-rouge">--datapath-addr</code> をそれぞれ指定します。
Swarm に参加させるノードに対しては、必ずこれを行わなければなりません。</p>

<h2 id="operations-for-standalone-containers-on-overlay-networks">オーバーレイネットワーク上のスタンドアロンコンテナーに対する操作</h2>

<h3 id="attach-a-standalone-container-to-an-overlay-network">オーバーレイネットワークへのスタンドアロンコンテナーのアタッチ</h3>

<p><code class="language-plaintext highlighter-rouge">ingress</code> ネットワークを <code class="language-plaintext highlighter-rouge">--attachable</code> フラグの指定をせずに生成すると、Swarm サービスだけがこれを利用できるようになり、スタンドアロンコンテナーは利用できません。
スタンドアロンコンテナーの場合は、ユーザー定義のオーバーレイネットワークを <code class="language-plaintext highlighter-rouge">--attachable</code> フラグにより生成すれば、接続ができます。
このようにすれば、スタンドアロンコンテナーを、さまざまな Docker デーモン上に起動させることが可能であり、
個別のデーモンホスト上にルーティングを設定することなく、通信が行えるようになります。</p>

<h3 id="publish-ports">公開ポート</h3>

<table>
  <thead>
    <tr>
      <th>フラグ値</th>
      <th>内容説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">-p 8080:80</code></td>
      <td>コンテナー上の TCP ポート 80 をオーバーレイネットワーク上のポート 8080 にマッピングします。</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">-p 8080:80/udp</code></td>
      <td>コンテナー上の UDP ポート 80 をオーバーレイネットワーク上のポート 8080 にマッピングします。</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">-p 8080:80/sctp</code></td>
      <td>コンテナー上の SCTP ポート 80 をオーバーレイネットワーク上のポート 8080 にマッピングします。</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">-p 8080:80/tcp -p 8080:80/udp</code></td>
      <td>コンテナー上の TCP ポート 80 をオーバーレイネットワーク上のポート 8080 にマッピングします。またコンテナー上の UDP ポート 80 をオーバーレイネットワーク上のポート 8080 にマッピングします。</td>
    </tr>
  </tbody>
</table>

<h3 id="container-discovery">コンテナーの検出</h3>

<p>接続先を指定するには、たいていの場合サービス名を用います。
サービスが負荷分散されていたり、サービスのもとにあるコンテナー（「タスク」）のすべてによって取り扱われていたりするからです。
サービスのもとにあるタスク全一覧を取得するには、<code class="language-plaintext highlighter-rouge">tasks.&lt;サービス名&gt;</code> に対して DNS 問い合わせを行ってください。</p>

<h2 id="next-steps">次のステップ</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/network/network-tutorial-overlay/">オーバーレイネットワークのチュートリアル</a> をひととおり読んでください。</li>
  <li><a href="/docs.docker.jp.onthefly/config/containers/container-networking/">コンテナーから見たネットワーク</a> について。</li>
  <li><a href="/docs.docker.jp.onthefly/network/bridge/">スタンドアロンブリッジネットワーク</a> について。</li>
  <li><a href="/docs.docker.jp.onthefly/network/macvlan/">Macvlan ネットワーク</a> について。</li>
</ul>
