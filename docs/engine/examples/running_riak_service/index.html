<p>The goal of this example is to show you how to build a Docker image with
Riak pre-installed.</p>

<h2 id="create-a-dockerfile">Create a Dockerfile</h2>

<p>Create an empty file called <code class="language-plaintext highlighter-rouge">Dockerfile</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ touch Dockerfile
</code></pre></div></div>

<p>Next, define the parent image you want to use to build your image on top
of. We use <a href="https://hub.docker.com/_/ubuntu/">Ubuntu</a> (tag:
<code class="language-plaintext highlighter-rouge">trusty</code>), which is available on <a href="https://hub.docker.com">Docker Hub</a>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Riak
#
# VERSION       0.1.1

# Use the Ubuntu parent image provided by dotCloud
FROM ubuntu:trusty
</code></pre></div></div>

<p>After that, we install the curl which is used to download the repository setup
script and we download the setup script and run it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Install Riak repository before we do apt-get update, so that update happens
# in a single step
RUN apt-get install -q -y curl &amp;&amp; \
    curl -fsSL https://packagecloud.io/install/repositories/basho/riak/script.deb | sudo bash
</code></pre></div></div>

<p>Then we install and setup a few dependencies:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">supervisor</code> is used manage the Riak processes</li>
  <li><code class="language-plaintext highlighter-rouge">riak=2.0.5-1</code> is the Riak package coded to version 2.0.5</li>
</ul>

<!-- -->

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Install and setup project dependencies
RUN apt-get update &amp;&amp; \
    apt-get install -y supervisor riak=2.0.5-1

RUN mkdir -p /var/log/supervisor

RUN locale-gen en_US en_US.UTF-8

COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf
</code></pre></div></div>

<p>After that, we modify Riak’s configuration:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Configure Riak to accept connections from any host
RUN sed -i "s|listener.http.internal = 127.0.0.1:8098|listener.http.internal = 0.0.0.0:8098|" /etc/riak/riak.conf
RUN sed -i "s|listener.protobuf.internal = 127.0.0.1:8087|listener.protobuf.internal = 0.0.0.0:8087|" /etc/riak/riak.conf
</code></pre></div></div>

<p>Then, we expose the Riak Protocol Buffers and HTTP interfaces:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Expose Riak Protocol Buffers and HTTP interfaces
EXPOSE 8087 8098
</code></pre></div></div>

<p>Finally, run <code class="language-plaintext highlighter-rouge">supervisord</code> so that Riak is started:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CMD ["/usr/bin/supervisord"]
</code></pre></div></div>

<h2 id="create-a-supervisord-configuration-file">Create a supervisord configuration file</h2>

<p>Create an empty file called <code class="language-plaintext highlighter-rouge">supervisord.conf</code>. Make
sure it’s at the same directory level as your <code class="language-plaintext highlighter-rouge">Dockerfile</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>touch supervisord.conf
</code></pre></div></div>

<p>Populate it with the following program definitions:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[supervisord]
nodaemon=true

[program:riak]
command=bash -c "/usr/sbin/riak console"
numprocs=1
autostart=true
autorestart=true
user=riak
environment=HOME="/var/lib/riak"
stdout_logfile=/var/log/supervisor/%(program_name)s.log
stderr_logfile=/var/log/supervisor/%(program_name)s.log
</code></pre></div></div>

<h2 id="build-the-docker-image-for-riak">Build the Docker image for Riak</h2>

<p>Now you can build a Docker image for Riak:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker build -t "&lt;yourname&gt;/riak" .
</code></pre></div></div>

<h2 id="next-steps">Next steps</h2>

<p>Riak is a distributed database. Many production deployments consist of
<a href="https://riak.com/why-your-riak-cluster-should-have-at-least-five-nodes/">at least five nodes</a>.
See the <a href="https://github.com/hectcastro/docker-riak">docker-riak</a> project
details on how to deploy a Riak cluster using Docker and Pipework.</p>
