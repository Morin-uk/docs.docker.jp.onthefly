
<h2 id="install-postgresql-on-Docker">Docker での PostgreSQL インストール</h2>

<p>条件に合う Docker イメージが <a href="https://hub.docker.com">Docker Hub</a> にはなかったと仮定して、自分で作ることにします。</p>

<p>新たに <code class="language-plaintext highlighter-rouge">Dockerfile</code> を作るところから始めます。</p>

<blockquote>
  <p><strong>メモ</strong>:
この PostgreSQL 環境の構築は、単に開発目的で行うものです。
PostgreSQL に対する設定が、適切に安全なものに
Refer to the
PostgreSQL documentation to fine-tune these settings so that it is
suitably secure.</p>
</blockquote>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#</span>
<span class="c"># example Dockerfile for https://docs.docker.com/engine/examples/postgresql_service/</span>
<span class="c">#</span>

<span class="k">FROM</span><span class="s"> ubuntu:16.04</span>

<span class="c"># Add the PostgreSQL PGP key to verify their Debian packages.</span>
<span class="c"># It should be the same key as https://www.postgresql.org/media/keys/ACCC4CF8.asc</span>
<span class="k">RUN </span>apt-key adv <span class="nt">--keyserver</span> hkp://p80.pool.sks-keyservers.net:80 <span class="nt">--recv-keys</span> B97B0AFCAA1A47F044F244A07FCC7D46ACCC4CF8

<span class="c"># Add PostgreSQL's repository. It contains the most recent stable release</span>
<span class="c">#  of PostgreSQL.</span>
<span class="k">RUN </span><span class="nb">echo</span> <span class="s2">"deb http://apt.postgresql.org/pub/repos/apt/ precise-pgdg main"</span> <span class="o">&gt;</span> /etc/apt/sources.list.d/pgdg.list

<span class="c"># Install ``python-software-properties``, ``software-properties-common`` and PostgreSQL 9.3</span>
<span class="c">#  There are some warnings (in red) that show up during the build. You can hide</span>
<span class="c">#  them by prefixing each apt-get statement with DEBIAN_FRONTEND=noninteractive</span>
<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> python-software-properties software-properties-common postgresql-9.3 postgresql-client-9.3 postgresql-contrib-9.3

<span class="c"># Note: The official Debian and Ubuntu images automatically ``apt-get clean``</span>
<span class="c"># after each ``apt-get``</span>

<span class="c"># Run the rest of the commands as the ``postgres`` user created by the ``postgres-9.3`` package when it was ``apt-get installed``</span>
<span class="k">USER</span><span class="s"> postgres</span>

<span class="c"># Create a PostgreSQL role named ``docker`` with ``docker`` as the password and</span>
<span class="c"># then create a database `docker` owned by the ``docker`` role.</span>
<span class="c"># Note: here we use ``&amp;&amp;\`` to run commands one after the other - the ``\``</span>
<span class="c">#       allows the RUN command to span multiple lines.</span>
<span class="k">RUN    </span>/etc/init.d/postgresql start <span class="o">&amp;&amp;</span><span class="se">\
</span>    psql <span class="nt">--command</span> <span class="s2">"CREATE USER docker WITH SUPERUSER PASSWORD 'docker';"</span> <span class="o">&amp;&amp;</span><span class="se">\
</span>    createdb <span class="nt">-O</span> docker docker

<span class="c"># Adjust PostgreSQL configuration so that remote connections to the</span>
<span class="c"># database are possible.</span>
<span class="k">RUN </span><span class="nb">echo</span> <span class="s2">"host all  all    0.0.0.0/0  md5"</span> <span class="o">&gt;&gt;</span> /etc/postgresql/9.3/main/pg_hba.conf

<span class="c"># And add ``listen_addresses`` to ``/etc/postgresql/9.3/main/postgresql.conf``</span>
<span class="k">RUN </span><span class="nb">echo</span> <span class="s2">"listen_addresses='*'"</span> <span class="o">&gt;&gt;</span> /etc/postgresql/9.3/main/postgresql.conf

<span class="c"># Expose the PostgreSQL port</span>
<span class="k">EXPOSE</span><span class="s"> 5432</span>

<span class="c"># Add VOLUMEs to allow backup of config, logs and databases</span>
<span class="k">VOLUME</span><span class="s">  ["/etc/postgresql", "/var/log/postgresql", "/var/lib/postgresql"]</span>

<span class="c"># Set the default command to run when starting the container</span>
<span class="k">CMD</span><span class="s"> ["/usr/lib/postgresql/9.3/bin/postgres", "-D", "/var/lib/postgresql/9.3/main", "-c", "config_file=/etc/postgresql/9.3/main/postgresql.conf"]</span>
</code></pre></div></div>

<p>Dockerfile からイメージをビルドして名前を与えます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker build <span class="nt">-t</span> eg_postgresql <span class="nb">.</span>
</code></pre></div></div>

<p>PostgreSQL サーバーコンテナーを（フォアグラウンドで）実行します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">--rm</span> <span class="nt">-P</span> <span class="nt">--name</span> pg_test eg_postgresql
</code></pre></div></div>

<p>PostgreSQL サーバーへの接続方法は２通りあります。
<a href="/docs.docker.jp.onthefly/network/links/"><strong>リンクコンテナー</strong></a> を使うか、ホスト（あるいはネットワーク）からアクセスします。</p>

<blockquote>
  <p><strong>メモ</strong>: <code class="language-plaintext highlighter-rouge">--rm</code> は、コンテナーが正常終了したときに、コンテナーとそのイメージを削除するものです。</p>
</blockquote>

<h3 id="use-container-linking">コンテナーリンクの利用</h3>

<p>Containers can be linked to another container’s ports directly using
<code class="language-plaintext highlighter-rouge">--link remote_name:local_alias</code> in the client’s
<code class="language-plaintext highlighter-rouge">docker run</code>. This sets a number of environment
variables that can then be used to connect:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">--rm</span> <span class="nt">-t</span> <span class="nt">-i</span> <span class="nt">--link</span> pg_test:pg eg_postgresql bash

postgres@7ef98b1b7243:/<span class="nv">$ </span>psql <span class="nt">-h</span> <span class="nv">$PG_PORT_5432_TCP_ADDR</span> <span class="nt">-p</span> <span class="nv">$PG_PORT_5432_TCP_PORT</span> <span class="nt">-d</span> docker <span class="nt">-U</span> docker <span class="nt">--password</span>
</code></pre></div></div>

<h3 id="connect-from-your-host-system">ホストシステムからの接続</h3>

<p>Assuming you have the postgresql-client installed, you can use the
host-mapped port to test as well. You need to use <code class="language-plaintext highlighter-rouge">docker ps</code>
to find out what local host port the container is mapped to
first:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker ps

CONTAINER ID        IMAGE                  COMMAND                CREATED             STATUS              PORTS                                      NAMES
5e24362f27f6        eg_postgresql:latest   /usr/lib/postgresql/   About an hour ago   Up About an hour    0.0.0.0:49153-&gt;5432/tcp                    pg_test

<span class="nv">$ </span>psql <span class="nt">-h</span> localhost <span class="nt">-p</span> 49153 <span class="nt">-d</span> docker <span class="nt">-U</span> docker <span class="nt">--password</span>
</code></pre></div></div>

<h3 id="test-the-database">データベースの動作確認</h3>

<p>Once you have authenticated and have a <code class="language-plaintext highlighter-rouge">docker =#</code>
prompt, you can create a table and populate it.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">psql</span> <span class="p">(</span><span class="mi">9</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span>
<span class="k">Type</span> <span class="nv">"help"</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span>

<span class="err">$</span> <span class="n">docker</span><span class="o">=#</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">cities</span> <span class="p">(</span>
<span class="n">docker</span><span class="p">(</span><span class="o">#</span>     <span class="n">name</span>            <span class="nb">varchar</span><span class="p">(</span><span class="mi">80</span><span class="p">),</span>
<span class="n">docker</span><span class="p">(</span><span class="o">#</span>     <span class="k">location</span>        <span class="n">point</span>
<span class="n">docker</span><span class="p">(</span><span class="o">#</span> <span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span>
<span class="err">$</span> <span class="n">docker</span><span class="o">=#</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">cities</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'San Francisco'</span><span class="p">,</span> <span class="s1">'(-194.0, 53.0)'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="mi">0</span> <span class="mi">1</span>
<span class="err">$</span> <span class="n">docker</span><span class="o">=#</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">cities</span><span class="p">;</span>
     <span class="n">name</span>      <span class="o">|</span> <span class="k">location</span>
<span class="c1">---------------+-----------</span>
 <span class="n">San</span> <span class="n">Francisco</span> <span class="o">|</span> <span class="p">(</span><span class="o">-</span><span class="mi">194</span><span class="p">,</span><span class="mi">53</span><span class="p">)</span>
<span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="use-the-container-volumes">コンテナーボリュームの利用</h3>

<p>You can use the defined volumes to inspect the PostgreSQL log files and
to backup your configuration and data:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">--rm</span> <span class="nt">--volumes-from</span> pg_test <span class="nt">-t</span> <span class="nt">-i</span> busybox sh

/ <span class="c"># ls</span>
bin      etc      lib      linuxrc  mnt      proc     run      sys      usr
dev      home     lib64    media    opt      root     sbin     tmp      var
/ <span class="c"># ls /etc/postgresql/9.3/main/</span>
environment      pg_hba.conf      postgresql.conf
pg_ctl.conf      pg_ident.conf    start.conf
/tmp <span class="c"># ls /var/log</span>
ldconfig    postgresql
</code></pre></div></div>
