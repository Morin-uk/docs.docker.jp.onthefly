
<h2 id="build-an-eg_sshd-image"><code class="language-plaintext highlighter-rouge">eg_sshd</code> イメージのビルド</h2>

<h3 id="generate-a-secure-root-password-for-your-image">イメージに対するセキュアな root パスワードの生成</h3>

<p>root アクセスにあたって固定的なパスワードを用いるのは危険です。
この先に進むにあたってはランダムなパスワードを生成してください。</p>

<h3 id="build-the-image">イメージのビルド</h3>

<p>以下に示す <code class="language-plaintext highlighter-rouge">Dockerfile</code> はコンテナー内に SSHd サービスを設定します。
これを用いて他のコンテナーのボリュームに接続し内容を確認したり、テストコンテナーにもすぐにアクセスできるようになります。
以下に示す部分は書き換えてください。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">RUN echo 'root:THEPASSWORDYOUCREATED' | chpasswd</code> においては、”THEPASSWORDYOUCREATED” の部分は、事前に生成しておいたパスワードに書き換えてください。</li>
  <li><code class="language-plaintext highlighter-rouge">RUN sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config</code> は、Ubuntu 14.04 においては <code class="language-plaintext highlighter-rouge">prohibit-password</code> ではなく <code class="language-plaintext highlighter-rouge">without-password</code> を指定してください。</li>
</ul>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> ubuntu:20.04</span>

<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> openssh-server
<span class="k">RUN </span><span class="nb">mkdir</span> /var/run/sshd
<span class="k">RUN </span><span class="nb">echo</span> <span class="s1">'root:THEPASSWORDYOUCREATED'</span> | chpasswd
<span class="k">RUN </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/#*PermitRootLogin prohibit-password/PermitRootLogin yes/g'</span> /etc/ssh/sshd_config

<span class="c"># SSH ログインの設定修正。これを行わないとログインした後に処理実行できない。</span>
<span class="k">RUN </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g'</span> /etc/pam.d/sshd

<span class="k">ENV</span><span class="s"> NOTVISIBLE="in users profile"</span>
<span class="k">RUN </span><span class="nb">echo</span> <span class="s2">"export VISIBLE=now"</span> <span class="o">&gt;&gt;</span> /etc/profile

<span class="k">EXPOSE</span><span class="s"> 22</span>
<span class="k">CMD</span><span class="s"> ["/usr/sbin/sshd", "-D"]</span>
</code></pre></div></div>

<p>以下のコマンドによりイメージをビルドします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker build <span class="nt">-t</span> eg_sshd <span class="nb">.</span>
</code></pre></div></div>

<h2 id="run-a-test_sshd-container"><code class="language-plaintext highlighter-rouge">test_sshd</code> コンテナーの実行</h2>

<p>コンテナーを実行します。
<code class="language-plaintext highlighter-rouge">docker port</code> を使うと、コンテナーのポート 22 番がホストの何番ポートに割り当てられているかがわかります。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">-P</span> <span class="nt">--name</span> test_sshd eg_sshd
<span class="nv">$ </span>docker port test_sshd 22

0.0.0.0:49154
</code></pre></div></div>

<p>ここでコンテナーの IP アドレスに向けて <code class="language-plaintext highlighter-rouge">root</code> により SSH ログインします。
（IP アドレスは <code class="language-plaintext highlighter-rouge">docker inspect</code> を実行するとわかります。)
あるいは Docker デーモンのホスト IP アドレスに、ポート <code class="language-plaintext highlighter-rouge">49514</code> で接続します。
（<code class="language-plaintext highlighter-rouge">ip address</code> あるいは <code class="language-plaintext highlighter-rouge">ifconfig</code> により IP アドレスがわかります。）
Docker デーモンホスト上の場合は <code class="language-plaintext highlighter-rouge">localhost</code> に接続します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh root@192.168.1.2 <span class="nt">-p</span> 49154
<span class="c"># または</span>
<span class="nv">$ </span>ssh root@localhost <span class="nt">-p</span> 49154
<span class="c"># The password is ``screencast``.</span>
root@f38c87f2a42d:/#
</code></pre></div></div>

<h2 id="environment-variables">環境変数</h2>

<p><code class="language-plaintext highlighter-rouge">sshd</code> デーモンによりシェル起動するので、ユーザーシェルへの環境変数の受け渡しは複雑になります。Docker の通常のメカニズムにより <code class="language-plaintext highlighter-rouge">sshd</code> サービスがシェルを起動する前に環境変数をクリアしてしまうためです。</p>

<p><code class="language-plaintext highlighter-rouge">Dockerfile</code> 内に <code class="language-plaintext highlighter-rouge">ENV</code> を使って値設定をしている場合は、それを <code class="language-plaintext highlighter-rouge">/etc/profile</code> のようなシェル初期化ファイルに受け渡す必要があります。
その例は上の <code class="language-plaintext highlighter-rouge">Dockerfile</code> に示しています。</p>

<p><code class="language-plaintext highlighter-rouge">docker run -e ENV=value</code> の実行のようにして値を受け渡す場合は、<code class="language-plaintext highlighter-rouge">sshd -D</code> を実行する前に、同じことを行う単純なスクリプトを生成して、<code class="language-plaintext highlighter-rouge">CMD</code> の行をそのスクリプトに置き換えることが必要です。</p>

<h2 id="clean-up">環境クリア</h2>

<p>環境構築のテストが済んだら、コンテナーの停止と削除を行い、イメージを削除します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker container stop test_sshd
<span class="nv">$ </span>docker container <span class="nb">rm </span>test_sshd
<span class="nv">$ </span>docker image <span class="nb">rm </span>eg_sshd
</code></pre></div></div>
