
<p><a href="/docs.docker.jp.onthefly/engine/security/https/">HTTPS による Docker 起動</a> において学んだことは、デフォルトにおいて Docker はインターネット通信ではない Unix ソケットを通じて動作しているということでした。
また Docker クライアントとデーモンとの間で HTTPS を介して安全なやり取りとするためには TLS を有効にしなければならないということでした。
TLS はレジストリエンドポイントが信頼できるものであることを確実にし、レジストリとの間のトラフィックは暗号化してくれます。</p>

<p>本文においては、Docker レジストリサーバーと Docker デーモン（レジストリサーバーに対するクライアント）の間において、通信トラフィックが暗号化され、<strong>証明書ベースのクライアントサーバー認証</strong> を用いて適切に認証されることを示します。</p>

<p>ここではレジストリにおいて、認証局（Certificate Authority; CA）のルート証明書のインストール方法と、クライアント TLS 証明書の設定方法を示します。</p>

<h2 id="understand-the-configuration">設定内容の理解</h2>

<p>カスタム証明書は <code class="language-plaintext highlighter-rouge">/etc/docker/certs.d</code> ディレクトリ配下に新たなディレクトリを生成して、そこに設定ファイルを置きます。
ディレクトリ名はレジストリのホスト名と同一に、たとえば <code class="language-plaintext highlighter-rouge">localhost</code> のようにします。
<code class="language-plaintext highlighter-rouge">*.crt</code> ファイルはすべて、CA ルートとしてこのディレクトリに追加していきます。</p>

<blockquote>
  <p><strong>メモ</strong>:
Docker 1.13 の時点において、Linux 上のルート認証局は、システムが持つデフォルトのものにマージされます。
したがってそこにはホストのルート認証局のセットも含まれます。
これ以前の Docker や Windows Server 向けの Docker Enterprise Edition においては、カスタムルート証明書が設定されていない場合に限って、システムのデフォルト証明書が利用されます。</p>
</blockquote>

<p>1 つでも <code class="language-plaintext highlighter-rouge">&lt;filename&gt;.key/cert</code> のペアがあるということは、そのリポジトリに対するアクセスにはカスタム証明書が必要であることを Docker に伝えるものです。</p>

<blockquote>
  <p><strong>メモ</strong>:
複数の証明書が存在していた場合、その処理はアルファベット順に行われます。
4xx や 5xx のレベルの認証エラーがあると、Docker はその次の証明書を使った処理を試します。</p>
</blockquote>

<p>以下は、複数のカスタム証明書がある場合の設定例です。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    /etc/docker/certs.d/        &lt;-- 証明書のディレクトリ
    └── localhost:5000          &lt;-- ホスト名：ポート
       ├── client.cert          &lt;-- クライアント証明書
       ├── client.key           &lt;-- クライアント鍵
       └── ca.crt               &lt;-- レジストリ証明書に署名した認証局
</code></pre></div></div>

<p>上記は、オペレーティングシステムに特有のものであって、単に一例を示しただけにすぎません。
OS が提供する証明書チェーンを生成するためには、各オペレーティングシステムのドキュメントを参照してください。</p>

<h2 id="create-the-client-certificates">クライアント証明書の生成</h2>

<p>OpenSSL の <code class="language-plaintext highlighter-rouge">genrsa</code> コマンドと <code class="language-plaintext highlighter-rouge">req</code> コマンドを使って、まずは RSA 鍵を生成します。
そしてこの鍵を使って証明書を生成します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openssl genrsa -out client.key 4096
$ openssl req -new -x509 -text -key client.key -out client.cert
</code></pre></div></div>

<blockquote>
  <p><strong>メモ</strong>:
この TLS コマンドが生成するのは Linux 上において動作する証明書です。
macOS における OpenSSL バージョンは、Docker が必要とする種類の証明書のタイプとは互換性がありません。</p>
</blockquote>

<h2 id="troubleshooting-tips">トラブルシューティングのためのヒント</h2>

<p>Docker デーモンは <code class="language-plaintext highlighter-rouge">.crt</code> ファイルを CA 証明書として、<code class="language-plaintext highlighter-rouge">.cert</code> ファイルをクライアント証明書として、それぞれ解釈します。
仮に CA 証明書の拡張子が、本来の正しい <code class="language-plaintext highlighter-rouge">.crt</code> でなく間違って <code class="language-plaintext highlighter-rouge">.cert</code> になってしまっていたら、Docker デーモンは以下のようなエラーメッセージをログ出力します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Missing key KEY_NAME for client certificate CERT_NAME. CA certificates should use the extension .crt.
</code></pre></div></div>

<p>Docker レジストリをポート番号なしにアクセスするなら、ディレクトリ名にポート番号をつけないでください。
以下に示す設定は、デフォルトのポート 443 を使ってレジストリにアクセスできるようにするものです。
実際のアクセスは <code class="language-plaintext highlighter-rouge">docker login my-https.registry.example.com</code> のように行います。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    /etc/docker/certs.d/
    └── my-https.registry.example.com          &lt;-- ポートなしのホスト名
       ├── client.cert
       ├── client.key
       └── ca.crt
</code></pre></div></div>

<h2 id="related-information">関連情報</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/engine/security/trust/">信頼できるイメージの利用</a></li>
  <li><a href="/docs.docker.jp.onthefly/engine/security/https/">Docker デーモンソケットの保護</a></li>
</ul>
