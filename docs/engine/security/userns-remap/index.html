
<p>Linux の名前空間は、プロセスによるシステムリソースへのアクセスを制限しながら、プロセスを分離して実行します。
実行されたプロセスにとっては、アクセスが制限されていることはわかりません。
Linux の名前空間に関する詳細は <a href="https://www.linux.com/news/understanding-and-securing-linux-namespaces" target="_blank" rel="noopener" class="_">Linux 名前空間</a> を参照してください。</p>

<p>コンテナー内部からの権限昇格による攻撃を防ぐ最大の方法は、コンテナーのアプリケーションを非特権ユーザーで実行することです。
コンテナー内において、プロセスを <code class="language-plaintext highlighter-rouge">root</code> ユーザーで実行しなければならない場合は、この <code class="language-plaintext highlighter-rouge">root</code> ユーザーを、Docker ホスト上のより権限の少ないユーザーに再割り当て（re-map）します。
名前空間内では通常 0 から 65536 という範囲の UID が正しく機能しますが、割り当て対象のユーザーには、この範囲内で UID を定めます。
ただしこの UID はホストマシン上では何の権限もないものです。</p>

<h2 id="about-remapping-and-subordinate-user-and-group-ids">ユーザー ID、グループ ID の再割り当てとサブ ID</h2>

<p>再割り当て自体は 2 つのファイル、<code class="language-plaintext highlighter-rouge">/etc/subuid</code> と <code class="language-plaintext highlighter-rouge">/etc/subgid</code> によって扱われます。
2 つのファイルとも同様の動作をしますが、一方はユーザー ID 範囲に関して、他方はグループ ID 範囲に関して取り扱うものです。
<code class="language-plaintext highlighter-rouge">/etc/subuid</code> 内に以下のエントリーがあるとします。</p>

<pre><code class="language-none">testuser:231072:65536
</code></pre>

<p>上の意味は、<code class="language-plaintext highlighter-rouge">testuser</code> のサブ ID を <code class="language-plaintext highlighter-rouge">231072</code> から 65536 個分の連続した整数範囲で割り当てるものです。
UID <code class="language-plaintext highlighter-rouge">231072</code> は、名前空間内（ここではコンテナー内）においては UID <code class="language-plaintext highlighter-rouge">0</code>（<code class="language-plaintext highlighter-rouge">root</code>）に割り当てられています。
同じく UID <code class="language-plaintext highlighter-rouge">231073</code> は UID <code class="language-plaintext highlighter-rouge">1</code> へ割り当てられています。
以下同様です。
名前空間の外部から権限昇格を試みるようなプロセスがあったとします。
ホスト上では権限を持たない大きな数値の UID によってプロセスが起動しており、その UID は現実のユーザーには割り当てられていません。
つまりそのプロセスは、ホストシステム上での権限をまったく持たないということです。</p>

<blockquote>
  <p>複数の範囲指定</p>

  <p>1 つのユーザーまたはグループに対して、サブ ID の範囲を複数割り当てることができます。
これを行うには <code class="language-plaintext highlighter-rouge">/etc/subuid</code> または <code class="language-plaintext highlighter-rouge">/etc/subgid</code> において 1 つのユーザーあるいはグループに対して、互いに重複しない範囲指定を複数行います。
これを行った場合、Docker は複数の範囲指定の中から、はじめの 5 つ分のみを利用します。
カーネルが <code class="language-plaintext highlighter-rouge">/proc/self/uid_map</code> や <code class="language-plaintext highlighter-rouge">/proc/self/gid_map</code> において、5 つ分のエントリーしか取り扱わないという制約に従ったものです。</p>
</blockquote>

<p>Docker において <code class="language-plaintext highlighter-rouge">userns-remap</code> 機能を利用する際には、必要に応じて既存のユーザーやグループを指定することができます。
あるいは <code class="language-plaintext highlighter-rouge">default</code> を指定することもできます。
<code class="language-plaintext highlighter-rouge">default</code> を指定した場合、<code class="language-plaintext highlighter-rouge">dockremap</code> というユーザーおよびグループが生成され、この機能のために利用されます。</p>

<blockquote class="warning-vanila">
  <p><strong>警告</strong>: RHEL や CentOS 7.3 などのディストリビューションにおいて、 <code class="language-plaintext highlighter-rouge">/etc/subuid</code> と <code class="language-plaintext highlighter-rouge">/etc/subgid</code> に対して新たなグループの追加を自動では行わないものがあります。
その場合はこれらのファイルを編集する必要があり、他とは重複しないような範囲指定を行う必要があります。
このことは <a href="#prerequisites">前提条件</a> において触れています。</p>
</blockquote>

<p>範囲指定は重複していないことがとても重要です。
そうなっていないと、プロセスが別の名前空間内でのアクセスを実現できません。
Linux ディストリビューションの多くでは、ユーザーの追加、削除を行う際の ID 範囲指定を制御するシステムユーティリティーを提供しています。</p>

<p>この再割り当ての機能は、コンテナーにおいてはわかりやすいものです。
ただし設定を行う上では複雑な状況がありえます。
たとえば Docker ホスト上のリソースにコンテナーがアクセスする必要がある場合です。
具体的にバインドマウントでは、システムユーザーが書き込み不能なファイルシステムの領域にマウントを行います。
セキュリティの観点からは、こういった状況は避けることが一番です。</p>

<h2 id="prerequisites">前提条件</h2>

<ol>
  <li>
    <p>サブ UID とサブ GID の設定範囲は、既存ユーザーに対して関連づいていなければなりません。
ただし関連づけは、実装上の都合によるものです。
ユーザーは <code class="language-plaintext highlighter-rouge">/var/lib/docker/</code> 配下に、名前空間により分けられた保存ディレクトリを所有します。
既存ユーザーを利用したくない場合は、Docker がかわりにユーザーを生成して利用してくれます。
逆に既存ユーザーの名前または ID を利用したい場合は、あらかじめ存在していなければなりません。
通常は <code class="language-plaintext highlighter-rouge">/etc/passwd</code> や <code class="language-plaintext highlighter-rouge">/etc/group</code> 内に、対応するエントリーが存在していなければなりませんが、別の認証システムをバックエンドに利用している場合は、そのファイルのエントリーは、別の形で取り扱われることになります。</p>

    <p>上のことを確認するために <code class="language-plaintext highlighter-rouge">id</code> コマンドを実行します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">id </span>testuser

<span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>testuser<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>testuser<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>testuser<span class="o">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>名前空間の再割り当てがホスト上において処理される際には、2 つのファイルが利用されます。
<code class="language-plaintext highlighter-rouge">/etc/subuid</code> と <code class="language-plaintext highlighter-rouge">/etc/subgid</code> です。
このファイルは通常は、ユーザーやグループの追加、削除の際に、自動的に生成管理されます。
ただし RHEL や CentOS 7.3 のような一部のディストリビューションでは、このファイルの手動での管理を必要とするものがあります。</p>

    <p>この 2 つのファイルでは 3 つの項目が記述されます。
ユーザー名あるいはユーザー ID、続いて UID または GID の開始値（名前空間内では UID または GID がゼロとして扱われるもの）、最後にそのユーザーにおいて利用可能な UID または GID の最大数です。
たとえば以下のようなエントリーがあったとします。</p>

    <pre><code class="language-none">testuser:231072:65536
</code></pre>

    <p>上が意味することは以下のとおりです。
<code class="language-plaintext highlighter-rouge">testuser</code> によって起動されたユーザー名前空間のプロセスは、ホスト上の <code class="language-plaintext highlighter-rouge">231072</code>（名前空間内では UID <code class="language-plaintext highlighter-rouge">0</code> として見えるもの）から <code class="language-plaintext highlighter-rouge">296607</code> (231072 + 65536 - 1) までの間の UID によって所有されます。
この範囲は他と重複してはなりません。
これを確実に行うことで、名前空間内のプロセスが別の名前空間へアクセスできないようにします。</p>

    <p>ユーザーを追加したら <code class="language-plaintext highlighter-rouge">/etc/subuid</code> と <code class="language-plaintext highlighter-rouge">/etc/subgid</code> のそれぞれにおいて、追加したユーザーを表わすエントリーが含まれていることを確認してください。
もしエントリーが存在しなければ、追加してください。
ID の重複には十分に注意してください。</p>

    <p>Docker によって自動的に生成される <code class="language-plaintext highlighter-rouge">dockremap</code> ユーザーを利用したい場合は、<code class="language-plaintext highlighter-rouge">dockremap</code> のエントリーがそのファイル内にあるかどうかを確認しますが、それは設定を行って Docker を再起動した <strong>後に</strong> 行ってください。</p>
  </li>
  <li>
    <p>Docker ホスト上に、非特権ユーザーが書き込みを必要とするディレクトリがあるとします。
その場合はそのディレクトリのパーミッションを適切に調整してください。
これは Docker によって自動生成された <code class="language-plaintext highlighter-rouge">dockremap</code> ユーザーを利用する場合も同様ですが、このときにはパーミッション変更後に Docker を再起動しない限り、その設定変更は反映されません。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">userns-remap</code> を有効にすることで、既存イメージやコンテナーのレイヤーは効果的に保護されます。
これは <code class="language-plaintext highlighter-rouge">/var/lib/docker/</code> 内にある Docker オブジェクトすべてについて言えることです。
そもそも Docker ではそういったリソース類の所有者を調整する必要があり、そうして <code class="language-plaintext highlighter-rouge">/var/lib/docker/</code> 内のサブディレクトリに情報を保存するからです。
新たな Docker インストールの際に、この機能を有効にして利用していくことがベストです。</p>

    <p>同じような話として、<code class="language-plaintext highlighter-rouge">userns-remap</code> を無効化すると、有効化していたときに生成したリソースへは、いっさいアクセスできなくなります。</p>
  </li>
  <li>
    <p>ユーザー名前空間に関する <a href="#user-namespace-known-limitations">制約</a> を確認し、利用することが可能かどうかを判断してください。</p>
  </li>
</ol>

<h2 id="enable-userns-remap-on-the-daemon">デーモン上での userns-remap の有効化</h2>

<p><code class="language-plaintext highlighter-rouge">dockerd</code> の実行時には <code class="language-plaintext highlighter-rouge">--userns-remap</code> フラグを利用することができます。
または以降の手順に示すように、設定ファイル <code class="language-plaintext highlighter-rouge">daemon.json</code> を使ってデーモンを設定することができます。
<code class="language-plaintext highlighter-rouge">daemon.json</code> ファイルを用いる方法が推奨されます。
フラグを利用する方法をとる場合、コマンドのひな形は以下のようになります。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dockerd <span class="nt">--userns-remap</span><span class="o">=</span><span class="s2">"testuser:testuser"</span>
</code></pre></div></div>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/etc/docker/daemon.json</code> を編集します。
ファイルはまったくの空であったとします。
以下に示す項目は、<code class="language-plaintext highlighter-rouge">testuser</code> というユーザーおよびグループを使って <code class="language-plaintext highlighter-rouge">userns-remap</code> を有効にするものです。
ユーザーやグループは、ID と名前のいずれでも指定が可能です。
グループ名やグループ ID は、それがユーザー名またはユーザー ID とは異なる場合のみ、指定することが必要です。
ユーザーとグループの名前あるいは ID をともに指定する場合は、両者をコロン（<code class="language-plaintext highlighter-rouge">:</code>）で区切ります。
以下の書式は、すべて有効な指定です。
ここで <code class="language-plaintext highlighter-rouge">testuser</code> の UID および GID は <code class="language-plaintext highlighter-rouge">1001</code> であるものとします。</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">testuser</code></li>
      <li><code class="language-plaintext highlighter-rouge">testuser:testuser</code></li>
      <li><code class="language-plaintext highlighter-rouge">1001</code></li>
      <li><code class="language-plaintext highlighter-rouge">1001:1001</code></li>
      <li><code class="language-plaintext highlighter-rouge">testuser:1001</code></li>
      <li><code class="language-plaintext highlighter-rouge">1001:testuser</code></li>
    </ul>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"userns-remap"</span><span class="p">:</span><span class="w"> </span><span class="s2">"testuser"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>

    <blockquote>
      <p><strong>メモ</strong>: <code class="language-plaintext highlighter-rouge">dockremap</code> ユーザーは Docker が生成します。
<code class="language-plaintext highlighter-rouge">dockremap</code> ユーザーを利用する場合は、設定値に <code class="language-plaintext highlighter-rouge">testuser</code> ではなく <code class="language-plaintext highlighter-rouge">default</code> を指定してください。</p>
    </blockquote>

    <p>ファイルを保存して Docker を再起動します。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">dockremap</code> ユーザーを利用する場合は、<code class="language-plaintext highlighter-rouge">id</code> コマンドを実行して Docker がそのユーザーを生成していることを確認します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">id </span>dockremap

<span class="nv">uid</span><span class="o">=</span>112<span class="o">(</span>dockremap<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>116<span class="o">(</span>dockremap<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>116<span class="o">(</span>dockremap<span class="o">)</span>
</code></pre></div>    </div>

    <p><code class="language-plaintext highlighter-rouge">/etc/subuid</code> と <code class="language-plaintext highlighter-rouge">/etc/subgid</code> に対してエントリーが追加されていることを確認します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">grep </span>dockremap /etc/subuid

dockremap:231072:65536

<span class="nv">$ </span><span class="nb">grep </span>dockremap /etc/subgid

dockremap:231072:65536
</code></pre></div>    </div>

    <p>上のようなエントリーが存在しない場合は、<code class="language-plaintext highlighter-rouge">root</code> ユーザーになってこのファイルを編集します。
そして UID または GID の開始値として、すでに割り当てられている最大値を割り当て、これに加えてオフセット値（ここでは <code class="language-plaintext highlighter-rouge">65536</code>）を指定します。
複数の範囲指定のそれぞれにて ID の重複がないようにします。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">docker image ls</code> コマンドを実行し、以前利用していたイメージがないことを確認します。
出力には何も表示されないはずです。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">hello-world</code> イメージを使ってコンテナーを起動します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run hello-world
</code></pre></div>    </div>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/var/lib/docker/</code> 配下に名前空間によるディレクトリがあることを確認します。
ディレクトリ名には、名前空間におけるユーザーの UID と GID が用いられています。
その所有は UID および GID であり、グループやワールドは読み込み権限がありません。
サブディレクトリの中には <code class="language-plaintext highlighter-rouge">root</code> が所有しているものがあり、パーミッションも別のものになっています。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo ls</span> <span class="nt">-ld</span> /var/lib/docker/231072.231072/

drwx------ 11 231072 231072 11 Jun 21 21:19 /var/lib/docker/231072.231072/

<span class="nv">$ </span><span class="nb">sudo ls</span> <span class="nt">-l</span> /var/lib/docker/231072.231072/

total 14
drwx------ 5 231072 231072 5 Jun 21 21:19 aufs
drwx------ 3 231072 231072 3 Jun 21 21:21 containers
drwx------ 3 root   root   3 Jun 21 21:19 image
drwxr-x--- 3 root   root   3 Jun 21 21:19 network
drwx------ 4 root   root   4 Jun 21 21:19 plugins
drwx------ 2 root   root   2 Jun 21 21:19 swarm
drwx------ 2 231072 231072 2 Jun 21 21:21 tmp
drwx------ 2 root   root   2 Jun 21 21:19 trust
drwx------ 2 231072 231072 3 Jun 21 21:19 volumes
</code></pre></div>    </div>

    <p>特にコンテナーのストレージドライバーとして <code class="language-plaintext highlighter-rouge">aufs</code> 以外のものを利用している場合に、ディレクトリの一覧は、上とは異なる場合があります。</p>

    <p>再割り当てによるユーザーが所有するディレクトリは、<code class="language-plaintext highlighter-rouge">/var/lib/docker/</code> 直下にある同名ディレクトリとは切り離されて利用されます。
同名ディレクトリの使用しなくなった方（この例においては <code class="language-plaintext highlighter-rouge">/var/lib/docker/tmp/</code> など）は削除してかまいません。
Docker は <code class="language-plaintext highlighter-rouge">userns-remap</code> が有効になっている間は、それを利用しません。</p>
  </li>
</ol>

<h2 id="disable-namespace-remapping-for-a-container">コンテナーの名前空間再割り当ての無効化</h2>

<p>デーモンにおいてユーザー名前空間を有効にした場合に、コンテナーを起動すると、どのコンテナーにおいてもデフォルトでユーザー名前空間が有効になります。
特定の権限により実行されているコンテナーのような場合には、そのコンテナーに対してユーザー名前空間を明示的に無効にすることが必要になります。
そういった制約に関しては <a href="#user-namespace-known-limitations">ユーザー名前空間における既知の制約</a> を参照してください。</p>

<p>特定のコンテナーに対してユーザー名前空間を無効とするには、<code class="language-plaintext highlighter-rouge">docker container create</code>、<code class="language-plaintext highlighter-rouge">docker container run</code>、<code class="language-plaintext highlighter-rouge">docker container exec</code> の各コマンド実行の際に <code class="language-plaintext highlighter-rouge">--userns=host</code> フラグを追加します。</p>

<p>このフラグを利用した場合には副作用があります。
ユーザーの再割り当てはそのコンテナーにおいて有効になりませんが、読み込み専用の（イメージ）レイヤーはコンテナー間で共有されるため、コンテナーのファイルシステムの所有者は、再割り当てされたままです。</p>

<p>これは以下を意味します。
コンテナーのファイルシステムはすべて、デーモンフラグ <code class="language-plaintext highlighter-rouge">--userns-remap</code> において指定されたユーザー（上の例では <code class="language-plaintext highlighter-rouge">231072</code>）に属します。
このことから、コンテナー内のプログラムが予期しない動作となることがあります。
たとえば <code class="language-plaintext highlighter-rouge">sudo</code>（実行するバイナリがユーザー <code class="language-plaintext highlighter-rouge">0</code> に属するかどうかを確認する）や <code class="language-plaintext highlighter-rouge">setuid</code> フラグがついている実行バイナリの場合です。</p>

<h2 id="user-namespace-known-limitations">ユーザー名前空間における既知の制約</h2>

<p>以下に示す標準的な Docker の機能は、ユーザー名前空間を有効にして Docker デーモンを起動した際には、動作が変わります。</p>

<ul>
  <li>ホストの指定（<code class="language-plaintext highlighter-rouge">--pid=host</code> or <code class="language-plaintext highlighter-rouge">--network=host</code>）を行った PID 名前空間や NET 名前空間の共有。</li>
  <li>デーモンのユーザー名前空間利用について、その利用がわからない、あるいは処理できない外部の（ボリュームまたはストレージ）ドライバー。</li>
  <li><code class="language-plaintext highlighter-rouge">docker run</code> の実行において <code class="language-plaintext highlighter-rouge">--userns=host</code> がなく <code class="language-plaintext highlighter-rouge">--privileged</code> モードフラグを指定した場合。</li>
</ul>

<p>ユーザー名前空間は応用的な機能であって、他のケーパビリティーと連携が必要になります。
たとえばホストからボリュームをマウントするときには、あらかじめファイルの所有権を整備しておく必要があり、ボリューム内への読み書きの権限を与えておく必要があります。</p>

<p>ユーザー名前空間を利用したコンテナーのプロセス内において root ユーザーは、コンテナー内のスーパーユーザーとして期待される数多くの権限を持ちます。
しかし Linux カーネルは、そこがユーザー名前空間内のプロセスであることを知っていて、それに基づいた機能制約を課します。
明らかな制約の例が、<code class="language-plaintext highlighter-rouge">mknod</code> コマンドを使えなくすることです。
<code class="language-plaintext highlighter-rouge">root</code> ユーザーによって実行されているコンテナー内においては、デバイスの生成は拒否されます。</p>
