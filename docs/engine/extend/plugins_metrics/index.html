<!-- This file is maintained within the docker/cli GitHub
     repository at https://github.com/docker/cli/. Make all
     pull requests against that repo. If you see this file in
     another repository, consider it read-only there, as it will
     periodically be overwritten by the definitive file. Pull
     requests which include edits to this file in other repositories
     will be rejected.
-->

<h1 id="docker-metrics-collector-plugins">Docker metrics collector plugins</h1>

<p>Docker exposes internal metrics based on the prometheus format. Metrics plugins
enable accessing these metrics in a consistent way by providing a Unix
socket at a predefined path where the plugin can scrape the metrics.</p>

<blockquote>
  <p><strong>Note</strong>: that while the plugin interface for metrics is non-experimental, the naming
of the metrics and metric labels is still considered experimental and may change
in a future version.</p>
</blockquote>

<h2 id="creating-a-metrics-plugin">Creating a metrics plugin</h2>

<p>You must currently set <code class="language-plaintext highlighter-rouge">PropagatedMount</code> in the plugin <code class="language-plaintext highlighter-rouge">config.json</code> to
<code class="language-plaintext highlighter-rouge">/run/docker</code>. This allows the plugin to receive updated mounts
(the bind-mounted socket) from Docker after the plugin is already configured.</p>

<h2 id="metricscollector-protocol">MetricsCollector protocol</h2>

<p>Metrics plugins must register as implementing the<code class="language-plaintext highlighter-rouge">MetricsCollector</code> interface
in <code class="language-plaintext highlighter-rouge">config.json</code>.</p>

<p>On Unix platforms, the socket is located at <code class="language-plaintext highlighter-rouge">/run/docker/metrics.sock</code> in the
pluginâ€™s rootfs.</p>

<p><code class="language-plaintext highlighter-rouge">MetricsCollector</code> must implement two endpoints:</p>

<h3 id="metricscollectorstartmetrics"><code class="language-plaintext highlighter-rouge">MetricsCollector.StartMetrics</code></h3>

<p>Signals to the plugin that the metrics socket is now available for scraping</p>

<p><strong>Request</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{}</span><span class="w">
</span></code></pre></div></div>

<p>The request has no playload.</p>

<p><strong>Response</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="nl">"Err"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>If an error occurred during this request, add an error message to the <code class="language-plaintext highlighter-rouge">Err</code> field
in the response. If no error then you can either send an empty response (<code class="language-plaintext highlighter-rouge">{}</code>)
or an empty value for the <code class="language-plaintext highlighter-rouge">Err</code> field. Errors will only be logged.</p>

<h3 id="metricscollectorstopmetrics"><code class="language-plaintext highlighter-rouge">MetricsCollector.StopMetrics</code></h3>

<p>Signals to the plugin that the metrics socket is no longer available.
This may happen when the daemon is shutting down.</p>

<p><strong>Request</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{}</span><span class="w">
</span></code></pre></div></div>

<p>The request has no playload.</p>

<p><strong>Response</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="nl">"Err"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>If an error occurred during this request, add an error message to the <code class="language-plaintext highlighter-rouge">Err</code> field
in the response. If no error then you can either send an empty response (<code class="language-plaintext highlighter-rouge">{}</code>)
or an empty value for the <code class="language-plaintext highlighter-rouge">Err</code> field. Errors will only be logged.</p>
