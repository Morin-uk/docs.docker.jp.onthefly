<!-- This file is maintained within the docker/cli GitHub
     repository at https://github.com/docker/cli/. Make all
     pull requests against that repo. If you see this file in
     another repository, consider it read-only there, as it will
     periodically be overwritten by the definitive file. Pull
     requests which include edits to this file in other repositories
     will be rejected.
-->

<h1 id="docker-volume-plugins">Docker ボリュームプラグイン</h1>

<p>Docker Engine ボリュームプラグインは、Amazon EBS のような外部ストレージシステムと統合した Engine デプロイメントを可能にするものです。
そして単独の Docker ホスト上では維持できない、データボリュームの長期保存を可能にします。
詳細は <a href="/docs.docker.jp.onthefly/engine/extend/legacy_plugins/">プラグインのドキュメント</a> を参照してください。</p>

<h2 id="changelog">変更履歴</h2>

<h3 id="1130">1.13.0</h3>

<ul>
  <li>プラグインアーキテクチャー v2 を部分的に用いている場合、プラグインにより返されるパスで構成される mountpoints は、プラグイン設定内の <code class="language-plaintext highlighter-rouge">PropagatedMount</code> によって指定されるディレクトリ配下にマウントされるべき。
(<a href="https://github.com/docker/docker/pull/26398">#26398</a>)</li>
</ul>

<h3 id="1120">1.12.0</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">VolumeDriver.Get</code> レスポンスに <code class="language-plaintext highlighter-rouge">Status</code> フィールドを追加。
(<a href="https://github.com/docker/docker/pull/21006#">#21006</a>)</li>
  <li><code class="language-plaintext highlighter-rouge">VolumeDriver.Capabilities</code> の追加。ボリュームドライバーのケーパビリティ（capability）を取得する。
(<a href="https://github.com/docker/docker/pull/22077">#22077</a>)</li>
</ul>

<h3 id="1100">1.10.0</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">VolumeDriver.Get</code> の追加。 ボリュームの詳細情報を取得する。
(<a href="https://github.com/docker/docker/pull/16534">#16534</a>)</li>
  <li><code class="language-plaintext highlighter-rouge">VolumeDriver.List</code> の追加。 ドライバーが所有する全ボリューム一覧を取得する。
(<a href="https://github.com/docker/docker/pull/16534">#16534</a>)</li>
</ul>

<h3 id="180">1.8.0</h3>

<ul>
  <li>ボリュームドライバープラグインに対する初めてのサポート。
(<a href="https://github.com/docker/docker/pull/14659">#14659</a>)</li>
</ul>

<h2 id="command-line-changes">コマンドラインによる変更</h2>

<p>コンテナーからボリュームへアクセスするためには、<code class="language-plaintext highlighter-rouge">docker container run</code> コマンドの <code class="language-plaintext highlighter-rouge">--volume</code> フラグや <code class="language-plaintext highlighter-rouge">--volume-driver</code> フラグを用います。
<code class="language-plaintext highlighter-rouge">--volume</code> （または <code class="language-plaintext highlighter-rouge">-v</code>）フラグは、ボリューム名とホスト上のパスを指定します。
また <code class="language-plaintext highlighter-rouge">--volume-driver</code> フラグはドライバータイプを指定します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker volume create <span class="nt">--driver</span><span class="o">=</span>flocker volumename

<span class="nv">$ </span>docker container run <span class="nt">-it</span> <span class="nt">--volume</span> volumename:/data busybox sh
</code></pre></div></div>

<h3 id="--volume"><code class="language-plaintext highlighter-rouge">--volume</code></h3>

<p><code class="language-plaintext highlighter-rouge">--volume</code> （または <code class="language-plaintext highlighter-rouge">-v</code>）フラグは <code class="language-plaintext highlighter-rouge">&lt;volume_name&gt;:&lt;mountpoint&gt;</code> という書式の値をとります。
この値の 2 つの部分はコロン（<code class="language-plaintext highlighter-rouge">:</code>）によって区切ります。</p>

<ul>
  <li>ボリューム名は、人間が読み取れる文字を使って、ボリュームにつけた名前のことです。
<code class="language-plaintext highlighter-rouge">/</code> で始めることはできません。
これ以降では <code class="language-plaintext highlighter-rouge">volume_name</code> と呼び表わすことにします。</li>
  <li><code class="language-plaintext highlighter-rouge">Mountpoint</code> は、ホスト上のパス（v1 の場合）、またはプラグイン内のパス（v2 の場合）のいずれかであり、ボリュームが生成されている場所を示します。</li>
</ul>

<h3 id="volumedriver"><code class="language-plaintext highlighter-rouge">volumedriver</code></h3>

<p><code class="language-plaintext highlighter-rouge">volumename</code> とともに <code class="language-plaintext highlighter-rouge">volumedriver</code> を指定すると、<a href="https://github.com/ScatterHQ/flocker">Flocker</a> のようなプラグインが利用できるようになります。
これにより自ホストから、EBS 上などの外部にあるボリュームを管理できるようになります。</p>

<h2 id="create-a-volumedriver">VolumeDriver の生成</h2>

<p>コンテナーの生成エンドポイント（<code class="language-plaintext highlighter-rouge">/containers/create</code>）は、<code class="language-plaintext highlighter-rouge">string</code> 型の <code class="language-plaintext highlighter-rouge">VolumeDriver</code> を受け付け、ドライバー名を指定することができます。
指定されていない場合は、デフォルトの <code class="language-plaintext highlighter-rouge">"local"</code> になります。
（デフォルトドライバーはローカルボリューム向けのものです。）</p>

<h2 id="volume-plugin-protocol">ボリュームプラグインプロトコル</h2>

<p>プラグインが有効化される際に <code class="language-plaintext highlighter-rouge">VolumeDriver</code> として自分自身を登録するのであれば、このプラグインは Docker デーモンに対して、ホストファイルシステム上の書き込み可能なパスを提供しなければなりません。
Docker デーモンはそのパスをコンテナーに提供して利用させます。
Docker デーモンはボリュームを利用できるようにするために、そのパスをバインドマウントしてコンテナーに提供しています。</p>

<blockquote>
  <p><strong>メモ</strong>: ボリュームプラグインは、<code class="language-plaintext highlighter-rouge">/var/lib/docker/</code> ディレクトリや <code class="language-plaintext highlighter-rouge">/var/lib/docker/volumes</code> にデータ書き込みを行っては<strong>いけません</strong>。
<code class="language-plaintext highlighter-rouge">/var/lib/docker/</code> ディレクトリは Docker により予約されています。</p>
</blockquote>

<h3 id="volumedrivercreate"><code class="language-plaintext highlighter-rouge">/VolumeDriver.Create</code></h3>

<p><strong>リクエスト</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"volume_name"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Opts"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>プラグインに対して、指定するボリューム名によりユーザーがボリュームを生成したいということを伝えます。
プラグインはこのとき、ファイルシステム上のボリュームを明らかにすることは、（<code class="language-plaintext highlighter-rouge">Mount</code> が呼び出されるまでは）まだ必要ではありません。
<code class="language-plaintext highlighter-rouge">Opts</code> は、ユーザーリクエストを通じて受け渡されるドライバー固有オプションのマッピングです。</p>

<p><strong>レスポンス</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Err"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>エラーが発生した場合は、文字列によるエラーを返します。</p>

<h3 id="volumedriverremove"><code class="language-plaintext highlighter-rouge">/VolumeDriver.Remove</code></h3>

<p><strong>リクエスト</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"volume_name"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>指定されたボリュームをディスク上から削除します。
このリクエストは  <code class="language-plaintext highlighter-rouge">docker rm -v</code> により、関連づいたコンテナーからボリュームを削除する際に実行されます。</p>

<p><strong>レスポンス</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Err"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>エラーが発生した場合は、文字列によるエラーを返します。</p>

<h3 id="volumedrivermount"><code class="language-plaintext highlighter-rouge">/VolumeDriver.Mount</code></h3>

<p><strong>リクエスト</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"volume_name"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ID"</span><span class="p">:</span><span class="w"> </span><span class="s2">"b87d7442095999a92b65b3d9691e697b61713829cc0ffd1bb72e4ccd51aa4d6c"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Docker は、ユーザーが指定するボリューム名によるボリュームを提供するものとして、このプラグインを必要とします。
<code class="language-plaintext highlighter-rouge">Mount</code> はコンテナーが起動するたびに 1 回だけ呼び出されます。
<code class="language-plaintext highlighter-rouge">volume_name</code> が重複して要求された場合、プラグインは各マウント要求を記録しておく必要があります。
そしてマウントが要求されたときにマウント処理を行い、これに対応するアンマウントの要求のときにマウント解除を行うことになります。</p>

<p><code class="language-plaintext highlighter-rouge">ID</code> は、マウントを要求する呼び出し側の固有 ID です。</p>

<p><strong>レスポンス</strong></p>

<ul>
  <li>
    <p><strong>v1</strong></p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Mountpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/path/to/directory/on/host"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Err"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p><strong>v2</strong></p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Mountpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/path/under/PropagatedMount"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Err"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ul>

<p><code class="language-plaintext highlighter-rouge">Mountpoint</code> は、ホスト上のパス（v1 の場合）、またはプラグイン内のパス（v2 の場合）のいずれかであり、ボリュームが生成されている場所を示します。</p>

<p><code class="language-plaintext highlighter-rouge">Err</code> は空か、あるいはエラー文字列を含みます。</p>

<h3 id="volumedriverpath"><code class="language-plaintext highlighter-rouge">/VolumeDriver.Path</code></h3>

<p><strong>リクエスト</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"volume_name"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>指定された <code class="language-plaintext highlighter-rouge">volume_name</code> のボリュームに対してパスを要求します。</p>

<p><strong>レスポンス</strong></p>

<ul>
  <li>
    <p><strong>v1</strong></p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Mountpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/path/to/directory/on/host"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Err"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p><strong>v2</strong></p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Mountpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/path/under/PropagatedMount"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Err"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ul>

<p>ホスト上のパス（v1 の場合）、またはプラグイン内のパス（v2 の場合）のいずれか、ボリュームが生成されている場所を返します。
エラーが発生した場合は、文字列によるエラーを返します。</p>

<p><code class="language-plaintext highlighter-rouge">Mountpoint</code> は常に必要なものではありません。
ただしプラグインが利用できない状態になったときに、もう一度検索のために利用できます。</p>

<h3 id="volumedriverunmount"><code class="language-plaintext highlighter-rouge">/VolumeDriver.Unmount</code></h3>

<p><strong>リクエスト</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"volume_name"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ID"</span><span class="p">:</span><span class="w"> </span><span class="s2">"b87d7442095999a92b65b3d9691e697b61713829cc0ffd1bb72e4ccd51aa4d6c"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Docker は名前つきボリュームを利用していません。
<code class="language-plaintext highlighter-rouge">Unmount</code> はコンテナーが停止するたびに 1 回だけ呼び出されます。
プラグインは、この時点でボリュームを削除しておくのが安全かもしれません。</p>

<p><code class="language-plaintext highlighter-rouge">ID</code> は、アンマウントを要求する呼び出し側の固有 ID です。</p>

<p><strong>レスポンス</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Err"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>エラーが発生した場合は、文字列によるエラーを返します。</p>

<h3 id="volumedriverget"><code class="language-plaintext highlighter-rouge">/VolumeDriver.Get</code></h3>

<p><strong>リクエスト</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"volume_name"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">volume_name</code> に関する情報を取得します。</p>

<p><strong>レスポンス</strong></p>

<ul>
  <li>
    <p><strong>v1</strong></p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Volume"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"volume_name"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Mountpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/path/to/directory/on/host"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Status"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"Err"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p><strong>v2</strong></p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Volume"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"volume_name"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Mountpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/path/under/PropagatedMount"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Status"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"Err"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ul>

<p>エラーが発生した場合は、文字列によるエラーを返します。
<code class="language-plaintext highlighter-rouge">Mountpoint</code> と <code class="language-plaintext highlighter-rouge">Status</code> は常に必要なものではありません。</p>

<h3 id="volumedriverlist"><code class="language-plaintext highlighter-rouge">/VolumeDriver.List</code></h3>

<p><strong>リクエスト</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{}</span><span class="w">
</span></code></pre></div></div>

<p>プラグインに登録されているボリュームの一覧を取得します。</p>

<p><strong>レスポンス</strong></p>

<ul>
  <li>
    <p><strong>v1</strong></p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Volumes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"volume_name"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Mountpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/path/to/directory/on/host"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"Err"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p><strong>v2</strong></p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Volumes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"volume_name"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Mountpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/path/under/PropagatedMount"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"Err"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ul>

<p>エラーが発生した場合は、文字列によるエラーを返します。
<code class="language-plaintext highlighter-rouge">Mountpoint</code> は常に必要なものではありません。</p>

<h3 id="volumedrivercapabilities"><code class="language-plaintext highlighter-rouge">/VolumeDriver.Capabilities</code></h3>

<p><strong>リクエスト</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{}</span><span class="w">
</span></code></pre></div></div>

<p>ドライバーがサポートするケーパビリティ（capability）の一覧を取得します。</p>

<p>ドライバーは必ず <code class="language-plaintext highlighter-rouge">Capalibities</code> を実装しなければならないわけではありません。
実装されていなければデフォルトの値が用いられます。</p>

<p><strong>レスポンス</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Capabilities"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"Scope"</span><span class="p">:</span><span class="w"> </span><span class="s2">"global"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>サポートされているスコープは <code class="language-plaintext highlighter-rouge">global</code> と <code class="language-plaintext highlighter-rouge">local</code> です。
<code class="language-plaintext highlighter-rouge">Scope</code> において他の値があると無視されて <code class="language-plaintext highlighter-rouge">local</code> が用いられます。
<code class="language-plaintext highlighter-rouge">Scope</code> はクラスターマネージャーに対して、さまざまな方法によりボリュームを取り扱えるようにします。
たとえば <code class="language-plaintext highlighter-rouge">global</code> スコープは、クラスターマネージャーに対して、ただ一度だけボリュームを生成すればよいことを伝えます。つまり Docker ホストの個々において、ボリューム生成は不要とします。
ケーパビリティの機能は将来、さらに充足されるかもしれません。</p>
