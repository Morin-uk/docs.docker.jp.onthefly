<!-- This file is maintained within the docker/cli GitHub
     repository at https://github.com/docker/cli/. Make all
     pull requests against that repo. If you see this file in
     another repository, consider it read-only there, as it will
     periodically be overwritten by the definitive file. Pull
     requests which include edits to this file in other repositories
     will be rejected.
-->

<h1 id="using-volume-and-network-plugins-in-docker-services">Using Volume and Network plugins in Docker services</h1>

<p>In swarm mode, it is possible to create a service that allows for attaching
to networks or mounting volumes that are backed by plugins. Swarm schedules
services based on plugin availability on a node.</p>

<h3 id="volume-plugins">Volume plugins</h3>

<p>In this example, a volume plugin is installed on a swarm worker and a volume
is created using the plugin. In the manager, a service is created with the
relevant mount options. It can be observed that the service is scheduled to
run on the worker node with the said volume plugin and volume. Note that,
node1 is the manager and node2 is the worker.</p>

<ol>
  <li>
    <p>Prepare manager. In node 1:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker swarm init
Swarm initialized: current node <span class="o">(</span>dxn1zf6l61qsb1josjja83ngz<span class="o">)</span> is now a manager.
</code></pre></div>    </div>
  </li>
  <li>
    <p>Join swarm, install plugin and create volume on worker. In node 2:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker swarm <span class="nb">join</span> <span class="se">\</span>
 <span class="nt">--token</span> SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c <span class="se">\</span>
 192.168.99.100:2377
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker plugin <span class="nb">install </span>tiborvass/sample-volume-plugin
 latest: Pulling from tiborvass/sample-volume-plugin
 eb9c16fbdc53: Download <span class="nb">complete
 </span>Digest: sha256:00b42de88f3a3e0342e7b35fa62394b0a9ceb54d37f4c50be5d3167899994639
 Status: Downloaded newer image <span class="k">for </span>tiborvass/sample-volume-plugin:latest
 Installed plugin tiborvass/sample-volume-plugin
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker volume create <span class="nt">-d</span> tiborvass/sample-volume-plugin <span class="nt">--name</span> pluginVol
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create a service using the plugin and volume. In node1:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker service create <span class="nt">--name</span> my-service <span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span>volume,volume-driver<span class="o">=</span>tiborvass/sample-volume-plugin,source<span class="o">=</span>pluginVol,destination<span class="o">=</span>/tmp busybox top

 <span class="nv">$ </span>docker service <span class="nb">ls
 </span>z1sj8bb8jnfn  my-service   replicated  1/1       busybox:latest
</code></pre></div>    </div>
    <p>docker service ls shows service 1 instance of service running.</p>
  </li>
  <li>
    <p>Observe the task getting scheduled in node 2:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    
 <span class="nv">$ </span>docker ps <span class="nt">--format</span> <span class="s1">'{{.ID}}\t {{.Status}} {{.Names}} {{.Command}}'</span>
 83fc1e842599     Up 2 days my-service.1.9jn59qzn7nbc3m0zt1hij12xs <span class="s2">"top"</span>
    
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="network-plugins">Network plugins</h3>

<p>In this example, a global scope network plugin is installed on both the
swarm manager and worker. A service is created with replicated instances
using the installed plugin. We will observe how the availability of the
plugin determines network creation and container scheduling.</p>

<p>Note that node1 is the manager and node2 is the worker.</p>

<ol>
  <li>
    <p>Install a global scoped network plugin on both manager and worker. On node1
and node2:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker plugin <span class="nb">install </span>bboreham/weave2
 Plugin <span class="s2">"bboreham/weave2"</span> is requesting the following privileges:
 - network: <span class="o">[</span>host]
 - capabilities: <span class="o">[</span>CAP_SYS_ADMIN CAP_NET_ADMIN]
 Do you grant the above permissions? <span class="o">[</span>y/N] y
 latest: Pulling from bboreham/weave2
 7718f575adf7: Download <span class="nb">complete
 </span>Digest: sha256:2780330cc15644b60809637ee8bd68b4c85c893d973cb17f2981aabfadfb6d72
 Status: Downloaded newer image <span class="k">for </span>bboreham/weave2:latest
 Installed plugin bboreham/weave2
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create a network using plugin on manager. On node1:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker network create <span class="nt">--driver</span><span class="o">=</span>bboreham/weave2:latest globalnet

 <span class="nv">$ </span>docker network <span class="nb">ls
 </span>NETWORK ID          NAME                DRIVER                   SCOPE
 qlj7ueteg6ly        globalnet           bboreham/weave2:latest   swarm
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create a service on the manager and have replicas set to 8. Observe that
containers get scheduled on both manager and worker.</p>

    <p>On node 1:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker service create <span class="nt">--network</span> globalnet <span class="nt">--name</span> myservice <span class="nt">--replicas</span><span class="o">=</span>8 mrjana/simpleweb simpleweb
w90drnfzw85nygbie9kb89vpa
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker ps
 CONTAINER ID        IMAGE                                                                                      COMMAND             CREATED             STATUS              PORTS               NAMES
 87520965206a        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         5 seconds ago       Up 4 seconds                            myservice.4.ytdzpktmwor82zjxkh118uf1v
 15e24de0f7aa        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         5 seconds ago       Up 4 seconds                            myservice.2.kh7a9n3iauq759q9mtxyfs9hp
 c8c8f0144cdc        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         5 seconds ago       Up 4 seconds                            myservice.6.sjhpj5gr3xt33e3u2jycoj195
 2e8e4b2c5c08        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         5 seconds ago       Up 4 seconds                            myservice.8.2z29zowsghx66u2velublwmrh
</code></pre></div>    </div>

    <p>On node 2:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker ps
 CONTAINER ID        IMAGE                                                                                      COMMAND             CREATED             STATUS                  PORTS               NAMES
 53c0ae7c1dae        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         2 seconds ago       Up Less than a second                       myservice.7.x44tvvdm3iwkt9kif35f7ykz1
 9b56c627fee0        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         2 seconds ago       Up Less than a second                       myservice.1.x7n1rm6lltw5gja3ueikze57q
 d4f5927ba52c        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         2 seconds ago       Up 1 second                                 myservice.5.i97bfo9uc6oe42lymafs9rz6k
 478c0d395bd7        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         2 seconds ago       Up Less than a second                       myservice.3.yr7nkffa48lff1vrl2r1m1ucs
</code></pre></div>    </div>
  </li>
  <li>
    <p>Scale down the number of instances. On node1:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker service scale <span class="nv">myservice</span><span class="o">=</span>0
 myservice scaled to 0
</code></pre></div>    </div>
  </li>
  <li>
    <p>Disable and uninstall the plugin on the worker. On node2:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker plugin <span class="nb">rm</span> <span class="nt">-f</span> bboreham/weave2
 bboreham/weave2
</code></pre></div>    </div>
  </li>
  <li>
    <p>Scale up the number of instances again. Observe that all containers are
scheduled on the master and not on the worker, because the plugin is not available on the worker anymore.</p>

    <p>On node 1:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker service scale <span class="nv">myservice</span><span class="o">=</span>8
 myservice scaled to 8
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker ps
 CONTAINER ID        IMAGE                                                                                      COMMAND             CREATED             STATUS              PORTS               NAMES
 cf4b0ec2415e        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         39 seconds ago      Up 36 seconds                           myservice.3.r7p5o208jmlzpcbm2ytl3q6n1
 57c64a6a2b88        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         39 seconds ago      Up 36 seconds                           myservice.4.dwoezsbb02ccstkhlqjy2xe7h
 3ac68cc4e7b8        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         39 seconds ago      Up 35 seconds                           myservice.5.zx4ezdrm2nwxzkrwnxthv0284
 006c3cb318fc        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         39 seconds ago      Up 36 seconds                           myservice.8.q0e3umt19y3h3gzo1ty336k5r
 dd2ffebde435        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         39 seconds ago      Up 36 seconds                           myservice.7.a77y3u22prjipnrjg7vzpv3ba
 a86c74d8b84b        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         39 seconds ago      Up 36 seconds                           myservice.6.z9nbn14bagitwol1biveeygl7
 2846a7850ba0        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         39 seconds ago      Up 37 seconds                           myservice.2.ypufz2eh9fyhppgb89g8wtj76
 e2ec01efcd8a        mrjana/simpleweb@sha256:317d7f221d68c86d503119b0ea12c29de42af0a22ca087d522646ad1069a47a4   <span class="s2">"simpleweb"</span>         39 seconds ago      Up 38 seconds                           myservice.1.8w7c4ttzr6zcb9sjsqyhwp3yl
</code></pre></div>    </div>

    <p>On node 2:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>docker ps
 CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
</code></pre></div>    </div>
  </li>
</ol>
