
<p>Swarm 管理のライフサイクルの中では、以下のようなノード参照やノード更新が必要になります。</p>

<ul>
  <li><a href="#list-nodes">ノードの一覧表示</a></li>
  <li><a href="#inspect-an-individual-node">ノードの詳細表示</a></li>
  <li><a href="#update-a-node">ノードの更新</a></li>
  <li><a href="#leave-the-swarm">ノードの除外</a></li>
</ul>

<h2 id="list-nodes">ノードの一覧表示</h2>

<p>Swarm 内のノード一覧を表示するには、マネージャーノードから<code class="language-plaintext highlighter-rouge">docker node ls</code>を実行します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker node <span class="nb">ls

</span>ID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS
46aqrk4e473hjbt745z53cr3t    node-5    Ready   Active        Reachable
61pi3d91s0w3b90ijw3deeb2q    node-4    Ready   Active        Reachable
a5b2m3oghd48m8eu391pefq5u    node-3    Ready   Active
e7p8btxeu3ioshyuj6lxiv6g0    node-2    Ready   Active
ehkv3bcimagdese79dn78otj5 <span class="k">*</span>  node-1    Ready   Active        Leader
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">AVAILABILITY</code>欄は、そのノードに対してスケジューラーがタスクを割り当てることができるかどうかを表わします。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Active</code> は、スケジューラーがノードにタスクを割り当てられることを表わします。</li>
  <li><code class="language-plaintext highlighter-rouge">Pause</code> は、スケジューラーがノードに新たなタスクを割り当てられないことを表わします。
ただし既存のタスクは実行し続けることができます。</li>
  <li><code class="language-plaintext highlighter-rouge">Drain</code> は、スケジューラーがノードに新たなタスクを割り当てられないことを表わします。
 スケジューラーは既存のタスクを停止させて、利用可能な別のノードにタスクをスケジューリングします。</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">MANAGER STATUS</code>欄は、Raft 合意（Raft consensus）に従ったノードの参加状況を表わします。</p>

<ul>
  <li>表示がないものはワーカーノードであり、Swarm 管理に参加していないことを表わします。</li>
  <li><code class="language-plaintext highlighter-rouge">Leader</code>（リーダー） は、主となるマネージャーノードであることを表わします。
Swarm において、すべての Swarm 管理操作やオーケストレーション決定を行います。</li>
  <li><code class="language-plaintext highlighter-rouge">Reachable</code>（到達可能）は、Raft 合意（Raft consensus）の多数票（quorum）に参加しているマネージャーノードを表わします。
リーダーノードが利用不能になったときに、新たなリーダーとして選任される資格を持つノードです。</li>
  <li><code class="language-plaintext highlighter-rouge">Unavailable</code>（利用不能）は、他のマネージャーとの通信ができなくなっているマネージャーを表わします。
マネージャーノードが利用不能になった場合、新たなマネージャーノードを Swarm に参加させるか、ワーカーノードをマネージャーに昇格させる必要があります。</li>
</ul>

<p>Swarm の管理操作に関する詳細は <a href="/docs.docker.jp.onthefly/engine/swarm/admin_guide/">Swarm 管理ガイド</a> を参照してください。</p>

<h2 id="inspect-an-individual-node">ノードの詳細表示</h2>

<p>マネージャーノード上において<code class="language-plaintext highlighter-rouge">docker node inspect &lt;NODE-ID&gt;</code>を実行して、個々のノードについての詳細を確認することができます。
出力はデフォルトで JSON 形式です。
<code class="language-plaintext highlighter-rouge">--pretty</code>フラグを指定すれば、読みやすい書式で出力することができます。
たとえば以下のとおりです。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker node inspect self <span class="nt">--pretty</span>

ID:                     ehkv3bcimagdese79dn78otj5
Hostname:               node-1
Joined at:              2016-06-16 22:52:44.9910662 +0000 utc
Status:
 State:                 Ready
 Availability:          Active
Manager Status:
 Address:               172.17.0.2:2377
 Raft Status:           Reachable
 Leader:                Yes
Platform:
 Operating System:      linux
 Architecture:          x86_64
Resources:
 CPUs:                  2
 Memory:                1.954 GiB
Plugins:
  Network:              overlay, host, bridge, overlay, null
  Volume:               <span class="nb">local
</span>Engine Version:         1.12.0-dev
</code></pre></div></div>

<h2 id="update-a-node">ノードの更新</h2>

<p>ノードの属性は以下のようにして修正することができます。</p>

<ul>
  <li><a href="#change-node-availability">ノードの利用状況の変更</a></li>
  <li><a href="#add-or-remove-label-metadata">ラベルメタデータの追加、削除</a></li>
  <li><a href="#promote-or-demote-a-node">ノードのロール変更</a></li>
</ul>

<h3 id="change-node-availability">ノードの利用状況の変更</h3>

<p>ノードの利用状況（availability）は、以下のような変更を行うことができます。</p>

<ul>
  <li>マネージャーノードを排出（drain）することができます。
このマネージャーノードは、Swarm の管理タスクのみを実行しますが、タスク割り当ては行いません。</li>
  <li>ノードを排出することで、このノードの保守を行うことができます。</li>
  <li>ノードを一時停止すると、新たなタスクを受け入れることはできません。</li>
  <li>利用不能や一時停止したノードを、利用可能な状態に戻すことができます。</li>
</ul>

<p>たとえばマネージャーノードの利用状況を<code class="language-plaintext highlighter-rouge">Drain</code>にするには以下を行います。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker node update <span class="nt">--availability</span> drain node-1

node-1
</code></pre></div></div>

<p>別の利用状況オプションの説明については、<a href="#list-nodes">ノードの一覧出力</a> を参照してください。</p>

<h3 id="add-or-remove-label-metadata">ラベルメタデータの追加や削除</h3>

<p>ノードにラベルをつけておくと、ノードを構成する上で柔軟な運用が可能になります。
ノードラベルはサービスの制約を示すものとして利用することもできます。
サービスを作成するときに、スケジューラーのノードに対するタスク割り当てに制限がある場合には、制約を適用してください。</p>

<p>マネージャーノード上から<code class="language-plaintext highlighter-rouge">docker node update --label-add</code>を実行して、ノードにラベルメタデータを追加します。
<code class="language-plaintext highlighter-rouge">--label-add</code>フラグは、単独の<code class="language-plaintext highlighter-rouge">&lt;key&gt;</code>、または<code class="language-plaintext highlighter-rouge">&lt;key&gt;=&lt;value&gt;</code>のペア表記のいずれも可です。</p>

<p>ラベルを追加するノードに対して、一度だけ<code class="language-plaintext highlighter-rouge">--label-add</code>フラグをつけて以下を実行します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker node update <span class="nt">--label-add</span> foo <span class="nt">--label-add</span> <span class="nv">bar</span><span class="o">=</span>baz node-1

node-1
</code></pre></div></div>

<p>docker node update を使ってノード用に設定するラベルは、Swarm 内のノードにしか適用されません。
Docker デーモン <a href="/docs.docker.jp.onthefly/config/labels-custom-metadata/#daemon-labels">dockerd</a> におけるラベルと混同しないように注意してください。</p>

<p>そこで特定要件を満たすノードには、重要タスクのみを限定して割り当てるように、ノードラベルを活用することができます。
特別な処理を実行させるマシン、たとえば <a href="https://www.pcisecuritystandards.org/">PCI-SS コンプライアンス</a> を満たすマシンだけをスケジュールするような場合です。</p>

<p>ワーカーが侵害されても、そもそもノードラベルの変更はできないので、その特別な処理が侵害されることはありえません。</p>

<p>Engine ラベルは今でも活用できます。
コンテナーの機能の中には、オーケストレーションの安全性に影響を及ぼさない機能もあるので、そういった機能は分散化されることの方がよい場合があるので、Engine ラベルを利用できます。
たとえばノードに特定のディスクデバイスがあることを示すために、ラベルを設定します。
これを行ったからといって、おそらくセキュリティに直接関係しないはずです。
こういったラベルなら Swarm オーケストレーターは、より「安心して」利用することができます。</p>

<p>サービスの制約に関する詳細は <a href="/docs.docker.jp.onthefly/engine/reference/commandline/service_create/">CLI リファレンスの<code class="language-plaintext highlighter-rouge">docker service create</code></a> を参照してください。</p>

<h3 id="promote-or-demote-a-node">ノードの昇格と降格</h3>

<p>ワーカーノードはマネージャーに昇格させることができます。
マネージャーノードの 1 つが利用不能になるとか、マネージャーをオフラインにしてメンテナンスを行いたいといったときに、昇格操作を活用します。
同様にマネージャーノードをワーカーへと降格させることもできます。</p>

<blockquote>
  <p><strong>メモ</strong>: ノードの昇格や降格の理由がどのようなものであっても、Swarm 内のマネージャーノードの quorum は常に維持しておかなければなりません。
詳しくは <a href="/docs.docker.jp.onthefly/engine/swarm/admin_guide/">Swarm 管理ガイド</a> を参照してください。</p>
</blockquote>

<p>1 つあるいは複数のノードを昇格させるには、マネージャーノードから<code class="language-plaintext highlighter-rouge">docker node promote</code>を実行します。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#origin1">コマンド表記</a></li>
  <li><a data-toggle="tab" href="#japanese1">日本語訳</a></li>
</ul>
<div class="tab-content">
  <div id="origin1" class="tab-pane fade in active">
    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker node promote node-3 node-2

Node node-3 promoted to a manager in the swarm.
Node node-2 promoted to a manager in the swarm.
</code></pre></div>        </div>
      </div>
    </div>
  </div>
  <div id="japanese1" class="tab-pane fade">

    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker node promote node-3 node-2

ノード node-3 がこの Swarm においてマネージャーに昇格しました。
ノード node-2 がこの Swarm においてマネージャーに昇格しました。
</code></pre></div>        </div>
      </div>
    </div>

  </div>
</div>

<p>1 つあるいは複数のノードを降格させるには、マネージャーノードから<code class="language-plaintext highlighter-rouge">docker node demote</code>を実行します。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#origin2">コマンド表記</a></li>
  <li><a data-toggle="tab" href="#japanese2">日本語訳</a></li>
</ul>
<div class="tab-content">
  <div id="origin2" class="tab-pane fade in active">
    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker node demote node-3 node-2

Manager node-3 demoted in the swarm.
Manager node-2 demoted in the swarm.
</code></pre></div>        </div>
      </div>
    </div>
  </div>
  <div id="japanese2" class="tab-pane fade">

    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker node demote node-3 node-2

ノード node-3 がこの Swarm において降格しました。
ノード node-2 がこの Swarm において降格しました。
</code></pre></div>        </div>
      </div>
    </div>

  </div>
</div>

<p><code class="language-plaintext highlighter-rouge">docker node promote</code>と<code class="language-plaintext highlighter-rouge">docker node demote</code>は、それぞれ<code class="language-plaintext highlighter-rouge">docker node update --role manager</code>と<code class="language-plaintext highlighter-rouge">docker node update --role worker</code>の省略形です。</p>

<h2 id="install-plugins-on-swarm-nodes">Swarm ノードへのプラグインのインストール</h2>

<p>Swarm サービスが <a href="/docs.docker.jp.onthefly/engine/extend/plugin_api/">プラグイン</a> をいくつか必要としている場合は、サービスがデプロイされる可能性のあるすべてのノード上において、そのプラグインが利用できることが必要です。
プラグインのインストールは、各ノード上において手動で行うか、スクリプトを用意して行うことになります。
Docker 17.07 およびそれ以降においては、Docker API を利用するグローバルサービスと同様の方法により、プラグインをデプロイすることができます。
その際には<code class="language-plaintext highlighter-rouge">ContainerSpec</code>ではなく<code class="language-plaintext highlighter-rouge">PluginSpec</code>を利用します。</p>

<blockquote>
  <p><strong>メモ</strong>: 今のところ、Docker CLI や Docker Compose を使って、プラグインを Swarm にデプロイする手段はありません。
さらにプライベートリポジトリからプラグインをインストールすることもできません。</p>
</blockquote>

<p>プラグイン開発者が <a href="/docs.docker.jp.onthefly/engine/extend/plugin_api/#json-specification"><code class="language-plaintext highlighter-rouge">PluginSpec</code></a> というものを定義しています。
Docker ノードすべてにプラグインをインストールするには、<code class="language-plaintext highlighter-rouge">TaskTemplate</code>内に<code class="language-plaintext highlighter-rouge">PluginSpec</code>JSON を定義して <a href="/engine/api/v1.31/#operation/ServiceCreate"><code class="language-plaintext highlighter-rouge">service/create</code></a> API を利用します。</p>

<h2 id="leave-the-swarm">Swarm からのノード除外</h2>

<p>ノード上において<code class="language-plaintext highlighter-rouge">docker swarm leave</code>コマンドを実行すると、Swarm からそのノードが除外されます。</p>

<p>たとえばワーカーノードを Swarm から除外します。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#origin3">コマンド表記</a></li>
  <li><a data-toggle="tab" href="#japanese3">日本語訳</a></li>
</ul>
<div class="tab-content">
  <div id="origin3" class="tab-pane fade in active">
    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker swarm leave

Node left the swarm.
</code></pre></div>        </div>
      </div>
    </div>
  </div>
  <div id="japanese3" class="tab-pane fade">

    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker swarm leave

ノードが Swarm から除外されました。
</code></pre></div>        </div>
      </div>
    </div>

  </div>
</div>

<p>ノードが Swarm から除外されると、Docker Engine は Swarm モードを停止させます。
オーケストレーターは、そのノードに対してタスクをスケジュールすることはなくなります。</p>

<p>除外するノードがマネージャーノードの場合、quorum を維持することを警告するメッセージが表示されます。
警告表示をなくすには<code class="language-plaintext highlighter-rouge">--force</code>フラグをつけます。
最後に残ったマネージャーノードが除外されてしまうと、Swarm は利用不能になります。
これに対しては障害復旧の手段を講じるしかありません。</p>

<p>quorum の維持や障害復旧に関する詳細は <a href="/docs.docker.jp.onthefly/engine/swarm/admin_guide/">Swarm 管理ガイド</a> を参照してください。</p>

<p>ノードを Swarm から除外した後に、マネージャーノード上において<code class="language-plaintext highlighter-rouge">docker node rm</code>コマンドを実行すれば、ノード一覧からそのノードを削除することができます。</p>

<p>たとえば以下のとおりです。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker node <span class="nb">rm </span>node-2
</code></pre></div></div>

<h2 id="learn-more">さらに詳しく</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/engine/swarm/admin_guide/">Swarm 管理ガイド</a></li>
  <li><a href="/docs.docker.jp.onthefly/engine/reference/commandline/docker/">Docker Engine コマンドラインリファレンス</a></li>
  <li><a href="/docs.docker.jp.onthefly/engine/swarm/swarm-tutorial/">Swarm モードチュートリアル</a></li>
</ul>
