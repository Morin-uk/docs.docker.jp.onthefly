
<p>Docker に組み込まれている Swarm モードの公開鍵基盤（public key infrastructure; PKI）は、コンテナーによるオーケストレーションシステムを、簡単かつ安全にデプロイできるものです。
Swarm 内のノードは、他のノードとの認証、承認、通信暗号化のために相互 TLS を利用します。</p>

<p><code class="language-plaintext highlighter-rouge">docker swarm init</code> を実行して Swarm を生成すると、Docker 自体がマネージャーノードとなります。
マネージャーノードは、デフォルトで新たなルート認証局（CA）と鍵ペアを生成します。
これらは Swarm に参加するノードとの間でセキュアな通信を実現するために利用されます。
必要であれば <a href="/docs.docker.jp.onthefly/engine/reference/commandline/swarm_init/">docker swarm init</a> コマンドの <code class="language-plaintext highlighter-rouge">--external-ca</code> フラグを用いて、外部に生成した独自のルート CA を指定することができます。</p>

<p>マネージャーノードは、Swarm へのノード追加時に利用される 2 つのトークンも生成します。
その 1 つが <strong>ワーカートークン</strong> であり、もう 1 つが <strong>マネージャートークン</strong> です。
それぞれのトークンには、ルート CA 証明書のダイジェスト値と、ランダムに生成された Secret 情報が含まれます。
Swarm へノードが参加する際には、参加するノードがそのダイジェスト値を用いて、リモートマネージャーからのルート CA 証明書を検証します。
リモートマネージャーは Secret 情報を使って、参加ノードが承認されているノードであることを確認します。</p>

<p>新たなノードが Swarm に参加するたびに、マネージャーはノードに対して証明書を発行します。
その証明書には、ランダムに生成されたノード ID が含まれます。
このノード ID によって、証明書のコモンネーム（common name; CN）のもとでのノードと、組織名（organizational unit; OU）のもとでの役割が識別されます。
ノード ID は、現 Swarm 内においてこのノードが存在する間、暗号的に安全なノードとして機能します。</p>

<p>以下の図は、マネージャーノードとワーカーノードが、最低限必要となる TLS 1.2 を用いて、通信を暗号化している様子を示しています。</p>

<p><img src="/docs.docker.jp.onthefly/engine/swarm/images/tls.png" alt="TLS 図" /></p>

<p>以下の例では、ワーカーノード上の証明書の情報を示しています。</p>

<pre><code class="language-none">Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            3b:1c:06:91:73:fb:16:ff:69:c3:f7:a2:fe:96:c1:73:e2:80:97:3b
        Signature Algorithm: ecdsa-with-SHA256
        Issuer: CN=swarm-ca
        Validity
            Not Before: Aug 30 02:39:00 2016 GMT
            Not After : Nov 28 03:39:00 2016 GMT
        Subject: O=ec2adilxf4ngv7ev8fwsi61i7, OU=swarm-worker, CN=dw02poa4vqvzxi5c10gm4pq2g
...省略...
</code></pre>

<p>デフォルトにおいて Swarm 内の各ノードの証明書は、3 ヶ月ごとに更新されます。
この期間は <code class="language-plaintext highlighter-rouge">docker swarm update --cert-expiry &lt;期間&gt;</code> コマンドを使って設定することができます。
ローテーションの最小値は 1 時間です。
詳しくは CLI リファレンスの <a href="/docs.docker.jp.onthefly/engine/reference/commandline/swarm_update/">docker swarm update</a> を参照してください。</p>

<h2 id="rotating-the-ca-certificate">CA 証明書のローテート</h2>

<p>クラスターの CA 鍵やマネージャーノード自体においてセキュリティ侵害が発生した場合、Swarm のルート CA をローテートすることができます。
これによって古いルート CA により署名された証明書は、どのノードも信頼しないようにすることができます。</p>

<p><code class="language-plaintext highlighter-rouge">docker swarm ca --rotate</code> を実行すれば、新たな CA 証明書と鍵を生成することができます。
必要なら <code class="language-plaintext highlighter-rouge">--ca-cert</code> や <code class="language-plaintext highlighter-rouge">--external-ca</code> フラグを指定して、Swarm の外部にあるルート証明書やルート CA を設定することもできます。
これとは別に <code class="language-plaintext highlighter-rouge">--ca-cert</code> と <code class="language-plaintext highlighter-rouge">--ca-key</code> フラグを用いれば、Swarm で利用したい証明書と鍵を具体的に指定することもできます。</p>

<p><code class="language-plaintext highlighter-rouge">docker swarm ca --rotate</code> コマンドが実行されると、以下に示す内容が順に発生します。</p>

<ol>
  <li>
    <p>Docker はクロス署名された証明書を生成します。
これはつまり新たなルート CA 証明書が、古いルート CA 証明書によって署名されるということです。
このクロス署名証明書は、新たなノードの証明書に対する中間証明書として利用されます。
こうすることで、古いルート証明書を信頼するノードが、新たな CA によって署名された証明書も有効にできます。</p>
  </li>
  <li>
    <p>Docker 17.06 またはそれ以降において、Docker は全ノードに対して、TLS 証明書をすぐに更新するように指示することになりました。
この処理は Swarm 内のノード数に応じて数分程度かかります。</p>

    <blockquote>
      <p><strong>メモ</strong>: Swarm 内のノードの Docker バージョンが異なる場合、以下に示す 2 つのことが言えます。</p>
      <ul>
        <li>マネージャーがリーダーとして稼動していて <strong>かつ</strong> Docker 17.06 以上であるもののみが、ノードに対して TLS 証明書の更新を指示します。</li>
        <li>Docker 17.06 以上のノードのみがこの指示に従います。</li>
      </ul>

      <p>動作をわかりやすくするために、Swarm ノードはすべて Docker 17.6 またはそれ以降を用いるようにしてください。</p>
    </blockquote>
  </li>
  <li>
    <p>Swarm 内のノードがすべて、新たな CA によって署名された新たな TLS 証明書を受け取った後は、Docker は古い CA 証明書や鍵に関することは一切忘れます。
そしてノードに対しては、新たな CA 証明書だけを信頼するように指示を出します。</p>

    <p>その際には Swarm への参加時のトークンも変更されます。
それまでの参加時のトークンはこれ以降は無効になります。</p>
  </li>
</ol>

<p>これ以降、新たなノードに発行される証明書は、新たなルート CA によって署名されます。
中間証明書が含まれることはありません。</p>

<h2 id="learn-more">さらに詳しく</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/engine/swarm/how-swarm-mode-works/nodes/">ノード</a> の動作について。</li>
  <li>Swarm モードの <a href="/docs.docker.jp.onthefly/engine/swarm/how-swarm-mode-works/services/">サービス</a> の動作について。</li>
</ul>
