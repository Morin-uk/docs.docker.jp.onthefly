
<p>Docker Engine 1.12 において導入された Swarm モードでは、1 つあるいは複数の Docker Engine からなるクラスター、つまり Swarm と呼ぶものが生成できるようになりました。
1 つの Swarm はいくつかのノードから構成されていて、物理マシン仮想マシンを問わず、Docker Engine 1.12 またはそれ以降が Swarm モードにおいて稼動します。</p>

<p>ノードには <a href="#manager-nodes"><strong>マネージャー</strong></a> と <a href="#worker-nodes"><strong>ワーカー</strong></a> という 2 つの種類があります。</p>

<p><img src="/docs.docker.jp.onthefly/engine/swarm/images/swarm-diagram.png" alt="Swarm モードクラスター" /></p>

<p><a href="/docs.docker.jp.onthefly/engine/swarm/">Swarm モード概要</a> や <a href="/docs.docker.jp.onthefly/engine/swarm/key-concepts/">重要な考え方</a> をまだ読んでいない方は、ざっと目を通してください。</p>

<h2 id="manager-nodes">マネージャーノード</h2>

<p>マネージャーノードはクラスター管理タスクを取り扱います。</p>

<ul>
  <li>クラスター状態の管理。</li>
  <li>サービスのスケジュール管理。</li>
  <li>Swarm モードの <a href="/docs.docker.jp.onthefly/engine/api/">HTTP API endpoints</a> の提供。</li>
</ul>

<p>マネージャーにおいては <a href="https://raft.github.io/raft.pdf">Raft</a> を利用することによって、Swarm 全体を一貫した状態に保ちながら、そこに稼動するサービスをすべて管理します。
テスト目的であれば、1 つのマネージャーからなる 1 つの Swarm を実行することも可能です。
もっともただ 1 つのマネージャーしか持たない Swarm においてマネージャーが処理に失敗すると、サービスは稼動し続けますが、復旧のためにはもう 1 つ新たなクラスターを生成しなければなりません。</p>

<p>Swarm モードが持つ耐障害性（fault-tolerance）機能を活用するために、Docker では高可用性に関する開発方針に従って、奇数のノードを用意することを推奨しています。
複数のマネージャーを用意しておけば、マネージャーノードの 1 つに障害が発生しても、システムダウンをさせずに復旧することが可能になります。</p>

<ul>
  <li>Swarm 内に 3 つのマネージャーがあれば、最大で 1 つのマネージャーの障害に耐えられます。</li>
  <li>Swarm 内に 5 つのマネージャーがあれば、最大かつ同時に 2 つのマネージャーの障害に耐えられます。</li>
  <li>Swarm 内に <code class="language-plaintext highlighter-rouge">N</code> 個のマネージャーがあれば、最大で <code class="language-plaintext highlighter-rouge">(N-1)/2</code> 個のマネージャーの障害に耐えられます。</li>
  <li>
    <p>Docker では、1 つの Swarm に対して最大 7 つのマネージャーを持つことを推奨します。</p>

    <blockquote>
      <p><strong>重要事項</strong> より多くのマネージャーを加えたからといって、スケーラビリティーや性能が向上するわけでは <strong>ありません</strong>。
一般的には、増やさないのが正しいことです。</p>
    </blockquote>
  </li>
</ul>

<h2 id="worker-nodes">ワーカーノード</h2>

<p>ワーカーノードも Docker Engine のインスタンスです。
その唯一の目的はコンテナーを稼動させることです。
ワーカーノードは、Raft の分散状態の中には含まれず、スケジュール決定や Swarm モード HTTP API の提供も行いません。</p>

<p>1 つの Swarm においてマネージャーノードを 1 つだけとすることは可能ですが、1 つのマネージャーノードも存在しないところに 1 つだけワーカーノードを生成することはできません。
デフォルトで、マネージャーは同時にワーカーとしても動作します。
1 つのマネージャーノードしか持たないクラスターにおいては、<code class="language-plaintext highlighter-rouge">docker service create</code> といったコマンドを実行すると、スケジューラーはタスクのすべてをローカルの Engine に配置することになります。</p>

<p>複数ノードから構成される Swarm において、マネージャーに対してスケジューラーがタスクの割り当てを行わないようにするには、マネージャーノードの利用状態（availability）を <code class="language-plaintext highlighter-rouge">Drain</code> に設定します。
スケジューラーは <code class="language-plaintext highlighter-rouge">Drain</code> モードに設定されたノード上ではタスクを停止し、<code class="language-plaintext highlighter-rouge">Active</code> モードのタスクにはタスクをスケジューリングします。
スケジューラーは、利用状態が <code class="language-plaintext highlighter-rouge">Drain</code> であるようなノードに対しては、一切タスクを割り振ることはありません。</p>

<p>コマンドラインリファレンスの <a href="/docs.docker.jp.onthefly/engine/reference/commandline/node_update/"><code class="language-plaintext highlighter-rouge">docker node update</code></a> を参照して、ノードの利用状態の変更方法について確認してください。</p>

<h2 id="change-roles">ロールの変更</h2>

<p><code class="language-plaintext highlighter-rouge">docker node promote</code> を実行すれば、ワーカーノードをマネージャーノードに昇格させることができます。
たとえば、1 つのマネージャーノードを保守目的でオフラインとした場合には、別のワーカーノードを昇格させることが必要になる場合があります。
<a href="/docs.docker.jp.onthefly/engine/reference/commandline/node_promote/">node promote</a> を参照してください。</p>

<p>マネージャーノードをワーカーノードに降格させることもできます。
<a href="/docs.docker.jp.onthefly/engine/reference/commandline/node_demote/">node demote</a> を参照してください。</p>

<h2 id="learn-more">さらに詳しく</h2>

<ul>
  <li>Swarm モードの <a href="/docs.docker.jp.onthefly/engine/swarm/how-swarm-mode-works/services/">サービス</a> の動作について。</li>
  <li>Swarm モードにおける <a href="/docs.docker.jp.onthefly/engine/swarm/how-swarm-mode-works/pki/">PKI</a> 動作について。</li>
</ul>
