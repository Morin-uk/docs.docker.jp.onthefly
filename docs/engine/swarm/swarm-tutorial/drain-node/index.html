
<p>このチュートリアルの初めの方では、実行されているノードの利用状態（availability）は <code class="language-plaintext highlighter-rouge">ACTIVE</code> になっていました。
Swarm マネージャーは <code class="language-plaintext highlighter-rouge">ACTIVE</code> なノードであるからこそ、タスクを割り振ることができます。
ここまでのところは、ノードがすべて利用可能であったから、タスクを受け取ることができたわけです。</p>

<p>たとえば定期メンテナンスの時などでは、ノードの利用状態を <code class="language-plaintext highlighter-rouge">DRAIN</code>、つまり解放状態にしておくことが必要な場合があります。
<code class="language-plaintext highlighter-rouge">DRAIN</code> という状態にあるノードは Swarm マネージャーから、新たなタスクを受け取ることができません。
またそのノード上に実行されていたタスクは、マネージャーによって停止され、<code class="language-plaintext highlighter-rouge">ACTIVE</code> 状態にある別のノードに複製タスクが割り振られます。</p>

<blockquote class="important">
  <p><strong>重要</strong>: スタンドアロンコンテナーは <code class="language-plaintext highlighter-rouge">docker run</code>、<code class="language-plaintext highlighter-rouge">docker-compose up</code>、あるいは Docker Engine API を使って生成されますが、ノードの状態を <code class="language-plaintext highlighter-rouge">DRAIN</code> にするということは、そのノードからスタンドアロンコンテナーを削除するという意味ではありません。
<code class="language-plaintext highlighter-rouge">DRAIN</code> も含めてノードの状態というものは、Swarm サービスによる処理スケジューリングにあたり、ノードの利用能力の有無を決めるものでしかありません。</p>
</blockquote>

<ol>
  <li>
    <p>マシンへの接続ができていなければ、端末画面を開いて SSH により接続します。
接続先はマネージャーノードを起動したマシンです。
たとえばこのチュートリアルでは <code class="language-plaintext highlighter-rouge">manager1</code> というマシンを利用します。</p>
  </li>
  <li>
    <p>ノードがすべてアクティブであって利用可能であることを確認します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker node <span class="nb">ls

</span>ID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS
1bcef6utixb0l0ca7gxuivsj0    worker2   Ready   Active
38ciaotwjuritcdtn9npbnkuz    worker1   Ready   Active
e216jshn25ckzbvmwlnh5jr3g <span class="k">*</span>  manager1  Ready   Active        Leader
</code></pre></div>    </div>
  </li>
  <li>
    <p>チュートリアルの <a href="/docs.docker.jp.onthefly/engine/swarm/swarm-tutorial/rolling-update/">ローリングアップデート</a> における <code class="language-plaintext highlighter-rouge">redis</code> を停止してしまっている場合は、ここで起動します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service create <span class="nt">--replicas</span> 3 <span class="nt">--name</span> redis <span class="nt">--update-delay</span> 10s redis:3.0.6

c5uo6kdmzpon37mgj9mwglcfw
</code></pre></div>    </div>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">docker service ps redis</code> を実行して、Swarm マネージャーがさまざまなノードに対して、タスクを割り当てている様子を確認します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service ps redis

NAME                               IMAGE        NODE     DESIRED STATE  CURRENT STATE
redis.1.7q92v0nr1hcgts2amcjyqg3pq  redis:3.0.6  manager1 Running        Running 26 seconds
redis.2.7h2l8h3q3wqy5f66hlv9ddmi6  redis:3.0.6  worker1  Running        Running 26 seconds
redis.3.9bg7cezvedmkgg6c8yzvbhwsd  redis:3.0.6  worker2  Running        Running 26 seconds
</code></pre></div>    </div>

    <p>この例では、Swarm マネージャーが 1 つのタスクを各ノードに分散しています。
実行環境によっては、複数ノード間でのタスク分散の仕方が異なっているかもしれません。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">docker node update --availability drain &lt;ノードID&gt;</code> を実行して、1 つのタスクが割り当てられているノードを解放（drain）します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker node update <span class="nt">--availability</span> drain worker1

worker1
</code></pre></div>    </div>
  </li>
  <li>
    <p>ノードが利用可能であるか（availability）を確認します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker node inspect <span class="nt">--pretty</span> worker1

ID:			38ciaotwjuritcdtn9npbnkuz
Hostname:		worker1
Status:
 State:			Ready
 Availability:		Drain
...snip...
</code></pre></div>    </div>

    <p>解放したノードの <code class="language-plaintext highlighter-rouge">AVAILABILITY</code> は <code class="language-plaintext highlighter-rouge">Drain</code> と示されています。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">docker service ps redis</code> を実行して、Swarm マネージャーが <code class="language-plaintext highlighter-rouge">redis</code> サービスに対して、どのようにタスク割り当てを更新しているかを確認します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service ps redis

NAME                                    IMAGE        NODE      DESIRED STATE  CURRENT STATE           ERROR
redis.1.7q92v0nr1hcgts2amcjyqg3pq       redis:3.0.6  manager1  Running        Running 4 minutes
redis.2.b4hovzed7id8irg1to42egue8       redis:3.0.6  worker2   Running        Running About a minute
 <span class="se">\_</span> redis.2.7h2l8h3q3wqy5f66hlv9ddmi6   redis:3.0.6  worker1   Shutdown       Shutdown 2 minutes ago
redis.3.9bg7cezvedmkgg6c8yzvbhwsd       redis:3.0.6  worker2   Running        Running 4 minutes
</code></pre></div>    </div>

    <p>Swarm マネージャーは求められる状態を維持するために、<code class="language-plaintext highlighter-rouge">Drain</code> 状態にあるノード上のタスクを終了させ、<code class="language-plaintext highlighter-rouge">Active</code> 状態にあるノード上に新たなタスクを生成します。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">docker node update --availability active &lt;ノードID&gt;</code> を実行すれば、解放状態にあったノードをアクティブ状態に戻すことができます。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker node update <span class="nt">--availability</span> active worker1

worker1
</code></pre></div>    </div>
  </li>
  <li>
    <p>ノードの状態が更新されていることを確認します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker node inspect <span class="nt">--pretty</span> worker1

ID:			38ciaotwjuritcdtn9npbnkuz
Hostname:		worker1
Status:
 State:			Ready
 Availability:		Active
...snip...
</code></pre></div>    </div>

    <p>ノードの状態を <code class="language-plaintext highlighter-rouge">Active</code> に戻した場合、新たなタスクを受け取るようになるのは、以下のときです。</p>

    <ul>
      <li>サービスがスケールアップするために更新されたとき。</li>
      <li>ローリングアップデートのとき。</li>
      <li>別のノードの状態を <code class="language-plaintext highlighter-rouge">Drain</code> にしたとき。</li>
      <li>別のアクティブなノードにおいてタスクが失敗したとき。</li>
    </ul>
  </li>
</ol>

<h2 id="whats-next">次にすることは</h2>

<p><a href="/docs.docker.jp.onthefly/engine/swarm/ingress/">Swarm モードでのルーティングメッシュの利用</a> について学びます。</p>
