
<p>このチュートリアルは、Docker Engine の Swarm モード機能を説明するものです。
これをはじめる前に <a href="/docs.docker.jp.onthefly/engine/swarm/key-concepts/">重要な考え方</a> を読んでおいてください。</p>

<p>このチュートリアルでは、以下のような作業を進めていきます。</p>

<ul>
  <li>Swarm モード内で Docker Engine のクラスターを初期化します。</li>
  <li>Swarm にノードを追加します。</li>
  <li>Swarm に対してアプリケーションサービスをデプロイします。</li>
  <li>正常に動作させることができたら Swarm の管理を行います。</li>
</ul>

<p>このチュートリアルでは、端末画面上のコマンドラインから Docker Engine CLI コマンドを利用します。</p>

<p>Docker を初めて使う場合は、<a href="/docs.docker.jp.onthefly/engine/">Docker Engine について</a> を参照してください。</p>

<h2 id="set-up">セットアップ</h2>

<p>このチュートリアルを実行するには、以下の項目が必要です。</p>

<ul>
  <li><a href="#three-networked-host-machines">3 つの Linux ホストに Docker がインストールされ、ネットワーク上で互いに通信可能であること。</a></li>
  <li><a href="#docker-engine-112-or-newer">Docker Engine 1.12 またはそれ以降がインストールされていること。</a></li>
  <li><a href="#the-ip-address-of-the-manager-machine">マネージャーマシンの IP アドレス。</a></li>
  <li><a href="#open-protocols-and-ports-between-the-hosts">ホスト間でポートが開放されていること。</a></li>
</ul>

<h3 id="three-networked-host-machines">ネットワーク接続された 3 つのホストマシン</h3>

<p>このチュートリアルでは、Docker がインストールされ、互いにネットワーク通信が可能である 3 つの Linux ホストを用います。
このホストは物理マシン、仮想マシン、Amazon EC2 インスタンス、その他のホストのいずれでもかまいません。
Docker Machine を利用するのであれば、Linux、Mac、Windows のいずれをホストすることもできます。
<a href="/docs.docker.jp.onthefly/get-started/swarm-deploy/#prerequisites">Swarm をはじめよう</a> を確認し、ホストとして設定可能なものを選んでください。</p>

<p>このマシンのうちの 1 つをマネージャー（<code class="language-plaintext highlighter-rouge">manager1</code>）とし、残りの 2 つをワーカー（<code class="language-plaintext highlighter-rouge">worker1</code> と <code class="language-plaintext highlighter-rouge">worker2</code>）とします。</p>

<blockquote>
  <p><strong>メモ</strong>: このチュートリアルに示す手順の多くは、単一ノードの Swarm を確認する際にも用いることができます。
その場合は、ホストはただ 1 つあれば十分です。
複数ノード用コマンドは動作しませんが、Swarm の初期化、サービス生成、スケール変更は行うことができます。</p>
</blockquote>

<h3 id="docker-engine-112-or-newer">Docker Engine 1.12 またはそれ以降</h3>

<p>このチュートリアルのホストマシンには、いずれも Docker Engine 1.12 またはそれ以降がインストールされていることが必要です。
適切な Docker Engine をインストールして Docker Engine デーモンが各マシンにおいて実行されていることを確認してください。
Docker Engine の最新版は以下から入手することができます。</p>

<ul>
  <li>
    <p><a href="#install-docker-engine-on-linux-machines">Linux マシンへの Docker Engine インストール</a></p>
  </li>
  <li>
    <p><a href="#use-docker-desktop-for-mac-or-docker-desktop-for-windows">Docker Desktop for Mac または Docker Desktop for Windows の利用</a></p>
  </li>
</ul>

<h4 id="install-docker-engine-on-linux-machines">Linux マシンへの Docker Engine インストール</h4>

<p>ホストとして利用するものが Linux ベースの物理コンピューターやクラウドコンピューターである場合は、各プラットフォームに合わせて単純に <a href="/docs.docker.jp.onthefly/engine/install/">Linux インストール手順</a> に従います。
3 つのマシンを設定したら準備が整いました。
Linux マシン上では単一ノード、複数ノードのいずれのシナリオでも作業していくことができます。</p>

<h4 id="use-docker-desktop-for-mac-or-docker-desktop-for-windows">Docker Desktop for Mac または Docker Desktop for Windows の利用</h4>

<p>別の方法として、手元のコンピューターに最新の <a href="/docs.docker.jp.onthefly/docker-for-mac/">Docker Desktop for Mac</a> または <a href="/docs.docker.jp.onthefly/docker-for-windows/">Docker Desktop for Windows</a> をインストールして利用することもできます。
このコンピューターからは、単一ノード、複数ノードのいずれの Swarm でもテストすることができます。
ただし複数ノードの例をテストするためには Docker Machine が必要です。</p>

<ul>
  <li>Docker Desktop for Mac や Docker Desktop for Windows は、Swarm モードにおける <strong>単一ノード</strong> の確認や、単一ノードからなる Swarm の初期化、サービス生成、サービスのスケーリングを行うことができます。
Hyperkit (Mac) 上、または Hyper-V (Windows) 上の Docker “Moby” が単一 Swarm ノードを提供します。</li>
</ul>

<p></p>

<ul>
  <li>現時点において Docker Desktop for Mac または Docker Desktop for Windows を単独で利用するだけでは、<strong>複数ノード</strong> Swarm を扱うことはできません。
ただし単独ノードの Swarm 設定に対して、数多くの利用例を参考にすることはできます。</li>
</ul>

<h3 id="the-ip-address-of-the-manager-machine">マネージャーマシンの IP アドレス</h3>

<p>ホストオペレーティングシステムが利用するネットワークインターフェースに対しては、IP アドレスを割り振る必要があります。
Swarm 上のノードはすべて、マネージャーに対して IP アドレスにより接続します。</p>

<p>他のノードからもマネージャーノードの IP アドレスを通じて接続するため、IP アドレスは固定しておく必要があります。</p>

<p>Linux や macOS では <code class="language-plaintext highlighter-rouge">ifconfig</code> を実行すれば、利用可能なネットワークインターフェースの一覧を確認できます。</p>

<p>Docker Machine を利用している場合は、<code class="language-plaintext highlighter-rouge">docker-machine ls</code> または <code class="language-plaintext highlighter-rouge">docker-machine ip &lt;マシン名&gt;</code>（たとえば <code class="language-plaintext highlighter-rouge">docker-machine ip manager1</code>） によってマネージャーの IP アドレスを確認することができます。</p>

<p>このチュートリアルでは <code class="language-plaintext highlighter-rouge">manager1</code> が <code class="language-plaintext highlighter-rouge">192.168.99.100</code> であるものとします。</p>

<h3 id="open-protocols-and-ports-between-the-hosts">ホスト間でのプロトコルとポートの開放</h3>

<p>以下のポートの利用が必要です。
システムの中には、デフォルトでこれらのポートはすでに開放されているものがあります。</p>

<ul>
  <li><strong>TCP ポートの 2377</strong>、クラスター管理における通信のため</li>
  <li><strong>TCP</strong> および <strong>UDP ポートの 7946</strong>、ノード間の通信のため</li>
  <li><strong>UDP ポートの 4789</strong>、オーバーレイネットワークのトラフィックのため</li>
</ul>

<p>オーバーレイネットワークを暗号化（<code class="language-plaintext highlighter-rouge">--opt encrypted</code>）込みで生成する場合は、<strong>ip protocol 50</strong> (<strong>ESP</strong>) を許可しておく必要があります。</p>

<h2 id="whats-next">次にすることは</h2>

<p>環境を整えたら、次に <a href="/docs.docker.jp.onthefly/engine/swarm/swarm-tutorial/create-swarm/">Swarm の生成</a> を行います。</p>
