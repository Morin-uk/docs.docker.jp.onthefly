
<p>チュートリアルの前の手順では、サービスのインスタンス数を <a href="/docs.docker.jp.onthefly/engine/swarm/swarm-tutorial/scale-service/">スケール変更</a> しました。
ここでは Redis 3.0.6 というタグをつけたコンテナーを使って、サービスのデプロイを行います。
そしてこのサービスが Redis 3.0.7 というコンテナーイメージを用いるように、ローリングアップデートを使ってサービスをアップグレードします。</p>

<ol>
  <li>
    <p>マシンへの接続ができていなければ、端末画面を開いて SSH により接続します。
接続先はマネージャーノードを起動したマシンです。
たとえばこのチュートリアルでは <code class="language-plaintext highlighter-rouge">manager1</code> というマシンを利用します。</p>
  </li>
  <li>
    <p>Regis タグを Swarm にデプロイします。
そして Swarm に対して、アップデートの待機時間（update delay）を 10 秒に設定します。
なお以下の例は、古い方の Redis タグを使っています。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service create <span class="se">\</span>
  <span class="nt">--replicas</span> 3 <span class="se">\</span>
  <span class="nt">--name</span> redis <span class="se">\</span>
  <span class="nt">--update-delay</span> 10s <span class="se">\</span>
  redis:3.0.6

0u6a4s31ybk7yw2wyvtikmu50
</code></pre></div>    </div>

    <p>上のコマンドにより、サービスデプロイ時のローリングアップデートポリシーを設定したことになります。</p>

    <p><code class="language-plaintext highlighter-rouge">--update-delay</code> フラグは、サービスの 1 つあるいは複数のタスクに対して、アップデートの待機時間を設定するものです。
数値を <code class="language-plaintext highlighter-rouge">T</code> として、<code class="language-plaintext highlighter-rouge">Ts</code> は秒、<code class="language-plaintext highlighter-rouge">Tm</code> は分、<code class="language-plaintext highlighter-rouge">Th</code> は時間を表現します。
そこでたとえば <code class="language-plaintext highlighter-rouge">10m30s</code> は 10 分 30 秒の遅延を表現します。</p>

    <p>デフォルトにおいてスケジューラーは、一度に 1 つのタスクをアップデートします。
<code class="language-plaintext highlighter-rouge">--update-parallelism</code> フラグを指定すれば、スケジューラーが同時にアップデート可能なサービスタスクの最大数を設定することができます。</p>

    <p>ある 1 つのタスクに対するアップデート処理の結果として <code class="language-plaintext highlighter-rouge">RUNNING</code> という状態が返ってきたとします。
デフォルトでスケジューラーは、その場合、別のタスクを処理するようにし、最終的にタスクすべてのアップデートが完了するようにスケジュールされます。
アップデートのどういうタイミングであっても、タスクが <code class="language-plaintext highlighter-rouge">FAILED</code> を返してきたら、スケジューラーはアップデート処理を中断します。
この動きに対しては、<code class="language-plaintext highlighter-rouge">docker service create</code> や <code class="language-plaintext highlighter-rouge">docker service update</code> における <code class="language-plaintext highlighter-rouge">--update-failure-action</code> フラグを使って制御することができます。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">redis</code> サービスを確認します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service inspect <span class="nt">--pretty</span> redis

ID:             0u6a4s31ybk7yw2wyvtikmu50
Name:           redis
Service Mode:   Replicated
 Replicas:      3
Placement:
 Strategy:	    Spread
UpdateConfig:
 Parallelism:   1
 Delay:         10s
ContainerSpec:
 Image:         redis:3.0.6
Resources:
Endpoint Mode:  vip
</code></pre></div>    </div>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">redis</code> に対するコンテナーイメージのアップデータを行います。
Swarm マネージャーは <code class="language-plaintext highlighter-rouge">UpdateConfig</code> ポリシーに従って、ノードへのアップデートを適用します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service update <span class="nt">--image</span> redis:3.0.7 redis
redis
</code></pre></div>    </div>

    <p>スケジューラーは、デフォルトで以下のようにしてローリングアップデートを適用します。</p>

    <ul>
      <li>最初のタスクを停止します。</li>
      <li>停止したタスクに対してアップデートをスケジュールします。</li>
      <li>アップデート対象のタスクに対してコンテナーを起動します。</li>
      <li>1 つのタスクに対するアップデートにおいて <code class="language-plaintext highlighter-rouge">RUNNING</code> が返ってきたら、指定された待機時間だけ待って、次のタスクの処理を開始します。</li>
      <li>アップデート中にタスクが <code class="language-plaintext highlighter-rouge">FAILED</code> を返したら、アップデートを中断します。</li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">docker service inspect --pretty redis</code> を実行して、新たなイメージが思ったとおりの状態になっていることを確認します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service inspect <span class="nt">--pretty</span> redis

ID:             0u6a4s31ybk7yw2wyvtikmu50
Name:           redis
Service Mode:   Replicated
 Replicas:      3
Placement:
 Strategy:	    Spread
UpdateConfig:
 Parallelism:   1
 Delay:         10s
ContainerSpec:
 Image:         redis:3.0.7
Resources:
Endpoint Mode:  vip
</code></pre></div>    </div>

    <p>処理失敗によりアップデートが中断していたら <code class="language-plaintext highlighter-rouge">service inspect</code> の結果は以下のようになります。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service inspect <span class="nt">--pretty</span> redis

ID:             0u6a4s31ybk7yw2wyvtikmu50
Name:           redis
...snip...
Update status:
 State:      paused
 Started:    11 seconds ago
 Message:    update paused due to failure or early termination of task 9p7ith557h8ndf0ui9s0q951b
...snip...
</code></pre></div>    </div>

    <p>中断しているアップデートを再び開始するには、<code class="language-plaintext highlighter-rouge">docker service update &lt;サービスID&gt;</code> を実行します。
たとえば以下のとおりです。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service update redis
</code></pre></div>    </div>

    <p>特定のアップデータ失敗が続くようであれば、これを解消するために、<code class="language-plaintext highlighter-rouge">docker service update</code> に何らかのフラグを指定して、サービスを再設定する必要があるかもしれません。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">docker service ps &lt;サービスID&gt;</code> を実行して、ローリングアップデートの状況を確認します。</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service ps redis

NAME                                   IMAGE        NODE       DESIRED STATE  CURRENT STATE            ERROR
redis.1.dos1zffgeofhagnve8w864fco      redis:3.0.7  worker1    Running        Running 37 seconds
 <span class="se">\_</span> redis.1.88rdo6pa52ki8oqx6dogf04fh  redis:3.0.6  worker2    Shutdown       Shutdown 56 seconds ago
redis.2.9l3i4j85517skba5o7tn5m8g0      redis:3.0.7  worker2    Running        Running About a minute
 <span class="se">\_</span> redis.2.66k185wilg8ele7ntu8f6nj6i  redis:3.0.6  worker1    Shutdown       Shutdown 2 minutes ago
redis.3.egiuiqpzrdbxks3wxgn8qib1g      redis:3.0.7  worker1    Running        Running 48 seconds
 <span class="se">\_</span> redis.3.ctzktfddb2tepkr45qcmqln04  redis:3.0.6  mmanager1  Shutdown       Shutdown 2 minutes ago
</code></pre></div>    </div>

    <p>Swarm が全タスクに対するアップデートを終えていない状態であれば、<code class="language-plaintext highlighter-rouge">redis:3.0.6</code> を実行しているものがあり、また <code class="language-plaintext highlighter-rouge">redis:3.0.7</code> を実行しているものもありました。
上の結果からは、ローリングアップデート処理を終えた状態であることがわかります。</p>
  </li>
</ol>

<h2 id="whats-next">次にすることは</h2>

<p>次は Swarm 内からの <a href="/docs.docker.jp.onthefly/engine/swarm/swarm-tutorial/drain-node/">ノードの解放</a> について学びます。</p>
