
<p>Swarm を生成したら、それは単一の Docker Engine を Swarm モードにしたということです。
Swarm モードを最大限活用するには、Swarm にノードを追加していきます。</p>

<ul>
  <li>ワーカーノードは、これを追加することによって収容能力を増加させます。
Swarm に対してサービスをデプロイすると Engine は、ワーカーノード、マネージャーノードを問わず、利用可能なノードに対してタスクをスケジューリングします。
Swarm に対してワーカーノードを追加すると、Swarm のスケールが増加し、マネージャーの Raft 合意に影響することなくタスクを取り扱うことができます。</li>
  <li>マネージャーノードは耐障害性能を向上させます。
マネージャーノードは Swarm においてオーケストレーション機能およびクラスター管理機能を実現します。
マネージャーの中では、リーダーとなるノードがオーケストレーションタスクを管理します。
リーダーノードが処理不能になると、残りのマネージャーノードの中から新たなリーダーが選出され、オーケストレーション機能と Swarm 状態を復元します。
デフォルトではマネージャーノードも通常のタスクを実行します。</li>
</ul>

<p>Swarm にノードを追加するためには、ホストマシンに Docker Engine 1.12 またはそれ以降をインストールしておく必要があります。</p>

<p>Docker Engine が Swarm に参加する際には、<code class="language-plaintext highlighter-rouge">docker swarm join</code>コマンドによって示される <strong>参加トークン</strong>（join-token）を利用します。
ノードがトークンを利用するのはこの参加のときだけです。
この後にトークンのローテート操作を行っても、既存の Swarm ノードには影響しません。
<a href="/docs.docker.jp.onthefly/engine/swarm/swarm-mode/#view-the-join-command-or-update-a-swarm-join-token">Docker Engine の Swarm モード実行</a> を参照してください。</p>

<blockquote>
  <p><strong>メモ</strong>: Docker engine では、FIPS が有効な Swarm クラスターに対して、FIPS の無効なノードでも参加させることができます。</p>
</blockquote>

<p>FIPS が混在している環境であっても、ステータスの更新や変更は簡単にできますが、Docker ではそのような混在した状況を本番環境で利用することはお勧めしません。</p>

<h2 id="join-as-a-worker-node">ワーカーノードとしての参加</h2>

<p>ワーカーノード用に、参加トークンの表示も込みで join コマンドを表示するには、マネージャーノード上にて以下のコマンドを実行します。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#origin1">コマンド表記</a></li>
  <li><a data-toggle="tab" href="#japanese1">日本語訳</a></li>
</ul>
<div class="tab-content">
  <div id="origin1" class="tab-pane fade in active">
    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker swarm join-token worker

To add a worker to this swarm, run the following command:

    docker swarm join \
    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c \
    192.168.99.100:2377
</code></pre></div>        </div>
      </div>
    </div>
  </div>
  <div id="japanese1" class="tab-pane fade">

    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker swarm join-token worker

Swarm にワーカーを追加するには、以下のコマンドを実行してください。

    docker swarm join \
    --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c \
    192.168.99.100:2377
</code></pre></div>        </div>
      </div>
    </div>

  </div>
</div>

<p>ワーカーノード上において、出力結果どおりのコマンドを実行して Swarm に参加します。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#origin2">コマンド表記</a></li>
  <li><a data-toggle="tab" href="#japanese2">日本語訳</a></li>
</ul>
<div class="tab-content">
  <div id="origin2" class="tab-pane fade in active">
    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker swarm join \
  --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c \
  192.168.99.100:2377

This node joined a swarm as a worker.
</code></pre></div>        </div>
      </div>
    </div>
  </div>
  <div id="japanese2" class="tab-pane fade">

    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker swarm join \
  --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c \
  192.168.99.100:2377

このノードはワーカーとして Swarm に参加しました。
</code></pre></div>        </div>
      </div>
    </div>

  </div>
  <hr />
</div>

<p><code class="language-plaintext highlighter-rouge">docker swarm join</code>コマンドは以下の処理を行います。</p>

<ul>
  <li>現在のノードである Docker Engine を Swarm モードに切り替えます。</li>
  <li>マネージャーに TLS 証明書を要求します。</li>
  <li>マシンホスト名を使ってノード名を定めます。</li>
  <li>Swarm トークンに基づくマネージャーのリッスンアドレスで、現在のノードを Swarm に参加させます。</li>
  <li>現在のノードの利用状態（availability）を<code class="language-plaintext highlighter-rouge">Active</code>に設定します。
これはスケジューラーからのタスク受け入れが可能であることを意味します。</li>
  <li>現在のノードに対して、<code class="language-plaintext highlighter-rouge">ingress</code>オーバーレイネットワークを拡張します。</li>
</ul>

<h2 id="join-as-a-manager-node">マネージャーノードとしての参加</h2>

<p><code class="language-plaintext highlighter-rouge">docker swarm join</code>を実行してマネージャートークンを受け渡すと、Docker Engine はワーカーノードの場合と同様に、Swarm モードへの切り替えを行います。
マネージャーノードは Raft 合意（raft consensus）にも参加します。
新たに参加させたこのノードは<code class="language-plaintext highlighter-rouge">Reachable</code>（到達可能）となりますが、Swarm の<code class="language-plaintext highlighter-rouge">Leader</code>は、それまでのものがそのまま担当します。</p>

<p>Docker はクラスターの高可用性を実現するため、マネージャーノードを 3 つあるいは 5 つにより構成することが推奨されます。
Swarm モードにおけるマネージャーノードは Raft を利用してデータ共有を行うため、マネージャーノード数は奇数としなければなりません。
Swarm はマネージャーノードの半数以上の quorum（多数票）が得られれば、機能し続けることができます。</p>

<p>Swarm マネージャーと Swarm の管理に関する詳細は <a href="/docs.docker.jp.onthefly/engine/swarm/admin_guide/">Docker Engine の Swarm 管理と保守</a> を参照してください。</p>

<p>マネージャーノード用に、参加トークンの表示も込みで join コマンドを表示するには、マネージャーノード上において以下のコマンドを実行します。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#origin3">コマンド表記</a></li>
  <li><a data-toggle="tab" href="#japanese3">日本語訳</a></li>
</ul>
<div class="tab-content">
  <div id="origin3" class="tab-pane fade in active">
    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker swarm join-token manager

To add a manager to this swarm, run the following command:

    docker swarm join \
    --token SWMTKN-1-61ztec5kyafptydic6jfc1i33t37flcl4nuipzcusor96k7kby-5vy9t8u35tuqm7vh67lrz9xp6 \
    192.168.99.100:2377
</code></pre></div>        </div>
      </div>
    </div>
  </div>
  <div id="japanese3" class="tab-pane fade">

    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker swarm join-token manager

Swarm にマネージャーを追加するには、以下のコマンドを実行してください。

    docker swarm join \
    --token SWMTKN-1-61ztec5kyafptydic6jfc1i33t37flcl4nuipzcusor96k7kby-5vy9t8u35tuqm7vh67lrz9xp6 \
    192.168.99.100:2377
</code></pre></div>        </div>
      </div>
    </div>

  </div>
</div>

<p>新たなマネージャーノード上において、出力結果どおりのコマンドを実行して Swarm に参加します。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#origin4">コマンド表記</a></li>
  <li><a data-toggle="tab" href="#japanese4">日本語訳</a></li>
</ul>
<div class="tab-content">
  <div id="origin4" class="tab-pane fade in active">
    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker swarm join \
  --token SWMTKN-1-61ztec5kyafptydic6jfc1i33t37flcl4nuipzcusor96k7kby-5vy9t8u35tuqm7vh67lrz9xp6 \
  192.168.99.100:2377

This node joined a swarm as a manager.
</code></pre></div>        </div>
      </div>
    </div>
  </div>
  <div id="japanese4" class="tab-pane fade">

    <div class="language-bash highlighter-rouge">
      <div class="highlight">
        <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker swarm join \
  --token SWMTKN-1-61ztec5kyafptydic6jfc1i33t37flcl4nuipzcusor96k7kby-5vy9t8u35tuqm7vh67lrz9xp6 \
  192.168.99.100:2377

このノードはマネージャーとして Swarm に参加しました。
</code></pre></div>        </div>
      </div>
    </div>

  </div>
</div>

<h2 id="learn-more">さらに詳しく</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/engine/reference/commandline/swarm_join/">コマンドラインリファレンス</a> の<code class="language-plaintext highlighter-rouge">swarm join</code></li>
  <li><a href="/docs.docker.jp.onthefly/engine/swarm/swarm-tutorial/">Swarm モードチュートリアル</a></li>
</ul>
