<!-- Page generated 2020-10-09 20:55:22 +0900 -->
<!DOCTYPE html>
<html lang="ja"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WL2QLG5');</script>

  <title>ECS での Docker コンテナーのデプロイ | Docker Documentation</title>
  <meta name="description" content="ECS において Docker コンテナーをデプロイします。" />
  <meta name="keywords" content="Docker, AWS, ECS, Integration, context, Compose, cli, deploy, containers, cloud">
  <link rel="canonical" href="/engine/context/ecs-integration/" />

  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <link rel="apple-touch-icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta name="msapplication-TileImage" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico">
  <meta property="og:image" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
  <!-- metadata -->

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/font-awesome.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/bootstrap.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/pygments/perldoc.css" id="pygments">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/style.css" id="pagestyle">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans">

  <!-- SEO stuff -->
  <meta name="twitter:title" itemprop="title name" content="ECS での Docker コンテナーのデプロイ"/>
  <meta name="twitter:description" property="og:description" itemprop="description" content="" />
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:domain" content="matsuand.github.io"/>
  <meta name="twitter:site" content="@docker_docs"/>
  <meta name="twitter:url" content="https://twitter.com/docker_docs"/>
  <meta name="twitter:image:src" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:image:alt" content="Docker ドキュメント"/>
  <meta property="og:title" content="ECS での Docker コンテナーのデプロイ" />
  <meta property="og:description" content="ECS において Docker コンテナーをデプロイします。" />
  <meta property="og:type" content="website"/>
  <meta property="og:updated_time" itemprop="dateUpdated" content="2020-10-09T20:55:22+09:00"/>
  <meta property="og:image" itemprop="image primaryImageOfPage" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta property="og:locale" content="ja_JP" />
  <meta property="og:url" content="https://matsuand.github.io/docs.docker.jp.onthefly/engine/context/ecs-integration/" />
  <meta property="og:site_name" content="Docker ドキュメント" />
  <meta property="article:published_time" itemprop="datePublished" content="2020-10-09T20:55:22+09:00"/>
  <script type="application/ld+json">{"@context":"http://schema.org","@type":"WebPage","headline":"ECS での Docker コンテナーのデプロイ","description":"ECS において Docker コンテナーをデプロイします。","url":"https://docs.docker.com/engine/context/ecs-integration/"}</script>
  <!-- END SEO STUFF -->
</head>
<body class="colums">
    <header>
        <nav class="nav-secondary navbar navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="/docs.docker.jp.onthefly/">
                <img class="logo" src="/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs">
            </a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="logo-mobile">
    <a href="/docs.docker.jp.onthefly/">
        <img src="/docs.docker.jp.onthefly/images/docker-icon.svg" alt="Docker Docs" title="Docker Docs">
    </a>
</div>
<div class="search-form" id="search-div">
    <form class="search-form form-inline" id="searchForm" action="/docs.docker.jp.onthefly/search/">
        <input class="search-field form-control ds-input" id="st-search-input" value="" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteContainer">
            <div id="autocompleteResults"></div>
        </div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container hidden-sm hidden-xs">
    <div id="tabs">
        <ul class="tabs jsTOCHorizontal"><li><a href="/docs.docker.jp.onthefly/" id="home">ホーム</a></li><li><a href="/docs.docker.jp.onthefly/get-started/overview/" id="guides">ガイド</a></li><li><a href="/docs.docker.jp.onthefly/engine/" id="manuals">製品マニュアル</a></li><li><a href="/docs.docker.jp.onthefly/reference/" id="reference">リファレンス</a></li><li><a href="/docs.docker.jp.onthefly/samples/" id="samples">サンプル</a></li></ul>
    </div>
    <div class="ctrl-right">
        <a href="javascript:void(0)" id="menu-toggle"><i class="fa fa-indent" aria-hidden="true"></i></a>
    </div>
</div>

        </div>
    </div>
</nav>

    </header>
    <div class="wrapper right-open">
        <div class="container-fluid">
            <div class="row">
                <div class="col-body">
                    <main class="col-content content">
                        <section class="section"><h1>ECS での Docker コンテナーのデプロイ</h1><span class="reading-time" title="Estimated reading time">
  <span class="reading-time-label">読む時間の目安: </span>
  
  
    5 分
  
</span>

<h2 id="overview">概要</h2>

<p>Docker Compose CLI は、Amazon EC2 コンテナーサービス（Amazon EC2 Container Service; ECS）の中で、ネイティブな Docker コマンドの利用を可能にします。
これを使って、クラウドに適したアプリケーションを構築し実行します。</p>

<p>Docker と Amazon ECS の統合により、開発者が Docker Compose CLI を用いる際には、以下のことが可能になります。</p>

<ul>
  <li>1 つの Docker コマンドに対して AWS コンテキストを設定することができます。
これによってローカルコンテキストとクラウドコンテキストを切り替えられるようになり、アプリケーションの実行をすばやく簡単に行うことができます。</li>
  <li>Compose ファイルを使って、Amazon ECS 上の複数コンテナーアプリケーションの開発を単純化できます。</li>
</ul>

<blockquote class="important">
  <p><strong>メモ</strong></p>

  <p>Docker Compose CLIは、現在ベータ版として提供されます。
提供されるコマンドやフラグは、将来のリリースにおいて変更されることがあります。</p>
</blockquote>

<h2 id="prerequisites">前提条件</h2>

<p>Docker コンテナーを ECS にデプロイするには、以下の条件を満たしていることが必要です。</p>

<ol>
  <li>
    <p>Docker Desktop 安定版（Stable）2.3.0.5 またはそれ以降、あるいは最新版（Edge）2.3.2.0 またはそれ以降をダウンロードしインストールしていることが必要です。</p>

    <ul>
      <li><a href="https://desktop.docker.com/mac/edge/Docker.dmg" target="_blank" class="_">Download for Mac</a></li>
      <li><a href="https://desktop.docker.com/win/edge/Docker%20Desktop%20Installer.exe" target="_blank" class="_">Download for Windows</a></li>
    </ul>

    <p>あるいは <a href="#install-the-docker-compose-cli-on-linux">Docker Compose CLI for Linux</a> をインストールしていることが必要です。</p>
  </li>
  <li>
    <p>AWS アカウントを持っていることが必要です。</p>
  </li>
</ol>

<p>Docker は、単にローカルのマルチコンテナーを実行するだけのものではなくなります。
<code class="highlighter-rouge">docker compose up</code> により Compose ファイルを使って Amazon ECS 上の Docker コンテナーをシームレスにデプロイできます。
以下の節では Amazon ECS 上において Docker コンテナーをデプロイする手順を説明します。</p>

<h3 id="create-aws-context">AWS コンテキストの生成</h3>

<p><code class="highlighter-rouge">docker context create ecs myecscontext</code> コマンドを実行して AWS コンテキストを生成します。
すでに AWS CLI をインストールし設定を行っているのであれば、このセットアップコマンドにより、既存の AWS プロファイルを選んで Amazon への接続を行います。
これがまだできていない場合は、<a href="https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys" target="_blank" class="_">AWS access key ID and a secret access key</a> を通じて、新たなプロファイルを生成します。</p>

<p>AWS コンテキストを生成したら、<code class="highlighter-rouge">docker context ls</code> コマンドを実行して Docker コンテキストの一覧を表示します。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">NAME   DESCRIPTION  DOCKER ENDPOINT  KUBERNETES ENDPOINT ORCHESTRATOR
myecscontext *
default  Current DOCKER_HOST based configuration   unix:///var/run/docker.sock     swarm
</span></code></pre></div></div>

<h2 id="run-compose-applications">Compose アプリケーションの実行</h2>

<p>Compose ファイルに定義したマルチコンテナーによるアプリケーションを、Amazon ECS に対してデプロイし管理するためには、<code class="highlighter-rouge">docker compose</code> コマンドを実行します。
これを行うためには以下のことが必要です。</p>

<ul>
  <li>
    <p>AWS コンテキストを利用していることが必要です。
これはコマンド実行時に<code class="highlighter-rouge">--context myecscontext</code>フラグを指定するか、あるいはカレントなコンテキストを設定するコマンド<code class="highlighter-rouge">docker context use myecscontext</code>を実行します。</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">docker compose up</code>と<code class="highlighter-rouge">docker compose down</code>を実行して、Compose アプリケーションの開始、停止ができることが必要です。</p>

    <p>デフォルトにおいて<code class="highlighter-rouge">docker compose up</code>は、カレントフォルダーの<code class="highlighter-rouge">docker-compose.yaml</code>ファイルを利用します。
Compose ファイルを直接<code class="highlighter-rouge">--file</code>フラグを使って指定することもできます。</p>

    <p>Compose アプリケーションのデプロイの際に<code class="highlighter-rouge">--project-name</code>フラグを使って、アプリケーション名を指定することもできます。
アプリケーション名の指定がなかった場合は、ワーキングディレクトリから名前が定められます。</p>
  </li>
  <li>
    <p>Amazon ECS 上の Compose アプリケーションに対して生成されたサービスの情報およびその状態を確認するには<code class="highlighter-rouge">docker compose ps</code>コマンドを実行します。</p>
  </li>
  <li>
    <p>Compose アプリケーションを構成するコンテナーに対しては、コマンド<code class="highlighter-rouge">docker compose logs</code>を実行してそれぞれのログを確認できます。</p>
  </li>
</ul>

<h2 id="private-docker-images">プライベートな Docker イメージ</h2>

<p>Docker Compose CLI では自動的に認証が設定されます。
したがって Amazon ECR レジストリにあるプライベートイメージは、同じ AWS アカウントを使ってプルすることができます。
一方 Docker Hub も含め、別のレジストリからプライベートイメージをプルするには、<a href="https://docs.aws.amazon.com/secretsmanager/" target="_blank" class="_">AWS Secrets Manager service</a> 上にユーザー名とパスワード（あるいはユーザー名とトークン）を生成する必要があります。</p>

<p>Docker Compose CLI では、便利なコマンドとして<code class="highlighter-rouge">docker secret</code>が提供されています。
したがって AWS CLI をインストールしていなくても、AWS SMS において生成した機密情報を管理することができます。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">docker secret create dockerhubAccessToken --username &lt;dockerhubuser&gt;</span>  <span class="nt">--password</span> &lt;dockerhubtoken&gt;
<span class="go">arn:aws:secretsmanager:eu-west-3:12345:secret:DockerHubAccessToken
</span></code></pre></div></div>

<p>この ARN を生成したら Compose ファイル内において、カスタム拡張 <code class="highlighter-rouge">x-aws-pull_credentials</code> を利用して、そのサービスに対する Docker イメージ URI を指定することができます。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">version: 3.8
services:
  worker:
    image: mycompany/privateimage
    x-aws-pull_credentials: "arn:aws:secretsmanager:eu-west-3:12345:secret:DockerHubAccessToken"
</span></code></pre></div></div>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>Compose ファイルのバージョンを 3.8 またはそれ以降に指定すると、この Compose ファイルをそのまま、<code class="highlighter-rouge">docker-compose</code> を使ってローカル開発環境向けに利用することができます。
その場合、カスタム拡張は無視されます。</p>
</blockquote>

<h2 id="service-discovery">サービスの検出</h2>

<blockquote class="warning">
  <p><strong>日本語訳情報</strong></p>

  <p>当節の内容はよく理解できなかったため、訳出に自信がありません。
内容がおわかりの方はご教示よろしくお願いします。</p>
</blockquote>

<p>サービス間の通信は <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-security-groups.html" target="_blank" class="_">Security Groups</a> ルールによって実現されています。
サービス間では共通の Compose ファイル「network」が共有され、互いに通信を行います。
そこでは特定のサービスに対して、異なる（メモリ、CPU の）制約やレプリカに関するルールにもとづいて実行することが可能です。
ただしこれを行うための条件として、Docker イメージがサービスを検出できて、従属サービスの利用可能状態を待つことができなければなりません。</p>

<h3 id="service-names">サービス名</h3>

<p>Docker Compose CLI においてアプリケーションデプロイを行うサービスは、<a href="https://docs.aws.amazon.com/cloud-map/latest/dg/what-is-cloud-map.html" target="_blank" class="_">AWS Cloud Map</a> 上に登録されます。
これは <code class="highlighter-rouge">&lt;サービス&gt;.&lt;composeプロジェクト名&gt;.local</code> という形の完全修飾ドメイン名として表わされています。
サービスが、依存するサービスを引き出す際には、この完全修飾ドメイン名を利用するか、あるいは短いサービス名（docker-compose において用いられるもの）が利用されます。
完全修飾ドメイン名は Docker Compose CLI が自動的に、環境変数<code class="highlighter-rouge">LOCALDOMAIN</code>に設定します。
これを使った処理は、Docker イメージにドメイン名解決の機能が実装されていれば、即座に動作します。
（Alpine ベースの Docker イメージを利用している場合など）その機能が実装されていない場合は、Docker イメージに <a href="/docs.docker.jp.onthefly/develop/develop-images/dockerfile_best-practices/#entrypoint">エンドポイントスクリプト</a> を用意して、そのオプションを有効にする必要があります。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="o">!</span> /bin/sh
<span class="go">
</span><span class="gp">if [ "$</span><span class="o">{</span>LOCALDOMAIN<span class="o">}</span>x<span class="s2">" != "</span>x<span class="s2">" ]; then echo "</span>search <span class="k">${</span><span class="nv">LOCALDOMAIN</span><span class="k">}</span><span class="s2">" &gt;&gt; /etc/resolv.conf; fi
</span><span class="gp">exec "$</span><span class="s2">@"</span>
</code></pre></div></div>

<h3 id="secrets">Secrets</h3>

<p>Docker モデルを使って ECS サービスに Secret 情報を受け渡すことにより、<code class="highlighter-rouge">/run/secrets</code>配下にあるファイルを機密データとして結びつけることができます。
Compose ファイルに Secret 情報を宣言している場合、ECS 上へのアプリケーションのデプロイにあたって、デプロイの一部としてその情報が生成されます。
Compose ファイル内にて既存の Secret 情報を<code class="highlighter-rouge">external: true</code>として参照している場合、Secret 名として ECS Secrets Manager の 完全リソース名を使うことができます。</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">webapp</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">...</span>
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">foo</span>

<span class="na">secrets</span><span class="pi">:</span>
  <span class="na">foo</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">arn:aws:secretsmanager:eu-west-3:1234:secret:foo-ABC123"</span>
    <span class="na">external</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<p>Secret はサービス実行時には、<code class="highlighter-rouge">/run/secrets/foo</code> というプレーンなテキストファイルとしてアクセスできます。</p>

<p>AWS Secrets マネージャーにおいて機密情報を保存する際には、（Docker の Secret と同じように）プレーンテキストとして保存する方法と、階層化した JSON ドキュメントとして保存する方法があります。
Docker Compose CLI にて後者の方法を利用する場合には、カスタム項目<code class="highlighter-rouge">x-aws-keys</code>を利用して、サービスコンテナー内の Secret として、JSON ドキュメント内のどの項目を結びつけるかを定義します。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">webapp</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">...</span>
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">foo</span>

<span class="na">secrets</span><span class="pi">:</span>
  <span class="na">foo</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">arn:aws:secretsmanager:eu-west-3:1234:secret:foo-ABC123"</span>
    <span class="na">keys</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">bar"</span>
</code></pre></div></div>

<p>このようにするとキー <code class="highlighter-rouge">bar</code> に対する機密データは、サービスの実行時に <code class="highlighter-rouge">/run/secrets/foo/bar</code> というプレーンなテキストファイルとしてアクセスできます。
特別な値として <code class="highlighter-rouge">*</code> を用いると、コンテナー内のキーすべてを得ることができます。</p>

<h3 id="logging">ログ処理</h3>

<p>Docker Compose CLI では、コンテナーに対して AWS CloudWatch ログサービスを設定します。
アプリケーションにおいて、ロググループ<code class="highlighter-rouge">docker-compose/&lt;アプリケーション名&gt;</code>が生成され、またアプリケーション内の各サービスとコンテナーにおいては、ログストリーム<code class="highlighter-rouge">&lt;アプリケーション名&gt;/&lt;サービス名&gt;/&lt;コンテナーID&gt;</code>が生成されます。</p>

<p>AWS CloudWatch ログに対しては Compose ファイル内の拡張項目<code class="highlighter-rouge">x-aws-logs_retention</code>を使って、イベントの保存日数を調整することができます。
デフォルトは無期限に保存します。</p>

<p>標準的な Compose ファイルの項目<code class="highlighter-rouge">logging.driver_opts</code>を使えば、コンテナーに対して<code class="highlighter-rouge">awslogs</code>ドライバーのパラメーターを指定することができます。</p>

<h3 id="dependent-service-startup-time-and-dns-resolution">依存サービスの起動タイミングと DNS 名前解決</h3>

<p>ECS 上におけるサービスは、Compose ファイルがデプロイされたと同時にスケジュールされます。
AWS Cloud Map は DNS サービスに対して初期の待機時間を導入していて、デプロイされたサービスのドメイン名をDNS サービスが解決できるまで待機します。
このため、開発コードにはこの待機時間への対応が必要であり、依存サービスが準備状態になるまで待つ、あるいはエントリーポイントにウェイトを行うスクリプトを Docker イメージに追加するなどして、調整を行う必要があります。
このことは <a href="/docs.docker.jp.onthefly/compose/startup-order/">Compose における起動、停止順の制御</a> で述べています。</p>

<p>あるいは Compose ファイルにおける <a href="https://github.com/compose-spec/compose-spec/blob/master/spec.md#depends_on" target="_blank" class="_">depends_on</a> の機能を利用することもできます。
これを利用すると、依存サービスがまず初めに生成され、これが起動されるのを待って、アプリケーションのデプロイが行われるようになります。</p>

<h3 id="rolling-update">ローリングアップデート</h3>

<p>ECS サービスはローリングアップデート設定を含めて生成されます。
Compose ファイルを修正した上で<code class="highlighter-rouge">docker compose up</code>を実行すると、その修正に応じてアップデートが行われ、必要なサービスは置き換えられます。
この置き換え処理は、サービスの <a href="https://docs.docker.com/compose/compose-file/#update_config"><code class="highlighter-rouge">deploy.update_config</code></a>  設定によって定められるローリングアップデート設定に従います。</p>

<p>AWS ECS ではパーセントベースモデル（percent-based model）を採用して、ローリングアップデート時に起動または停止するコンテナー数を定義しています。
Docker Compose CLI では項目<code class="highlighter-rouge">prallelism</code>または<code class="highlighter-rouge">replicas</code>に従って、ローリングアップデート設定を算出しています。
ローリングアップデートの設定を、項目<code class="highlighter-rouge">x-aws-min_percent</code>や<code class="highlighter-rouge">x-aws-max_percent</code>を使って設定したい場合があります。
<code class="highlighter-rouge">x-aws-min_percent</code>はサービスに対して、起動させるコンテナーの最小パーセントを設定します。
<code class="highlighter-rouge">x-aws-max_percent</code>は、それまでのバージョンのコンテナーを削除する前に、追加で起動するコンテナーの最大パーセントを設定します。</p>

<p>デフォルトにおいて ECS のローリングアップデートは、コンテナー数の 2 倍（200%）の数だけ起動されるように設定されます。
またアップデート時にコンテナー停止を行う程度は 100 % として設定されます。</p>

<h3 id="iam-roles">IAM ロール</h3>

<p>ECS タスクは、AWS 管理ポリシー<a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_execution_IAM_role.html"><code class="highlighter-rouge">AmazonECSTaskExecutionRolePolicy</code></a> と <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecr_managed_policies.html"><code class="highlighter-rouge">AmazonEC2ContainerRegistryReadOnly</code></a> へのアクセスが可能な、専用の IAM ロールによって実行されます。
さらにサービスが Secret を利用している場合、IAM ロールは追加の権限によって AWS Secret マネージャーから Secret の読み込みと復号化を行います。</p>

<p>サービスの実行にあたって管理ポリシーを追加で利用するには、サービス定義の内部において<code class="highlighter-rouge">x-aws-policies</code>を用います。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">foo</span><span class="pi">:</span>
    <span class="na">x-aws-policies</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">arn:aws:iam::aws:policy/AmazonS3FullAccess"</span>
</code></pre></div></div>

<p>また独自に <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-iam-roles.html">IAM ポリシードキュメント</a> を記述して、ECS サービスに適用する IAM ロールを調整することができます。
そしてサービス定義内に<code class="highlighter-rouge">x-aws-role</code>を用いることで、YAML 書式のポリシードキュメントを受け渡すことができます。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">foo</span><span class="pi">:</span>
    <span class="na">x-aws-role</span><span class="pi">:</span>
      <span class="na">Version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2012-10-17"</span>
      <span class="na">Statement</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Allow"</span>
          <span class="na">Action</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">some_aws_service"</span>
          <span class="s">Resource"</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">*"</span>
</code></pre></div></div>

<h2 id="tuning-the-cloudformation-template">CloudFormation テンプレートの調整</h2>

<p>Docker Compose CLI では <a href="https://docs.aws.amazon.com/cloudformation/" target="_blank" class="_">Amazon CloudFormation</a> を活用して、アプリケーションのデプロイ管理を行っています。
生成済みのリソースをより的確に制御するには、<code class="highlighter-rouge">docker compose convert</code> を使い、Compose ファイルから CloudFormation スタックファイルを生成します。
スタックファイルを生成すると、そこに定義されたリソースの確認や、必要に応じたテンプレートのカスタマイズ、AWS CLI や AWS ウェブコンソールからのテンプレートの適用を行うことができます。</p>

<h2 id="using-existing-aws-network-resources">既存の AWS ネットワークリソースの利用</h2>

<p>Docker Compose CLI では、Compose アプリケーションに対して、デフォルトで以下のものを生成します。
1 つは Compose アプリケーション用の ECS クラスターです。
もう 1 つはネットワークごとの SecurityGroup です。
これは AWS でのデフォルト VPC 上において、Compose ファイルによって定義されるネットワークごとのものです。
そしてサービスのトラフィックをルーティングする LoadBlancer です。
AWS アカウントに、そのようなリソースを生成する <a href="https://github.com/docker/ecs-plugin/blob/master/docs/requirements.md#permissions" target="_blank" class="_">パーミッション</a> が与えられていない場合、あるいは独自にこれらを管理したい場合は、以下のカスタム Compose 拡張機能を利用することができます。</p>

<ul>
  <li>
    <p>Compose ファイルの最上位項目として<code class="highlighter-rouge">x-aws-cluster</code>を利用します。
これは Compose アプリケーションのデプロイ時に利用する ECS クラスターの ARN を設定するものです。
これがない場合、クラスターは Compose プロジェクトに対して生成されます。</p>
  </li>
  <li>
    <p>Compose ファイルの最上位項目として<code class="highlighter-rouge">x-aws-vpc</code>を利用します。
これは Compose アプリケーションのデプロイ時に利用する VPC の ARN を設定します。</p>
  </li>
  <li>
    <p>Compose ファイルの最上位項目として <code class="highlighter-rouge">x-aws-loadbalancer</code> を利用します。
これは既存の LoadBalancer の ARN を設定します。</p>
  </li>
  <li>
    <p>Docker Compose CLI 向けの Compose ファイルにおいて、ネットワーク定義内に<code class="highlighter-rouge">external: true</code>を記述します。
これによってセキュリティグループを生成 <strong>しない</strong> ようにします。
そしてサービス間のネットワーク接続を実現するために、利用したい既存の SecurityGroup における名前と ID を設定します。</p>
  </li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">networks</span><span class="pi">:</span>
  <span class="na">back_tier</span><span class="pi">:</span>
    <span class="na">external</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">sg-1234acbd"</span>
</code></pre></div></div>

<h2 id="local-simulation">ローカルシミュレーション</h2>

<p>ECS 上にアプリケーションをデプロイする際に、追加の AWS サービスを用いたい場合があります。
そのような場合には、コード内に AWS SDK を埋め込んで、実行時に API 資格情報を取り出すことが必要になります。
AWS では資格情報を取得するメカニズムが用意されていて、SDK を使って完全実装されています。
そして固定 IP アドレス上のメタデータサービスにアクセスすることで、これを実現しています。</p>

<p>ただこの手法を採用してしまうと、ローカル環境においてテストやデバッグ目的でアプリケーションを実行することが困難になります。
そこでコンテキストを生成する際のオプションを導入しています。
そのオプションでは<code class="highlighter-rouge">ecs-local</code>コンテキストを設定して、ローカルマシンと AWS クラウドプロバイダー間でのアプリケーションの可搬性を確保しています。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker context create ecs <span class="nt">--local-simulation</span> ecsLocal
<span class="go">Successfully created ecs-local context "ecsLocal"
</span></code></pre></div></div>

<p>ローカルシミュレーションコンテキストを選んだ場合、<code class="highlighter-rouge">docker compose up</code>コマンドを実行しても、アプリケーションは ECS 上にデプロイされません。
したがってアプリケーションはローカルでの実行となり、Compose アプリケーションは <a href="https://github.com/awslabs/amazon-ecs-local-container-endpoints/">ECS local endpoints</a> を用いるように、自動的に調整されます。
このことから、アプリケーションコード内にて利用する AWS SDK は、「AWS メタデータ API」としてローカルの一時的なコンテナーにアクセスし、ローカルの設定ファイル<code class="highlighter-rouge">.aws/credentials</code>から資格情報を取得することになります。</p>

<h2 id="install-the-docker-compose-cli-on-linux">Linux における Docker Compose CLI のインストール</h2>

<p>Docker Compose CLI は、ECS 上のコンテナー実行と管理をサポートします。</p>

<blockquote class="important">
  <p><strong>メモ</strong></p>

  <p><strong>Docker Compose CLI はベータ版です</strong>。
インストール処理、コマンド、フラグは、将来のリリースにおいて変更されることがあります。</p>
</blockquote>

<h3 id="prerequisites">前提条件</h3>

<ul>
  <li><a href="https://docs.docker.com/get-docker/">Docker 19.03 またはそれ以降</a></li>
</ul>

<h3 id="install-script">インストールスクリプト</h3>

<p>インストールスクリプトを使えば、新たな CLI をインストールできます。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">curl -L https://raw.githubusercontent.com/docker/compose-cli/main/scripts/install/install_linux.sh | sh
</span></code></pre></div></div>

<h2 id="faq">FAQ</h2>

<p><strong><code class="highlighter-rouge">this tool requires the "new ARN resource ID format"</code> というエラーはどんな意味？</strong></p>

<p>このエラーメッセージは、利用アカウントに対しては ECS 向けの新たな ARN リソース ID フォーマットが必要であることを示しています。
詳しくは <a href="https://aws.amazon.com/blogs/compute/migrating-your-amazon-ecs-deployment-to-the-new-arn-and-resource-id-format-2/" target="_blank" class="_">Migrating your Amazon ECS deployment to the new ARN and resource ID format</a> を参照してください。</p>

<h2 id="feedback">フィードバック</h2>

<p>Docker Compose CLI を利用していただき、ありがとうございます。
みなさんからのフィードバックが大変重要です。
フィードバックをいただくには、Github レポジトリ <a href="https://github.com/docker/compose-cli" target="_blank" class="_">Compose CLI</a> に issue をあげてください。</p>
<span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span style="vertical-align: 2px"><a href="/docs.docker.jp.onthefly/search/?q=Docker">Docker</a>, <a href="/docs.docker.jp.onthefly/search/?q=AWS">AWS</a>, <a href="/docs.docker.jp.onthefly/search/?q=ECS">ECS</a>, <a href="/docs.docker.jp.onthefly/search/?q=Integration">Integration</a>, <a href="/docs.docker.jp.onthefly/search/?q=context">context</a>, <a href="/docs.docker.jp.onthefly/search/?q=Compose">Compose</a>, <a href="/docs.docker.jp.onthefly/search/?q=cli">cli</a>, <a href="/docs.docker.jp.onthefly/search/?q=deploy">deploy</a>, <a href="/docs.docker.jp.onthefly/search/?q=containers">containers</a>, <a href="/docs.docker.jp.onthefly/search/?q=cloud">cloud</a></span><div class="ratings-div"><div id="pd_rating_holder_8453675"></div></div></section>
                    </main>
                    <nav class="col-nav">
                        <div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
                            <div id="navbar" class="nav-sidebar">
    <ul class="nav jsTOCHorizontal hidden-md hidden-lg">
    </ul>
    <div class="divider hidden-md hidden-lg"></div>
    <ul class="nav" id="jsTOCLeftNav">
    </ul>
</div>

                        </div>
                    </nav>
                    <div class="col-toc">
                        <div class="sidebar hidden-xs hidden-sm">
                            <div class="toc-nav">
                                <div class="feedback-links">
                                    <ul><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/edit/master/src/engine/context/ecs-integration.ch"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 本ページの編集</a></li><li><a href="https://github.com/matsuand/docs.docker.jp.onthefly/issues/new?body=File: [engine/context/ecs-integration.md](https://docs.docker.com/engine/context/ecs-integration/)" class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 変更リクエスト</a></li>
                                        <li>
                                            <div class="toggle-mode">
                                                <div class="icon">
                                                    <i class="fa fa-sun-o" aria-hidden="true"></i>
                                                </div>
                                                <div class="toggle-switch">
                                                    <label class="switch">
                                                        <input type="checkbox" id="switch-style">
                                                        <div class="slider round"></div>
                                                    </label>
                                                </div>
                                                <div class="icon">
                                                    <i class="fa fa-moon-o" aria-hidden="true"></i>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div><div id="side-toc-title">本ページ内:</div>
<ul id="my_toc" class="inline_toc">
  <li><a href="#overview" class="nomunge">概要</a>
    <ul>
      <li><a href="#prerequisites" class="nomunge">前提条件</a></li>
      <li><a href="#run-compose-applications" class="nomunge">Compose アプリケーションの実行</a></li>
      <li><a href="#private-docker-images" class="nomunge">プライベートな Docker イメージ</a></li>
      <li><a href="#service-discovery" class="nomunge">サービスの検出</a></li>
      <li><a href="#tuning-the-cloudformation-template" class="nomunge">CloudFormation テンプレートの調整</a></li>
      <li><a href="#using-existing-aws-network-resources" class="nomunge">既存の AWS ネットワークリソースの利用</a></li>
      <li><a href="#local-simulation" class="nomunge">ローカルシミュレーション</a></li>
      <li><a href="#install-the-docker-compose-cli-on-linux" class="nomunge">Linux における Docker Compose CLI のインストール</a></li>
      <li><a href="#faq" class="nomunge">FAQ</a></li>
      <li><a href="#feedback" class="nomunge">フィードバック</a></li>
    </ul>
  </li>
</ul>

</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">
          
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/why-docker">なぜ Docker なのか？</a></b></li>
                        <li><a href="https://www.docker.com/what-container">コンテナーって何？</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/overview">製品</a></b></li>
                        <li><a href="https://www.docker.com/products/docker-desktop">Docker Desktop</a></li>
                        <li><a href="https://www.docker.com/products/docker-hub">Docker Hub</a></li>
                        <li><b><a href="https://www.docker.com/products/docker-desktop">機能</a></b></li>
                        <li><a href="https://www.docker.com/products/container-runtime">コンテナーランタイム</a></li>
                        <li><a href="https://www.docker.com/products/developer-tools">開発ツール</a></li>
                        <li><a href="https://www.docker.com/products/kubernetes">Kubernetes</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop">開発者</a></b></li>
                        <li><a href="https://www.docker.com/use-cases">利用例</a></li>
                        <li><a href="https://www.docker.com/play-with-docker">Docker で遊ぶ</a></li>
                        <li><a href="https://www.docker.com/docker-community">コミュニティ</a></li>
                        <li><a href="https://www.docker.com/open-source">オープンソース</a></li>
                        <li><a href="https://www.docker.com/community/docker-captains">Docker キャプテン</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/company" target="_blank">会社</a></b></li>
                        <li><a href="https://www.docker.com/company">概要</a></li>
                        <li><a href="https://www.docker.com/blog/" target="_blank">ブログ</a></li>
                        <li><a href="https://www.docker.com/customers">顧客</a></li>
                        <li><a href="https://www.docker.com/partners">パートナー</a></li>
                        <li><a href="https://www.docker.com/company/newsroom">ニュースルーム</a></li>
                        <li><a href="https://www.docker.com/careers">採用情報</a></li>
                        <li><a href="https://www.docker.com/company/contact">連絡先</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="http://status.docker.com/">ステータス</a></li>
                        <li><a href="https://www.docker.com/docker-security">セキュリティ</a></li>
                        <li><a href="https://www.docker.com/legal">法的情報</a></li>
                        <li><a href="https://www.docker.com/company/contact">連絡</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2013-2020 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="http://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="http://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-slideshare"><a href="https://www.slideshare.net/docker">Slideshare</a></li>
                    <li class="fa fa-reddit"><a href="https://www.reddit.com/r/docker">Reddit</a></li>
                </ul>
            </div>
        </div>
    </div>

    </footer>
    <script>const pageURL = "/engine/context/ecs-integration/";</script>
    <script defer src="/docs.docker.jp.onthefly/js/anchorlinks.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/menu.js"></script>
    <script src="/docs.docker.jp.onthefly/js/jquery.js"></script>
    <script src="/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
    <script src="/docs.docker.jp.onthefly/js/stickyfill.min.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/metadata.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/docs.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/toc.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/search.js"></script>
    <script>
        PDRTJS_settings_8453675 = {
            "id": "8453675",
            "unique_id": "engine/context/ecs-integration.md",
            "title": "ECS での Docker コンテナーのデプロイ",
            "permalink": "https://github.com/matsuand/docs.docker.jp.onthefly/blob/master/src/engine/context/ecs-integration.ch"
        };
        (function (d, c, j) {
            if (!document.getElementById(j)) {
                var pd = d.createElement(c), s;
                pd.id = j;
                pd.src = ('https:' === document.location.protocol) ? 'https://polldaddy.com/js/rating/rating.js' : 'http://i0.poll.fm/js/rating/rating.js';
                s = document.getElementsByTagName(c)[0];
                s.parentNode.insertBefore(pd, s);
            }
        }(document, 'script', 'pd-rating-js'));
    </script>
</body>
</html>
