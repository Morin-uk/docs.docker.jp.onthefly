
<p>Docker デーモンが停止すると、デフォルトでは起動中のコンテナーも停止します。
Docker Engine 1.12 から導入された機能として、デーモンが利用できなくなってもコンテナーが起動し続けるように設定できるようになりました。
この機能のことを <strong>ライブリストア</strong>（live restore）と呼びます。
ライブリストアのオプションを使えば、デーモンの障害時、計画停電時、システム更新時などに伴うコンテナーのダウンタイムを軽減できます。</p>

<blockquote>
  <p><strong>メモ</strong></p>

  <p>ライブリストアは Windows コンテナーに対応していません。
ただし Docker Desktop for Windows 上にて動作する Linux コンテナーには対応しています。</p>
</blockquote>

<h2 id="enable-live-restore">ライブリストア有効化</h2>

<p>ライブリストアを有効にする方法は２つあります。
デーモンが利用不能になっても、これによりコンテナーを起動し続けることができます。
ただしこれを行うのは <strong>２つのうちのいずれか１つ</strong> としてください。</p>

<ul>
  <li>
    <p>デーモン設定ファイルに設定を加えます。
Linux の場合、設定ファイルのデフォルトは <code class="language-plaintext highlighter-rouge">/etc/docker/daemon.json</code> です。
また Docker Desktop for Mac あるいは Docker Desktop for Windows の場合は、タスクバー上の Docker アイコンを選び、
<strong>Preferences</strong> -&gt; <strong>Daemon</strong> -&gt; <strong>Advanced</strong> をクリックします。</p>

    <ul>
      <li>
        <p>以下の JSON 記述を加えて <code class="language-plaintext highlighter-rouge">live-restore</code> を有効にします。</p>

        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"live-restore"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>        </div>
      </li>
      <li>
        <p>Docker デーモンを再起動します。
Linux の場合、再起動はせず（いずれのコンテナー停止も避けるために）Docker デーモンのリロードを行うこともできます。
<code class="language-plaintext highlighter-rouge">systemd</code> 利用時は <code class="language-plaintext highlighter-rouge">systemctl reload docker</code> コマンドを実行します。
それ以外の場合は <code class="language-plaintext highlighter-rouge">dockerd</code> プロセスに対して <code class="language-plaintext highlighter-rouge">SIGHUP</code> シグナルを送信します。</p>
      </li>
    </ul>
  </li>
  <li>
    <p>上とは別に、<code class="language-plaintext highlighter-rouge">dockerd</code> プロセスを手動で起動する際に <code class="language-plaintext highlighter-rouge">--live-restore</code> フラグを与える方法もあります。
ただしこの方法は推奨されません。
この方法によると Docker プロセス起動時に、<code class="language-plaintext highlighter-rouge">systemd</code> や他のプロセスが利用可能な環境を作り出していないからです。
このことが予期しない動作となることがあります。</p>
  </li>
</ul>

<h2 id="live-restore-during-upgrades">デーモン更新時のライブリストア</h2>

<p>ライブリストアの機能により、Docker デーモンの更新中でもコンテナーを起動し続けることができます。
ただしパッチリリース (<code class="language-plaintext highlighter-rouge">YY.MM.x</code>) のインストール時のみが対象であって、メジャーアップデート (<code class="language-plaintext highlighter-rouge">YY.MM</code>) の場合はサポートされません。</p>

<p>各アップデートのリリースを１度でも取りやめていた場合、デーモンによるコンテナーへの接続が復元できなくなる場合があります。
コンテナーへの接続が復元できなかった場合、起動中のコンテナーを制御できなくなっているので、手動でコンテナーを停止させる必要があります。</p>

<h2 id="live-restore-upon-restart">再起動時のライブリストア</h2>

<p>ライブリストアのオプションによってコンテナーが復元されるのは、デーモンのオプション、たとえばブリッジ IP アドレスやグラフドライバーなどに変更がない場合に限ります。
そのようなデーモンレベルの設定オプションのいずれかが変更されていた場合、ライブリストアは機能しない場合があります。
そのときは手動でコンテナーを停止させる必要があります。</p>

<h2 id="impact-of-live-restore-on-running-containers">実行コンテナーに対するライブリストアの影響</h2>

<p>デーモンが長い期間停止している場合、実行中のコンテナーが普段デーモンが読み込んでいる FIFO ログを、出力し続けているかもしれません。
ログがあふれてしまうと、コンテナーのログ出力はそれ以上できなくなります。
デフォルトのバッファーサイズは 64K です。
このバッファーがいっぱいになった場合は、これをフラッシュするために Docker デーモンを再起動する必要があります。</p>

<p>Linux の場合、<code class="language-plaintext highlighter-rouge">/proc/sys/fs/pipe-max-size</code> の値を編集することで、カーネルバッファーサイズを変更することができます。
Docker Desktop for Mac や Docker Desktop for Windows では、このバッファサイズを変更することはできません。</p>

<h2 id="live-restore-and-swarm-mode">ライブリストアと Swarm モード</h2>

<p>ライブリストアオプションはスタンドアロンコンテナーに対するものであって、Swarm サービスには適用されません。
Swarm サービスは Swarm マネージャーによって管理されます。
Swarm マネージャーが利用できないときに、Swarm サービスはワーカーノード上において起動を続けます。
ただし Swarm マネージャーが管理できる状態になるまで、Swarm サービスを管理することはできません。</p>
