
<p>Docker では <a href="/docs.docker.jp.onthefly/engine/reference/run/#restart-policies---restart">再起動ポリシー</a> (restart policy) が提供されています。
これは Docker の停止や再起動を指示した場合に、コンテナーを自動的に起動するかどうかを制御するものです。
再起動ポリシーを使えば、リンクしているコンテナーは確実に正しい順番で起動させることができます。
Docker ではこの再起動ポリシーを利用することが推奨されています。
プロセスマネージャーを利用してコンテナーを起動することはやめてください。</p>

<p>再起動ポリシーは <code class="language-plaintext highlighter-rouge">dockerd</code> コマンドの <code class="language-plaintext highlighter-rouge">--live-restore</code> フラグとは異なります。
<code class="language-plaintext highlighter-rouge">--live-restore</code> は Docker のアップグレード中にコンテナーを起動し続けるものですが、ネットワーク接続やユーザー入力は遮断されます。</p>

<h2 id="use-a-restart-policy">再起動ポリシーの利用</h2>

<p>コンテナーに対して再起動ポリシーを設定するには、<code class="language-plaintext highlighter-rouge">docker run</code> コマンド実行時の <code class="language-plaintext highlighter-rouge">--restart</code> フラグを用います。
<code class="language-plaintext highlighter-rouge">--restart</code> フラグには以下に示す値を指定することができます。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">フラグ</th>
      <th style="text-align: left">内容説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">no</code></td>
      <td style="text-align: left">コンテナーを自動では再起動しません。（デフォルト）</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">on-failure</code></td>
      <td style="text-align: left">エラー発生により停止したコンテナーを再起動します。非ゼロの終了コードが返ります。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">always</code></td>
      <td style="text-align: left">コンテナー停止時に常に再起動します。手動で停止させた場合は、Docker デーモン再起動時、あるいはコンテナーそのものが手動で再起動された場合のみ再起動します。 (<a href="#restart-policy-details">再起動ポリシーの詳細</a> における 2 項めを参照してください。)</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">unless-stopped</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">always</code> と同様。ただしコンテナーが（手動またはその他によって）停止した場合は除きます。Docker デーモンが再起動した場合には再起動しません。</td>
    </tr>
  </tbody>
</table>

<p>以下の例は Redis コンテナーを起動する際に、常に (always) 再起動するように設定していますが、ただし明示的に停止した場合や Docker が再起動された場合には再起動しないという設定です。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">--restart</span> unless-stopped redis
</code></pre></div></div>

<p>以下のコマンドは、<code class="language-plaintext highlighter-rouge">redis</code> というすでに起動されているコンテナーの再起動ポリシーを変更します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker update <span class="nt">--restart</span> unless-stopped redis
</code></pre></div></div>

<p>また以下のコマンドは、現在あるコンテナーの中で、停止されていてないものはすべて再起動します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker update <span class="nt">--restart</span> unless-stopped <span class="si">$(</span>docker ps <span class="nt">-q</span><span class="si">)</span>
</code></pre></div></div>

<h3 id="restart-policy-details">再起動ポリシーの詳細</h3>

<p>再起動ポリシーの利用にあたっては以下の点に注意してください。</p>

<ul>
  <li>
    <p>再起動ポリシーが処理適用されるのは、コンテナーが正常に起動した後です。
この正常に起動というのは、コンテナーの起動から 10 秒以上が経過し Docker がこれを監視し始めたときです。
このようになっているのは、コンテナーが全く起動していないまま再起動ループに陥ることがないようにするためです。</p>
  </li>
  <li>
    <p>コンテナーを手動で停止した場合は、Docker デーモンの再起動、あるいはコンテナーの手動再起動を行わない限り、再起動ポリシーは無視されます。
これも再起動ループを避けるための動作です。</p>
  </li>
  <li>
    <p>再起動ポリシーが適用されるのは <strong>コンテナー</strong> に対してのみです。
Swarm サービスに対する再起動ポリシーは、別の方法により設定します。
<a href="/docs.docker.jp.onthefly/engine/reference/commandline/service_create/">service restart に対するフラグ</a> を参照してください。</p>
  </li>
</ul>

<h2 id="use-a-process-manager">プロセスマネージャーの利用</h2>

<p>Docker 外部にあるプロセスが Docker コンテナーに依存するような場合、再起動ポリシーの利用は適当ではありません。
この場合は <a href="http://upstart.ubuntu.com/">upstart</a>、<a href="https://freedesktop.org/wiki/Software/systemd/">systemd</a>、<a href="http://supervisord.org/">supervisor</a> といったプロセスマネージャーを利用します。</p>

<blockquote class="warning">
  <p><strong>警告</strong></p>

  <p>Docker の再起動ポリシーとホストのプロセスマネージャーを組み合わせた利用は避けてください。
これを行うと衝突が発生します。</p>
</blockquote>

<p>プロセスマネージャーを利用する場合は、普段コンテナー起動を手動で行っているときと同じコマンド
<code class="language-plaintext highlighter-rouge">docker start</code> または <code class="language-plaintext highlighter-rouge">docker service</code> を使って、コンテナーを起動するように設定してください。
詳しくは個々のプロセスマネージャーのドキュメントを参照してください。</p>

<h3 id="using-a-process-manager-inside-containers">コンテナー内部のプロセスマネージャーの利用</h3>

<p>プロセスマネージャーはコンテナー内部において起動させることができます。
このプロセスマネージャーから、プロセスの実行状態を確認したり、起動、再起動を行うこともできます。</p>

<blockquote class="warning">
  <p><strong>警告</strong></p>

  <p>この場合は Docker が察知できる状況ではなくなり、コンテナー内のオペレーティングシステムのプロセスをただ監視するだけになります。
Docker ではこの方法を推奨しません。
これはプラットフォームに依存する話であり、利用する Linux ディストリビューションの各バージョンによって異なるからです。</p>
</blockquote>
