
<p>ログドライバー <code class="language-plaintext highlighter-rouge">journald</code> は、コンテナーのログを <a href="https://www.freedesktop.org/software/systemd/man/systemd-journald.service.html"><code class="language-plaintext highlighter-rouge">systemd</code> ジャーナル</a> へ送信します。
ログ出力された各項目は、<code class="language-plaintext highlighter-rouge">journal</code> API の利用を通じて <code class="language-plaintext highlighter-rouge">journalctl</code> コマンドを使って確認することができます。
または <code class="language-plaintext highlighter-rouge">docker logs</code> コマンドを使って確認することもできます。</p>

<p><code class="language-plaintext highlighter-rouge">journald</code> ログドライバーはジャーナル内において、元のログメッセージに加えて、以下のメタデータを保存します。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">項目</th>
      <th style="text-align: left">内容説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">CONTAINER_ID</code></td>
      <td style="text-align: left">The container ID truncated to 12 characters.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">CONTAINER_ID_FULL</code></td>
      <td style="text-align: left">64 文字からなる完全なコンテナー ID。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">CONTAINER_NAME</code></td>
      <td style="text-align: left">ログ出力開始時点でのコンテナー名。<code class="language-plaintext highlighter-rouge">docker rename</code> によりコンテナー名を変更しても、ジャーナルエントリには新たな名称は反映されません。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">CONTAINER_TAG</code>, <code class="language-plaintext highlighter-rouge">SYSLOG_IDENTIFIER</code></td>
      <td style="text-align: left">The container tag (<a href="/docs.docker.jp.onthefly/config/containers/logging/log_tags/">log tag option documentation</a>).</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">CONTAINER_PARTIAL_MESSAGE</code></td>
      <td style="text-align: left">A field that flags log integrity. Improve logging of long log lines.</td>
    </tr>
  </tbody>
</table>

<h2 id="usage">利用方法</h2>

<p>デフォルトのログドライバーとして <code class="language-plaintext highlighter-rouge">journald</code> を設定するには、<code class="language-plaintext highlighter-rouge">daemon.json</code> ファイル内において、<code class="language-plaintext highlighter-rouge">log-driver</code> と <code class="language-plaintext highlighter-rouge">log-opt</code> キーを適切に設定します。
<code class="language-plaintext highlighter-rouge">daemon.json</code> は Linux ホストの場合は <code class="language-plaintext highlighter-rouge">/etc/docker/</code> に、また Windows Server の場合は <code class="language-plaintext highlighter-rouge">C:\ProgramData\docker\config\daemon.json</code> にあります。
<code class="language-plaintext highlighter-rouge">daemon.json</code> を用いた Docker の設定方法については <a href="/docs.docker.jp.onthefly/engine/reference/commandline/dockerd/#daemon-configuration-file">daemon.json</a> を参照してください。</p>

<p>以下の例により、ログドライバーを <code class="language-plaintext highlighter-rouge">journald</code> に設定します。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"log-driver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"journald"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>変更内容を有効にするために Docker デーモンを再起動します。</p>

<p>このログドライバーを特定のコンテナーに対して設定するには、<code class="language-plaintext highlighter-rouge">docker run</code> コマンドにおいて <code class="language-plaintext highlighter-rouge">--log-driver</code> フラグを指定します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">--log-driver</span><span class="o">=</span>journald ...
</code></pre></div></div>

<h2 id="options">オプション</h2>

<p>ログドライバー <code class="language-plaintext highlighter-rouge">journald</code> のオプションを指定するには <code class="language-plaintext highlighter-rouge">--log-opt NAME=VALUE</code> フラグを利用します。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">オプション</th>
      <th style="text-align: left">Required</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">tag</code></td>
      <td style="text-align: left">optional</td>
      <td style="text-align: left">Specify template to set <code class="language-plaintext highlighter-rouge">CONTAINER_TAG</code> and <code class="language-plaintext highlighter-rouge">SYSLOG_IDENTIFIER</code> value in journald logs. Refer to <a href="/docs.docker.jp.onthefly/config/containers/logging/log_tags/">log tag option documentation</a> to customize the log tag format.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">labels</code></td>
      <td style="text-align: left">optional</td>
      <td style="text-align: left">Comma-separated list of keys of labels, which should be included in message, if these labels are specified for the container.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">env</code></td>
      <td style="text-align: left">optional</td>
      <td style="text-align: left">Comma-separated list of keys of environment variables, which should be included in message, if these variables are specified for the container.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">env-regex</code></td>
      <td style="text-align: left">optional</td>
      <td style="text-align: left">Similar to and compatible with env. A regular expression to match logging-related environment variables. Used for advanced <a href="/docs.docker.jp.onthefly/config/containers/logging/log_tags/">log tag options</a>.</td>
    </tr>
  </tbody>
</table>

<p>If a collision occurs between label and env keys, the value of the env takes
precedence. Each option adds additional fields to the attributes of a logging
message.</p>

<p>Below is an example of the logging options required to log to journald.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="se">\</span>
    <span class="nt">--log-driver</span><span class="o">=</span>journald <span class="se">\</span>
    <span class="nt">--log-opt</span> <span class="nv">labels</span><span class="o">=</span>location <span class="se">\</span>
    <span class="nt">--log-opt</span> <span class="nb">env</span><span class="o">=</span>TEST <span class="se">\</span>
    <span class="nt">--env</span> <span class="s2">"TEST=false"</span> <span class="se">\</span>
    <span class="nt">--label</span> <span class="nv">location</span><span class="o">=</span>west <span class="se">\</span>
    your/application
</code></pre></div></div>

<p>This configuration also directs the driver to include in the payload the label
location, and the environment variable TEST.  If the <code class="language-plaintext highlighter-rouge">--env "TEST=false"</code>
or <code class="language-plaintext highlighter-rouge">--label location=west</code> arguments were omitted, the corresponding key would
not be set in the journald log.</p>

<h2 id="note-regarding-container-names">コンテナー名に関するメモ</h2>

<p>The value logged in the <code class="language-plaintext highlighter-rouge">CONTAINER_NAME</code> field is the name of the container that
was set at startup. If you use <code class="language-plaintext highlighter-rouge">docker rename</code> to rename a container, the new
name <strong>is not reflected</strong> in the journal entries. Journal entries continue
to use the original name.</p>

<h2 id="retrieve-log-messages-with-journalctl"><code class="language-plaintext highlighter-rouge">journalctl</code> を使ったログメッセージの確認</h2>

<p>Use the <code class="language-plaintext highlighter-rouge">journalctl</code> command to retrieve log messages. You can apply filter
expressions to limit the retrieved messages to those associated with a specific
container:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>journalctl <span class="nv">CONTAINER_NAME</span><span class="o">=</span>webserver
</code></pre></div></div>

<p>You can use additional filters to further limit the messages retrieved. The <code class="language-plaintext highlighter-rouge">-b</code>
flag only retrieves messages generated since the last system boot:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>journalctl <span class="nt">-b</span> <span class="nv">CONTAINER_NAME</span><span class="o">=</span>webserver
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">-o</code> flag specifies the format for the retried log messages. Use <code class="language-plaintext highlighter-rouge">-o json</code>
to return the log messages in JSON format.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>journalctl <span class="nt">-o</span> json <span class="nv">CONTAINER_NAME</span><span class="o">=</span>webserver
</code></pre></div></div>

<h3 id="view-logs-for-a-container-with-a-tty-enabled">View logs for a container with a TTY enabled</h3>

<p>If TTY is enabled on a container you may see <code class="language-plaintext highlighter-rouge">[10B blob data]</code> in the output
when retrieving log messages.
The reason for that is that <code class="language-plaintext highlighter-rouge">\r</code> is appended to the end of the line and
<code class="language-plaintext highlighter-rouge">journalctl</code> doesn’t strip it automatically unless <code class="language-plaintext highlighter-rouge">--all</code> is set:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>journalctl <span class="nt">-b</span> <span class="nv">CONTAINER_NAME</span><span class="o">=</span>webserver <span class="nt">--all</span>
</code></pre></div></div>

<h2 id="retrieve-log-messages-with-the-journal-api">Retrieve log messages with the <code class="language-plaintext highlighter-rouge">journal</code> API</h2>

<p>This example uses the <code class="language-plaintext highlighter-rouge">systemd</code> Python module to retrieve container
logs:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">systemd.journal</span>

<span class="n">reader</span> <span class="o">=</span> <span class="n">systemd</span><span class="p">.</span><span class="n">journal</span><span class="p">.</span><span class="n">Reader</span><span class="p">()</span>
<span class="n">reader</span><span class="p">.</span><span class="n">add_match</span><span class="p">(</span><span class="s">'CONTAINER_NAME=web'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">'{CONTAINER_ID_FULL}: {MESSAGE}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="o">**</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div></div>
