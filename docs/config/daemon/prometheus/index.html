
<p><a href="https://prometheus.io/">Prometheus</a> はシステム監視や警告を行うオープンソースのツールキットです。
この Prometheus の対象として Docker を設定することができます。
ここでは Docker の設定、Docker コンテナーとしての Prometheus の設定、Prometheus を使った Docker インスタンスの監視について示します。</p>

<blockquote>
  <p><strong>警告</strong>: 利用可能なメトリックスおよびその名称は、現在開発中のものであるため、随時変更されます。</p>
</blockquote>

<p>現時点において監視できる対象は Docker そのものです。
Docker ターゲットとしてアプリケーションを監視することは、今のところできません。</p>

<h2 id="configure-docker">Docker の設定</h2>

<p>Docker デーモンを Prometheus のターゲットとして設定するには、<code class="language-plaintext highlighter-rouge">metrics-address</code> を指定する必要があります。
これを行う一番良い方法は <code class="language-plaintext highlighter-rouge">daemon.json</code> に記述することです。
デフォルトにおいて <code class="language-plaintext highlighter-rouge">daemon.json</code> は以下に示すいずれかのディレクトリにあります。
もしこのファイルが存在していない場合は、新規に生成します。</p>

<ul>
  <li><strong>Linux</strong>: <code class="language-plaintext highlighter-rouge">/etc/docker/daemon.json</code></li>
  <li><strong>Windows Server</strong>: <code class="language-plaintext highlighter-rouge">C:\ProgramData\docker\config\daemon.json</code></li>
  <li><strong>Docker Desktop for Mac / Docker Desktop for Windows</strong>:
ツールバーの Docker アイコンをクリック、<strong>Preferences</strong>、<strong>Daemon</strong> を選択。<strong>Advanced</strong> をクリック。</li>
</ul>

<p>このファイルが空であった場合は、以下の内容を貼り付けます。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"metrics-addr"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"127.0.0.1:9323"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"experimental"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>このファイルが空でなかった場合は、上の 2 つのキーを追加します。
書き加えた結果は正しい JSON フォーマットでなければなりません。
最終行を除き、各行の終わりはカンマ（<code class="language-plaintext highlighter-rouge">,</code>）が必要です。</p>

<p>ファイルを保存します。
また Docker Desktop for Mac や Docker Desktop for Windows を利用している場合は、設定を保存します。
そして Docker を再起動します。</p>

<p>これにより Docker は、Prometheus 互換メトリックスをポート 9323 番にて公開することになります。</p>

<h2 id="configure-and-run-prometheus">Prometheus の設定と実行</h2>

<p>Docker swarm 上の Docker サービスとして Prometheus を実行します。</p>

<blockquote>
  <p><strong>前提条件</strong></p>

  <ol>
    <li>
      <p>1 つまたは複数の Docker Engine が参加して 1 つの Docker Swarm が形成されていること。
つまり 1 つのマネージャー上から <code class="language-plaintext highlighter-rouge">docker swarm init</code> を実行しているか、あるいは他のマネージャーやワーカーノードから <code class="language-plaintext highlighter-rouge">docker swarm join</code> を実行していること。</p>
    </li>
    <li>
      <p>Prometheus イメージをプルできるように、インターネット接続ができていること。</p>
    </li>
  </ol>
</blockquote>

<p>以下の設定ファイルの内容をいずれかコピーして、（Linux や Mac の場合）<code class="language-plaintext highlighter-rouge">/tmp/prometheus.yml</code>、（Windows の場合）<code class="language-plaintext highlighter-rouge">C:\tmp\prometheus.yml</code> に保存してください。
これは Prometheus のごく普通の設定ファイルです。
ただしファイルの最後段には Docker の処理定義を加えています。
Docker Desktop for Mac や Docker Desktop for Windows では、多少異なる設定が必要となります。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" data-target="#linux-config" data-group="linux">Docker for Linux</a></li>
  <li><a data-toggle="tab" data-target="#mac-config" data-group="mac">Docker Desktop for Mac</a></li>
  <li><a data-toggle="tab" data-target="#win-config" data-group="win">Docker Desktop for Windows</a></li>
</ul>

<div class="tab-content">
  <div id="linux-config" class="tab-pane fade in active">

    <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># グローバルな設定。</span>
<span class="na">global</span><span class="pi">:</span>
  <span class="na">scrape_interval</span><span class="pi">:</span>     <span class="s">15s</span> <span class="c1"># 情報を取り出す(scrapeする)間隔を15秒ごとに。デフォルトは1分ごと。</span>
  <span class="na">evaluation_interval</span><span class="pi">:</span> <span class="s">15s</span> <span class="c1"># 15秒ごとにルールを評価。デフォルトは1分ごと。</span>
  <span class="c1"># scrape_timeout はグローバルなデフォルト値(10s)に設定。</span>

  <span class="c1"># Attach these labels to any time series or alerts when communicating with</span>
  <span class="c1"># external systems (federation, remote storage, Alertmanager).</span>
  <span class="na">external_labels</span><span class="pi">:</span>
      <span class="na">monitor</span><span class="pi">:</span> <span class="s1">'</span><span class="s">codelab-monitor'</span>

<span class="c1"># ルールを一度ロードし、以降はグローバルな 'evaluation_interval' に従って定期的に評価。</span>
<span class="na">rule_files</span><span class="pi">:</span>
  <span class="c1"># - "first.rules"</span>
  <span class="c1"># - "second.rules"</span>

<span class="c1"># A scrape configuration containing exactly one endpoint to scrape:</span>
<span class="c1"># ここが Prometheus の設定そのもの。</span>
<span class="na">scrape_configs</span><span class="pi">:</span>
  <span class="c1"># この設定から取得されるすべてのタイムシリーズにて、ジョブ名は `job=&lt;job_name&gt;` というラベルとして追加。</span>
  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">prometheus'</span>

    <span class="c1"># metrics_path のデフォルトを '/metrics' に。</span>
    <span class="c1"># スキームのデフォルトを 'http' に。</span>

    <span class="na">static_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">localhost:9090'</span><span class="pi">]</span>

  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">docker'</span>
         <span class="c1"># metrics_path のデフォルトを '/metrics' に。</span>
         <span class="c1"># スキームのデフォルトを 'http' に。</span>

    <span class="na">static_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">localhost:9323'</span><span class="pi">]</span>
</code></pre></div>    </div>

  </div>
  <!-- linux -->
  <div id="mac-config" class="tab-pane fade">

    <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># グローバルな設定。</span>
<span class="na">global</span><span class="pi">:</span>
  <span class="na">scrape_interval</span><span class="pi">:</span>     <span class="s">15s</span> <span class="c1"># 情報を取り出す(scrapeする)間隔を15秒ごとに。デフォルトは1分ごと。</span>
  <span class="na">evaluation_interval</span><span class="pi">:</span> <span class="s">15s</span> <span class="c1"># 15秒ごとにルールを評価。デフォルトは1分ごと。</span>
  <span class="c1"># scrape_timeout はグローバルなデフォルト値(10s)に設定。</span>

  <span class="c1"># Attach these labels to any time series or alerts when communicating with</span>
  <span class="c1"># external systems (federation, remote storage, Alertmanager).</span>
  <span class="na">external_labels</span><span class="pi">:</span>
      <span class="na">monitor</span><span class="pi">:</span> <span class="s1">'</span><span class="s">codelab-monitor'</span>

<span class="c1"># ルールを一度ロードし、以降はグローバルな 'evaluation_interval' に従って定期的に評価。</span>
<span class="na">rule_files</span><span class="pi">:</span>
  <span class="c1"># - "first.rules"</span>
  <span class="c1"># - "second.rules"</span>

<span class="c1"># A scrape configuration containing exactly one endpoint to scrape:</span>
<span class="c1"># Here it's Prometheus itself.</span>
<span class="na">scrape_configs</span><span class="pi">:</span>
  <span class="c1"># この設定から取得されるすべてのタイムシリーズにて、ジョブ名は `job=&lt;job_name&gt;` というラベルとして追加。</span>
  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">prometheus'</span>

    <span class="c1"># metrics_path のデフォルトを '/metrics' に。</span>
    <span class="c1"># スキームのデフォルトを 'http' に。</span>

    <span class="na">static_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">host.docker.internal:9090'</span><span class="pi">]</span> <span class="c1"># Docker Desktop for Mac においてのみ動作。</span>

  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">docker'</span>
         <span class="c1"># metrics_path のデフォルトを '/metrics' に。</span>
         <span class="c1"># スキームのデフォルトを 'http' に。</span>

    <span class="na">static_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">docker.for.mac.host.internal:9323'</span><span class="pi">]</span>
</code></pre></div>    </div>

  </div>
  <!-- mac -->
  <div id="win-config" class="tab-pane fade">

    <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># グローバルな設定</span>
<span class="na">global</span><span class="pi">:</span>
  <span class="na">scrape_interval</span><span class="pi">:</span>     <span class="s">15s</span> <span class="c1"># 情報を取り出す(scrapeする)間隔を15秒ごとに。デフォルトは1分ごと。</span>
  <span class="na">evaluation_interval</span><span class="pi">:</span> <span class="s">15s</span> <span class="c1"># 15秒ごとにルールを評価。デフォルトは1分ごと。</span>
  <span class="c1"># scrape_timeout はグローバルなデフォルト値(10s)に設定。</span>

  <span class="c1"># Attach these labels to any time series or alerts when communicating with</span>
  <span class="c1"># external systems (federation, remote storage, Alertmanager).</span>
  <span class="na">external_labels</span><span class="pi">:</span>
      <span class="na">monitor</span><span class="pi">:</span> <span class="s1">'</span><span class="s">codelab-monitor'</span>

<span class="c1"># ルールを一度ロードし、以降はグローバルな 'evaluation_interval' に従って定期的に評価</span>
<span class="na">rule_files</span><span class="pi">:</span>
  <span class="c1"># - "first.rules"</span>
  <span class="c1"># - "second.rules"</span>

<span class="c1"># A scrape configuration containing exactly one endpoint to scrape:</span>
<span class="c1"># Here it's Prometheus itself.</span>
<span class="na">scrape_configs</span><span class="pi">:</span>
  <span class="c1"># この設定から取得されるすべてのタイムシリーズにて、ジョブ名は `job=&lt;job_name&gt;` というラベルとして追加。</span>
  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">prometheus'</span>

    <span class="c1"># metrics_path のデフォルトを '/metrics' に。</span>
    <span class="c1"># スキームのデフォルトを 'http' に。</span>

    <span class="na">static_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">host.docker.internal:9090'</span><span class="pi">]</span> <span class="c1"># Docker Desktop for Windows でのみ動作。</span>

  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">docker'</span>
         <span class="c1"># metrics_path のデフォルトを '/metrics' に。</span>
         <span class="c1"># スキームのデフォルトを 'http' に。</span>

    <span class="na">static_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">192.168.65.1:9323'</span><span class="pi">]</span>
</code></pre></div>    </div>

  </div>
  <!-- windows -->
</div>
<!-- tabs -->

<p>次にこの設定を使って、単一レプリカとなる Prometheus サービスを起動します。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" data-target="#linux-run" data-group="linux">Docker for Linux</a></li>
  <li><a data-toggle="tab" data-target="#mac-run" data-group="mac">Docker Desktop for Mac</a></li>
  <li><a data-toggle="tab" data-target="#win-run" data-group="win">Docker Desktop for Windows または Windows Server</a></li>
</ul>

<div class="tab-content">
  <div id="linux-run" class="tab-pane fade in active">

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service create <span class="nt">--replicas</span> 1 <span class="nt">--name</span> my-prometheus <span class="se">\</span>
    <span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/tmp/prometheus.yml,destination<span class="o">=</span>/etc/prometheus/prometheus.yml <span class="se">\</span>
    <span class="nt">--publish</span> <span class="nv">published</span><span class="o">=</span>9090,target<span class="o">=</span>9090,protocol<span class="o">=</span>tcp <span class="se">\</span>
    prom/prometheus
</code></pre></div>    </div>

  </div>
  <!-- linux -->
  <div id="mac-run" class="tab-pane fade">

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service create <span class="nt">--replicas</span> 1 <span class="nt">--name</span> my-prometheus <span class="se">\</span>
    <span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/tmp/prometheus.yml,destination<span class="o">=</span>/etc/prometheus/prometheus.yml <span class="se">\</span>
    <span class="nt">--publish</span> <span class="nv">published</span><span class="o">=</span>9090,target<span class="o">=</span>9090,protocol<span class="o">=</span>tcp <span class="se">\</span>
    prom/prometheus
</code></pre></div>    </div>

  </div>
  <!-- mac -->
  <div id="win-run" class="tab-pane fade">

    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">PS</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">docker</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nt">--replicas</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="nt">--name</span><span class="w"> </span><span class="nx">my-prometheus</span><span class="w">
    </span><span class="nt">--mount</span><span class="w"> </span><span class="kr">type</span><span class="o">=</span><span class="nf">bind</span><span class="p">,</span><span class="nx">source</span><span class="o">=</span><span class="nf">C:/tmp/prometheus.yml</span><span class="p">,</span><span class="nx">destination</span><span class="o">=</span><span class="nf">/etc/prometheus/prometheus.yml</span><span class="w">
    </span><span class="nt">--publish</span><span class="w"> </span><span class="nx">published</span><span class="o">=</span><span class="mi">9090</span><span class="p">,</span><span class="nf">target</span><span class="o">=</span><span class="mi">9090</span><span class="p">,</span><span class="nf">protocol</span><span class="o">=</span><span class="nf">tcp</span><span class="w">
    </span><span class="nx">prom/prometheus</span><span class="w">
</span></code></pre></div>    </div>

  </div>
  <!-- windows -->
</div>
<!-- tabs -->

<p>http://localhost:9090/targets/ にアクセスして Docker ターゲットが一覧表示されていることを確認します。</p>

<p><img src="/docs.docker.jp.onthefly/config/daemon/images/prometheus-targets.png" alt="Prometheus ターゲットページ" /></p>

<p>Docker Desktop for Mac や Docker Desktop for Windows を利用している場合は、エンドポイント URL に直接アクセスすることはできません。</p>

<h2 id="use-prometheus">Prometheus の利用</h2>

<p>グラフを生成します。
Prometheus UI 画面の <strong>Graphs</strong> リンクをクリックします。
そして <strong>Execute</strong> ボタンの右にあるコンボボックスからメトリックを選び <strong>Execute</strong> をクリックします。
以下に示すスクリーンショットは <code class="language-plaintext highlighter-rouge">engine_daemon_network_actions_seconds_count</code> に対するグラフを示しています。</p>

<p><img src="/docs.docker.jp.onthefly/config/daemon/images/prometheus-graph_idle.png" alt="Prometheus engine_daemon_network_actions_seconds_count report" /></p>

<p>上のグラフは Docker インスタンスがアイドル状態であることを表わします。
作業をし始めると、このグラフは変化していきます。</p>

<p>このグラフが変化していくことを見るために、ネットワーク処理を生成してみます。
1 つのサービスに 10 個のタスクを用意し、Docker に対して停止なしに ping を打ち続けるようにします。
（ping 先は好きなように変更してください。）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service create <span class="se">\</span>
  <span class="nt">--replicas</span> 10 <span class="se">\</span>
  <span class="nt">--name</span> ping_service <span class="se">\</span>
  alpine ping docker.com
</code></pre></div></div>

<p>ほんの数分（デフォルトとした scrape interval 15 秒）待って、グラフを再表示してみます。</p>

<p><img src="/docs.docker.jp.onthefly/config/daemon/images/prometheus-graph_load.png" alt="Prometheus の engine_daemon_network_actions_seconds_count レポート" /></p>

<p>確認ができたら、サービス <code class="language-plaintext highlighter-rouge">ping_service</code> を停止して削除します。
こうして、余計な ping によってホストが溢れないようにします。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker service remove ping_service
</code></pre></div></div>

<p>しばらくしてみると、このグラフがまたアイドル状態に戻るはずです。</p>

<h2 id="next-steps">次のステップ</h2>

<ul>
  <li><a href="https://prometheus.io/docs/introduction/overview/" target="_blank" rel="noopener" class="_">Prometheus のドキュメント</a> を読む。</li>
  <li><a href="https://prometheus.io/docs/alerting/overview/" target="_blank" rel="noopener" class="_">警告</a> を設定してみる。</li>
</ul>
