
<p>コンテナー化プロセスが可搬性や再生産性に優れているということは、つまりコンテナー化アプリケーションをクラウドやデータセンター間において移行させスケール変更が容易になるということです。
コンテナーというものは、アプリケーションをどこで動作させても同じように動くことが保証されるものであり、すべての環境下においてその性能をすばやく簡単に利用することができます。
アプリケーションをスケールアップするときには、アプリケーションのメンテナンスを自動化するツールが必要になってきます。
また動作不良をおこしたコンテナーを自動的に置き換えたり、コンテナー稼働中でのアップデートの適用や再設定の管理ができることが求められます。</p>

<p>コンテナー化アプリケーションを管理しスケール変更や保守を行うツールのことを <strong>オーケストレーター（orchestrator）</strong> と呼びます。
その具体例が <strong>Kubernetes</strong> と <strong>Docker Swarm</strong> です。
この２つのオーケストレーターによる開発環境デプロイ機能は、Docker Desktop によって提供されています。
本ガイドでは、これからオーケストレーションされた、コンテナー化アプリケーションを生成するために、このオーケストレーターを利用していきます。</p>

<p>この高度なモジュールを利用して以下のことを学んでいきます。</p>

<ol>
  <li><a href="/docs.docker.jp.onthefly/get-started/kube-deploy/">開発環境上にて Kubernetes 環境を構築して利用する</a></li>
  <li><a href="/docs.docker.jp.onthefly/get-started/swarm-deploy/">開発環境上にて Swarm 環境を構築して利用する</a></li>
</ol>

<h2 id="enable-kubernetes">Kubernetes の有効化</h2>

<p>Docker Desktop では Kubernetes をすばやく簡単に設定することができます。
利用しているオペレーティングシステムに合わせて、以下の設定および確認手順を進めてください。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#kubeosx">Mac</a></li>
  <li><a data-toggle="tab" href="#kubewin">Windows</a></li>
</ul>
<div class="tab-content">
  <div id="kubeosx" class="tab-pane fade in active">
    <h3 id="mac">Mac</h3>
    <ol>
      <li>
        <p>Docker Desktop のインストール後には、メニューバー上に Docker アイコンが表示されます。 これをクリックして <strong>Preferences</strong> &gt; <strong>Kubernetes</strong> を実行します。</p>
      </li>
      <li>
        <p><strong>Enable Kubernetes</strong> と書かれたチェックボックスにチェックを入れて <strong>Apply &amp; Restart</strong> をクリックします。 Docker Desktop が自動的に Kubernetes を設定します。 Preferences メニューにおいて ‘Kubernetes <em>running</em>’ と書かれた横にグリーンライトが表示されるので、これによって Kubernetes が正常に有効化されたことがわかります。</p>
      </li>
      <li>
        <p>Kubernetes が起動していることを確認するために、<code class="language-plaintext highlighter-rouge">pod.yaml</code> というテキストファイルを生成し、その内容を以下のようにします。</p>
        <div class="language-yaml highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
kind: Pod
metadata:
  name: demo
spec:
  containers:
  - name: testpod
    image: alpine:3.5
    command: ["ping", "8.8.8.8"]
</code></pre></div>            </div>
          </div>
        </div>
        <p>これは１つのコンテナー内に１つのポッド（pod）を定義し、単純に 8.8.8.8 への ping を行います。</p>
      </li>
      <li>
        <p>端末にて <code class="language-plaintext highlighter-rouge">pod.yaml</code> を生成したディレクトリに移動しポッドを生成します。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply -f pod.yaml
</code></pre></div>            </div>
          </div>
        </div>
      </li>
      <li>
        <p>ポッドが起動して実行中であることを確認します。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div>            </div>
          </div>
        </div>
        <p>たとえば以下のような表示になります。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME      READY     STATUS    RESTARTS   AGE
demo      1/1       Running   0          4s
</code></pre></div>            </div>
          </div>
        </div>
      </li>
      <li>
        <p>ping 処理によって得られるログを確認してみます。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl logs demo
</code></pre></div>            </div>
          </div>
        </div>
        <p>ping プロセスが正常に実行されていれば、以下のような出力になります。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PING 8.8.8.8 (8.8.8.8): 56 data bytes
64 bytes from 8.8.8.8: seq=0 ttl=37 time=21.393 ms
64 bytes from 8.8.8.8: seq=1 ttl=37 time=15.320 ms
64 bytes from 8.8.8.8: seq=2 ttl=37 time=11.111 ms
...
</code></pre></div>            </div>
          </div>
        </div>
      </li>
      <li>
        <p>作業を終えたらテスト用ポッドを削除します。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete -f pod.yaml
</code></pre></div>            </div>
          </div>
        </div>
      </li>
    </ol>
  </div>
  <div id="kubewin" class="tab-pane fade">

    <h3 id="windows">Windows</h3>

    <ol>
      <li>
        <p>Docker Desktop のインストール後には、システムトレイ上に Docker アイコンが表示されます。 アイコンを右クリックして <strong>Settings</strong> &gt; <strong>Kubernetes</strong> を実行します。</p>
      </li>
      <li>
        <p><strong>Enable Kubernetes</strong> と書かれたチェックボックスにチェックを入れて <strong>Apply &amp; Restart</strong> をクリックします。 Docker Desktop が自動的に Kubernetes を設定します。 <strong>Settings</strong> メニューにおいて ‘Kubernetes <em>running</em>’ と書かれた横にグリーンライトが表示されるので、これによって Kubernetes が正常に有効化されたことがわかります。</p>
      </li>
      <li>
        <p>Kubernetes が起動していることを確認するために、<code class="language-plaintext highlighter-rouge">pod.yaml</code> というテキストファイルを生成し、その内容を以下のようにします。</p>
        <div class="language-yaml highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
kind: Pod
metadata:
  name: demo
spec:
  containers:
  - name: testpod
    image: alpine:3.5
    command: ["ping", "8.8.8.8"]
</code></pre></div>            </div>
          </div>
        </div>
        <p>これは１つのコンテナー内に１つのポッド（pod）を定義し、単純に 8.8.8.8 への ping を行います。</p>
      </li>
      <li>
        <p>PowerShell において <code class="language-plaintext highlighter-rouge">pod.yaml</code> を生成したディレクトリに移動しポッドを生成します。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply -f pod.yaml
</code></pre></div>            </div>
          </div>
        </div>
      </li>
      <li>
        <p>ポッドが起動して実行中であることを確認します。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div>            </div>
          </div>
        </div>
        <p>たとえば以下のような表示になります。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME      READY     STATUS    RESTARTS   AGE
demo      1/1       Running   0          4s
</code></pre></div>            </div>
          </div>
        </div>
      </li>
      <li>
        <p>ping 処理によって得られるログを確認してみます。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl logs demo
</code></pre></div>            </div>
          </div>
        </div>
        <p>ping プロセスが正常に実行されていれば、以下のような出力になります。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PING 8.8.8.8 (8.8.8.8): 56 data bytes
64 bytes from 8.8.8.8: seq=0 ttl=37 time=21.393 ms
64 bytes from 8.8.8.8: seq=1 ttl=37 time=15.320 ms
64 bytes from 8.8.8.8: seq=2 ttl=37 time=11.111 ms
...
</code></pre></div>            </div>
          </div>
        </div>
      </li>
      <li>
        <p>作業を終えたらテスト用ポッドを削除します。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete -f pod.yaml
</code></pre></div>            </div>
          </div>
        </div>
      </li>
    </ol>

  </div>
  <hr />
</div>

<h2 id="enable-docker-swarm">Docker Swarm の有効化</h2>

<p>Docker Desktop は主に Docker Engine 上において動作します。
これがあれば、ビルトインの Swarm を動作させる機能がすべて含まれています。
利用オペレーティングシステムに応じて、以下の設定および確認手順に従ってください。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#swarmosx">Mac</a></li>
  <li><a data-toggle="tab" href="#swarmwin">Windows</a></li>
</ul>
<div class="tab-content">
  <div id="swarmosx" class="tab-pane fade in active">
    <h3 id="mac">Mac</h3>
    <ol>
      <li>
        <p>端末を開いて Docker Swarm モードを初期化します。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker swarm init
</code></pre></div>            </div>
          </div>
        </div>
        <p>正常に処理されると、以下のようなメッセージが出力されます。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Swarm initialized: current node (tjjggogqpnpj2phbfbz8jd5oq) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-3e0hh0jd5t4yjg209f4g5qpowbsczfahv2dea9a1ay2l8787cf-2h4ly330d0j917ocvzw30j5x9 192.168.65.3:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.
</code></pre></div>            </div>
          </div>
        </div>
      </li>
      <li>
        <p>単純な Docker サービスを実行します。 これは alpine ベースのファイルシステムを利用するものであり、8.8.8.8 への ping プロセスを実行します。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service create --name demo alpine:3.5 ping 8.8.8.8
</code></pre></div>            </div>
          </div>
        </div>
      </li>
      <li>
        <p>サービスから 1 つのコンテナーが生成されていることを確認します。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service ps demo
</code></pre></div>            </div>
          </div>
        </div>
        <p>以下のような出力が得られます。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE           ERROR               PORTS
463j2s3y4b5o        demo.1              alpine:3.5          docker-desktop      Running             Running 8 seconds ago
</code></pre></div>            </div>
          </div>
        </div>
      </li>
      <li>
        <p>ログを参照して、期待どおりに ping プロセスが得られていることを確認します。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service logs demo
</code></pre></div>            </div>
          </div>
        </div>
        <p>ping 処理が正常に処理されて以下のように出力されているはずです。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>demo.1.463j2s3y4b5o@docker-desktop    | PING 8.8.8.8 (8.8.8.8): 56 data bytes
demo.1.463j2s3y4b5o@docker-desktop    | 64 bytes from 8.8.8.8: seq=0 ttl=37 time=13.005 ms
demo.1.463j2s3y4b5o@docker-desktop    | 64 bytes from 8.8.8.8: seq=1 ttl=37 time=13.847 ms
demo.1.463j2s3y4b5o@docker-desktop    | 64 bytes from 8.8.8.8: seq=2 ttl=37 time=41.296 ms
...
</code></pre></div>            </div>
          </div>
        </div>
      </li>
      <li>
        <p>最後はテストしたサービスを終了させます。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service rm demo
</code></pre></div>            </div>
          </div>
        </div>
      </li>
    </ol>
  </div>
  <div id="swarmwin" class="tab-pane fade">

    <h3 id="windows">Windows</h3>

    <ol>
      <li>
        <p>powershell を開いて Docker Swarm モードを初期化します。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker swarm init
</code></pre></div>            </div>
          </div>
        </div>
        <p>正常に処理されると、以下のようなメッセージが出力されます。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Swarm initialized: current node (tjjggogqpnpj2phbfbz8jd5oq) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-3e0hh0jd5t4yjg209f4g5qpowbsczfahv2dea9a1ay2l8787cf-2h4ly330d0j917ocvzw30j5x9 192.168.65.3:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.
</code></pre></div>            </div>
          </div>
        </div>
      </li>
      <li>
        <p>単純な Docker サービスを実行します。 これは alpine ベースのファイルシステムを利用するものであり、8.8.8.8 への ping プロセスを実行します。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service create --name demo alpine:3.5 ping 8.8.8.8
</code></pre></div>            </div>
          </div>
        </div>
      </li>
      <li>
        <p>サービスから 1 つのコンテナーが生成されていることを確認します。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service ps demo
</code></pre></div>            </div>
          </div>
        </div>
        <p>以下のような出力が得られます。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE           ERROR               PORTS
463j2s3y4b5o        demo.1              alpine:3.5          docker-desktop      Running             Running 8 seconds ago
</code></pre></div>            </div>
          </div>
        </div>
      </li>
      <li>
        <p>ログを参照して、期待どおりに ping プロセスが得られていることを確認します。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service logs demo
</code></pre></div>            </div>
          </div>
        </div>
        <p>ping 処理が正常に処理されて以下のように出力されているはずです。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>demo.1.463j2s3y4b5o@docker-desktop    | PING 8.8.8.8 (8.8.8.8): 56 data bytes
demo.1.463j2s3y4b5o@docker-desktop    | 64 bytes from 8.8.8.8: seq=0 ttl=37 time=13.005 ms
demo.1.463j2s3y4b5o@docker-desktop    | 64 bytes from 8.8.8.8: seq=1 ttl=37 time=13.847 ms
demo.1.463j2s3y4b5o@docker-desktop    | 64 bytes from 8.8.8.8: seq=2 ttl=37 time=41.296 ms
...
</code></pre></div>            </div>
          </div>
        </div>
      </li>
      <li>
        <p>最後はテストしたサービスを終了させます。</p>
        <div class="language-shell highlighter-rouge">
          <div class="highlight">
            <div class="language-plaintext highlight highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service rm demo
</code></pre></div>            </div>
          </div>
        </div>
      </li>
    </ol>

  </div>
  <hr />
</div>

<h2 id="conclusion">まとめ</h2>

<p>ここまで、Kubernetes や Swarm を使って単純なコンテナー化アプリが起動できることを確認しました。
次のステップでは Kubernetes 上にてコンテナーの起動と管理を行うための Kubenetes yaml の記述方法を学びます。</p>

<p><a href="/docs.docker.jp.onthefly/get-started/kube-deploy/" class="button outline-btn" style="margin-bottom: 30px; margin-right: 200%">Kubernetes へのデプロイ &gt;&gt;</a></p>

<p>Swarm 上にて、コンテナーの起動と管理を行うためのファイル記述方法については <a href="/docs.docker.jp.onthefly/get-started/swarm-deploy/">Swarm へのデプロイ</a> を参照してください。</p>

<h2 id="cli-references">CLI リファレンス</h2>

<p>本説明において利用した CLI コマンドの詳細については、以下を参照してください。</p>

<ul>
  <li><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#apply"><code class="language-plaintext highlighter-rouge">kubectl apply</code></a></li>
  <li><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#get"><code class="language-plaintext highlighter-rouge">kubectl get</code></a></li>
  <li><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#logs"><code class="language-plaintext highlighter-rouge">kubectl logs</code></a></li>
  <li><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#delete"><code class="language-plaintext highlighter-rouge">kubectl delete</code></a></li>
  <li><a href="https://docs.docker.com/engine/reference/commandline/swarm_init/"><code class="language-plaintext highlighter-rouge">docker swarm init</code></a></li>
  <li><a href="https://docs.docker.com/engine/reference/commandline/service/"><code class="language-plaintext highlighter-rouge">docker service *</code></a></li>
</ul>
