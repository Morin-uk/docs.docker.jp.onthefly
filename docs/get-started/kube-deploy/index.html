
<h2 id="prerequisites">前提条件</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/get-started/">概要</a> にて説明している Docker Desktop をダウンロードしインストールしていること。</li>
  <li><a href="/docs.docker.jp.onthefly/get-started/part2/">クイックスタート 2 部</a> においてアプリケーションのコンテナー化を一通り学んでいること。</li>
  <li>Docker Desktop 上において Kubernetes が有効になっていること。
    <ul>
      <li><strong>Mac</strong>: メニューバーの Docker アイコンをクリック、<strong>Preferences</strong> を実行し ‘Kubernetes’ の横がグリーンに点灯していること。</li>
      <li><strong>Windows</strong>: システムトレイの Docker アイコンをクリック、<strong>Settings</strong> を実行し ‘Kubernetes’ の横がグリーンに点灯していること。</li>
    </ul>

    <p>Kubernetes が起動していない場合は、本チュートリアルの <a href="/docs.docker.jp.onthefly/get-started/orchestration/">概要</a> に示す手順に従って設定を行ってください。</p>
  </li>
</ul>

<h2 id="introduction">はじめに</h2>

<p>ここまでにアプリケーションの個々のコンポーネントが、スタンドアロンなコンテナーとして実行される様子を見てきました。
ここからはそれらを整理して、Kubernetes のようなオーケストレーターによって管理してくことにします。
Kubernetes はコンテナー化されたアプリケーションに対して、そのコンテナーの能力を超えて、スケール、ネットワーク、セキュリティ、保守を行うツールを数多く提供します。</p>

<p>Kubernetes 上においてコンテナー化アプリケーションが適正に動作していることを確認するために、まずは開発マシン上にて Kubernetes 環境化の Docker Desktop を用いてアプリケーションデプロイを行います。
完全な Kubernetes クラスターによる本番環境での稼動は、その次に扱っていくことにします。
Docker Desktop によって構築されている Kubernetes 環境は <strong>完全な機能</strong> を有しています。
つまりそこには Kubernetes の全機能が含まれていて、実際のクラスター上でアプリを動作させることができ、開発マシンから容易にアクセスすることができます。</p>

<h2 id="describing-apps-using-kubernetes-yaml">Kubernetes YAML を用いたアプリ記述</h2>

<p>Kubernetes 内の全コンテナーは <strong>ポッド</strong>（pod）としてスケジューリングされます。
このポッドとは、リソースを共有する複数コンテナーのグループのことです。
なお現実のアプリケーションにおいては、ポッドを１つずつ生成するようなことはしません。
たいていのアプリケーション開発では <strong>deployments</strong> としてスケジューリングされます。
これは Kubernetes によって自動的に管理される、スケール変更可能なポッドのグループのことです。
そして Kubernetes によるオブジェクトは、すべて <strong>Kubernetes YAML</strong> ファイルと呼ばれるファイル内に記述されます。
この YAML ファイルに Kubernetes アプリのコンポーネントや設定をすべて記述します。
こうして Kubernetes 環境内でのアプリケーションの生成と削除が容易にできるようになります。</p>

<ol>
  <li>
    <p>本チュートリアルのオーケストレーション概要の部において、すでに基本的な Kubernetes YAML ファイルを作り出しました。
そこでこの YAML ファイルをもう少し洗練されたものにして、掲示板アプリの実行と管理を行っていきます。
<code class="language-plaintext highlighter-rouge">bb.yaml</code> というファイルに以下の内容を記述してください。</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">bb-demo</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">bb</span><span class="pi">:</span> <span class="s">web</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">bb</span><span class="pi">:</span> <span class="s">web</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">bb-site</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">bulletinboard:1.0</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">bb-entrypoint</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">bb</span><span class="pi">:</span> <span class="s">web</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8080</span>
    <span class="na">nodePort</span><span class="pi">:</span> <span class="m">30001</span>
</code></pre></div>    </div>

    <p>この Kubernetes YAML ファイルには二つのオブジェクトを定義しています。
それらは <code class="language-plaintext highlighter-rouge">---</code> で区切られています。</p>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">Deployment</code> は、スケール変更可能な同一ポッドのグループを表わします。
この例では <code class="language-plaintext highlighter-rouge">replica</code> すなわちポッドのコピーを１つだけ用意します。
そしてこのポッドは、その中に１つだけコンテナーを持ちます（このことは <code class="language-plaintext highlighter-rouge">template:</code> キー配下により示されます）。
ベースとするイメージは、本チュートリアルの以前の手順にて利用した <code class="language-plaintext highlighter-rouge">bulletinboard:1.0</code> です。</li>
      <li><code class="language-plaintext highlighter-rouge">NodePort</code> サービスは、ホストのポート 30001 からのトラフィックを処理して、ポッド内の 8080 ポートへ接続します。
こうしてネットワーク上から掲示板アプリへアクセスできるようになります。</li>
    </ul>

    <p>また Kubernetes YAML は、はじめのうちは長く複雑に見えがちですが、たいていは同一パターンを持っています。</p>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">apiVersion</code>、オブジェクトを扱うための Kubernetes API を表わします。</li>
      <li><code class="language-plaintext highlighter-rouge">kind</code> は、このオブジェクトがどういう種類のものかを表わします。</li>
      <li><code class="language-plaintext highlighter-rouge">metadata</code> は、たとえば name などの情報をオブジェクトに適用します。</li>
      <li><code class="language-plaintext highlighter-rouge">spec</code> は、オブジェクトに対するパラメーターや設定項目を指定します。</li>
    </ul>
  </li>
</ol>

<h2 id="deploy-and-check-your-application">アプリケーションのデプロイと確認</h2>

<ol>
  <li>
    <p>端末にて <code class="language-plaintext highlighter-rouge">bb.yaml</code> を生成したディレクトリに移動し、Kubernetes にアプリケーションをデプロイします。</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> bb.yaml
</code></pre></div>    </div>

    <p>以下のような出力が得られます。
これは Kubernetes オブジェクトが正常に生成されたことを示しています。</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>deployment.apps/bb-demo created
service/bb-entrypoint created
</code></pre></div>    </div>
  </li>
  <li>
    <p>デプロイ結果の一覧を表示して、正常にすべてが動作していることを確認します。</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get deployments
</code></pre></div>    </div>

    <p>すべて正常であれば、以下のようにデプロイ結果が一覧表示されます。</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
bb-demo   1         1         1            1           48s
</code></pre></div>    </div>

    <p>YAML ファイル内に指定したポッドの個々が、すべて起動していることがわかります。
同様にサービスに対しても確認します。</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get services

NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>          AGE
bb-entrypoint   NodePort    10.106.145.116   &lt;none&gt;        8080:30001/TCP   53s
kubernetes      ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          138d
</code></pre></div>    </div>

    <p>デフォルトの <code class="language-plaintext highlighter-rouge">kubernetes</code> サービスに加えて <code class="language-plaintext highlighter-rouge">bb-entrypoint</code> サービスが表示されます。
このサービスはトラフィックをポート 30001/TCP から受け付けます。</p>
  </li>
  <li>
    <p>ブラウザーを開いて <code class="language-plaintext highlighter-rouge">localhost:30001</code> にアクセスし掲示板アプリを開きます。
ここでも掲示板アプリを見ることができます。
これはクイックスタートチュートリアルの <a href="/docs.docker.jp.onthefly/get-started/part2/">2 部</a> において、スタンドアロンなコンテナー上に起動させたアプリと同一のものです。</p>
  </li>
  <li>
    <p>結果を確認できたらアプリケーションを削除します。</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete <span class="nt">-f</span> bb.yaml
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="conclusion">まとめ</h2>

<p>開発マシン上にて Kubernetes の全機能を実現した環境に、Docker Desktop を用いてアプリケーションをデプロイすることに成功しました。
Kubernetes を使った作業には、まだまだ多くのことがあります。
これは入り口に入ったばかりということです。
アプリケーションに別のコンポーネントを加えてみれば、Kubernetes の優れた機能や性能が見えてきます。
それをまさに開発マシン上で確認できます。</p>

<p>Kubernetes へのデプロイに加えて、アプリケーションを Kubernetes YAML ファイルとして記述しました。
この単純なテキストファイルが、アプリケーションを生成して実行するために必要なものをすべて含んでいるわけです。
このファイルをバージョン管理システムにアップして、仲間と共有してみましょう。
そうすればこのアプリケーションを別の担当者（おそらく開発担当者から受け渡す先として、テスト環境担当者や本番環境担当者）に容易に配布できることになります。</p>

<h2 id="kubernetes-references">Kubernetes リファレンス</h2>

<p>本文において新たに用いた Kubernetes オブジェクトについての詳細は、以下を参照してください。</p>

<ul>
  <li><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod/">Kubernetes ポッド</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Kubernetes デプロイメント</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/services-networking/service/">Kubernetes サービス</a></li>
</ul>
