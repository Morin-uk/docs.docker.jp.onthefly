
<h2 id="prerequisites">前提条件</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/get-started/">概要</a> にて説明している Docker Desktop をダウンロードしインストールしていること。</li>
  <li><a href="/docs.docker.jp.onthefly/get-started/part2/">クイックスタート 2 部</a> においてアプリケーションのコンテナー化を一通り学んでいること。</li>
  <li>
    <p>Docker Desktop 上において Swarm が有効になっていること。
これは <code class="language-plaintext highlighter-rouge">docker system info</code> を入力し、メッセージ内に <code class="language-plaintext highlighter-rouge">Swarm: active</code> があることで確認（多少スクロールして見ることが必要）。</p>

    <p>Swarm が起動していない場合は、シェルプロンプトから単純に <code class="language-plaintext highlighter-rouge">docker swarm init</code> と入力して起動します。</p>
  </li>
</ul>

<h2 id="introduction">はじめに</h2>

<p>ここまでにはアプリケーションの個々のコンポーネントが、スタンドアロンなコンテナーとして実行され、それを Kubernetes を用いてデプロイするところまでを見てきました。
今度は Docker Swarm によってどのように管理していくのかを見ていきます。
Swarm はコンテナー化されたアプリケーションに対して、そのコンテナーの能力を超えて、スケール、ネットワーク、セキュリティ、保守を行うツールを数多く提供します。</p>

<p>Swarm 上においてコンテナー化アプリケーションが適正に動作していることを確認するために、まずは開発マシン上にて Swarm 環境化の Docker Desktop を用いてアプリケーションデプロイを行います。
完全な Swarm クラスターによる本番環境での稼動は、その次に扱っていくことにします。
Docker Desktop によって構築されている Swarm 環境は <strong>完全な機能</strong> を有しています。
つまりそこには Swarm の全機能が含まれていて、実際のクラスター上でアプリを動作させることができ、開発マシンから容易にアクセスすることができます。</p>

<h2 id="describe-apps-using-stack-files">スタックファイルを用いたアプリ記述</h2>

<p>本チュートリアルの以前の手順とは違って、Swarm では個別にコンテナーを生成することはしません。
そのかわり、Swarm 全体を <strong>サービス</strong> としてスケジューリングします。
これはスケール変更可能なコンテナーのグループであり、さらに Swarm によって自動的に管理されるネットワーク機能が付け加えられています。
そして Swarm によるオブジェクトは、すべて <strong>スタックファイル</strong>（stack file）と呼ばれるファイル内に記述されます。
この YAML ファイルに Swarm アプリのコンポーネントや設定をすべて記述します。
こうして Swarm 環境内でのアプリケーションの生成と削除が容易にできるようになります。</p>

<p>では掲示板アプリを起動し管理するための単純なスタックファイルを記述します。
<code class="language-plaintext highlighter-rouge">bb-stack.yaml</code> というファイルに以下の内容を記述してください。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.7'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">bb-app</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">bulletinboard:1.0</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8000:8080"</span>
</code></pre></div></div>

<p>この Swarm YAML ファイルには <code class="language-plaintext highlighter-rouge">service</code> という１つのオブジェクトがあるのみです。
これはスケール変更可能な同一コンテナーのグループを表わします。
今の場合、（デフォルトにより）ただ１つのコンテナーを生成します。
ベースとするイメージは、クイックスタートチュートリアルの <a href="/docs.docker.jp.onthefly/get-started/part2/">2 部</a> の手順にて利用した <code class="language-plaintext highlighter-rouge">bulletinboard:1.0</code> です。
そして開発マシン上のポート 8000 にきたトラフィックを、掲示板アプリコンテナー内のポート 8080 にフォワードするように指定しています。</p>

<blockquote>
  <p><strong>Kubernetes サービスと Swarm サービスはまったく違います。</strong>
この 2 つのオーケストレーターはサービスという同じ名前を持っていますが、サービスの意味するところがまったく違います。
Swarm の場合はスケジューリング機能とネットワーク機能が <strong>両方ともに</strong> 提供されます。
またコンテナーの生成と、これに向けてトラフィック送信を行うツールが提供されます。
Kubernetes の場合、スケジューリング機能とネットワーク機能は別々に扱われています。
<strong>デプロイ機能</strong>（あるいは他の制御機能）が、コンテナーのスケジューリングをポッド（pod）として扱います。
また <strong>サービス機能</strong> というものが、そのポッドに対してのネットワーク機能付与のみを行います。</p>
</blockquote>

<h2 id="deploy-and-check-your-application">アプリケーションのデプロイと確認</h2>

<ol>
  <li>
    <p>Swarm にアプリケーションをデプロイします。</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker stack deploy <span class="nt">-c</span> bb-stack.yaml demo
</code></pre></div>    </div>

    <p>すべて正常であればエラーはなく、スタックオブジェクトがすべて生成できたことを表示します。</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Creating network demo_default
Creating service demo_bb-app
</code></pre></div>    </div>

    <p>サービスが生成されると同時に、Swarm はデフォルトで Docker ネットワークを生成し、スタックの一部分としてデプロイされたコンテナーを分離し実行します。</p>
  </li>
  <li>
    <p>サービス一覧を表示して、正常にすべてが動作していることを確認します。</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker service <span class="nb">ls</span>
</code></pre></div>    </div>

    <p>すべて正常に動作していれば、サービスからレプリカ 1/1 が生成されたことが表示されます。</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ID                  NAME                MODE                REPLICAS            IMAGE               PORTS
il7elwunymbs        demo_bb-app         replicated          1/1                 bulletinboard:1.0   <span class="k">*</span>:8000-&gt;8080/tcp
</code></pre></div>    </div>

    <p>これはつまり、サービスの一部分として生成が指示された 1/1 のコンテナーが起動していることが示されています。
また開発マシンの 8000 ポートが、掲示板アプリの 8080 ポートにフォワード設定されていることもわかります。</p>
  </li>
  <li>
    <p>ブラウザーを開いて <code class="language-plaintext highlighter-rouge">localhost:30001</code> にアクセスし掲示板アプリを開きます。
ここでも掲示板アプリを見ることができます。
これはクイックスタートチュートリアルの 2 部において、スタンドアロンなコンテナー上に起動させたアプリと同一のものです。</p>
  </li>
  <li>
    <p>結果を確認できたらアプリケーションを削除します。</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker stack <span class="nb">rm </span>demo
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="conclusion">まとめ</h2>

<p>開発マシン上にて Swarm の全機能を実現した環境に、Docker Desktop を用いてアプリケーションをデプロイすることに成功しました。
Swarm を使った作業には、まだまだ多くのことがあります。
これは入り口に入ったばかりということです。
アプリケーションに別のコンポーネントを加えてみれば、Swarm の優れた機能や性能が見えてきます。
それをまさに開発マシン上で確認できます。</p>

<p>Swarm へのデプロイに加えて、アプリケーションをスタックファイルとして記述しました。
この単純なテキストファイルが、アプリケーションを生成して実行するために必要なものをすべて含んでいるわけです。
このファイルをバージョン管理システムにアップして、仲間と共有してみましょう。
そうすればこのアプリケーションを別の担当者（おそらく開発担当者から受け渡す先として、テスト環境担当者や本番環境担当者）に容易に配布できることになります。</p>

<h2 id="swarm-and-cli-references">Swarm と CLI リファレンス</h2>

<p>本文において新たに用いた Swarm オブジェクトについての詳細は、以下を参照してください。</p>

<ul>
  <li><a href="https://docs.docker.com/engine/swarm/how-swarm-mode-works/services/">Swarm サービス</a></li>
  <li><a href="https://docs.docker.com/engine/swarm/stack-deploy/">Swarm スタック</a></li>
  <li><a href="https://docs.docker.com/engine/reference/commandline/stack/"><code class="language-plaintext highlighter-rouge">docker stack *</code></a></li>
  <li><a href="https://docs.docker.com/engine/reference/commandline/service/"><code class="language-plaintext highlighter-rouge">docker service *</code></a></li>
</ul>
