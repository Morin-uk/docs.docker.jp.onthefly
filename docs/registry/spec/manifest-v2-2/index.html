<h1 id="image-manifest-version-2-schema-2">Image Manifest Version 2, Schema 2</h1>

<p>This document outlines the format of the V2 image manifest, schema version 2.
The original (and provisional) image manifest for V2 (schema 1), was introduced
in the Docker daemon in the <a href="https://github.com/docker/docker/commit/9f482a66ab37ec396ac61ed0c00d59122ac07453">v1.3.0
release</a>
and is specified in the <a href="/docs.docker.jp.onthefly/registry/spec/manifest-v2-1/">schema 1 manifest definition</a></p>

<p>This second schema version has two primary goals. The first is to allow
multi-architecture images, through a “fat manifest” which references image
manifests for platform-specific versions of an image. The second is to
move the Docker engine towards content-addressable images, by supporting
an image model where the image’s configuration can be hashed to generate
an ID for the image.</p>

<h1 id="media-types">Media Types</h1>

<p>The following media types are used by the manifest formats described here, and
the resources they reference:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">application/vnd.docker.distribution.manifest.v1+json</code>: schema1 (existing manifest format)</li>
  <li><code class="language-plaintext highlighter-rouge">application/vnd.docker.distribution.manifest.v2+json</code>: New image manifest format (schemaVersion = 2)</li>
  <li><code class="language-plaintext highlighter-rouge">application/vnd.docker.distribution.manifest.list.v2+json</code>: Manifest list, aka “fat manifest”</li>
  <li><code class="language-plaintext highlighter-rouge">application/vnd.docker.container.image.v1+json</code>: Container config JSON</li>
  <li><code class="language-plaintext highlighter-rouge">application/vnd.docker.image.rootfs.diff.tar.gzip</code>: “Layer”, as a gzipped tar</li>
  <li><code class="language-plaintext highlighter-rouge">application/vnd.docker.image.rootfs.foreign.diff.tar.gzip</code>: “Layer”, as a gzipped tar that should never be pushed</li>
  <li><code class="language-plaintext highlighter-rouge">application/vnd.docker.plugin.v1+json</code>: Plugin config JSON</li>
</ul>

<h2 id="manifest-list">Manifest List</h2>

<p>The manifest list is the “fat manifest” which points to specific image manifests
for one or more platforms. Its use is optional, and relatively few images will
use one of these manifests. A client will distinguish a manifest list from an
image manifest based on the Content-Type returned in the HTTP response.</p>

<h2 id="manifest-list-field-descriptions"><em>Manifest List</em> Field Descriptions</h2>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">schemaVersion</code></strong> <em>int</em></p>

    <p>This field specifies the image manifest schema version as an integer. This
schema uses the version <code class="language-plaintext highlighter-rouge">2</code>.</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">mediaType</code></strong> <em>string</em></p>

    <p>The MIME type of the manifest list. This should be set to
  <code class="language-plaintext highlighter-rouge">application/vnd.docker.distribution.manifest.list.v2+json</code>.</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">manifests</code></strong> <em>array</em></p>

    <p>The manifests field contains a list of manifests for specific platforms.</p>

    <p>Fields of an object in the manifests list are:</p>

    <ul>
      <li>
        <p><strong><code class="language-plaintext highlighter-rouge">mediaType</code></strong> <em>string</em></p>

        <p>The MIME type of the referenced object. This will generally be
  <code class="language-plaintext highlighter-rouge">application/vnd.docker.distribution.manifest.v2+json</code>, but it could also
  be <code class="language-plaintext highlighter-rouge">application/vnd.docker.distribution.manifest.v1+json</code> if the manifest
  list references a legacy schema-1 manifest.</p>
      </li>
      <li>
        <p><strong><code class="language-plaintext highlighter-rouge">size</code></strong> <em>int</em></p>

        <p>The size in bytes of the object. This field exists so that a client
  will have an expected size for the content before validating. If the
  length of the retrieved content does not match the specified length,
  the content should not be trusted.</p>
      </li>
      <li>
        <p><strong><code class="language-plaintext highlighter-rouge">digest</code></strong> <em>string</em></p>

        <p>The digest of the content, as defined by the
  <a href="/docs.docker.jp.onthefly/registry/spec/api/#digest-parameter">Registry V2 HTTP API Specificiation</a>.</p>
      </li>
      <li>
        <p><strong><code class="language-plaintext highlighter-rouge">platform</code></strong> <em>object</em></p>

        <p>The platform object describes the platform which the image in the
  manifest runs on. A full list of valid operating system and architecture
  values are listed in the <a href="https://golang.org/doc/install/source#environment">Go language documentation for <code class="language-plaintext highlighter-rouge">$GOOS</code> and
  <code class="language-plaintext highlighter-rouge">$GOARCH</code></a></p>

        <ul>
          <li>
            <p><strong><code class="language-plaintext highlighter-rouge">architecture</code></strong> <em>string</em></p>

            <p>The architecture field specifies the CPU architecture, for example
  <code class="language-plaintext highlighter-rouge">amd64</code> or <code class="language-plaintext highlighter-rouge">ppc64le</code>.</p>
          </li>
          <li>
            <p><strong><code class="language-plaintext highlighter-rouge">os</code></strong> <em>string</em></p>

            <p>The os field specifies the operating system, for example
  <code class="language-plaintext highlighter-rouge">linux</code> or <code class="language-plaintext highlighter-rouge">windows</code>.</p>
          </li>
          <li>
            <p><strong><code class="language-plaintext highlighter-rouge">os.version</code></strong> <em>string</em></p>

            <p>The optional os.version field specifies the operating system version,
  for example <code class="language-plaintext highlighter-rouge">10.0.10586</code>.</p>
          </li>
          <li>
            <p><strong><code class="language-plaintext highlighter-rouge">os.features</code></strong> <em>array</em></p>

            <p>The optional os.features field specifies an array of strings,
  each listing a required OS feature (for example on Windows
  <code class="language-plaintext highlighter-rouge">win32k</code>).</p>
          </li>
          <li>
            <p><strong><code class="language-plaintext highlighter-rouge">variant</code></strong> <em>string</em></p>

            <p>The optional variant field specifies a variant of the CPU, for
  example <code class="language-plaintext highlighter-rouge">armv6l</code> to specify a particular CPU variant of the ARM CPU.</p>
          </li>
          <li>
            <p><strong><code class="language-plaintext highlighter-rouge">features</code></strong> <em>array</em></p>

            <p>The optional features field specifies an array of strings, each
  listing a required CPU feature (for example <code class="language-plaintext highlighter-rouge">sse4</code> or <code class="language-plaintext highlighter-rouge">aes</code>).</p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="example-manifest-list">Example Manifest List</h2>

<p><em>Example showing a simple manifest list pointing to image manifests for two platforms:</em></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"schemaVersion"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.distribution.manifest.list.v2+json"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"manifests"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">7143</span><span class="p">,</span><span class="w">
      </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"platform"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"architecture"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ppc64le"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"os"</span><span class="p">:</span><span class="w"> </span><span class="s2">"linux"</span><span class="p">,</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">7682</span><span class="p">,</span><span class="w">
      </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:5b0bcabd1ed22e9fb1310cf6c2dec7cdef19f0ad69efa1f392e94a4333501270"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"platform"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"architecture"</span><span class="p">:</span><span class="w"> </span><span class="s2">"amd64"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"os"</span><span class="p">:</span><span class="w"> </span><span class="s2">"linux"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"sse4"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h1 id="image-manifest">Image Manifest</h1>

<p>The image manifest provides a configuration and a set of layers for a container
image. It’s the direct replacement for the schema-1 manifest.</p>

<h2 id="image-manifest-field-descriptions"><em>Image Manifest</em> Field Descriptions</h2>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">schemaVersion</code></strong> <em>int</em></p>

    <p>This field specifies the image manifest schema version as an integer. This
schema uses version <code class="language-plaintext highlighter-rouge">2</code>.</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">mediaType</code></strong> <em>string</em></p>

    <p>The MIME type of the manifest. This should be set to
  <code class="language-plaintext highlighter-rouge">application/vnd.docker.distribution.manifest.v2+json</code>.</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">config</code></strong> <em>object</em></p>

    <p>The config field references a configuration object for a container, by
  digest. This configuration item is a JSON blob that the runtime uses
  to set up the container. This new schema uses a tweaked version
  of this configuration to allow image content-addressability on the
  daemon side.</p>

    <p>Fields of a config object are:</p>

    <ul>
      <li>
        <p><strong><code class="language-plaintext highlighter-rouge">mediaType</code></strong> <em>string</em></p>

        <p>The MIME type of the referenced object. This should generally be
  <code class="language-plaintext highlighter-rouge">application/vnd.docker.container.image.v1+json</code>.</p>
      </li>
      <li>
        <p><strong><code class="language-plaintext highlighter-rouge">size</code></strong> <em>int</em></p>

        <p>The size in bytes of the object. This field exists so that a client
  will have an expected size for the content before validating. If the
  length of the retrieved content does not match the specified length,
  the content should not be trusted.</p>
      </li>
      <li>
        <p><strong><code class="language-plaintext highlighter-rouge">digest</code></strong> <em>string</em></p>

        <p>The digest of the content, as defined by the
  <a href="/docs.docker.jp.onthefly/registry/spec/api/#digest-parameter">Registry V2 HTTP API Specificiation</a>.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">layers</code></strong> <em>array</em></p>

    <p>The layer list is ordered starting from the base image (opposite order of schema1).</p>

    <p>Fields of an item in the layers list are:</p>

    <ul>
      <li>
        <p><strong><code class="language-plaintext highlighter-rouge">mediaType</code></strong> <em>string</em></p>

        <p>The MIME type of the referenced object. This should
  generally be <code class="language-plaintext highlighter-rouge">application/vnd.docker.image.rootfs.diff.tar.gzip</code>.
  Layers of type
  <code class="language-plaintext highlighter-rouge">application/vnd.docker.image.rootfs.foreign.diff.tar.gzip</code> may be
  pulled from a remote location but they should never be pushed.</p>
      </li>
      <li>
        <p><strong><code class="language-plaintext highlighter-rouge">size</code></strong> <em>int</em></p>

        <p>The size in bytes of the object. This field exists so that a client
  will have an expected size for the content before validating. If the
  length of the retrieved content does not match the specified length,
  the content should not be trusted.</p>
      </li>
      <li>
        <p><strong><code class="language-plaintext highlighter-rouge">digest</code></strong> <em>string</em></p>

        <p>The digest of the content, as defined by the
  <a href="/docs.docker.jp.onthefly/registry/spec/api/#digest-parameter">Registry V2 HTTP API Specificiation</a>.</p>
      </li>
      <li>
        <p><strong><code class="language-plaintext highlighter-rouge">urls</code></strong> <em>array</em></p>

        <p>Provides a list of URLs from which the content may be fetched. Content
  should be verified against the <code class="language-plaintext highlighter-rouge">digest</code> and <code class="language-plaintext highlighter-rouge">size</code>. This field is
  optional and uncommon.</p>
      </li>
    </ul>
  </li>
</ul>

<h2 id="example-image-manifest">Example Image Manifest</h2>

<p><em>Example showing an image manifest:</em></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"schemaVersion"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.container.image.v1+json"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">7023</span><span class="p">,</span><span class="w">
        </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"layers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">32654</span><span class="p">,</span><span class="w">
            </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">16724</span><span class="p">,</span><span class="w">
            </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:3c3a4604a545cdc127456d94e421cd355bca5b528f4a9c1905b15da2eb4a4c6b"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">73109</span><span class="p">,</span><span class="w">
            </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:ec4b8955958665577945c89419d1af06b5f7636b4ac3da7f12184802ad867736"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h1 id="backward-compatibility">Backward compatibility</h1>

<p>The registry will continue to accept uploads of manifests in both the old and
new formats.</p>

<p>When pushing images, clients which support the new manifest format should first
construct a manifest in the new format. If uploading this manifest fails,
presumably because the registry only supports the old format, the client may
fall back to uploading a manifest in the old format.</p>

<p>When pulling images, clients indicate support for this new version of the
manifest format by sending the
<code class="language-plaintext highlighter-rouge">application/vnd.docker.distribution.manifest.v2+json</code> and
<code class="language-plaintext highlighter-rouge">application/vnd.docker.distribution.manifest.list.v2+json</code> media types in an
<code class="language-plaintext highlighter-rouge">Accept</code> header when making a request to the <code class="language-plaintext highlighter-rouge">manifests</code> endpoint. Updated
clients should check the <code class="language-plaintext highlighter-rouge">Content-Type</code> header to see whether the manifest
returned from the endpoint is in the old format, or is an image manifest or
manifest list in the new format.</p>

<p>If the manifest being requested uses the new format, and the appropriate media
type is not present in an <code class="language-plaintext highlighter-rouge">Accept</code> header, the registry will assume that the
client cannot handle the manifest as-is, and rewrite it on the fly into the old
format. If the object that would otherwise be returned is a manifest list, the
registry will look up the appropriate manifest for the amd64 platform and
linux OS, rewrite that manifest into the old format if necessary, and return
the result to the client. If no suitable manifest is found in the manifest
list, the registry will return a 404 error.</p>

<p>One of the challenges in rewriting manifests to the old format is that the old
format involves an image configuration for each layer in the manifest, but the
new format only provides one image configuration. To work around this, the
registry will create synthetic image configurations for all layers except the
top layer. These image configurations will not result in runnable images on
their own, but only serve to fill in the parent chain in a compatible way.
The IDs in these synthetic configurations will be derived from hashes of their
respective blobs. The registry will create these configurations and their IDs
using the same scheme as Docker 1.10 when it creates a legacy manifest to push
to a registry which doesn’t support the new format.</p>
