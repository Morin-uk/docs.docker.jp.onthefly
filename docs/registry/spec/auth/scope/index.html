<h1 id="docker-registry-token-scope-and-access">Docker Registry Token Scope and Access</h1>

<p>Tokens used by the registry are always restricted what resources they may
be used to access, where those resources may be accessed, and what actions
may be done on those resources. Tokens always have the context of a user which
the token was originally created for. This document describes how these
restrictions are represented and enforced by the authorization server and
resource providers.</p>

<h2 id="scope-components">Scope Components</h2>

<h3 id="subject-authenticated-user">Subject (Authenticated User)</h3>

<p>The subject represents the user for which a token is valid. Any actions
performed using an access token should be considered on behalf of the subject.
This is included in the <code class="language-plaintext highlighter-rouge">sub</code> field of access token JWT. A refresh token should
be limited to a single subject and only be able to give out access tokens for
that subject.</p>

<h3 id="audience-resource-provider">Audience (Resource Provider)</h3>

<p>The audience represents a resource provider which is intended to be able to
perform the actions specified in the access token. Any resource provider which
does not match the audience should not use that access token. The audience is
included in the <code class="language-plaintext highlighter-rouge">aud</code> field of the access token JWT. A refresh token should be
limited to a single audience and only be able to give out access tokens for that
audience.</p>

<h3 id="resource-type">Resource Type</h3>

<p>The resource type represents the type of resource which the resource name is
intended to represent. This type may be specific to a resource provider but must
be understood by the authorization server in order to validate the subject
is authorized for a specific resource.</p>

<h4 id="resource-class">Resource Class</h4>

<p>The resource type might have a resource class which further classifies the
the resource name within the resource type. A class is not required and
is specific to the resource type.</p>

<h4 id="example-resource-types">Example Resource Types</h4>

<ul>
  <li><code class="language-plaintext highlighter-rouge">repository</code> - represents a single repository within a registry. A
repository may represent many manifest or content blobs, but the resource type
is considered the collections of those items. Actions which may be performed on
a <code class="language-plaintext highlighter-rouge">repository</code> are <code class="language-plaintext highlighter-rouge">pull</code> for accessing the collection and <code class="language-plaintext highlighter-rouge">push</code> for adding to
it. By default the <code class="language-plaintext highlighter-rouge">repository</code> type has the class of <code class="language-plaintext highlighter-rouge">image</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">repository(plugin)</code> - represents a single repository of plugins within a
registry. A plugin repository has the same content and actions as a repository.</li>
  <li><code class="language-plaintext highlighter-rouge">registry</code> - represents the entire registry. Used for administrative actions
or lookup operations that span an entire registry.</li>
</ul>

<h3 id="resource-name">Resource Name</h3>

<p>The resource name represent the name which identifies a resource for a resource
provider. A resource is identified by this name and the provided resource type.
An example of a resource name would be the name component of an image tag, such
as “samalba/myapp” or “hostname/samalba/myapp”.</p>

<h3 id="resource-actions">Resource Actions</h3>

<p>The resource actions define the actions which the access token allows to be
performed on the identified resource. These actions are type specific but will
normally have actions identifying read and write access on the resource. Example
for the <code class="language-plaintext highlighter-rouge">repository</code> type are <code class="language-plaintext highlighter-rouge">pull</code> for read access and <code class="language-plaintext highlighter-rouge">push</code> for write
access.</p>

<h2 id="authorization-server-use">Authorization Server Use</h2>

<p>Each access token request may include a scope and an audience. The subject is
always derived from the passed in credentials or refresh token. When using
a refresh token the passed in audience must match the audience defined for
the refresh token. The audience (resource provider) is provided using the
<code class="language-plaintext highlighter-rouge">service</code> field. Multiple resource scopes may be provided using multiple <code class="language-plaintext highlighter-rouge">scope</code>
fields on the <code class="language-plaintext highlighter-rouge">GET</code> request. The <code class="language-plaintext highlighter-rouge">POST</code> request only takes in a single
<code class="language-plaintext highlighter-rouge">scope</code> field but may use a space to separate a list of multiple resource
scopes.</p>

<h3 id="resource-scope-grammar">Resource Scope Grammar</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scope                   := resourcescope [ ' ' resourcescope ]*
resourcescope           := resourcetype  ":" resourcename  ":" action [ ',' action ]*
resourcetype            := resourcetypevalue [ '(' resourcetypevalue ')' ]
resourcetypevalue       := /[a-z0-9]+/
resourcename            := [ hostname '/' ] component [ '/' component ]*
hostname                := hostcomponent ['.' hostcomponent]* [':' port-number]
hostcomponent           := /([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9])/
port-number             := /[0-9]+/
action                  := /[a-z]*/
component               := alpha-numeric [ separator alpha-numeric ]*
alpha-numeric           := /[a-z0-9]+/
separator               := /[_.]|__|[-]*/
</code></pre></div></div>
<p>Full reference grammar is defined
<a href="https://godoc.org/github.com/docker/distribution/reference">here</a>. Currently
the scope name grammar is a subset of the reference grammar.</p>

<blockquote>
  <p><strong>NOTE:</strong> that the <code class="language-plaintext highlighter-rouge">resourcename</code> may contain one <code class="language-plaintext highlighter-rouge">:</code> due to a possible port
number in the hostname component of the <code class="language-plaintext highlighter-rouge">resourcename</code>, so a naive
implementation that interprets the first three <code class="language-plaintext highlighter-rouge">:</code>-delimited tokens of a
<code class="language-plaintext highlighter-rouge">scope</code> to be the <code class="language-plaintext highlighter-rouge">resourcetype</code>, <code class="language-plaintext highlighter-rouge">resourcename</code>, and a list of <code class="language-plaintext highlighter-rouge">action</code>
would be insufficient.</p>
</blockquote>

<h2 id="resource-provider-use">Resource Provider Use</h2>

<p>Once a resource provider has verified the authenticity of the scope through
JWT access token verification, the resource provider must ensure that scope
satisfies the request. The resource provider should match the given audience
according to name or URI the resource provider uses to identify itself. Any
denial based on subject is not defined here and is up to resource provider, the
subject is mainly provided for audit logs and any other user-specific rules
which may need to be provided but are not defined by the authorization server.</p>

<p>The resource provider must ensure that ANY resource being accessed as the
result of a request has the appropriate access scope. Both the resource type
and resource name must match the accessed resource and an appropriate action
scope must be included.</p>

<p>When appropriate authorization is not provided either due to lack of scope
or missing token, the resource provider to return a <code class="language-plaintext highlighter-rouge">WWW-AUTHENTICATE</code> HTTP
header with the <code class="language-plaintext highlighter-rouge">realm</code> as the authorization server, the <code class="language-plaintext highlighter-rouge">service</code> as the
expected audience identifying string, and a <code class="language-plaintext highlighter-rouge">scope</code> field for each required
resource scope to complete the request.</p>

<h2 id="jwt-access-tokens">JWT Access Tokens</h2>

<p>Each JWT access token may only have a single subject and audience but multiple
resource scopes. The subject and audience are put into standard JWT fields
<code class="language-plaintext highlighter-rouge">sub</code> and <code class="language-plaintext highlighter-rouge">aud</code>. The resource scope is put into the <code class="language-plaintext highlighter-rouge">access</code> field. The
structure of the access field can be seen in the
<a href="/docs.docker.jp.onthefly/registry/spec/auth/jwt/">jwt documentation</a>.</p>

<h2 id="refresh-tokens">Refresh Tokens</h2>

<p>A refresh token must be defined for a single subject and audience. Further
restricting scope to specific type, name, and actions combinations should be
done by fetching an access token using the refresh token. Since the refresh
token is not scoped to specific resources for an audience, extra care should
be taken to only use the refresh token to negotiate new access tokens directly
with the authorization server, and never with a resource provider.</p>
