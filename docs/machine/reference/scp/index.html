
<p><code class="language-plaintext highlighter-rouge">scp</code> を使ってファイルをコピーします。
ホストからマシンへ、マシン間で、マシンからホストへコピーを行います。</p>

<p>引数の記述書式は <code class="language-plaintext highlighter-rouge">machinename:/path/to/files</code> とします。
ホストマシンである場合、マシン名の指定は不要であり、パスの指定だけで十分です。</p>

<h2 id="example">利用例</h2>

<p>以下に示す利用例を見てみます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>foo.txt
<span class="nb">cat</span>: foo.txt: No such file or directory

<span class="nv">$ </span>docker-machine ssh dev <span class="nb">pwd</span>
/home/docker

<span class="nv">$ </span>docker-machine ssh dev <span class="s1">'echo A file created remotely! &gt;foo.txt'</span>
<span class="nv">$ </span>docker-machine scp dev:/home/docker/foo.txt <span class="nb">.</span>
foo.txt                                                           100%   28     0.0KB/s   00:00
<span class="nv">$ </span><span class="nb">cat </span>foo.txt
A file created remotely!
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">scp</code> において、ファイルを再帰的にコピーする <code class="language-plaintext highlighter-rouge">-r</code> フラグがあるのと同様に、<code class="language-plaintext highlighter-rouge">docker-machine</code> にも同じ機能の <code class="language-plaintext highlighter-rouge">-r</code> フラグがあります。</p>

<p>マシン間でのファイルコピーの場合、コピーされるファイルはローカルホストのファイルシステムを経由します。
（<code class="language-plaintext highlighter-rouge">scp</code> の <code class="language-plaintext highlighter-rouge">-3</code> フラグが利用されます。）</p>

<p>大容量ファイルをコピーしたり、大量のファイルを含むディレクトリを更新したりする場合は <code class="language-plaintext highlighter-rouge">-d </code> フラグを利用します。
これによって全ファイルをコピーするのではなく、<code class="language-plaintext highlighter-rouge">rsync</code> を使って差分をコピーすることになります。</p>

<p>ファイルだけでなくディレクトリをコピーする場合は、rsync が誤動作しないように、コピー元、コピー先ともに最後にスラッシュをつけるようにします。
たとえば以下のとおりです。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> bar
<span class="nv">$ </span><span class="nb">touch </span>bar/baz
<span class="nv">$ </span>docker-machine scp <span class="nt">-r</span> <span class="nt">-d</span> bar/ dev:/home/docker/bar/
<span class="nv">$ </span>docker-machine ssh dev <span class="nb">ls </span>bar
baz
</code></pre></div></div>

<h2 id="specifying-file-paths-for-remote-deployments">リモートデプロイ時のファイルパス指定</h2>

<p>アプリのデプロイのため <code class="language-plaintext highlighter-rouge">docker-machine scp</code> を使ってリモートサーバーへファイルコピーを行う場合、<code class="language-plaintext highlighter-rouge">docker-compose</code> や Docker デーモンがコピーするファイルを探し出せるようにしておくことが重要です。
<a href="/docs.docker.jp.onthefly/compose/compose-file/">Compose ファイル</a> 内に絶対パスが指定されていながら、コピー時に相対パスを使うことはやめてください。
Docker デーモンとコンテナー内部におけるパス指定には、ともに絶対パスとすることが適切です。</p>

<p>たとえばローカルディレクトリ <code class="language-plaintext highlighter-rouge">/Users/&lt;ユーザー名&gt;/webapp</code> をリモートマシンにコピーし、リモートホスト上のコンテナーに対してバインドマウントを行うとします。
リモートユーザー名が <code class="language-plaintext highlighter-rouge">ubuntu</code> であるとすると、以下のようなコマンド実行となります。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-machine scp <span class="nt">-r</span> /Users/&lt;ユーザー名&gt;/webapp マシン名:/home/ubuntu/webapp
</code></pre></div></div>

<p>そして docker-compose ファイルには、バインドマウントを行う以下のような記述を行います。</p>

<pre><code class="language-none">version: "3.1"
services:
  webapp:
    image: alpine
    command: cat /app/root.php
    volumes:
    - "/home/ubuntu/webapp:/app"
</code></pre>

<p>以下のようにしてこれを実行します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">eval</span> <span class="si">$(</span>docker-machine <span class="nb">env </span>マシン名<span class="si">)</span>
<span class="nv">$ </span>docker-compose run webapp
</code></pre></div></div>
