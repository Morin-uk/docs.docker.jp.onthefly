
<p>以下に示す例に従って、Docker 化された <a href="https://digitalocean.com">DigitalOcean</a> ドロップレット（クラウドホスト）を生成します。</p>

<h3 id="step-1-create-a-digitalocean-account">ステップ 1. DigitalOcean アカウントの生成</h3>

<p><a href="https://digitalocean.com">DigitalOcean</a> のアカウントをまだ生成していない場合は、サイトにアクセスしてアカウントを生成し、ログインします。</p>

<h3 id="step-2-generate-a-personal-access-token">ステップ 2. 個人用アクセストークンの生成</h3>

<p>個人用のアクセストークンを以下のようにして生成します。</p>

<ol>
  <li>
    <p>DigitalOcean の管理コンソールにアクセスし、ヘッダーにある <strong>API</strong> をクリックします。</p>

    <p><img src="/docs.docker.jp.onthefly/machine/img/ocean_click_api.png" alt="DigitalOcean コンソールでの API クリック" /></p>
  </li>
  <li>
    <p><strong>Generate new token</strong>（新たなトークンの生成）をクリックしてトークン生成画面に進みます。</p>

    <p><img src="/docs.docker.jp.onthefly/machine/img/ocean_gen_token.png" alt="トークンの生成" /></p>
  </li>
  <li>
    <p>トークンに対するわかりやすい名前を入力して、チェックボックス <strong>Write (Optional)</strong> をチェックします。
そして <strong>Generate Token</strong>（トークンの生成）をクリックします。</p>

    <p><img src="/docs.docker.jp.onthefly/machine/img/ocean_token_create.png" alt="トークンの命名と生成" /></p>
  </li>
  <li>
    <p>画面上に生成された長い 16 進数文字列を取得して（クリップボードにコピーして）どこか安全な場所に保存します。</p>

    <p><img src="/docs.docker.jp.onthefly/machine/img/ocean_save_token.png" alt="個人用アクセストークンのコピーと保存" /></p>

    <p>これが個人用のアクセストークンであり、クラウドサーバー生成のために次のステップで利用します。</p>
  </li>
</ol>

<h3 id="step-3-use-machine-to-create-the-droplet">ステップ 3. Machine を使ったドロップレットの生成</h3>

<ol>
  <li>
    <p>ドライバーに<code class="language-plaintext highlighter-rouge">digitalocean</code>を指定して<code class="language-plaintext highlighter-rouge">docker-machine create</code>コマンドを実行します。
トークンは<code class="language-plaintext highlighter-rouge">--digitalocean-access-token</code>フラグに指定します。
また新たなクラウドサーバーに対する名前を指定します。</p>

    <p>以下の例では、新たなドロップレットを<code class="language-plaintext highlighter-rouge">docker-sandbox</code>とします。</p>

    <pre><code class="language-none">$ docker-machine create --driver digitalocean --digitalocean-access-token xxxxx docker-sandbox
Running pre-create checks...
Creating machine...
(docker-sandbox) OUT | Creating SSH key...
(docker-sandbox) OUT | Creating Digital Ocean droplet...
(docker-sandbox) OUT | Waiting for IP address to be assigned to the Droplet...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Detecting the provisioner...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
To see how to connect Docker to this machine, run: docker-machine env docker-sandbox
</code></pre>

    <p>ドロップレットが生成されると、Docker はユニークな SSH 鍵を生成して、ローカルシステムの<code class="language-plaintext highlighter-rouge">~/.docker/machines</code>に保存します。
  はじめにこの鍵は、ホストのプロビジョニングに用いられます。
  そして後には、<code class="language-plaintext highlighter-rouge">docker-machine ssh</code>コマンドを通じて、ドロップレットに直接アクセスするために用いられます。
  Docker Engine はクラウドサーバー上にインストールされ、Docker デーモンの TCP リモート接続を可能とするために TLS 認証を用いるように設定されます。</p>
  </li>
  <li>
    <p>DigitalOcean コンソールにアクセスして、新たなドロップレットを確認してみます。</p>

    <p><img src="/docs.docker.jp.onthefly/machine/img/ocean_droplet.png" alt="Machine により生成された DigitalOcean のドロップレット" /></p>
  </li>
  <li>
    <p>コマンドターミナル画面から<code class="language-plaintext highlighter-rouge">docker-machine ls</code>を実行します。</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker-machine ls
 NAME             ACTIVE   DRIVER         STATE     URL                         SWARM
 default          -        virtualbox     Running   tcp://192.168.99.100:2376
 docker-sandbox   *        digitalocean   Running   tcp://45.55.139.48:2376
</code></pre></div>    </div>

    <p>新たな<code class="language-plaintext highlighter-rouge">docker-sandbox</code>マシンが実行されています。
 それがアクティブホストとなっていることが、アスタリスク（*）の表示からわかります。
 さらに新たなマシンを生成すると、コマンドシェルは自動的にそのマシンに接続されます。
 何らかの理由によりマシンがアクティブホストでない場合は、<code class="language-plaintext highlighter-rouge">docker-machine env docker-sandbox</code>を実行した上で、<code class="language-plaintext highlighter-rouge">eval $(docker-machine env docker-sandbox)</code>を実行し、マシンへの接続を行います。</p>
  </li>
</ol>

<h3 id="step-4-run-docker-commands-on-the-droplet">ステップ 4. ドロップレット上での Docker コマンド実行</h3>

<ol>
  <li>
    <p>リモートホストが確認できる<code class="language-plaintext highlighter-rouge">docker-machine</code>コマンドを実行します。
たとえば<code class="language-plaintext highlighter-rouge">docker-machine ip &lt;マシン名&gt;</code>は、ホストの IP アドレスを取得します。
また<code class="language-plaintext highlighter-rouge">docker-machine inspect &lt;マシン名&gt;</code>はマシンの詳細を一覧表示します。</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker-machine ip docker-sandbox
 104.131.43.236

 $ docker-machine inspect docker-sandbox
 {
     "ConfigVersion": 3,
     "Driver": {
     "IPAddress": "104.131.43.236",
     "MachineName": "docker-sandbox",
     "SSHUser": "root",
     "SSHPort": 22,
     "SSHKeyPath": "/Users/samanthastevens/.docker/machine/machines/docker-sandbox/id_rsa",
     "StorePath": "/Users/samanthastevens/.docker/machine",
     "SwarmMaster": false,
     "SwarmHost": "tcp://0.0.0.0:3376",
     "SwarmDiscovery": "",
     ...
</code></pre></div>    </div>
  </li>
  <li>
    <p>Docker Engine が正しくインストールできていることを確認するために<code class="language-plaintext highlighter-rouge">docker</code>コマンドを実行します。</p>

    <p>たとえば<code class="language-plaintext highlighter-rouge">docker run hello-world</code>のような簡単なコマンドから実行してみてください。
 あるいはもっとおもしろい確認として、Docker 化されたウェブサーバーをリモートマシン上に起動してみます。</p>

    <p>以下の例において<code class="language-plaintext highlighter-rouge">-p</code>オプションは、<code class="language-plaintext highlighter-rouge">nginx</code>コンテナーのポート 80 を公開する指定であり、<code class="language-plaintext highlighter-rouge">docker-sandbox</code>ホストのポート<code class="language-plaintext highlighter-rouge">8000</code>からアクセスできるようにします。</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ docker run -d -p 8000:80 --name webserver kitematic/hello-world-nginx
 Unable to find image 'kitematic/hello-world-nginx:latest' locally
 latest: Pulling from kitematic/hello-world-nginx
 a285d7f063ea: Pull complete
 2d7baf27389b: Pull complete
 ...
 Digest: sha256:ec0ca6dcb034916784c988b4f2432716e2e92b995ac606e080c7a54b52b87066
 Status: Downloaded newer image for kitematic/hello-world-nginx:latest
 942dfb4a0eaae75bf26c9785ade4ff47ceb2ec2a152be82b9d7960e8b5777e65
</code></pre></div>    </div>

    <p>ウェブブラウザーから<code class="language-plaintext highlighter-rouge">http://&lt;ホストIP&gt;:8000</code>にアクセスして、ウェブサーバーのホームページを開きます。
 <code class="language-plaintext highlighter-rouge">&lt;host_ip&gt;</code>は、前のステップにおいて実行したコマンド<code class="language-plaintext highlighter-rouge">docker-machine ip &lt;マシン名&gt;</code>の出力結果から、すでに取得できているものです。
 また指定するポートは、<code class="language-plaintext highlighter-rouge">docker run</code>コマンドにおいて指定したものです。</p>

    <p><img src="/docs.docker.jp.onthefly/machine/img/nginx-webserver.png" alt="Nginx ウェブサーバー" /></p>
  </li>
</ol>

<h3 id="step-5-use-machine-to-remove-the-droplet">ステップ 5. Machine を使ったドロップレットの削除</h3>

<p>ホストとそのコンテナーやイメージを削除するには、その前にマシンを停止させ、それから<code class="language-plaintext highlighter-rouge">docker-machine rm</code>コマンドを実行します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker-machine stop docker-sandbox
$ docker-machine rm docker-sandbox
Do you really want to remove "docker-sandbox"? (y/n): y
Successfully removed docker-sandbox

$ docker-machine ls
NAME      ACTIVE   DRIVER       STATE     URL                         SWARM
default   *        virtualbox   Running   tcp:////xxx.xxx.xx.xxx:xxxx
</code></pre></div></div>

<p>上のコマンド実行の際に DigitalOcean コンソールを確認していたら、まずドロップレットが停止され、次にドロップレットが削除される様子がわかります。</p>

<p>Docker Machine を使ってホストを生成しておいて、その削除をクラウドプロバイダーコンソールから行ったとしたら、Docker Machine はサーバーの状態を追跡できないことになります。
<code class="language-plaintext highlighter-rouge">docker-machine create</code>を使って生成したホストは、<code class="language-plaintext highlighter-rouge">docker-machine rm</code>コマンドを使うようにしてください。</p>

<h2 id="where-to-go-next">次に読むものは</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/machine/concepts/">Machine の考え方</a></li>
  <li><a href="/docs.docker.jp.onthefly/machine/drivers/">Docker Machine ドライバーライセンス</a></li>
  <li><a href="/docs.docker.jp.onthefly/machine/reference/">Docker Machine サブコマンドリファレンス</a></li>
  <li><a href="/docs.docker.jp.onthefly/get-started/part2/">Docker Machine におけるコンテナー生成</a></li>
</ul>
