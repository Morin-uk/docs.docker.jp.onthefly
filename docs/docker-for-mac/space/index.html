
<p>Docker Desktop では Linux コンテナーやイメージを一つの大きな「ディスクイメージ」として Mac ファイルシステム内に保存します。
これは Linux 上の Docker とは異なっていて、Linux 上ではコンテナーやイメージは通常 <code class="language-plaintext highlighter-rouge">/var/lib/docker</code> ディレクトリに保存されます。</p>

<h2 id="where-is-the-disk-image-file">ディスクイメージファイルはどこにあるか</h2>

<p>ディスクイメージファイルの場所を確認するには、Docker アイコンを選択して <strong>Preferences</strong> &gt; <strong>Resources</strong> &gt; <strong>Advanced</strong> を実行します。</p>

<p><img src="/docs.docker.jp.onthefly/docker-for-mac/images/menu/prefs-advanced.png" alt="Disk preferences" width="750px" /></p>

<p><strong>Advanced</strong> タブに、ディスクイメージの場所が表示されています。
またディスクイメージの最大サイズや、現在消費しているディスクイメージ容量も表示されています。
なおファイルの利用容量のことを最大ファイルサイズと表現しているツールがありますが、実際のファイルサイズとして表現していないから誤りです。</p>

<h2 id="if-the-file-is-too-big">ファイルが大きすぎる場合</h2>

<p>ディスクイメージが大きくなりすぎた場合は、以下を行います。</p>

<ul>
  <li>より容量の大きなドライブに移動させます。</li>
  <li>不要なコンテナーあるいはイメージは削除します。</li>
  <li>ファイルの最大許容サイズを減らします。</li>
</ul>

<h3 id="move-the-file-to-a-bigger-drive">より大きなドライブへの移動</h3>

<p>ディスクイメージを別の場所に移動するには、以下を行います。</p>

<ol>
  <li>
    <p><strong>Preferences</strong> &gt; <strong>Resources</strong> &gt; <strong>Advanced</strong> を実行します。</p>
  </li>
  <li>
    <p><strong>Disk image location</strong>（ディスクイメージの場所）セクションにおいて、<strong>Browse</strong> をクリックして、ディスクイメージを置く新たな場所を選びます。</p>
  </li>
  <li>
    <p><strong>Apply &amp; Restart</strong> をクリックして、変更内容を適用します。</p>
  </li>
</ol>

<p>Finder においてファイルを直接移動しないでください。
これを行うと、Docker Desktop はファイルを追跡できなくなります。</p>

<h3 id="delete-unnecessary-containers-and-images">不要コンテナー、イメージの削除</h3>

<p>不要なコンテナーやイメージが残っていないか確認します。
クライアントやデーモン API のバージョンが 1.25 またはそれ以降である場合（クライアント上にて <code class="language-plaintext highlighter-rouge">docker version</code> を実行することで、クライアントとデーモン API のバージョンを確認できます）、以下を実行すると、ディスク使用状況の詳細を確認できます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker system df -v
</code></pre></div></div>

<p>あるいはイメージ一覧を見るには、以下を実行します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker image <span class="nb">ls</span>
</code></pre></div></div>

<p>またコンテナー一覧は以下を実行します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker container <span class="nb">ls</span> <span class="nt">-a</span>
</code></pre></div></div>

<p>不要なオブジェクトがたくさんあるなら、以下のコマンドを実行します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker system prune
</code></pre></div></div>

<p>このコマンドを実行すると、停止中のコンテナー、未使用のネットワーク、参照されていないイメージ、ビルドキャッシュをすべて削除します。</p>

<p>ディスクイメージファイルのフォーマットの違いにより、空き容量を作り出すには数分の時間を要します。</p>

<ul>
  <li>ファイル名が <code class="language-plaintext highlighter-rouge">Docker.raw</code> の場合： ホストが空き容量を作るのに要する時間は、数秒以内です。</li>
  <li>ファイル名が <code class="language-plaintext highlighter-rouge">Docker.qcow2</code> の場合： 空き容量生成にはバックグラウンド処理が実行され、数分を要します。</li>
</ul>

<p>容量が確保できるのは、イメージを削除できたときだけです。
ファイルが削除できたとしても、それが実行中コンテナー内であった場合は、容量の確保は自動的に行われません。
容量の確保を実行するには、以下のコマンドを実行します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run --privileged --pid=host docker/desktop-reclaim-space
</code></pre></div></div>

<p>多くのツールにおいて表示されるのは、最大ファイルサイズであって、実際のファイルサイズではありません。
ホスト上のファイルの本当のサイズを確認するには、ターミナルから以下を実行します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> ~/Library/Containers/com.docker.docker/Data
<span class="nv">$ </span><span class="nb">cd </span>vms/0/data
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-klsh</span> Docker.raw
2333548 <span class="nt">-rw-r--r--</span>@ 1 username  staff    64G Dec 13 17:42 Docker.raw
</code></pre></div></div>

<p>この例において、実際のディスクサイズは <code class="language-plaintext highlighter-rouge">2333548</code> KB であり、最大ディスクサイズは <code class="language-plaintext highlighter-rouge">64</code> GB です。</p>

<h3 id="reduce-the-maximum-size-of-the-file">ファイルの最大許容サイズの制限</h3>

<p>ディスクイメージファイルの最大サイズを減らすには、以下を行います。</p>

<ol>
  <li>
    <p>Docker アイコンを選択して <strong>Preferences</strong> &gt; <strong>Resources</strong> &gt; <strong>Advanced</strong> を実行します。</p>
  </li>
  <li>
    <p><strong>Disk image size</strong>（ディスクイメージサイズ）セクションにスライダーバーがあり、ディスクイメージの最大サイズを変更できるようになっています。
このスライダーを使って、最小限のサイズを設定します。</p>
  </li>
  <li>
    <p><strong>Apply &amp; Restart</strong> をクリックします。</p>
  </li>
</ol>

<p>最大サイズを減らした場合、現在のディスクイメージファイルは削除されます。
つまりすべてのコンテナーとイメージを失うことになります。</p>
