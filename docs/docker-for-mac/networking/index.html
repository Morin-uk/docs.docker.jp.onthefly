
<p>Docker Desktop for Mac では、より簡単に利用できるネットワーク機能をいくつも提供しています。</p>

<h2 id="features">機能</h2>

<h3 id="vpn-passthrough">VPN パススルー</h3>

<p>Docker Desktop for Mac のネットワークは VPN に接続して利用することができます。
このとき Docker Desktop for Mac は、コンテナーからのトラフィックを捕捉し Mac へ受け渡します。
まるで Docker アプリケーションから発信されたかのように扱います。</p>

<h3 id="port-mapping">ポートマッピング</h3>

<p>コンテナーの起動時に、たとえば以下のように <code class="language-plaintext highlighter-rouge">-p</code> 引数をつけたとします。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run -p 80:80 -d nginx
</code></pre></div></div>

<p>Docker Desktop for Mac は、コンテナー上のポート 80 を使って稼動するものすべて（この場合は <code class="language-plaintext highlighter-rouge">nginx</code>）、<code class="language-plaintext highlighter-rouge">localhost</code> のポート 80 から利用できるようにします。
この例では、ホストとコンテナーのそれぞれのポート番号は同一にしています。
ホストのポートを別のものに指定する必要があるとしたら、どうなるでしょう。
つまり、ホストマシン上においてすでにポート 80 を利用して起動しているアプリケーションがあるなら、コンテナーのポートを別のものに接続したらよいことになります。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run -p 8000:80 -d nginx
</code></pre></div></div>

<p>こうすると <code class="language-plaintext highlighter-rouge">localhost:8000</code> への接続が、コンテナー内のポート 80 へ接続されます。
<code class="language-plaintext highlighter-rouge">-p</code> の文法は <code class="language-plaintext highlighter-rouge">ホストポート:クライアントポート</code> です。</p>

<h3 id="httphttps-proxy-support">HTTP/HTTPS プロキシーサポート</h3>

<p><a href="/docs.docker.jp.onthefly/docker-for-mac/#proxies">Proxies タブ</a> を参照してください。</p>

<h2 id="known-limitations-use-cases-and-workarounds">既知の制約、利用状況、回避策</h2>

<p>以下では、Docker Desktop for Mac の現状のネットワーク機能における制約と回避方法についてまとめます。</p>

<h3 id="there-is-no-docker0-bridge-on-macos">macOS 上に docker0 ブリッジがない</h3>

<p>Docker Desktop for Mac におけるネットワーク機能の実装方法により、ホスト上から <code class="language-plaintext highlighter-rouge">docker0</code> インターフェースを見ることはできません。
このインターフェースは仮想マシン内にあります。</p>

<h3 id="i-cannot-ping-my-containers">コンテナーに ping ができない</h3>

<p>Docker Desktop for Mac がコンテナーに対して、トラフィックをルーティングできません。</p>

<h3 id="per-container-ip-addressing-is-not-possible">コンテナー単位の IP アドレス割り当てができない</h3>

<p>Docker の（Linux における）ブリッジネットワークが、macOS ホストからアクセスできません。</p>

<h3 id="use-cases-and-workarounds">利用状況と回避策</h3>

<p>上記の制約から影響を受ける利用状況が 2 つあります。</p>

<h4 id="i-want-to-connect-from-a-container-to-a-service-on-the-host">コンテナーからホスト上のサービスに接続したい</h4>

<p>ホストには可変の IP アドレスがあります（もっともネットワークを利用しなければ何もありません）。
推奨されるのは、特別な DNS 名 <code class="language-plaintext highlighter-rouge">host.docker.internal</code> に接続することです。
この DNS は、ホストが利用する内部 IP アドレスを名前解決します。
これは開発環境において用いられるものであり、Docker Desktop for Mac の範囲外にある本番環境では動作しません。</p>

<p>ゲートウェイも <code class="language-plaintext highlighter-rouge">gateway.docker.internal</code> を利用してアクセス可能です。</p>

<p>マシン上に Python をインストールしている場合は、例として以下の手順に従い、コンテナーからホスト上のサービスに接続します。</p>

<ol>
  <li>
    <p>以下のコマンドを実行して、単純の HTTP サーバーをポート 8000 で起動します。</p>

    <p><code class="language-plaintext highlighter-rouge">python -m http.server 8000</code></p>

    <p>Python 2.x をインストールしている場合は、<code class="language-plaintext highlighter-rouge">python -m SimpleHTTPServer 8000</code> を実行します。</p>
  </li>
  <li>
    <p>そしてコンテナーの実行と <code class="language-plaintext highlighter-rouge">curl</code> のインストールを行って、以下のコマンドのようにホストへの接続を試してみます。</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp"> $</span><span class="w"> </span>docker run <span class="nt">--rm</span> <span class="nt">-it</span> alpine sh
<span class="gp"> #</span><span class="w"> </span>apk add curl
<span class="gp"> #</span><span class="w"> </span>curl http://host.docker.internal:8000
<span class="gp"> #</span><span class="w"> </span><span class="nb">exit</span>
</code></pre></div>    </div>
  </li>
</ol>

<h4 id="i-want-to-connect-to-a-container-from-the-mac">Mac からコンテナーに接続したい</h4>

<p><code class="language-plaintext highlighter-rouge">localhost</code> に対するポート転送（port forwarding）が動作します。
つまり <code class="language-plaintext highlighter-rouge">--publish</code>、<code class="language-plaintext highlighter-rouge">-p</code>、<code class="language-plaintext highlighter-rouge">-P</code> はすべて動きます。
Linux コンテナーから公開されたポートは、ホストに転送されます。</p>

<p>今のところ推奨される方法は、ポートを公開するか、あるいはもう 1 つ別のコンテナーから接続することです。
Linux 上であっても、コンテナーがブリッジネットワーク上ではなく、オーバーレイネットワーク上にある場合には、こういった方法が必要になります。
その場合にはルートが解決されないからです。</p>

<p>以下は、<a href="/docs.docker.jp.onthefly/docker-for-mac/#explore-the-application">はじめよう</a> の節に示している <code class="language-plaintext highlighter-rouge">nginx</code> ウェブサーバーの起動コマンドです。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">-p</span> 80:80 <span class="nt">--name</span> webserver nginx
</code></pre></div></div>

<p>文法を明確にする目的で、以下の 2 つのコマンドを実行します。
両方ともコンテナー上のポート <code class="language-plaintext highlighter-rouge">80</code> を、ホスト上のポート <code class="language-plaintext highlighter-rouge">8000</code> に向けて公開するものです。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">--publish</span> 8000:80 <span class="nt">--name</span> webserver nginx

<span class="nv">$ </span>docker run <span class="nt">-p</span> 8000:80 <span class="nt">--name</span> webserver nginx
</code></pre></div></div>

<p>ポートをすべて公開するには <code class="language-plaintext highlighter-rouge">-P</code> フラグを使います。
たとえば以下のコマンドは（デタッチモードで）コンテナーを起動し、<code class="language-plaintext highlighter-rouge">-P</code> フラグによってコンテナー上の全ポートを、ホスト上のランダムなポートとして公開します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">-P</span> <span class="nt">--name</span> webserver nginx
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">docker run</code> コマンドにて利用できる、ポート公開に関するオプションの詳細については <a href="/docs.docker.jp.onthefly/engine/reference/commandline/run/">run コマンド</a> を参照してください。</p>
