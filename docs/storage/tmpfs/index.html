
<p><a href="/docs.docker.jp.onthefly/storage/volumes/">ボリューム</a> や <a href="/docs.docker.jp.onthefly/storage/bind-mounts/">バインドマウント</a> を利用すれば、ホストマシンとコンテナー間にてファイル共有ができました。
これによりコンテナーが停止した後でも、データを保持できるようになります。</p>

<p>Docker を Linux 上にて稼動させている場合は、さらに 3 つめの方法があります。
それが <code class="language-plaintext highlighter-rouge">tmpfs</code> マウントです。
<code class="language-plaintext highlighter-rouge">tmpfs</code> マウントを用いてコンテナーを生成した場合、コンテナーが書き込むファイルは、コンテナーの外部にある書き込みレイヤーに生成されます。</p>

<p>ボリュームやバインドマウントとは違って <code class="language-plaintext highlighter-rouge">tmpfs</code> マウントは一時的なものであり、ホストマシンのメモリ上にのみ存在します。
コンテナーが停止されると <code class="language-plaintext highlighter-rouge">tmpfs</code> マウントは削除されてしまうため、そこに書き込まれたファイルを保持し続けることはできません。</p>

<p><img src="/docs.docker.jp.onthefly/storage/images/types-of-mounts-tmpfs.png" alt="Docker ホスト上の tmpfs" /></p>

<p>これが有用になるのは、重要な情報を含んだファイルを一時的に保存したい場合です。
こういった情報は、ホスト上およびコンテナーの書き込みレイヤー上のいずれであっても、ずっと残しておくわけにはいかないものです。</p>

<h2 id="limitations-of-tmpfs-mounts">tmpfs マウントの制約</h2>

<ul>
  <li>ボリュームやバインドマウントとは違って、<code class="language-plaintext highlighter-rouge">tmpfs</code> マウントはコンテナー間で共有することはできません。</li>
  <li>この機能は Docker on Linux を稼動させている場合にのみ利用可能です。</li>
</ul>

<h2 id="choose-the---tmpfs-or---mount-flag">--tmpfs フラグ、--mount フラグの使い分け</h2>

<p>元々<code class="language-plaintext highlighter-rouge">--tmpfs</code> フラグはスタンドアロンコンテナー向けに用いられ、<code class="language-plaintext highlighter-rouge">--mount</code> フラグは Swarm サービス向けに用いられていました。
しかし Docker 17.06 以降では <code class="language-plaintext highlighter-rouge">--mount</code> がスタンドアロンコンテナーに対しても利用できるようになりました。
一般に <code class="language-plaintext highlighter-rouge">--mount</code> の方が、より明示的なものであり多くの記述を必要とします。
はっきりとした違いは <code class="language-plaintext highlighter-rouge">--tmpfs</code> フラグでは設定変更可能なオプションが用意されていないということです。</p>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">--tmpfs</code></strong>: <code class="language-plaintext highlighter-rouge">tmpfs</code> マウントを行いますが、設定変更が行えるようなオプション指定はありません。
またこのオプションはスタンドアロンコンテナーに対してしか用いることはできません。</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">--mount</code></strong>: 複数のキーバリューペアを指定し、個々は <code class="language-plaintext highlighter-rouge">&lt;key&gt;=&lt;value&gt;</code> の記述としてそれぞれをカンマで区切ります。
<code class="language-plaintext highlighter-rouge">--mount</code> の書式は <code class="language-plaintext highlighter-rouge">--tmpfs</code> に比べて多くの記述を必要とします。</p>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">type</code> によりマウントのタイプ、つまり <a href="/docs.docker.jp.onthefly/storage/bind-mounts/"><code class="language-plaintext highlighter-rouge">bind</code></a>, <code class="language-plaintext highlighter-rouge">volume</code>, <a href="/docs.docker.jp.onthefly/storage/tmpfs/"><code class="language-plaintext highlighter-rouge">tmpfs</code></a> のいずれかを指定します。
<code class="language-plaintext highlighter-rouge">tmpfs</code> の説明を行っていますから、ここでは <code class="language-plaintext highlighter-rouge">tmpfs</code> とします。</li>
      <li><code class="language-plaintext highlighter-rouge">destination</code> はバリューにパスを指定します。
これはコンテナー内にて <code class="language-plaintext highlighter-rouge">tmpfs</code> マウントを行うパスを表わします。
<code class="language-plaintext highlighter-rouge">destination</code>、<code class="language-plaintext highlighter-rouge">dst</code>、<code class="language-plaintext highlighter-rouge">target</code> として指定することもできます。</li>
      <li><code class="language-plaintext highlighter-rouge">tmpfs-size</code> と <code class="language-plaintext highlighter-rouge">tmpfs-mode</code> オプションがあります。
<a href="#specify-tmpfs-options">tmpfs オプション</a> を参照してください。</li>
    </ul>
  </li>
</ul>

<p>以降では <code class="language-plaintext highlighter-rouge">--mount</code> と <code class="language-plaintext highlighter-rouge">--tmpfs</code> の両方について、利用可能な書式を示します。
はじめに示すのは <code class="language-plaintext highlighter-rouge">--mount</code> です。</p>

<h3 id="differences-between---tmpfs-and---mount-behavior"><code class="language-plaintext highlighter-rouge">--tmpfs</code> と <code class="language-plaintext highlighter-rouge">--mount</code> の違い</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">--tmpfs</code> フラグには設定変更可能なオプションの指定はありません。</li>
  <li><code class="language-plaintext highlighter-rouge">--tmpfs</code> フラグは Swarm サービスに対して用いることはできません。
その場合は <code class="language-plaintext highlighter-rouge">--mount</code> を用います。</li>
</ul>

<h2 id="use-a-tmpfs-mount-in-a-container">コンテナー内での tmpfs マウントの利用</h2>

<p>コンテナー内にて <code class="language-plaintext highlighter-rouge">tmpfs</code> マウントを利用するには <code class="language-plaintext highlighter-rouge">--tmpfs</code> フラグを用います。
あるいは <code class="language-plaintext highlighter-rouge">--mount</code> フラグにて <code class="language-plaintext highlighter-rouge">type=tmpfs</code> と <code class="language-plaintext highlighter-rouge">destination</code> オプションを指定します。
<code class="language-plaintext highlighter-rouge">tmpfs</code> マウントに <code class="language-plaintext highlighter-rouge">source</code> オプションは存在しません。
以下の利用例は Nginx コンテナー内の <code class="language-plaintext highlighter-rouge">/app</code> に対して <code class="language-plaintext highlighter-rouge">tmpfs</code> マウントを生成するものです。
1 例めでは <code class="language-plaintext highlighter-rouge">--mount</code> フラグ、2 例めでは <code class="language-plaintext highlighter-rouge">--tmpfs</code> フラグを用いています。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" data-group="mount" data-target="#mount-run"><code>--mount</code></a></li>
  <li><a data-toggle="tab" data-group="volume" data-target="#tmpfs-run"><code>--tmpfs</code></a></li>
</ul>
<div class="tab-content">
  <div id="mount-run" class="tab-pane fade in active">

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="se">\</span>
  <span class="nt">-it</span> <span class="se">\</span>
  <span class="nt">--name</span> tmptest <span class="se">\</span>
  <span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span>tmpfs,destination<span class="o">=</span>/app <span class="se">\</span>
  nginx:latest
</code></pre></div>    </div>

  </div>
  <!--mount-->
  <div id="tmpfs-run" class="tab-pane fade">

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="se">\</span>
  <span class="nt">-it</span> <span class="se">\</span>
  <span class="nt">--name</span> tmptest <span class="se">\</span>
  <span class="nt">--tmpfs</span> /app <span class="se">\</span>
  nginx:latest
</code></pre></div>    </div>

  </div>
  <!--volume-->
</div>
<!--tab-content-->

<p>マウントが <code class="language-plaintext highlighter-rouge">tmpfs</code> マウントであることを確認するために <code class="language-plaintext highlighter-rouge">docker container inspect
tmptest</code> を実行します。
結果は <code class="language-plaintext highlighter-rouge">Mounts</code> の項に示されます。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"Tmpfs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"/app"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>

<p>コンテナーを削除します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker container stop tmptest

<span class="nv">$ </span>docker container <span class="nb">rm </span>tmptest
</code></pre></div></div>

<h3 id="specify-tmpfs-options">tmpfs オプションの指定</h3>

<p><code class="language-plaintext highlighter-rouge">tmpfs</code> マウントには設定変更可能なオプションが 2 つあります。
いずれも任意指定です。
これを指定する場合は <code class="language-plaintext highlighter-rouge">--mount</code> フラグを用います。
<code class="language-plaintext highlighter-rouge">--tmpfs</code> フラグではこれを指定することはできません。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">オプション</th>
      <th style="text-align: left">内容説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">tmpfs-size</code></td>
      <td style="text-align: left">tmpfs マウントサイズをバイト単位で指定します。デフォルトは無制限です。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">tmpfs-mode</code></td>
      <td style="text-align: left">tmpfs のファイルモードを 8 進数表記で指定します。たとえば <code class="language-plaintext highlighter-rouge">700</code>、<code class="language-plaintext highlighter-rouge">0770</code> などです。デフォルトはすべて書き込み可能な <code class="language-plaintext highlighter-rouge">1777</code> です。</td>
    </tr>
  </tbody>
</table>

<p>以下の例では <code class="language-plaintext highlighter-rouge">tmpfs-mode</code> に <code class="language-plaintext highlighter-rouge">1770</code> を指定しています。
つまりこのコンテナー内においては、全ユーザーからの読み取りが制限されます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="se">\</span>
  <span class="nt">-it</span> <span class="se">\</span>
  <span class="nt">--name</span> tmptest <span class="se">\</span>
  <span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span>tmpfs,destination<span class="o">=</span>/app,tmpfs-mode<span class="o">=</span>1770 <span class="se">\</span>
  nginx:latest
</code></pre></div></div>

<h2 id="next-steps">次のステップ</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/storage/volumes/">ボリューム</a> について</li>
  <li><a href="/docs.docker.jp.onthefly/storage/bind-mounts/">バインドマウント</a> について</li>
  <li><a href="/storage/storagedriver/">ストレージドライバー</a> について</li>
</ul>
