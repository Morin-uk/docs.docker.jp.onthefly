
<p>バインドマウントは Docker の初期のころから存在しています。
ただし <a href="/docs.docker.jp.onthefly/storage/volumes/">ボリューム</a> に比べると、バインドマウントの機能は限定されます。
バインドマウントを利用すると「ホストマシン」上のファイルやディレクトリがコンテナー内にマウントされます。
そのファイルやディレクトリは、ホストマシン上の絶対パスにより参照できます。
これとは違ってボリュームを利用すると、ホストマシン上に新たなディレクトリが生成され、そこが Docker の保存ディレクトリとなります。
そして Docker はそのディレクトリ内の内容を管理していきます。</p>

<p>そのファイルやディレクトリは、Docker ホストに存在している必要がなくなります。
存在してなかったとしても、必要とされるときには生成されます。
バインドマウントは非常に性能の良いものですが、ただしホストマシンのファイルシステムに依存するものとなり、利用可能な特定のディレクトリ構造に従ったものになります。
今から新たに Docker アプリケーションを開発しようとする場合は、これにかわって <a href="/docs.docker.jp.onthefly/storage/volumes/">名前つきボリューム</a> の利用を考えてみてください。
バインドマウントを管理するために Docker CLI コマンドを直接利用することはできなくなります。</p>

<p><img src="/docs.docker.jp.onthefly/storage/images/types-of-mounts-bind.png" alt="Docker ホスト上のバインドマウント" /></p>

<h2 id="choose-the--v-or---mount-flag">-v または --mount フラグの選択</h2>

<p>もともと <code class="language-plaintext highlighter-rouge">-v</code> フラグや <code class="language-plaintext highlighter-rouge">--volume</code> フラグはスタンドアロンコンテナーに対して、また <code class="language-plaintext highlighter-rouge">--mount</code> フラグはスウォームサービスに対して用いられてきたものです。
しかし Docker 17.06 からは <code class="language-plaintext highlighter-rouge">--mount</code> をスタンドアロンコンテナーに対しても利用できるようになりました。
全般に <code class="language-plaintext highlighter-rouge">--mount</code> の方がわかりやすいものですが、記述は増えます。
両者の最大の違いは、<code class="language-plaintext highlighter-rouge">-v</code> の文法がオプション指定のすべてを 1 項目にとりまとめるものであるのに対して、<code class="language-plaintext highlighter-rouge">--mount</code> の文法はそれを 1 つずつ個別に分けている点です。
以下に両フラグにおける文法を比較します。</p>

<blockquote>
  <p><strong>ヒント</strong>: はじめて利用する方は <code class="language-plaintext highlighter-rouge">--mount</code> を利用してください。
上級ユーザーは <code class="language-plaintext highlighter-rouge">-v</code> や <code class="language-plaintext highlighter-rouge">--volume</code> を用いることに慣れているかもしれませんが、<code class="language-plaintext highlighter-rouge">--mount</code> を利用するように心がけてください。
<code class="language-plaintext highlighter-rouge">--mount</code> の方が簡単に利用することができるとの調査もあります。</p>
</blockquote>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">-v</code> または <code class="language-plaintext highlighter-rouge">--volume</code></strong>: 3 つの項目から構成され、それぞれをコロン（<code class="language-plaintext highlighter-rouge">:</code>）で区切ります。
各項目は正しい順に記述する必要があります。
各項目の意味は、そのときどきによって変わります。
    <ul>
      <li>バインドマウントの場合、1 つめの項目は <strong>ホストマシン</strong> 上のファイルまたはディレクトリへのパスです。</li>
      <li>2 つめは、コンテナー内にマウントされるファイルまたディレクトリのパスです。</li>
      <li>3 つめは任意の指定項目であり、オプション指定をカンマ区切りで指定します。
指定内容には <code class="language-plaintext highlighter-rouge">ro</code>, <code class="language-plaintext highlighter-rouge">z</code>, <code class="language-plaintext highlighter-rouge">Z</code> などがあります。
このオプションに関しては後に説明しています。</li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">--mount</code></strong>: 複数のキーバリューペアを指定し、各ペアはカンマにより区切ります。
そしてそれぞれのペアは <code class="language-plaintext highlighter-rouge">&lt;key&gt;=&lt;value&gt;</code> という記述を行います。
<code class="language-plaintext highlighter-rouge">--mount</code> における記述は <code class="language-plaintext highlighter-rouge">-v</code> や <code class="language-plaintext highlighter-rouge">--volume</code> におけるものよりも長くなります。
しかしキーの並び順に意味はなく、このフラグに与えられたキーバリューの内容は容易に理解することができます。
    <ul>
      <li><code class="language-plaintext highlighter-rouge">type</code> はマウントのタイプであり、<code class="language-plaintext highlighter-rouge">bind</code>, <code class="language-plaintext highlighter-rouge">volume</code>, <code class="language-plaintext highlighter-rouge">tmpfs</code> といった値を指定します。
ここで説明しているのはバインドマウントであるため、常に <code class="language-plaintext highlighter-rouge">bind</code> であるものとします。</li>
      <li><code class="language-plaintext highlighter-rouge">source</code> はマウント元です。
バインドマウントにおいては、Docker デーモンホスト上のファイルまたはディレクトリへのパスになります。
<code class="language-plaintext highlighter-rouge">source</code> あるいは <code class="language-plaintext highlighter-rouge">src</code> といった指定がよく用いられます。</li>
      <li><code class="language-plaintext highlighter-rouge">destination</code> には、コンテナー上にてマウントするファイルまたはディレクトリのパスを指定します。
<code class="language-plaintext highlighter-rouge">destination</code>, <code class="language-plaintext highlighter-rouge">dst</code>, <code class="language-plaintext highlighter-rouge">target</code> といった指定がよく用いられます。</li>
      <li>オプション <code class="language-plaintext highlighter-rouge">readonly</code> が指定されると、そのバインドマウンドが <a href="#use-a-read-only-bind-mount">コンテナーにおける読み込み専用マウント</a> としてマウントされます。</li>
      <li>オプション <code class="language-plaintext highlighter-rouge">bind-propagation</code> が指定されると、<a href="#configure-bind-propagation">バインドプロパゲーション</a>（bind propagation）の設定変更を行います。
<code class="language-plaintext highlighter-rouge">rprivate</code>, <code class="language-plaintext highlighter-rouge">private</code>, <code class="language-plaintext highlighter-rouge">rshared</code>, <code class="language-plaintext highlighter-rouge">shared</code>, <code class="language-plaintext highlighter-rouge">rslave</code>, <code class="language-plaintext highlighter-rouge">slave</code> のいずれかを指定します。</li>
      <li><code class="language-plaintext highlighter-rouge">--mount</code> フラグは、selinux ラベルを修正するための <code class="language-plaintext highlighter-rouge">z</code> または <code class="language-plaintext highlighter-rouge">Z</code> オプションには対応していません。</li>
    </ul>
  </li>
</ul>

<p>これ以降においては、可能なら <code class="language-plaintext highlighter-rouge">--mount</code> と <code class="language-plaintext highlighter-rouge">-v</code> の両方の例を示していきます。
また先に示すのは <code class="language-plaintext highlighter-rouge">--mount</code> とします。</p>

<h3 id="differences-between--v-and---mount-behavior"><code class="language-plaintext highlighter-rouge">-v</code> と <code class="language-plaintext highlighter-rouge">--mount</code> の動作の違い</h3>

<p><code class="language-plaintext highlighter-rouge">-v</code> および <code class="language-plaintext highlighter-rouge">--volume</code> フラグは、長らく Docker の一部分として実現してきているため、その動作を今さら変更することはできません。
このことがつまり、<strong><code class="language-plaintext highlighter-rouge">-v</code> と <code class="language-plaintext highlighter-rouge">--mount</code> の動作の違いの 1 つ</strong> になります。</p>

<p><code class="language-plaintext highlighter-rouge">-v</code> または <code class="language-plaintext highlighter-rouge">--volume</code> を使ってファイルやディレクトリをバインドマウントした際に、そのファイルやディレクトリが Docker ホスト上にまだ存在していなかった場合、<code class="language-plaintext highlighter-rouge">-v</code> はそのマウントエンドポイントを生成します。
<strong>その場合には常にディレクトリとして生成されます。</strong></p>

<p><code class="language-plaintext highlighter-rouge">--mount</code> を使ってファイルやディレクトリをバインドマウントした際に、そのファイルやディレクトリが Docker ホスト上に存在していなかった場合、Docker はそのファイルやディレクトリを自動的に生成することは<strong>しません</strong>。
かわりにエラーが出力されます。</p>

<h2 id="start-a-container-with-a-bind-mount">バインドマウントを用いたコンテナーの起動</h2>

<p>仮に <code class="language-plaintext highlighter-rouge">source</code> というディレクトリがあって、そこにソースコードが置かれているとします。
そして成果物はそのサブディレクトリ <code class="language-plaintext highlighter-rouge">source/target/</code> に置かれるものとします。
ここでコンテナーが <code class="language-plaintext highlighter-rouge">/app/</code> というディレクトリから、その成果物にアクセスできるようにします。
つまり開発ホスト上のソースディレクトリにおいて成果物をビルドしたら、すぐにその最新の成果物をコンテナーがアクセスできるようにする、というものです。
これを実現するには以下のようなコマンドにより、<code class="language-plaintext highlighter-rouge">target/</code> ディレクトリをコンテナー内の <code class="language-plaintext highlighter-rouge">/app/</code> にバインドマウントします。
コマンドは <code class="language-plaintext highlighter-rouge">source</code> ディレクトリから実行します。
<code class="language-plaintext highlighter-rouge">$(pwd)</code> というサブコマンドは、Linux あるいは macOS ホスト上において、カレントディレクトリに展開されます。</p>

<p><code class="language-plaintext highlighter-rouge">--mount</code> と <code class="language-plaintext highlighter-rouge">-v</code> によるそれぞれの例は、同一の結果になります。
ただし 2 つの例を同時に実行することはできません。
実行するためには、実行前に <code class="language-plaintext highlighter-rouge">devtest</code> コンテナーを削除しておくことが必要になります。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" data-group="mount" data-target="#mount-run"><code>--mount</code></a></li>
  <li><a data-toggle="tab" data-group="volume" data-target="#v-run"><code>-v</code></a></li>
</ul>
<div class="tab-content">
  <div id="mount-run" class="tab-pane fade in active">

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="se">\</span>
  <span class="nt">-it</span> <span class="se">\</span>
  <span class="nt">--name</span> devtest <span class="se">\</span>
  <span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span><span class="s2">"</span>/target,target<span class="o">=</span>/app <span class="se">\</span>
  nginx:latest
</code></pre></div>    </div>

  </div>
  <!--mount-->
  <div id="v-run" class="tab-pane fade">

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="se">\</span>
  <span class="nt">-it</span> <span class="se">\</span>
  <span class="nt">--name</span> devtest <span class="se">\</span>
  <span class="nt">-v</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span><span class="s2">"</span>/target:/app <span class="se">\</span>
  nginx:latest
</code></pre></div>    </div>

  </div>
  <!--volume-->
</div>
<!--tab-content-->

<p>バインドマウントが正しく生成されたかどうかを <code class="language-plaintext highlighter-rouge">docker inspect devtest</code> により確認します。
出力の中で <code class="language-plaintext highlighter-rouge">Mounts</code> の項目を見てみます。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"Mounts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bind"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/tmp/source/target"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Destination"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/app"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Mode"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
        </span><span class="nl">"RW"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Propagation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rprivate"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>

<p>この情報から、マウントは「バインド」マウントであることがわかります。
そしてマウント元、マウント先が正しいものであること、マウントが読み書き可能であること、プロパゲーションは <code class="language-plaintext highlighter-rouge">rprivate</code> に設定されていることがわかります。</p>

<p>コンテナーを停止します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker container stop devtest

<span class="nv">$ </span>docker container <span class="nb">rm </span>devtest
</code></pre></div></div>

<h3 id="mount-into-a-non-empty-directory-on-the-container">コンテナー上の空ではないディレクトリへのマウント</h3>

<p>バインドマウントする先のコンテナー内ディレクトリが空でなかったとします。
このときそのディレクトリ内にはじめからあった内容は、バインドマウントによって見えなくなってしまいます。
そうであっても、このことを便利に利用できる場合もあります。
たとえばアプリケーションの新バージョンをテストする際に、新たなイメージをビルドせずに実現するような場合です。
ただしそういった状況には驚くかもしれません。
またこの動きは <a href="/docs.docker.jp.onthefly/storage/volumes/">Docker ボリューム</a> とは異なるものです。</p>

<p>以下は極端な例です。
コンテナーの <code class="language-plaintext highlighter-rouge">/usr/</code> ディレクトリをホストマシン上の <code class="language-plaintext highlighter-rouge">/tmp/</code> ディレクトリに置き換えてしまうものです。
おそらくこのコンテナーは使いものにならなくなります。</p>

<p><code class="language-plaintext highlighter-rouge">--mount</code> と <code class="language-plaintext highlighter-rouge">-v</code> によるそれぞれの例は、同一の結果になります。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" data-group="mount" data-target="#mount-empty-run"><code>--mount</code></a></li>
  <li><a data-toggle="tab" data-group="volume" data-target="#v-empty-run"><code>-v</code></a></li>
</ul>
<div class="tab-content">
  <div id="mount-empty-run" class="tab-pane fade in active">

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="se">\</span>
  <span class="nt">-it</span> <span class="se">\</span>
  <span class="nt">--name</span> broken-container <span class="se">\</span>
  <span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/tmp,target<span class="o">=</span>/usr <span class="se">\</span>
  nginx:latest

docker: Error response from daemon: oci runtime error: container_linux.go:262:
starting container process caused <span class="s2">"exec: </span><span class="se">\"</span><span class="s2">nginx</span><span class="se">\"</span><span class="s2">: executable file not found in </span><span class="nv">$PATH</span><span class="s2">"</span><span class="nb">.</span>
</code></pre></div>    </div>

  </div>
  <!--mount-->
  <div id="v-empty-run" class="tab-pane fade">

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="se">\</span>
  <span class="nt">-it</span> <span class="se">\</span>
  <span class="nt">--name</span> broken-container <span class="se">\</span>
  <span class="nt">-v</span> /tmp:/usr <span class="se">\</span>
  nginx:latest

docker: Error response from daemon: oci runtime error: container_linux.go:262:
starting container process caused <span class="s2">"exec: </span><span class="se">\"</span><span class="s2">nginx</span><span class="se">\"</span><span class="s2">: executable file not found in </span><span class="nv">$PATH</span><span class="s2">"</span><span class="nb">.</span>
</code></pre></div>    </div>

  </div>
  <!--volume-->
</div>
<!--tab-content-->

<p>コンテナーは生成されましたが、起動はされませんでした。
コンテナーはここで削除します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker container <span class="nb">rm </span>broken-container
</code></pre></div></div>

<h2 id="use-a-read-only-bind-mount">読み込み専用バインドマウントの利用</h2>

<p>開発アプリケーションにおいて、バインドマウントに対してコンテナーから書き込みを行う必要があるものも当然あります。
この場合、その書き込みは Docker ホストに対して行われます。
一方でコンテナーが読み込みアクセスだけを必要とする場合もあります。</p>

<p>以下の例では先ほどと同様ながら、ディレクトリは読み込み専用としてバインドマウントするものです。
以下ではコンテナー内のマウントポイント指定の後に、リスト形式のオプションとして（デフォルトでは何も記述しない箇所に）<code class="language-plaintext highlighter-rouge">ro</code> を加えます。
複数のオプション指定を行っているので、それぞれをカンマで区切ります。</p>

<p><code class="language-plaintext highlighter-rouge">--mount</code> と <code class="language-plaintext highlighter-rouge">-v</code> によるそれぞれの例は、同一の結果になります。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" data-group="mount" data-target="#mount-readonly"><code>--mount</code></a></li>
  <li><a data-toggle="tab" data-group="volume" data-target="#v-readonly"><code>-v</code></a></li>
</ul>
<div class="tab-content">
  <div id="mount-readonly" class="tab-pane fade in active">

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="se">\</span>
  <span class="nt">-it</span> <span class="se">\</span>
  <span class="nt">--name</span> devtest <span class="se">\</span>
  <span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span><span class="s2">"</span>/target,target<span class="o">=</span>/app,readonly <span class="se">\</span>
  nginx:latest
</code></pre></div>    </div>

  </div>
  <!--mount-->
  <div id="v-readonly" class="tab-pane fade">

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="se">\</span>
  <span class="nt">-it</span> <span class="se">\</span>
  <span class="nt">--name</span> devtest <span class="se">\</span>
  <span class="nt">-v</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span><span class="s2">"</span>/target:/app:ro <span class="se">\</span>
  nginx:latest
</code></pre></div>    </div>

  </div>
  <!--volume-->
</div>
<!--tab-content-->

<p>バインドマウントが正しく生成されたかどうかを <code class="language-plaintext highlighter-rouge">docker inspect devtest</code> により確認します。
出力の中で <code class="language-plaintext highlighter-rouge">Mounts</code> の項目を見てみます。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"Mounts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bind"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/tmp/source/target"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Destination"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/app"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Mode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ro"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"RW"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"Propagation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rprivate"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>

<p>コンテナーを停止します。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker container stop devtest

<span class="nv">$ </span>docker container <span class="nb">rm </span>devtest
</code></pre></div></div>

<h2 id="configure-bind-propagation">バインドプロパゲーションの設定</h2>

<p>バインドマウントとボリュームのいずれにおいても、バインドプロパゲーション（bind propagation）のデフォルトは <code class="language-plaintext highlighter-rouge">rprivate</code> です。
この設定はバインドマウントに対してのみ、また Linux ホストマシン上においてのみ変更可能です。
バインドプロパゲーションは高度な技術であるため、多くのユーザーは設定する必要はありません。</p>

<p>バインドプロパゲーションとは、指定されたバインドマウントや名前つきボリュームによって生成されるマウントが、そのレプリカに対して情報伝達（propagate）をするかどうかを表わします。
ここで <code class="language-plaintext highlighter-rouge">/mnt</code> というマウントポイントを考えます。
これが <code class="language-plaintext highlighter-rouge">/tmp</code> にマウントされているとします。
これに対するプロパゲーションの設定は、<code class="language-plaintext highlighter-rouge">/tmp/a</code> 上のマウントが <code class="language-plaintext highlighter-rouge">/mnt/a</code> として利用可能かどうかを制御するものです。
プロパゲーションの各設定においては、再帰的に対応するマウントポイントが存在します。
再帰的という点でいうと、仮に <code class="language-plaintext highlighter-rouge">/tmp/a</code> が <code class="language-plaintext highlighter-rouge">/foo</code> としてマウントされていたとします。
このときプロパゲーション設定は <code class="language-plaintext highlighter-rouge">/mnt/a</code> や <code class="language-plaintext highlighter-rouge">/tmp/a</code> が存在するかどうかを定めるものです。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">プロパゲーション設定</th>
      <th style="text-align: left">内容説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">shared</code></td>
      <td style="text-align: left">マウント元に対するサブマウントは、マウント先にも公開されます。マウント先に対するサブマウントも、マウント元に対して公開されます。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">slave</code></td>
      <td style="text-align: left">shared に類似。ただし一方向のみ。マウント元がサブマウントを公開するなら、マウント先でもこれを見ることができますが、マウント先がサブマウントを公開しても、マウント元からは見ることができません。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">private</code></td>
      <td style="text-align: left">マウントはプライベートなものになります。マウント元におけるサブマウントは、マウント先に公開されません。またマウント先のサブマウントも、マウント元には公開されません。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">rshared</code></td>
      <td style="text-align: left">shared と同様。, but the propagation also extends to and from mount points nested within any of the original or replica mount points.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">rslave</code></td>
      <td style="text-align: left">slave と同様。, but the propagation also extends to and from mount points nested within any of the original or replica mount points.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">rprivate</code></td>
      <td style="text-align: left">デフォルト。private と同様。つまりマウント元やマウント先に対するサブマウントは、どの方向にも伝播（propagate）しません。</td>
    </tr>
  </tbody>
</table>

<p>マウントポイントに対してバインドプロパゲーションを設定するには、ホストのファイルシステムがバインドプロパゲーションに対応している必要があります。</p>

<p>バインドプロパゲーションの詳細は <a href="https://www.kernel.org/doc/Documentation/filesystems/sharedsubtree.txt" target="_blank" rel="noopener" class="_">Linux カーネルドキュメントの shared subtree</a> を参照してください。</p>

<p>以下の例では <code class="language-plaintext highlighter-rouge">target/</code> ディレクトリをコンテナーに対して 2 度マウントしています。
そして 2 つめのマウントでは <code class="language-plaintext highlighter-rouge">ro</code> オプションと、バインドプロパゲーションのオプション <code class="language-plaintext highlighter-rouge">rslave</code> を指定しています。</p>

<p><code class="language-plaintext highlighter-rouge">--mount</code> と <code class="language-plaintext highlighter-rouge">-v</code> によるそれぞれの例は、同一の結果になります。</p>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" data-group="mount" data-target="#mount-propagation"><code>--mount</code></a></li>
  <li><a data-toggle="tab" data-group="volume" data-target="#v-propagation"><code>-v</code></a></li>
</ul>
<div class="tab-content">
  <div id="mount-propagation" class="tab-pane fade in active">

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="se">\</span>
  <span class="nt">-it</span> <span class="se">\</span>
  <span class="nt">--name</span> devtest <span class="se">\</span>
  <span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span><span class="s2">"</span>/target,target<span class="o">=</span>/app <span class="se">\</span>
  <span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span><span class="s2">"</span>/target,target<span class="o">=</span>/app2,readonly,bind-propagation<span class="o">=</span>rslave <span class="se">\</span>
  nginx:latest
</code></pre></div>    </div>

  </div>
  <!--mount-->
  <div id="v-propagation" class="tab-pane fade">

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="se">\</span>
  <span class="nt">-it</span> <span class="se">\</span>
  <span class="nt">--name</span> devtest <span class="se">\</span>
  <span class="nt">-v</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span><span class="s2">"</span>/target:/app <span class="se">\</span>
  <span class="nt">-v</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span><span class="s2">"</span>/target:/app2:ro,rslave <span class="se">\</span>
  nginx:latest
</code></pre></div>    </div>

  </div>
  <!--volume-->
</div>
<!--tab-content-->

<p>Now if you create <code class="language-plaintext highlighter-rouge">/app/foo/</code>, <code class="language-plaintext highlighter-rouge">/app2/foo/</code> also exists.</p>

<h2 id="configure-the-selinux-label">selinux ラベルの設定</h2>

<p><code class="language-plaintext highlighter-rouge">selinux</code> を利用している場合 <code class="language-plaintext highlighter-rouge">z</code> または <code class="language-plaintext highlighter-rouge">Z</code> オプションを使って、selinux ラベルを修正することができます。
修正するのは、コンテナーに対してマウントされている <strong>ホスト上のファイルやディレクトリ</strong> です。
つまりその結果はホストマシンそのもののファイルやディレクトリを変更するため、Docker の範囲外に影響を及ぼします。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">z</code> オプションは、複数コンテナー間においてバインドマウントされた内容を共有します。</li>
  <li><code class="language-plaintext highlighter-rouge">Z</code> オプションは、バインドマウントされた内容はプライベートなものであって共有はされません。</li>
</ul>

<p>このオプションに対しては <strong>最大限</strong> 注意してください。
<code class="language-plaintext highlighter-rouge">Z</code> オプションを使って、<code class="language-plaintext highlighter-rouge">/home</code> や <code class="language-plaintext highlighter-rouge">/usr</code> などのようなシステムディレクトリをバインドマウントしてしまうと、ホストマシンは制御できなくなり、ホストマシン上のファイルに対するラベル設定を手動で行うことになります。</p>

<blockquote class="important">
  <p><strong>重要</strong>: バインドマウントをサービス内にて行った場合には、selinux ラベル（<code class="language-plaintext highlighter-rouge">:Z</code> や <code class="language-plaintext highlighter-rouge">:z</code>）は、<code class="language-plaintext highlighter-rouge">ro</code> と同じように無視されます。
詳しくは <a href="https://github.com/moby/moby/issues/32579">moby/moby #32579</a> を参照してください。</p>
</blockquote>

<p>以下は <code class="language-plaintext highlighter-rouge">z</code> オプションの指定により、複数コンテナーがバインドマウント先を共有できるようにする例です。</p>

<p>selinux ラベルの修正は <code class="language-plaintext highlighter-rouge">--mount</code> フラグでは行うことができません。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="se">\</span>
  <span class="nt">-it</span> <span class="se">\</span>
  <span class="nt">--name</span> devtest <span class="se">\</span>
  <span class="nt">-v</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span><span class="s2">"</span>/target:/app:z <span class="se">\</span>
  nginx:latest
</code></pre></div></div>

<h2 id="next-steps">次のステップ</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/storage/volumes/">ボリューム</a> について学ぶ</li>
  <li><a href="/docs.docker.jp.onthefly/storage/tmpfs/">tmpfs マウント</a> について学ぶ</li>
  <li><a href="/storage/storagedriver/">ストレージドライバー</a> について学ぶ</li>
</ul>
