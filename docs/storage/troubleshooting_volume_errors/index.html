
<p>ここでは Docker ボリュームやバインドマウントの利用時に発生しやすいエラーについて示します。</p>

<h2 id="error-unable-to-remove-filesystem"><code class="language-plaintext highlighter-rouge">Error: Unable to remove filesystem</code></h2>

<p><a href="https://github.com/google/cadvisor">Google cAdvisor</a> のようなコンテナーベースのユーティリティーにおいては、<code class="language-plaintext highlighter-rouge">/var/lib/docker/</code> といった Docker システムのディレクトリをコンテナーにマウントするものがあります。
たとえば <code class="language-plaintext highlighter-rouge">cadvisor</code> のドキュメントには、<code class="language-plaintext highlighter-rouge">cadvisor</code> コンテナーを以下のようにして実行するように説明しています。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker run <span class="se">\</span>
  <span class="nt">--volume</span><span class="o">=</span>/:/rootfs:ro <span class="se">\</span>
  <span class="nt">--volume</span><span class="o">=</span>/var/run:/var/run:rw <span class="se">\</span>
  <span class="nt">--volume</span><span class="o">=</span>/sys:/sys:ro <span class="se">\</span>
  <span class="nt">--volume</span><span class="o">=</span>/var/lib/docker/:/var/lib/docker:ro <span class="se">\</span>
  <span class="nt">--publish</span><span class="o">=</span>8080:8080 <span class="se">\</span>
  <span class="nt">--detach</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--name</span><span class="o">=</span>cadvisor <span class="se">\</span>
  google/cadvisor:latest
</code></pre></div></div>

<p>When you bind-mount <code class="language-plaintext highlighter-rouge">/var/lib/docker/</code>, this effectively mounts all resources of
all other running containers as filesystems within the container which mounts
<code class="language-plaintext highlighter-rouge">/var/lib/docker/</code>. When you attempt to remove any of these containers, the
removal attempt may fail with an error like the following:</p>

<pre><code class="language-none">Error: Unable to remove filesystem for
74bef250361c7817bee19349c93139621b272bc8f654ae112dd4eb9652af9515:
remove /var/lib/docker/containers/74bef250361c7817bee19349c93139621b272bc8f654ae112dd4eb9652af9515/shm:
Device or resource busy
</code></pre>

<p>The problem occurs if the container which bind-mounts <code class="language-plaintext highlighter-rouge">/var/lib/docker/</code>
uses <code class="language-plaintext highlighter-rouge">statfs</code> or <code class="language-plaintext highlighter-rouge">fstatfs</code> on filesystem handles within <code class="language-plaintext highlighter-rouge">/var/lib/docker/</code>
and does not close them.</p>

<p>Typically, we would advise against bind-mounting <code class="language-plaintext highlighter-rouge">/var/lib/docker</code> in this way.
However, <code class="language-plaintext highlighter-rouge">cAdvisor</code> requires this bind-mount for core functionality.</p>

<p>If you are unsure which process is causing the path mentioned in the error to
be busy and preventing it from being removed, you can use the <code class="language-plaintext highlighter-rouge">lsof</code> command
to find its process. For instance, for the error above:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>lsof /var/lib/docker/containers/74bef250361c7817bee19349c93139621b272bc8f654ae112dd4eb9652af9515/shm
</code></pre></div></div>

<p>To work around this problem, stop the container which bind-mounts
<code class="language-plaintext highlighter-rouge">/var/lib/docker</code> and try again to remove the other container.</p>
