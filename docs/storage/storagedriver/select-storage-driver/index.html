
<p>理想を言えば、コンテナーの書き込みレイヤーへのデータの書き込みは最小とし、データ出力先には Docker ボリュームを利用します。
しかし処理内容によっては、書き込みレイヤーにデータを書き込めるようにする必要が出てきます。
これがあるからこそストレージドライバーが必要になります。</p>

<p>Docker では複数のストレージドライバーがサポートされ、これは交換可能な、つまりプラガブルなアーキテクチャーに基づいています。
ストレージドライバーは Docker ホスト上において、イメージやコンテナーが行うデータ保存や管理を制御します。</p>

<p><a href="/docs.docker.jp.onthefly/storage/storagedriver/">ストレージドライバーの概要</a> を読み終えたら、次は作業に必要となる最良のストレージドライバーを選択することです。
ドライバーを決定するにあたっては、考えておくべき高度な要因が 3 つあります。</p>

<p>利用するカーネルが複数のストレージドライバーに対応している場合に Docker は、ストレージドライバーが設定されていなかったとしても、どのストレージドライバーを用いるべきであるかを示す優先リストを持ちます。
あくまでストレージドライバーが利用できる前提条件を満たしている場合に限ります。</p>

<p>ストレージドライバーは多くの利用状況において、最大限の性能と安定性を持つものを利用します。</p>

<p>Docker は以下のストレージドライバーをサポートします。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">overlay2</code> は、現在サポートしている Linux ディストリビューションの中で、よく用いられているストレージドライバーです。
 特別な設定は必要ありません。</li>
  <li><code class="language-plaintext highlighter-rouge">aufs</code> は Docker 18.06 あるいはそれ以前においては、よく用いられていました。
 そのときはカーネル 3.13 を利用する Ubuntu 14.04 において稼動しており、<code class="language-plaintext highlighter-rouge">overlay2</code> がサポートされていないときでした。</li>
  <li><code class="language-plaintext highlighter-rouge">devicemapper</code> はサポートされているものですが、本番環境において <code class="language-plaintext highlighter-rouge">direct-lvm</code> が必要となります。
 というのも <code class="language-plaintext highlighter-rouge">loopback-lvm</code> は何も設定する必要がないのですが、処理性能が極めて低いためです。
 <code class="language-plaintext highlighter-rouge">devicemapper</code> は CentOS や RHEL において推奨されていました。
 これらのカーネルバージョンが <code class="language-plaintext highlighter-rouge">overlay2</code> をサポートしていなかったためです。
 最新の CentOS と RHEL においては <code class="language-plaintext highlighter-rouge">overlay2</code> がサポートされ、今では <code class="language-plaintext highlighter-rouge">overlay2</code> が推奨ドライバーとなっています。</li>
  <li><code class="language-plaintext highlighter-rouge">btrfs</code> と <code class="language-plaintext highlighter-rouge">zfs</code> というストレージドライバーは、その名前が示すファイルシステム上において利用します。
（ファイルシステムは Docker がインストールされているホスト上のファイルシステムを表わします。）
このファイルシステムに対しては「snapshots」を生成するような高度なオプションがありますが、他に比べて設定と保守を必要とします。
このドライバーを利用するためには、それぞれのファイルシステムが適切に設定できていることが必要です。</li>
  <li><code class="language-plaintext highlighter-rouge">vfs</code> ストレージドライバーはテスト目的を意図しています。
またはコピーオンライト方式のファイルシステムを利用しなくて構わない状況での利用を意図しています。
このストレージドライバーの性能は低く、一般に本番環境での利用は推奨されません。</li>
</ul>

<p>Docker のソースコードにおいては優先順位を定義しています。
その順番は <a href="https://github.com/docker/docker-ce/blob/19.03/components/engine/daemon/graphdriver/driver_linux.go#L50">Docker Engine - Community 19.03 のソースコード</a> を見ればわかります。</p>

<p id="storage-driver-order">上のサイトのファイル参照画面において Docker バージョンが利用するものと異なっている場合は、画面上部にあるブランチ切り替えボタンを使って、利用しているバージョンブランチに切り替えてください。</p>

<p>ストレージドライバーにおいては、それが基づいているファイルシステムに対応した所定のフォーマットを必要とします。
特定のファイルシステムを利用するべき理由がある場合には、ドライバーの選択肢が少なくなるかもしれません。
<a href="#supported-backing-filesystems">対応するファイルシステム</a> を参照してください。</p>

<p>どのストレージドライバーを利用するべきかが絞り込めてきたら、開発作業の特性や必要となる安定性に基づいて最終決定を行います。
<a href="#other-considerations">その他の考慮事項</a> を参考にして、最終的な決定を行ってください。</p>

<blockquote>
  <p><strong><em>メモ</em></strong>: ドライバーの選択は Docker エディション、オペレーティングシステム、ディストリビューションにより限定されることがあります。
たとえば <code class="language-plaintext highlighter-rouge">aufs</code> は Ubuntu と Debian においてのみサポートされるものであって、しかも追加パッケージのインストールを必要とします。
また <code class="language-plaintext highlighter-rouge">btrfs</code> は SLES に対してのみサポートされ、さらに Docker Enterprise にしか対応していません。
詳しくは <a href="#supported-storage-drivers-per-linux-distribution">Linux ディストリビューションがサポートするストレージドライバー</a> を参照してください。</p>
</blockquote>

<h2 id="supported-storage-drivers-per-linux-distribution">Linux ディストリビューションがサポートするストレージドライバー</h2>

<p>At a high level, the storage drivers you can use is partially determined by
the Docker edition you use.</p>

<p>In addition, Docker does not recommend any configuration that requires you to
disable security features of your operating system, such as the need to disable
<code class="language-plaintext highlighter-rouge">selinux</code> if you use the <code class="language-plaintext highlighter-rouge">overlay</code> or <code class="language-plaintext highlighter-rouge">overlay2</code> driver on CentOS.</p>

<h3 id="docker-engine---community">Docker Engine - Community</h3>

<p>For Docker Engine - Community, only some configurations are tested, and your operating
system’s kernel may not support every storage driver. In general, the following
configurations work on recent versions of the Linux distribution:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Linux distribution</th>
      <th style="text-align: left">Recommended storage drivers</th>
      <th style="text-align: left">Alternative drivers</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Docker Engine - Community on Ubuntu</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">overlay2</code> or <code class="language-plaintext highlighter-rouge">aufs</code> (for Ubuntu 14.04 running on kernel 3.13)</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">overlay</code>¹, <code class="language-plaintext highlighter-rouge">devicemapper</code>², <code class="language-plaintext highlighter-rouge">zfs</code>, <code class="language-plaintext highlighter-rouge">vfs</code></td>
    </tr>
    <tr>
      <td style="text-align: left">Docker Engine - Community on Debian</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">overlay2</code> (Debian Stretch), <code class="language-plaintext highlighter-rouge">aufs</code> or <code class="language-plaintext highlighter-rouge">devicemapper</code> (older versions)</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">overlay</code>¹, <code class="language-plaintext highlighter-rouge">vfs</code></td>
    </tr>
    <tr>
      <td style="text-align: left">Docker Engine - Community on CentOS</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">overlay2</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">overlay</code>¹, <code class="language-plaintext highlighter-rouge">devicemapper</code>², <code class="language-plaintext highlighter-rouge">zfs</code>, <code class="language-plaintext highlighter-rouge">vfs</code></td>
    </tr>
    <tr>
      <td style="text-align: left">Docker Engine - Community on Fedora</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">overlay2</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">overlay</code>¹, <code class="language-plaintext highlighter-rouge">devicemapper</code>², <code class="language-plaintext highlighter-rouge">zfs</code>, <code class="language-plaintext highlighter-rouge">vfs</code></td>
    </tr>
  </tbody>
</table>

<p>¹) The <code class="language-plaintext highlighter-rouge">overlay</code> storage driver is deprecated in Docker Engine - Enterprise 18.09, and will be
removed in a future release. It is recommended that users of the <code class="language-plaintext highlighter-rouge">overlay</code> storage driver
migrate to <code class="language-plaintext highlighter-rouge">overlay2</code>.</p>

<p>²) The <code class="language-plaintext highlighter-rouge">devicemapper</code> storage driver is deprecated in Docker Engine 18.09, and will be
removed in a future release. It is recommended that users of the <code class="language-plaintext highlighter-rouge">devicemapper</code> storage driver
migrate to <code class="language-plaintext highlighter-rouge">overlay2</code>.</p>

<p>When possible, <code class="language-plaintext highlighter-rouge">overlay2</code> is the recommended storage driver. When installing
Docker for the first time, <code class="language-plaintext highlighter-rouge">overlay2</code> is used by default. Previously, <code class="language-plaintext highlighter-rouge">aufs</code> was
used by default when available, but this is no longer the case. If you want to
use <code class="language-plaintext highlighter-rouge">aufs</code> on new installations going forward, you need to explicitly configure
it, and you may need to install extra packages, such as <code class="language-plaintext highlighter-rouge">linux-image-extra</code>.
See <a href="/docs.docker.jp.onthefly/storage/storagedriver/aufs-driver/">aufs</a>.</p>

<p>On existing installations using <code class="language-plaintext highlighter-rouge">aufs</code>, it is still used.</p>

<p>When in doubt, the best all-around configuration is to use a modern Linux
distribution with a kernel that supports the <code class="language-plaintext highlighter-rouge">overlay2</code> storage driver, and to
use Docker volumes for write-heavy workloads instead of relying on writing data
to the container’s writable layer.</p>

<p>The <code class="language-plaintext highlighter-rouge">vfs</code> storage driver is usually not the best choice. Before using the <code class="language-plaintext highlighter-rouge">vfs</code>
storage driver, be sure to read about
<a href="/docs.docker.jp.onthefly/storage/storagedriver/vfs-driver/">its performance and storage characteristics and limitations</a>.</p>

<blockquote>
  <p><strong>Expectations for non-recommended storage drivers</strong>: Commercial support is
not available for Docker Engine - Community, and you can technically use any storage driver
that is available for your platform. For instance, you can use <code class="language-plaintext highlighter-rouge">btrfs</code> with
Docker Engine - Community, even though it is not recommended on any platform for
Docker Engine - Community, and you do so at your own risk.</p>

  <p>The recommendations in the table above are based on automated regression
testing and the configurations that are known to work for a large number of
users. If you use a recommended configuration and find a reproducible issue,
it is likely to be fixed very quickly. If the driver that you want to use is
not recommended according to this table, you can run it at your own risk. You
can and should still report any issues you run into. However, such issues
have a lower priority than issues encountered when using a recommended
configuration.</p>
</blockquote>

<h3 id="docker-desktop-for-mac-and-docker-desktop-for-windows">Docker Desktop for Mac and Docker Desktop for Windows</h3>

<p>Docker Desktop for Mac and Docker Desktop for Windows are intended for development, rather
than production. Modifying the storage driver on these platforms is not
possible.</p>

<h2 id="supported-backing-filesystems">Supported backing filesystems</h2>

<p>With regard to Docker, the backing filesystem is the filesystem where
<code class="language-plaintext highlighter-rouge">/var/lib/docker/</code> is located. Some storage drivers only work with specific
backing filesystems.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">ストレージドライバー</th>
      <th style="text-align: left">Supported backing filesystems</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">overlay2</code>, <code class="language-plaintext highlighter-rouge">overlay</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">xfs</code> with ftype=1, <code class="language-plaintext highlighter-rouge">ext4</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">aufs</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">xfs</code>, <code class="language-plaintext highlighter-rouge">ext4</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">devicemapper</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">direct-lvm</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">btrfs</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">btrfs</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">zfs</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">zfs</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">vfs</code></td>
      <td style="text-align: left">どのファイルシステムでも</td>
    </tr>
  </tbody>
</table>

<h2 id="other-considerations">その他の考慮事項</h2>

<h3 id="suitability-for-your-workload">Suitability for your workload</h3>

<p>Among other things, each storage driver has its own performance characteristics
that make it more or less suitable for different workloads. Consider the
following generalizations:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">overlay2</code>, <code class="language-plaintext highlighter-rouge">aufs</code>, and <code class="language-plaintext highlighter-rouge">overlay</code> all operate at the file level rather than
the block level. This uses memory more efficiently, but the container’s
writable layer may grow quite large in write-heavy workloads.</li>
  <li>Block-level storage drivers such as <code class="language-plaintext highlighter-rouge">devicemapper</code>, <code class="language-plaintext highlighter-rouge">btrfs</code>, and <code class="language-plaintext highlighter-rouge">zfs</code> perform
better for write-heavy workloads (though not as well as Docker volumes).</li>
  <li>For lots of small writes or containers with many layers or deep filesystems,
<code class="language-plaintext highlighter-rouge">overlay</code> may perform better than <code class="language-plaintext highlighter-rouge">overlay2</code>, but consumes more inodes, which
can lead to inode exhaustion.</li>
  <li><code class="language-plaintext highlighter-rouge">btrfs</code> and <code class="language-plaintext highlighter-rouge">zfs</code> require a lot of memory.</li>
  <li><code class="language-plaintext highlighter-rouge">zfs</code> is a good choice for high-density workloads such as PaaS.</li>
</ul>

<p>More information about performance, suitability, and best practices is available
in the documentation for each storage driver.</p>

<h3 id="shared-storage-systems-and-the-storage-driver">Shared storage systems and the storage driver</h3>

<p>If your enterprise uses SAN, NAS, hardware RAID, or other shared storage
systems, they may provide high availability, increased performance, thin
provisioning, deduplication, and compression. In many cases, Docker can work on
top of these storage systems, but Docker does not closely integrate with them.</p>

<p>Each Docker storage driver is based on a Linux filesystem or volume manager. Be
sure to follow existing best practices for operating your storage driver
(filesystem or volume manager) on top of your shared storage system. For
example, if using the ZFS storage driver on top of a shared storage system, be
sure to follow best practices for operating ZFS filesystems on top of that
specific shared storage system.</p>

<h3 id="stability">安定性</h3>

<p>ユーザーにとっては、処理性能よりも安定性が重要視されることがあります。
ここに説明するストレージドライバーはすべて安定していると考えられますが、中には更新され活発に開発中であるものもあります。
一般に <code class="language-plaintext highlighter-rouge">overlay2</code>, <code class="language-plaintext highlighter-rouge">aufs</code>, <code class="language-plaintext highlighter-rouge">overlay</code>, <code class="language-plaintext highlighter-rouge">devicemapper</code> は最も安定したものとして選ぶことができます。</p>

<h3 id="test-with-your-own-workloads">Test with your own workloads</h3>

<p>You can test Docker’s performance when running your own workloads on different
storage drivers. Make sure to use equivalent hardware and workloads to match
production conditions, so you can see which storage driver offers the best
overall performance.</p>

<h2 id="check-your-current-storage-driver">利用中のストレージドライバーの確認</h2>

<p>The detailed documentation for each individual storage driver details all of the
set-up steps to use a given storage driver.</p>

<p>To see what storage driver Docker is currently using, use <code class="language-plaintext highlighter-rouge">docker info</code> and look
for the <code class="language-plaintext highlighter-rouge">Storage Driver</code> line:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker info

Containers: 0
Images: 0
Storage Driver: overlay2
 Backing Filesystem: xfs
&lt;output truncated&gt;
</code></pre></div></div>

<p>To change the storage driver, see the specific instructions for the new storage
driver. Some drivers require additional configuration, including configuration
to physical or logical disks on the Docker host.</p>

<blockquote class="important">
  <p><strong>Important</strong>: When you change the storage driver, any existing images and
containers become inaccessible. This is because their layers cannot be used
by the new storage driver. If you revert your changes, you can
access the old images and containers again, but any that you pulled or
created using the new driver are then inaccessible.</p>
</blockquote>

<h2 id="related-information">関連情報</h2>

<ul>
  <li><a href="/docs.docker.jp.onthefly/storage/storagedriver/">About images, containers, and storage drivers</a></li>
  <li><a href="/docs.docker.jp.onthefly/storage/storagedriver/aufs-driver/"><code class="language-plaintext highlighter-rouge">aufs</code> storage driver in practice</a></li>
  <li><a href="/docs.docker.jp.onthefly/storage/storagedriver/device-mapper-driver/"><code class="language-plaintext highlighter-rouge">devicemapper</code> storage driver in practice</a></li>
  <li><a href="/docs.docker.jp.onthefly/storage/storagedriver/overlayfs-driver/"><code class="language-plaintext highlighter-rouge">overlay</code> and <code class="language-plaintext highlighter-rouge">overlay2</code> storage drivers in practice</a></li>
  <li><a href="/docs.docker.jp.onthefly/storage/storagedriver/btrfs-driver/"><code class="language-plaintext highlighter-rouge">btrfs</code> storage driver in practice</a></li>
  <li><a href="/docs.docker.jp.onthefly/storage/storagedriver/zfs-driver/"><code class="language-plaintext highlighter-rouge">zfs</code> storage driver in practice</a></li>
</ul>
