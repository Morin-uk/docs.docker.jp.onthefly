
<p>Docker では Docker Hub 上でのプルリクエストに対して、ダウンロードレート制限を有効化してきました。
この制限はアカウントの種類により決定されます。
詳しくは <a href="https://hub.docker.com/pricing" target="_blank" rel="noopener" class="_">Docker Hub Pricing</a> を参照してください。</p>

<p>ユーザーへの制限というのは、個人アカウントやこれが所属する組織に対しての、最大限の資格を意味します。
これを利用するためには <a href="https://hub.docker.com/" target="_blank" rel="noopener" class="_">Docker Hub</a> に対して、認証されたユーザーとしてログインしなければなりません。
<a href="#how-do-i-authenticate-pull-requests">プルリクエストの認証方法</a> を参照してください。
認証されていない（匿名）ユーザーは、IP を通じて制限が課せられます。</p>

<ul>
  <li>プルリクエストとは、Registry マニフェスト URL（<code class="language-plaintext highlighter-rouge">/v2/*/manifests/*</code>）において、最大 2 つの <code class="language-plaintext highlighter-rouge">GET</code> リクエストとして定義されています。</li>
  <li>通常のイメージプルは、単一のマニフェストリクエストを行います。</li>
  <li>マルチアーキテクチャーイメージに対するプルリクエストは、2 つのマニフェストリクエストを行います。</li>
  <li><code class="language-plaintext highlighter-rouge">HEAD</code> リクエストは数に含めません。</li>
  <li>制限は、プルを行うユーザーに対して適用されます。
プルされたイメージやその所有者に対して適用されるものではありません。</li>
</ul>

<p>Docker においてこのレート制限は徐々に導入され、完全な動作となったのは 2020 年 11 月 1 日からです。</p>

<h2 id="how-do-I-authenticate-pull-requests">プルリクエストの認証方法</h2>

<p>以下の節では、Docker Hub にログインして、プルリクエストを認証する方法を説明します。</p>

<h3 id="docker-desktop">Docker Desktop</h3>

<p>Docker Desktop を利用している場合、Docker Desktop メニューから Docker Hub にログインすることができます。</p>

<p>Docker Desktop メニューから <strong>Sign in / Create Docker ID</strong> をクリックして、画面内の指示に従って、サインイン操作を完了させます。</p>

<h3 id="docker-engine">Docker Engine</h3>

<p>Docker Engine のスタンドアロン版を利用している場合は、ターミナル画面から <code class="language-plaintext highlighter-rouge">docker login</code> コマンドを実行して Docker Hub の認証を取得します。
このコマンドの使い方については <a href="/docs.docker.jp.onthefly/engine/reference/commandline/login/">docker login</a> を参照してください。</p>

<h3 id="docker-swarm">Docker Swarm</h3>

<p>Docker Swarm を実行している場合、Docker Hub における認証を得るためには <code class="language-plaintext highlighter-rouge">-- with-registry-auth</code> フラグを用いる必要があります。
詳しくは <a href="/docs.docker.jp.onthefly/engine/reference/commandline/service_create/#create-a-service">docker service create</a> を参照してください。
Docker Compose ファイルを使ってアプリケーションをデプロイしている場合は <a href="/docs.docker.jp.onthefly/engine/reference/commandline/stack_deploy/">docker stack deploy</a> を参照してください。</p>

<h3 id="gitHub-actions">GitHub Action</h3>

<p>GitHub の Action を利用して、Docker Hub における Docker イメージのビルドとプッシュを行っている場合は、<a href="https://github.com/docker/login-action#dockerhub" target="_blank" rel="noopener" class="_">login action</a> を参照してください。
これとは別の Action を利用している場合、認証と同じようにユーザー名とアクセストークンを追加する必要があります。</p>

<h3 id="kubernetes">Kubernetes</h3>

<p>Kubernetes を実行している場合、認証に関する情報は <a href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/" target="_blank" rel="noopener" class="_">Pull an Image from a Private Registry</a> に示されている手順に従ってください。</p>

<h3 id="third-party-platforms">サードパーティー製のプラットフォーム</h3>

<p>サードパーティー製のプラットフォームを利用している場合は、各プロバイダーから提供される、レジストリ認証を利用する手順に従ってください。</p>

<ul>
  <li><a href="https://www.jfrog.com/confluence/display/JFROG/Advanced+Settings#AdvancedSettings-RemoteCredentials" target="_blank" rel="noopener" class="_">Artifactory</a></li>
  <li><a href="https://aws.amazon.com/blogs/devops/how-to-use-docker-images-from-a-private-registry-in-aws-codebuild-for-your-build-environment/" target="_blank" rel="noopener" class="_">AWS CodeBuild</a></li>
  <li><a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/private-auth.html" target="_blank" rel="noopener" class="_">AWS ECS/Fargate</a></li>
  <li><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/library/service-endpoints?view=azure-devops&amp;tabs=yaml#sep-docreg" target="_blank" rel="noopener" class="_">Azure Pipelines</a></li>
  <li><a href="https://circleci.com/docs/2.0/private-images/" target="_blank" rel="noopener" class="_">CircleCI</a></li>
  <li><a href="https://codefresh.io/docs/docs/docker-registries/external-docker-registries/docker-hub/" target="_blank" rel="noopener" class="_">Codefresh</a></li>
  <li><a href="https://docs.drone.io/pipeline/docker/syntax/images/#pulling-private-images" target="_blank" rel="noopener" class="_">Drone.io</a></li>
  <li><a href="https://layerci.com/docs/advanced-workflows#logging-in-to-docker" target="_blank" rel="noopener" class="_">LayerCI</a></li>
</ul>

<h2 id="other-limits">その他の制限</h2>

<p>Docker Hub ではアプリケーションやインフラストラクチャーを保護するために、ダウンロードレートの総量制限があります。
この制限は Hub に対するリクエストすべてに適用されるものであり、ウェブページ、API、イメージプルなどを含みます。
制限は IP アドレスごとに行われ、負荷状況などにより時間とともに変化しますが、1 分あたり数千個のリクエスト相当のものです。
レートの総量制限は、アカウントのレベルに関係なく、全ユーザーに等しく適用されます。</p>

<p>この制限が適用されたかどうかは、エラーコードを見ればわかります。
総量制限が適用された場合、単純に<code class="language-plaintext highlighter-rouge">429 Too Many Requests</code>レスポンスが返されます。
イメージのダウンロードの際に発生する制限の場合は、もっと長いエラーメッセージが示され、その中には本ページへのリンクが示されます。</p>
