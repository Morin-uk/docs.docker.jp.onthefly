
<p>リポジトリへのプッシュイベントに呼応して、他のサービスへのアクションを行うウェブフックを利用することができます。
ウェブフックは Docker Hub 上において、設定した URL に対して送信される POST リクエストです。</p>

<p>Docker Hub のリポジトリ画面において「Webhooks」タブを通じてウェブフックを設定してください。</p>

<p><img src="/docs.docker.jp.onthefly/docker-hub/images/webhooks-empty.png" alt="ウェブフックページ" /></p>

<h3 id="create-webhooks">ウェブフックの生成</h3>

<p>ウェブフックを生成するには、リポジトリ画面の Webhooks タブにアクセスし、以下を実行します。</p>
<ol>
  <li>ウェブフック名を入力します。</li>
  <li>目的とするウェブフック URL を入力します。
これはウェブフックによる POST リクエストが送信される先を表わします。</li>
</ol>

<p><img src="/docs.docker.jp.onthefly/docker-hub/images/webhooks-create.png" alt="ウェブフックの生成" /></p>

<h3 id="view-webhook-delivery-history">ウェブフック送信履歴の参照</h3>

<p>ウェブフックの送信履歴を確認するには、ウェブフックのサブメニューを表示して「View History」をクリックします。</p>

<p><img src="/docs.docker.jp.onthefly/docker-hub/images/webhooks-submenu.png" alt="ウェブフック送信履歴の参照" /></p>

<p>上により送信履歴を参照することができます。
また POST リクエスト送信の成功、失敗を確認することもできます。</p>

<p><img src="/docs.docker.jp.onthefly/docker-hub/images/webhooks-history.png" alt="ウェブフック履歴" /></p>

<h3 id="example-webhook-payload">ウェブフック本体部分の例</h3>

<p>Docker Hub ウェブフックの本体部分は、以下のような JSON 形式により表現されます。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"callback_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://registry.hub.docker.com/u/svendowideit/testhook/hook/2141b5bi5i5b02bec211i4eeih0242eg11000a/"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"push_data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"images"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"27d47432a69bca5f2700e4dff7de0388ed65f9d3fb1ec645e2bc24c223dc1cc3"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"51a9c7c1f8bb2fa19bcd09789a34e63f35abb80044bc10196e304f6634cc582c"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"..."</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"pushed_at"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.417566161e+09</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pusher"</span><span class="p">:</span><span class="w"> </span><span class="s2">"trustedbuilder"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"latest"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"repository"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"comment_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"date_created"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.417494799e+09</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="nl">"dockerfile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#</span><span class="se">\n</span><span class="s2"># BUILD</span><span class="se">\u</span><span class="s2">0009</span><span class="se">\u</span><span class="s2">0009docker build -t svendowideit/apt-cacher .</span><span class="se">\n</span><span class="s2"># RUN</span><span class="se">\u</span><span class="s2">0009</span><span class="se">\u</span><span class="s2">0009docker run -d -p 3142:3142 -name apt-cacher-run apt-cacher</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2"># and then you can run containers with:</span><span class="se">\n</span><span class="s2"># </span><span class="se">\u</span><span class="s2">0009</span><span class="se">\u</span><span class="s2">0009docker run -t -i -rm -e http_proxy http://192.168.1.2:3142/ debian bash</span><span class="se">\n</span><span class="s2">#</span><span class="se">\n</span><span class="s2">FROM</span><span class="se">\u</span><span class="s2">0009</span><span class="se">\u</span><span class="s2">0009ubuntu</span><span class="se">\n\n\n</span><span class="s2">VOLUME</span><span class="se">\u</span><span class="s2">0009</span><span class="se">\u</span><span class="s2">0009[/var/cache/apt-cacher-ng]</span><span class="se">\n</span><span class="s2">RUN</span><span class="se">\u</span><span class="s2">0009</span><span class="se">\u</span><span class="s2">0009apt-get update ; apt-get install -yq apt-cacher-ng</span><span class="se">\n\n</span><span class="s2">EXPOSE </span><span class="se">\u</span><span class="s2">0009</span><span class="se">\u</span><span class="s2">00093142</span><span class="se">\n</span><span class="s2">CMD</span><span class="se">\u</span><span class="s2">0009</span><span class="se">\u</span><span class="s2">0009chmod 777 /var/cache/apt-cacher-ng ; /etc/init.d/apt-cacher-ng start ; tail -f /var/log/apt-cacher-ng/*</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"full_description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Docker Hub based automated build from a GitHub repo"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is_official"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is_private"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is_trusted"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"testhook"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"svendowideit"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"owner"</span><span class="p">:</span><span class="w"> </span><span class="s2">"svendowideit"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"repo_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"svendowideit/testhook"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"repo_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://registry.hub.docker.com/u/svendowideit/testhook/"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"star_count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Active"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="validate-a-webhook-callback">ウェブフックコールバックの検証</h3>

<p>ウェブフックチェーン内の 1 つのコールバックを検証するには、以下の手順が必要となります。</p>

<ol>
  <li>リクエストの JSON 形式部分から <code class="language-plaintext highlighter-rouge">callback_url</code> の値を取得します。</li>
  <li>上が示している URL に対して、正常な JSON 形式の本体を含む POST リクエストを送信します。</li>
</ol>

<blockquote>
  <p><strong>メモ</strong>: チェーンリクエストは、最終のコールバックが正常であることが検証されて、初めて完全なものとして受け付けられます。</p>
</blockquote>

<h4 id="callback-json-data">コールバックの JSON データ</h4>

<p>コールバックデータ内では、以下のパラメーターが識別されます。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">state</code> (必須): 受け入れ可能な値は <code class="language-plaintext highlighter-rouge">success</code>, <code class="language-plaintext highlighter-rouge">failure</code>, <code class="language-plaintext highlighter-rouge">error</code> のいずれか。
<code class="language-plaintext highlighter-rouge">state</code> の値が <code class="language-plaintext highlighter-rouge">success</code> ではない場合、ウェブフックチェーンは中断されます。</li>
  <li><code class="language-plaintext highlighter-rouge">description</code>: Docker Hub 上において利用するさまざまな情報を含んだ文字列。
255 文字まで。</li>
  <li><code class="language-plaintext highlighter-rouge">context</code>: 処理対象のコンテキストに関する文字列。
Docker Hub から取り出すことができます。
100 文字まで。</li>
  <li><code class="language-plaintext highlighter-rouge">target_url</code>: 処理結果が得られる URL。
Docker Hub から取り出すことができます。</li>
</ul>

<p><strong>コールバック本体部分の例</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "state": "success",
  "description": "387 tests PASSED",
  "context": "Continuous integration by Acme CI",
  "target_url": "https://ci.acme.com/results/afd339c1c3d27"
}
</code></pre></div></div>
